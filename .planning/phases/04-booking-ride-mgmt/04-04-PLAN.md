---
phase: 04-booking-ride-mgmt
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - apps/web/app/(app)/components/cancellation-dialog.tsx
  - apps/web/app/(app)/components/ride-detail.tsx
  - apps/web/app/(app)/my-rides/page.tsx
autonomous: true

must_haves:
  truths:
    - "Driver or passenger can cancel a booking with an optional reason via a modal dialog"
    - "Cancelling a confirmed booking restores seats on the ride"
    - "Driver can cancel their entire ride, which cascades to all bookings"
    - "My Rides page shows both driver rides and passenger bookings with tabs"
    - "Passenger bookings on My Rides show ride details, booking status, and cancel action"
  artifacts:
    - path: "apps/web/app/(app)/components/cancellation-dialog.tsx"
      provides: "Modal dialog for cancelling a booking or ride with reason input"
    - path: "apps/web/app/(app)/my-rides/page.tsx"
      provides: "Updated My Rides with driver + passenger views"
  key_links:
    - from: "apps/web/app/(app)/components/cancellation-dialog.tsx"
      to: "supabase RPC cancel_booking / cancel_ride"
      via: "supabase.rpc('cancel_booking'|'cancel_ride', {...})"
      pattern: "rpc\\('cancel_(booking|ride)'"
    - from: "apps/web/app/(app)/my-rides/page.tsx"
      to: "packages/shared/src/queries/bookings.ts"
      via: "getPassengerBookings query"
      pattern: "getPassengerBookings"
---

<objective>
Add cancellation handling for bookings and rides, and extend My Rides to show passenger bookings.

Purpose: Users need to cancel bookings/rides with a tracked reason (for reliability scoring), and passengers need to see their bookings in My Rides alongside driver rides. This completes the booking management loop.

Output: CancellationDialog component, updated ride detail with RPC-based cancellation, My Rides page with driver + passenger tabs.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-booking-ride-mgmt/04-RESEARCH.md
@.planning/phases/04-booking-ride-mgmt/04-01-SUMMARY.md
@.planning/phases/04-booking-ride-mgmt/04-02-SUMMARY.md
@.planning/phases/04-booking-ride-mgmt/04-03-SUMMARY.md
@apps/web/app/(app)/my-rides/page.tsx
@apps/web/app/(app)/components/ride-detail.tsx
@packages/shared/src/queries/bookings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CancellationDialog and update ride detail to use cancel RPCs</name>
  <files>
    apps/web/app/(app)/components/cancellation-dialog.tsx
    apps/web/app/(app)/components/ride-detail.tsx
  </files>
  <action>
**CancellationDialog component** (`cancellation-dialog.tsx`):
'use client' modal dialog component receiving: `type` ('booking' | 'ride'), `id` (booking or ride ID), `isOpen`, `onClose`, `onCancelled` callback.

- Modal overlay with card content (centered, max-w-md)
- Header: "Cancel Booking" or "Cancel Ride" based on type
- For ride cancellation, show warning: "This will cancel all bookings on this ride and notify passengers."
- Textarea for optional reason (max 500 chars, use CancelBookingSchema from @festapp/shared for validation)
- "Cancel" (dismiss) and "Confirm Cancellation" (red/destructive) buttons
- Loading state on confirm

On confirm:
- For booking: `supabase.rpc('cancel_booking', { p_booking_id: id, p_user_id: currentUserId, p_reason: reason || null })`
- For ride: `supabase.rpc('cancel_ride', { p_ride_id: id, p_driver_id: currentUserId, p_reason: reason || null })`
- On success: toast ("Booking cancelled" or "Ride cancelled"), call onCancelled, close dialog
- On error: toast with error message

**Update ride-detail.tsx:**
- **Replace the existing handleCancel** (which does a direct updateRide call) with CancellationDialog:
  - Driver's "Cancel Ride" button opens CancellationDialog with type='ride'
  - onCancelled callback: router.refresh() to update page state
- **Add booking cancellation for passengers:**
  - When currentUserBooking exists and is 'pending' or 'confirmed', show a "Cancel Booking" button in the booking status area
  - This opens CancellationDialog with type='booking' and the booking ID
  - onCancelled callback: router.refresh()
- Keep the existing inline confirm pattern for the cancel button click (first click shows CancellationDialog, not the old two-click confirm)
  </action>
  <verify>
1. `pnpm turbo build --filter=web` compiles
2. Driver clicking "Cancel Ride" opens dialog with reason input
3. Confirming cancellation calls cancel_ride RPC and refreshes page
4. Passenger with a booking sees "Cancel Booking" button, dialog works with cancel_booking RPC
  </verify>
  <done>CancellationDialog handles both booking and ride cancellations with reason tracking. Ride detail uses cancel_ride RPC (replacing direct update) and offers booking cancellation to passengers.</done>
</task>

<task type="auto">
  <name>Task 2: Extend My Rides page to show passenger bookings alongside driver rides</name>
  <files>apps/web/app/(app)/my-rides/page.tsx</files>
  <action>
**Redesign My Rides page** to show both driver rides and passenger bookings:

Fetch data server-side:
- Existing: `getDriverRides(supabase, userId)` for rides where user is driver
- New: `getPassengerBookings(supabase, userId)` for rides where user is passenger (from @festapp/shared)

Layout with 3-level tabs:
1. **Top-level tabs:** "As Driver" | "As Passenger"
2. **Sub-tabs (within each):** "Upcoming" | "Past"

**As Driver tab** (mostly unchanged from current implementation):
- Upcoming: rides with status='upcoming' or 'in_progress', ordered by departure_time ascending
- Past: rides with status='completed' or 'cancelled', ordered by departure_time descending
- Each ride card shows: route, date, seats (booked/total), status badge, link to detail/manage
- For request-mode rides: show pending request count badge

**As Passenger tab** (new):
- Upcoming: bookings where joined ride status='upcoming' or 'in_progress' AND booking status IN ('pending', 'confirmed')
- Past: bookings where joined ride status='completed' or 'cancelled' OR booking status IN ('completed', 'cancelled')
- Each booking card shows:
  - Route (origin -> destination), departure date/time
  - Driver name and avatar (linked to profile)
  - Booking status badge (pending=amber, confirmed=green, cancelled=red, completed=blue)
  - Seats booked, price per seat
  - For upcoming confirmed: "Cancel Booking" button (opens CancellationDialog)
  - Link to ride detail page

Use the existing skeleton loading and empty state patterns from current my-rides/page.tsx.
Empty state for "As Passenger" upcoming: "No upcoming rides. Search for a ride!" with link to /search.
Empty state for "As Passenger" past: "No ride history yet."

Tab state managed client-side (useState). Default to "As Driver" tab. Use URL search params to persist active tab (optional, nice-to-have).

Use existing RideCard component style for consistency where possible. Import RideStatusBadge for status display.
  </action>
  <verify>
1. `pnpm turbo build --filter=web` compiles
2. My Rides page loads with "As Driver" and "As Passenger" tabs
3. "As Passenger" tab shows bookings with ride details, driver info, and status
4. Upcoming passenger bookings show cancel option
5. Past bookings show completed/cancelled status
6. Empty states display correctly
  </verify>
  <done>My Rides page shows both driver rides and passenger bookings with upcoming/past sub-tabs. Passenger bookings display ride details, driver info, booking status, and cancellation option for upcoming rides.</done>
</task>

</tasks>

<verification>
1. Driver can cancel a ride with reason via CancellationDialog
2. Ride cancellation cascades to all bookings (via cancel_ride RPC)
3. Passenger can cancel their booking with reason via CancellationDialog
4. Booking cancellation restores seats on confirmed bookings
5. My Rides "As Driver" tab shows driver rides (unchanged behavior)
6. My Rides "As Passenger" tab shows passenger bookings with correct statuses
7. Cancel action available on upcoming passenger bookings
8. Empty states display for both tabs
</verification>

<success_criteria>
- Cancellation flow uses RPCs (not direct updates) for data integrity
- Cancellation reason is tracked in the database for reliability scoring
- My Rides unified view shows complete picture for users who are both drivers and passengers
- All existing My Rides functionality preserved in "As Driver" tab
</success_criteria>

<output>
After completion, create `.planning/phases/04-booking-ride-mgmt/04-04-SUMMARY.md`
</output>
