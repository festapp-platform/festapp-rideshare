---
phase: 04-booking-ride-mgmt
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/web/app/(app)/components/booking-button.tsx
  - apps/web/app/(app)/components/passenger-list.tsx
  - apps/web/app/(app)/components/ride-detail.tsx
  - apps/web/app/(app)/rides/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Passenger sees a 'Book N seat(s)' button on instant-booking rides with a seat quantity selector"
    - "Clicking book calls book_ride_instant RPC and shows success or specific error message"
    - "Ride detail page shows a list of confirmed passengers with avatar, name, and seats booked"
    - "Driver cannot book their own ride (button hidden for ride owner)"
    - "Already-booked passenger sees their booking status instead of the book button"
  artifacts:
    - path: "apps/web/app/(app)/components/booking-button.tsx"
      provides: "Booking action button with seat selector for instant and request modes"
    - path: "apps/web/app/(app)/components/passenger-list.tsx"
      provides: "List of passengers booked on a ride"
    - path: "apps/web/app/(app)/components/ride-detail.tsx"
      provides: "Updated ride detail with booking button and passenger list"
    - path: "apps/web/app/(app)/rides/[id]/page.tsx"
      provides: "Server page fetching bookings data alongside ride"
  key_links:
    - from: "apps/web/app/(app)/components/booking-button.tsx"
      to: "supabase RPC book_ride_instant"
      via: "supabase.rpc('book_ride_instant', {...})"
      pattern: "rpc\\('book_ride_instant'"
    - from: "apps/web/app/(app)/rides/[id]/page.tsx"
      to: "packages/shared/src/queries/bookings.ts"
      via: "getBookingsForRide query"
      pattern: "getBookingsForRide"
---

<objective>
Add instant booking functionality to ride detail pages with seat selection and passenger list display.

Purpose: This is the core booking interaction -- passengers find a ride and book seats instantly. The ride detail page must show who's already booked and let new passengers join.

Output: BookingButton component (handles both instant and request modes), PassengerList component, updated ride detail page with server-side booking data fetching.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-booking-ride-mgmt/04-RESEARCH.md
@.planning/phases/04-booking-ride-mgmt/04-01-SUMMARY.md
@apps/web/app/(app)/components/ride-detail.tsx
@apps/web/app/(app)/rides/[id]/page.tsx
@packages/shared/src/queries/bookings.ts
@packages/shared/src/constants/booking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BookingButton and PassengerList components</name>
  <files>
    apps/web/app/(app)/components/booking-button.tsx
    apps/web/app/(app)/components/passenger-list.tsx
  </files>
  <action>
**BookingButton component** (`booking-button.tsx`):
'use client' component that receives: `rideId`, `bookingMode` ('instant' | 'request'), `seatsAvailable`, `driverId`, `currentUserId`, `existingBooking` (booking status if user already booked).

Behavior:
- If `currentUserId === driverId`: render nothing (driver can't book own ride)
- If `existingBooking` exists and is 'pending': show "Request pending" badge (amber/yellow)
- If `existingBooking` exists and is 'confirmed': show "Booked" badge (green) with seats count
- If `seatsAvailable === 0`: show "Fully booked" disabled button
- Otherwise: show seat selector (number input, min 1, max seatsAvailable, default 1) + action button

For instant mode: Button text "Book {n} seat(s)" with primary styling.
For request mode: Button text "Request {n} seat(s)" with secondary/outline styling.

On click:
- Set loading state
- For instant: `supabase.rpc('book_ride_instant', { p_ride_id: rideId, p_passenger_id: currentUserId, p_seats: seats })`
- For request: `supabase.rpc('request_ride_booking', { p_ride_id: rideId, p_passenger_id: currentUserId, p_seats: seats })`
- On success: show toast ("Seat booked!" or "Request sent!"), call `router.refresh()` to update page
- On error: parse error message and show specific toast:
  - "Not enough seats" -> "Not enough seats available"
  - "Already booked" or "Already requested" -> "You already have a booking on this ride"
  - "Driver cannot book" -> "You can't book your own ride"
  - Default: "Booking failed. Please try again."

Use createBrowserClient from existing Supabase pattern. Import useRouter from next/navigation. Use the pastel design tokens for styling (import from @festapp/shared).

**PassengerList component** (`passenger-list.tsx`):
Receives array of bookings (with joined passenger profile: display_name, avatar_url, seats_booked, status).

- Show section header "Passengers ({total confirmed seats}/{seats_total})"
- For each confirmed booking: show avatar (or initials fallback), display_name, "{n} seat(s)" badge
- For pending bookings (visible to driver only -- controlled by parent): show with "Pending" amber badge
- If no passengers: show "No passengers yet" empty state
- Link passenger name to their public profile: `/profile/{passenger_id}`
  </action>
  <verify>Components compile: `pnpm turbo build --filter=web`</verify>
  <done>BookingButton handles instant booking with seat selector, loading state, error handling, and existing booking display. PassengerList shows confirmed passengers with avatars and seat counts.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate booking components into ride detail page with server-side data</name>
  <files>
    apps/web/app/(app)/rides/[id]/page.tsx
    apps/web/app/(app)/components/ride-detail.tsx
  </files>
  <action>
**Update server page** (`rides/[id]/page.tsx`):
- Import `getBookingsForRide` from @festapp/shared
- After fetching ride data (existing code), also fetch bookings: `const { data: bookings } = await getBookingsForRide(supabase, ride.id)`
- Also fetch current user's booking for this ride (to determine existing booking status): filter bookings by current user ID
- Pass `bookings`, `currentUserBooking`, and `currentUserId` as props to the RideDetail client component

**Update RideDetail component** (`ride-detail.tsx`):
- Accept new props: `bookings`, `currentUserBooking`, `currentUserId`
- **Replace the placeholder booking section** (the "Book this ride (coming soon)" button around lines 331-361) with the BookingButton component:
  - Pass rideId, bookingMode (from ride data), seatsAvailable, driverId, currentUserId, existingBooking (currentUserBooking status)
  - Only show for rides with status 'upcoming'
- **Replace the placeholder passengers section** (around lines 362-371) with the PassengerList component:
  - Filter bookings to show: driver sees all (confirmed + pending), non-driver sees only confirmed
  - Pass ride's seats_total for the count display
- Keep all existing functionality (map, driver info, ride details, owner actions) unchanged
- Do NOT modify handleCancel yet (that's Plan 04)
  </action>
  <verify>
1. `pnpm turbo build --filter=web` compiles
2. Visit a ride detail page: booking button appears for non-owner, hidden for owner
3. Passenger list section shows (empty state if no bookings)
4. Instant booking creates a confirmed booking and shows in passenger list after refresh
  </verify>
  <done>Ride detail page fetches and displays bookings server-side, shows BookingButton for non-owners with seat selector, and PassengerList with confirmed/pending passengers. Instant booking works end-to-end via book_ride_instant RPC.</done>
</task>

</tasks>

<verification>
1. Non-owner sees "Book N seat(s)" button on instant-booking rides
2. Seat selector allows 1 to seatsAvailable selection
3. Successful booking shows toast, page refreshes, passenger appears in list
4. Booking errors show specific messages (not enough seats, already booked, own ride)
5. Already-booked passenger sees their booking status badge
6. Driver sees all bookings (confirmed + pending), non-driver sees only confirmed
7. Fully booked rides show "Fully booked" disabled state
</verification>

<success_criteria>
- Instant booking works end-to-end: select seats, click book, booking created, passenger list updates
- Error handling covers all edge cases with user-friendly messages
- Passenger list displays avatars, names, and seat counts with links to profiles
- BookingButton component is reusable for both instant and request modes (request mode wired in Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/04-booking-ride-mgmt/04-02-SUMMARY.md`
</output>
