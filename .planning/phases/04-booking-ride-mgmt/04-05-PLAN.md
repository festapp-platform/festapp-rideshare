---
phase: 04-booking-ride-mgmt
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - apps/web/app/(app)/components/ride-detail.tsx
  - apps/web/app/(app)/components/reliability-badge.tsx
  - apps/web/app/(app)/rides/[id]/manage/page.tsx
autonomous: true

must_haves:
  truths:
    - "Driver can mark a ride as completed from the ride detail or manage page"
    - "Completing a ride transitions all confirmed bookings to completed and cancels pending bookings"
    - "Complete button only appears after the ride's departure time has passed"
    - "Driver reliability score (completed rides, cancellation rate) displays on ride detail and manage pages"
    - "Reliability badge shows on the driver's profile section of ride detail"
  artifacts:
    - path: "apps/web/app/(app)/components/reliability-badge.tsx"
      provides: "Driver reliability score display component"
    - path: "apps/web/app/(app)/components/ride-detail.tsx"
      provides: "Updated with complete ride button and reliability badge"
    - path: "apps/web/app/(app)/rides/[id]/manage/page.tsx"
      provides: "Updated with complete ride button"
  key_links:
    - from: "apps/web/app/(app)/components/ride-detail.tsx"
      to: "supabase RPC complete_ride"
      via: "supabase.rpc('complete_ride', {...})"
      pattern: "rpc\\('complete_ride'"
    - from: "apps/web/app/(app)/components/reliability-badge.tsx"
      to: "supabase RPC get_driver_reliability"
      via: "supabase.rpc('get_driver_reliability', {...})"
      pattern: "rpc\\('get_driver_reliability'"
---

<objective>
Add ride completion flow and driver reliability score display.

Purpose: Drivers need to mark rides as completed to close the booking lifecycle and trigger future rating prompts. The reliability score builds trust by showing completion rates on driver profiles.

Output: Complete ride button on ride detail/manage pages, ReliabilityBadge component showing driver stats.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-booking-ride-mgmt/04-RESEARCH.md
@.planning/phases/04-booking-ride-mgmt/04-01-SUMMARY.md
@.planning/phases/04-booking-ride-mgmt/04-02-SUMMARY.md
@.planning/phases/04-booking-ride-mgmt/04-03-SUMMARY.md
@apps/web/app/(app)/components/ride-detail.tsx
@apps/web/app/(app)/rides/[id]/manage/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReliabilityBadge component and add to ride detail</name>
  <files>
    apps/web/app/(app)/components/reliability-badge.tsx
    apps/web/app/(app)/rides/[id]/page.tsx
  </files>
  <action>
**ReliabilityBadge component** (`reliability-badge.tsx`):
Server component (or client with useEffect) that receives `driverId` and fetches reliability stats.

Fetch: `supabase.rpc('get_driver_reliability', { p_driver_id: driverId })`

Display logic:
- If no data or total_rides_completed + total_rides_cancelled = 0: show nothing (new driver, no history)
- If data exists: show a compact badge/pill with:
  - Completed rides count: "{N} rides completed" with a green checkmark icon
  - If cancellation_rate > 0: "(X% cancellation rate)" -- red text if > 20%, amber if > 10%, green if <= 10%
  - Total bookings received as secondary info
- Tooltip or expandable with more details (total completed, total cancelled, bookings received)

Use pastel design tokens for styling. Keep compact -- this sits next to the driver name on ride detail.

**Update rides/[id]/page.tsx (server page):**
- Fetch driver reliability data server-side: `supabase.rpc('get_driver_reliability', { p_driver_id: ride.driver_id })`
- Pass reliability data as prop to RideDetail client component
- This avoids a client-side fetch waterfall

**Update ride-detail.tsx:**
- Accept new `driverReliability` prop
- Render ReliabilityBadge next to/below the driver name section
- Only show when driverReliability has data (completed rides > 0)
  </action>
  <verify>
1. `pnpm turbo build --filter=web` compiles
2. Ride detail page shows reliability badge next to driver name (when driver has history)
3. New drivers with no rides show no badge
  </verify>
  <done>ReliabilityBadge displays driver completion rate and cancellation stats. Ride detail fetches and shows reliability data server-side.</done>
</task>

<task type="auto">
  <name>Task 2: Add complete ride button to ride detail and manage pages</name>
  <files>
    apps/web/app/(app)/components/ride-detail.tsx
    apps/web/app/(app)/rides/[id]/manage/page.tsx
  </files>
  <action>
**Update ride-detail.tsx -- add "Complete Ride" button:**

In the owner actions section (where edit and cancel buttons are), add a "Complete Ride" button with these conditions:
- Only visible when `currentUserId === driverId` (ride owner)
- Only visible when ride status is 'upcoming' or 'in_progress'
- Only **enabled** when current time is past the ride's `departure_time` (compare with new Date())
- If before departure time: show disabled button with tooltip "Available after departure time"
- Button styling: green/success color, distinct from cancel (red) and edit (neutral)

On click:
- Confirm with inline two-step pattern (like existing cancel): first click changes text to "Confirm Complete?", second click executes
- Call `supabase.rpc('complete_ride', { p_ride_id: rideId, p_driver_id: currentUserId })`
- On success: toast "Ride completed!", router.refresh()
- On error "Only the driver": toast "Only the ride driver can complete this ride"
- On error "cannot be completed": toast "This ride cannot be completed from its current status"
- On error other: toast "Failed to complete ride"

After completion, ride status changes to 'completed' and all booking statuses update accordingly. The page refresh will show the updated status badge.

**Update manage page** (`rides/[id]/manage/page.tsx`):
- Add the same "Complete Ride" button at the top of the manage page
- Same conditions: owner only, after departure time, two-step confirm
- Same RPC call and error handling
- After completion: redirect to ride detail page (since manage actions are no longer relevant)

Both pages should show a completion summary when ride is already completed:
- "This ride was completed on {date}" informational banner
- No more action buttons
  </action>
  <verify>
1. `pnpm turbo build --filter=web` compiles
2. "Complete Ride" button appears on ride detail for driver after departure time
3. Button is disabled before departure time with tooltip explanation
4. Completing ride updates status, confirmed bookings become completed, pending become cancelled
5. Manage page also has complete button and shows completed state after
  </verify>
  <done>Driver can mark ride as completed from both ride detail and manage pages. Completion only allowed after departure time. All booking statuses transition correctly via complete_ride RPC. Completed rides show informational banner.</done>
</task>

</tasks>

<verification>
1. Complete button appears only for driver and only after departure time
2. Completing ride via RPC transitions ride to 'completed'
3. All confirmed bookings become 'completed'
4. All pending bookings become 'cancelled' with reason
5. ReliabilityBadge shows accurate stats for drivers with history
6. Cancellation rate color coding works (green <= 10%, amber 10-20%, red > 20%)
7. New drivers show no reliability badge
8. Completed rides show informational state (no more action buttons)
</verification>

<success_criteria>
- Ride completion works end-to-end via complete_ride RPC
- Departure time gate prevents premature completion
- Reliability badge provides trust signal to passengers viewing ride detail
- All booking state transitions are correct after completion
- UI clearly communicates ride lifecycle state (upcoming -> completable -> completed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-booking-ride-mgmt/04-05-SUMMARY.md`
</output>
