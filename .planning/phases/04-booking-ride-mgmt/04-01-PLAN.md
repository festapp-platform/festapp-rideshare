---
phase: 04-booking-ride-mgmt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000014_bookings.sql
  - supabase/migrations/00000000000015_booking_rpcs.sql
  - packages/shared/src/types/database.ts
  - packages/shared/src/constants/booking.ts
  - packages/shared/src/validation/booking.ts
  - packages/shared/src/queries/bookings.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Bookings table exists with status lifecycle (pending, confirmed, cancelled, completed)"
    - "Instant booking RPC atomically decrements seats and creates confirmed booking"
    - "Request booking RPC creates pending booking without decrementing seats"
    - "Respond-to-booking RPC allows driver to accept (with seat decrement) or reject"
    - "Cancel booking RPC restores seats for confirmed bookings and tracks cancellation"
    - "Complete ride RPC transitions ride and all bookings to completed"
    - "Cancel ride RPC cascades cancellation to all bookings"
    - "Reliability score RPC returns driver completion and cancellation stats"
    - "RLS allows passengers to see own bookings and drivers to see bookings on their rides"
    - "Shared package exports booking types, constants, validation schemas, and query builders"
  artifacts:
    - path: "supabase/migrations/00000000000014_bookings.sql"
      provides: "Bookings table with indexes, RLS, and reliability RPC"
    - path: "supabase/migrations/00000000000015_booking_rpcs.sql"
      provides: "All 6 booking RPC functions + expire cron update"
    - path: "packages/shared/src/constants/booking.ts"
      provides: "BOOKING_STATUS constant"
    - path: "packages/shared/src/validation/booking.ts"
      provides: "BookSeatSchema, CancelBookingSchema with Zod"
    - path: "packages/shared/src/queries/bookings.ts"
      provides: "Query builders for booking reads"
    - path: "packages/shared/src/types/database.ts"
      provides: "Updated Database interface with bookings table and RPC types"
  key_links:
    - from: "packages/shared/src/queries/bookings.ts"
      to: "packages/shared/src/types/database.ts"
      via: "SupabaseClient<Database> typed queries"
      pattern: "from\\('bookings'\\)"
    - from: "supabase/migrations/00000000000015_booking_rpcs.sql"
      to: "supabase/migrations/00000000000014_bookings.sql"
      via: "RPC functions reference bookings table"
      pattern: "public\\.bookings"
---

<objective>
Create the database foundation for the booking system and shared TypeScript package support.

Purpose: All booking features (instant, request/approve, cancellation, completion) depend on the bookings table and atomic RPC functions. The shared package must export types, constants, validation, and query builders so UI plans can consume them.

Output: 2 migration files (table + RPCs), updated database types, shared booking constants/validation/queries.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-booking-ride-mgmt/04-RESEARCH.md
@.planning/phases/03-ride-posting-search/03-01-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-02-SUMMARY.md
@packages/shared/src/types/database.ts
@packages/shared/src/constants/ride.ts
@packages/shared/src/queries/rides.ts
@packages/shared/src/index.ts
@supabase/migrations/00000000000013_ride_expiry_cron.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bookings table migration with RLS, indexes, and reliability RPC</name>
  <files>supabase/migrations/00000000000014_bookings.sql</files>
  <action>
Create migration `00000000000014_bookings.sql` with:

1. **Bookings table** (exact schema from research):
   - `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
   - `ride_id` UUID NOT NULL REFERENCES public.rides(id) ON DELETE CASCADE
   - `passenger_id` UUID NOT NULL REFERENCES public.profiles(id)
   - `seats_booked` INT NOT NULL DEFAULT 1 CHECK (seats_booked BETWEEN 1 AND 8)
   - `status` TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'confirmed', 'cancelled', 'completed'))
   - `cancelled_by` UUID REFERENCES public.profiles(id)
   - `cancellation_reason` TEXT
   - `cancelled_at` TIMESTAMPTZ
   - `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
   - `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()
   - UNIQUE (ride_id, passenger_id)

2. **Indexes:**
   - `idx_bookings_ride_id` ON bookings(ride_id)
   - `idx_bookings_passenger_id` ON bookings(passenger_id)
   - `idx_bookings_status` ON bookings(status)

3. **updated_at trigger** reusing the existing `update_updated_at_column` function from Phase 1.

4. **RLS policies:**
   - Enable RLS on bookings
   - SELECT policy: authenticated users can see their own bookings (passenger_id = auth.uid()) OR bookings on rides they drive (EXISTS subquery on rides.driver_id = auth.uid())
   - No INSERT/UPDATE/DELETE policies -- all mutations go through SECURITY DEFINER RPCs

5. **get_driver_reliability RPC** (exact SQL from research Pattern 6):
   - Returns TABLE (total_rides_completed INT, total_rides_cancelled INT, cancellation_rate NUMERIC, total_bookings_received INT)
   - LANGUAGE sql, STABLE, SET search_path = ''
   - Counts completed rides and driver-initiated cancellations of confirmed bookings
   - Only counts cancellations where cancelled_by = driver_id for reliability scoring
  </action>
  <verify>Run `supabase db reset` or apply migration. Confirm: bookings table exists with correct columns and constraints, RLS is enabled, SELECT policy works, get_driver_reliability returns correct type signature.</verify>
  <done>Bookings table with indexes, RLS SELECT policy, updated_at trigger, and get_driver_reliability RPC all exist and function correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Create booking RPC functions, update expire cron, and add shared package support</name>
  <files>
    supabase/migrations/00000000000015_booking_rpcs.sql
    packages/shared/src/types/database.ts
    packages/shared/src/constants/booking.ts
    packages/shared/src/validation/booking.ts
    packages/shared/src/queries/bookings.ts
    packages/shared/src/index.ts
  </files>
  <action>
**Migration 00000000000015_booking_rpcs.sql** with 6 SECURITY DEFINER RPC functions (all use SET search_path = ''):

1. `book_ride_instant(p_ride_id UUID, p_passenger_id UUID, p_seats INT DEFAULT 1) RETURNS UUID` -- Exact SQL from research Pattern 1. SELECT ... FOR UPDATE on rides row, validate status='upcoming', booking_mode='instant', driver != passenger, seats available, no existing booking. INSERT as 'confirmed', decrement seats_available.

2. `request_ride_booking(p_ride_id UUID, p_passenger_id UUID, p_seats INT DEFAULT 1) RETURNS UUID` -- Exact SQL from research Pattern 2 Step 1. Same validations but booking_mode check removed (works for 'request' mode). INSERT as 'pending', do NOT decrement seats.

3. `respond_to_booking(p_booking_id UUID, p_driver_id UUID, p_accept BOOLEAN) RETURNS void` -- Exact SQL from research Pattern 2 Step 2. FOR UPDATE OF b, r. Verify driver ownership and pending status. Accept: check seats, confirm, decrement. Reject: cancel with reason 'Request rejected by driver'.

4. `cancel_booking(p_booking_id UUID, p_user_id UUID, p_reason TEXT DEFAULT NULL) RETURNS void` -- Exact SQL from research Pattern 3. Verify user is driver or passenger, booking is pending or confirmed. Cancel and restore seats only if was confirmed.

5. `cancel_ride(p_ride_id UUID, p_driver_id UUID, p_reason TEXT DEFAULT NULL) RETURNS void` -- Exact SQL from research cancellation ride RPC. Verify ownership and upcoming status. Cancel ride + all associated bookings.

6. `complete_ride(p_ride_id UUID, p_driver_id UUID) RETURNS void` -- Exact SQL from research Pattern 4. Verify ownership and status is upcoming or in_progress. Complete ride, complete all confirmed bookings, cancel any pending bookings.

7. **Update expire_past_rides cron function** (CREATE OR REPLACE). Add after the existing ride status update: also complete confirmed bookings and cancel pending bookings for auto-expired rides. Use same pattern as complete_ride.

**Shared package files:**

`packages/shared/src/constants/booking.ts`:
```typescript
export const BOOKING_STATUS = {
  pending: 'pending',
  confirmed: 'confirmed',
  cancelled: 'cancelled',
  completed: 'completed',
} as const;

export type BookingStatus = typeof BOOKING_STATUS[keyof typeof BOOKING_STATUS];
```

`packages/shared/src/validation/booking.ts`:
```typescript
import { z } from 'zod';

export const BookSeatSchema = z.object({
  rideId: z.string().uuid(),
  seats: z.number().int().min(1).max(8),
});

export const CancelBookingSchema = z.object({
  bookingId: z.string().uuid(),
  reason: z.string().max(500).optional(),
});

export type BookSeat = z.infer<typeof BookSeatSchema>;
export type CancelBooking = z.infer<typeof CancelBookingSchema>;
```

`packages/shared/src/queries/bookings.ts`:
Create typed query builders following the existing pattern in `queries/rides.ts` (takes SupabaseClient<Database> as first arg):

- `getBookingsForRide(client, rideId)` -- select all bookings for a ride, join passenger profile (display_name, avatar_url, rating_avg). Order by created_at ascending.
- `getPassengerBookings(client, passengerId)` -- select bookings for a passenger, join ride data (origin_address, destination_address, departure_time, seats_total, seats_available, price_czk, status, driver_id) and driver profile (display_name, avatar_url, rating_avg). Order by created_at descending. (Exact pattern from research code examples.)
- `getBookingById(client, bookingId)` -- select single booking with ride and passenger profile joins.

`packages/shared/src/types/database.ts`:
Add `bookings` table to the Database interface following the exact pattern of the existing tables (Row, Insert, Update types). Add the RPC function type signatures to the Functions section:
- book_ride_instant: Args { p_ride_id, p_passenger_id, p_seats }, Returns string
- request_ride_booking: Args { p_ride_id, p_passenger_id, p_seats }, Returns string
- respond_to_booking: Args { p_booking_id, p_driver_id, p_accept }, Returns undefined
- cancel_booking: Args { p_booking_id, p_user_id, p_reason }, Returns undefined
- cancel_ride: Args { p_ride_id, p_driver_id, p_reason }, Returns undefined
- complete_ride: Args { p_ride_id, p_driver_id }, Returns undefined
- get_driver_reliability: Args { p_driver_id }, Returns { total_rides_completed, total_rides_cancelled, cancellation_rate, total_bookings_received }

`packages/shared/src/index.ts`:
Add exports for all new booking modules: BOOKING_STATUS, BookingStatus, BookSeatSchema, CancelBookingSchema, BookSeat, CancelBooking, getBookingsForRide, getPassengerBookings, getBookingById.
  </action>
  <verify>
1. Run `supabase db reset` to verify both migrations apply cleanly
2. Run `pnpm turbo build --filter=@festapp/shared` to confirm TypeScript compiles
3. Verify RPC functions exist: `\df public.book_ride_instant`, `\df public.cancel_ride`, etc.
4. Verify expire_past_rides now handles bookings
  </verify>
  <done>All 6 booking RPC functions exist with SECURITY DEFINER and FOR UPDATE locking. expire_past_rides handles booking completion. Shared package exports booking types, constants, validation schemas, and typed query builders. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `supabase db reset` applies all migrations (014 + 015) without errors
2. `pnpm turbo build --filter=@festapp/shared` compiles successfully
3. Bookings table has correct columns, constraints, indexes, and RLS
4. All 7 RPC functions (6 booking + 1 reliability) exist and are SECURITY DEFINER
5. expire_past_rides cron function now completes bookings alongside rides
</verification>

<success_criteria>
- Bookings table with UNIQUE(ride_id, passenger_id) constraint prevents duplicate bookings
- book_ride_instant atomically locks ride row, checks seats, creates confirmed booking, decrements seats
- request_ride_booking creates pending booking without seat decrement
- respond_to_booking allows driver accept (with seat decrement) or reject
- cancel_booking restores seats only for confirmed bookings
- cancel_ride cascades cancellation to all associated bookings
- complete_ride transitions ride + all confirmed bookings to completed, cancels pending
- get_driver_reliability returns accurate stats based on cancelled_by tracking
- Shared package types, constants, validation, and queries all export correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-booking-ride-mgmt/04-01-SUMMARY.md`
</output>
