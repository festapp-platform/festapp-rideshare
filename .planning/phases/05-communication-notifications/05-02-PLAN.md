---
phase: 05-communication-notifications
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/send-notification/index.ts
  - supabase/functions/_shared/onesignal.ts
  - supabase/functions/_shared/ses.ts
  - supabase/functions/_shared/notifications.ts
  - apps/web/public/OneSignalSDKWorker.js
  - apps/web/lib/onesignal.ts
autonomous: true

must_haves:
  truths:
    - "send-notification Edge Function accepts a notification payload and dispatches to push and/or email based on user preferences"
    - "OneSignal push uses REST API with include_aliases external_id targeting (not deprecated setExternalUserId)"
    - "AWS SES email uses @aws-sdk/client-sesv2 via npm: specifier (not SMTP)"
    - "Preferences are checked server-side before dispatching"
    - "Web has OneSignal service worker file for web push"
  artifacts:
    - path: "supabase/functions/send-notification/index.ts"
      provides: "Central notification dispatch Edge Function"
      contains: "Deno.serve"
    - path: "supabase/functions/_shared/onesignal.ts"
      provides: "OneSignal REST API push helper"
      contains: "api.onesignal.com"
    - path: "supabase/functions/_shared/ses.ts"
      provides: "AWS SES v2 email helper"
      contains: "SESv2Client"
    - path: "supabase/functions/_shared/notifications.ts"
      provides: "Preference checking and notification type mapping"
      contains: "shouldSendPush"
    - path: "apps/web/public/OneSignalSDKWorker.js"
      provides: "OneSignal service worker for web push"
      contains: "OneSignal"
    - path: "apps/web/lib/onesignal.ts"
      provides: "Web OneSignal initialization and login helper"
      contains: "OneSignal.init"
  key_links:
    - from: "supabase/functions/send-notification/index.ts"
      to: "supabase/functions/_shared/onesignal.ts"
      via: "import sendPush"
      pattern: "import.*sendPush.*onesignal"
    - from: "supabase/functions/send-notification/index.ts"
      to: "supabase/functions/_shared/ses.ts"
      via: "import sendEmail"
      pattern: "import.*sendEmail.*ses"
    - from: "supabase/functions/send-notification/index.ts"
      to: "supabase/functions/_shared/notifications.ts"
      via: "import preference checking"
      pattern: "import.*shouldSend.*notifications"
---

<objective>
Push notification infrastructure: centralized send-notification Edge Function with OneSignal push and AWS SES email dispatch, plus web OneSignal setup.

Purpose: All notification triggers (booking events, chat messages, ride reminders, route alerts) will call this single Edge Function. It checks user preferences and dispatches to the appropriate channel(s).
Output: send-notification Edge Function with OneSignal and SES helpers, web OneSignal service worker and initialization code.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md

@supabase/functions/_shared/auth.ts
@supabase/functions/_shared/supabase-client.ts
@supabase/functions/compute-route/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared Edge Function helpers for OneSignal push and AWS SES email</name>
  <files>
    supabase/functions/_shared/onesignal.ts
    supabase/functions/_shared/ses.ts
    supabase/functions/_shared/notifications.ts
  </files>
  <action>
**Create _shared/onesignal.ts:**
OneSignal REST API helper using fetch() directly (NOT the @onesignal/node-onesignal SDK — Pitfall 2 from research: SDK has Deno compatibility issues).

```typescript
interface PushPayload {
  userIds: string[];      // Supabase user UUIDs (external_id in OneSignal)
  title: string;
  body: string;
  data?: Record<string, string>;  // Deep link data
  url?: string;           // Web click URL
}

export async function sendPush(payload: PushPayload): Promise<boolean>
```

Implementation:
- Read ONESIGNAL_APP_ID and ONESIGNAL_REST_API_KEY from Deno.env.
- POST to `https://api.onesignal.com/notifications` with:
  - `app_id`: from env
  - `include_aliases: { external_id: payload.userIds }` (NOT deprecated include_external_user_ids)
  - `target_channel: 'push'`
  - `headings: { en: payload.title }`
  - `contents: { en: payload.body }`
  - `data`: payload.data if provided
  - `url`: payload.url if provided
- Authorization header: `Basic ${ONESIGNAL_REST_API_KEY}`
- Return response.ok boolean. Log error details if not ok (console.error for Supabase logs).
- If env vars missing, log warning and return false (graceful degradation for dev environments without OneSignal configured).

**Create _shared/ses.ts:**
AWS SES v2 email helper using `npm:@aws-sdk/client-sesv2` (NOT SMTP — Pitfall 3: ports blocked on Deno Deploy).

```typescript
interface EmailPayload {
  to: string;             // Recipient email
  subject: string;
  html: string;
}

export async function sendEmail(payload: EmailPayload): Promise<boolean>
```

Implementation:
- Import SESv2Client, SendEmailCommand from `npm:@aws-sdk/client-sesv2`.
- Create client with region from AWS_SES_REGION env (default 'eu-north-1'), credentials from AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY.
- FromEmailAddress from SES_FROM_EMAIL env.
- Send with Simple content (Subject + Html Body).
- Return true if httpStatusCode === 200. Log errors.
- If env vars missing, log warning and return false (graceful degradation).

**Create _shared/notifications.ts:**
Preference checking and notification type mapping.

```typescript
type NotificationType = 'booking_request' | 'booking_confirmation' | 'booking_cancellation'
  | 'new_message' | 'ride_reminder' | 'route_alert';

interface NotificationPreferences { ... }  // All boolean fields from DB

export function shouldSendPush(prefs: NotificationPreferences | null, type: NotificationType): boolean
export function shouldSendEmail(prefs: NotificationPreferences | null, type: NotificationType): boolean
export async function getNotificationPreferences(supabase: any, userId: string): Promise<NotificationPreferences | null>
```

Implementation:
- Map each NotificationType to its push/email preference field name.
- `shouldSendPush`: if prefs is null, return true (default all enabled — Pitfall 7 from research). Otherwise look up the push_* field for the given type.
- `shouldSendEmail`: same logic with email_* fields. Return false for types without email support (booking_request, new_message, route_alert have no email equivalent).
- `getNotificationPreferences`: query notification_preferences table by user_id using admin client. Return null if no row (means all defaults = enabled).
  </action>
  <verify>Verify files compile by checking for syntax errors. Run `deno check supabase/functions/_shared/onesignal.ts supabase/functions/_shared/ses.ts supabase/functions/_shared/notifications.ts` if deno is available, or manually review for import correctness.</verify>
  <done>Three shared helpers exist: onesignal.ts (REST API push), ses.ts (SES v2 email), notifications.ts (preference checking). All use correct modern APIs per research (not deprecated patterns). Graceful degradation when env vars are missing.</done>
</task>

<task type="auto">
  <name>Task 2: send-notification Edge Function and web OneSignal setup</name>
  <files>
    supabase/functions/send-notification/index.ts
    apps/web/public/OneSignalSDKWorker.js
    apps/web/lib/onesignal.ts
  </files>
  <action>
**Create send-notification Edge Function:**
Central dispatch function that all notification triggers call. Following the established CORS-enabled Edge Function pattern from compute-route.

```typescript
interface NotificationPayload {
  user_id: string;          // Target user
  type: NotificationType;   // Determines which preference to check
  title: string;            // Push notification title
  body: string;             // Push notification body
  data?: Record<string, string>;  // Deep link data for push
  url?: string;             // Web click URL for push
  email_subject?: string;   // If provided, attempt email too
  email_html?: string;      // Email body HTML
}
```

Implementation:
- Import sendPush from onesignal.ts, sendEmail from ses.ts, getNotificationPreferences and shouldSendPush/shouldSendEmail from notifications.ts.
- Import admin Supabase client from supabase-client.ts (for preference lookup without RLS).
- Validate incoming payload (must have user_id, type, title, body).
- Authenticate the request: check Authorization header matches service_role key (only server-side callers should trigger notifications — other Edge Functions and pg_net calls).
- Fetch user preferences via getNotificationPreferences.
- If shouldSendPush: call sendPush with { userIds: [payload.user_id], title, body, data, url }.
- If email_html provided AND shouldSendEmail: fetch user's email from auth.users via admin client, call sendEmail.
- Return JSON: { success: true, push_sent: boolean, email_sent: boolean }.
- Include CORS headers on all responses (consistent with existing Edge Function pattern).

**Create OneSignalSDKWorker.js:**
Place in apps/web/public/ (required for web push — Pitfall 5 from research):
```javascript
importScripts('https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.sw.js');
```
This is the standard OneSignal service worker file. Must be served from the root path.

**Create apps/web/lib/onesignal.ts:**
Web OneSignal initialization helper (client-side only):
```typescript
import OneSignal from 'react-onesignal';

let initialized = false;

export async function initOneSignal() {
  if (initialized || typeof window === 'undefined') return;

  const appId = process.env.NEXT_PUBLIC_ONESIGNAL_APP_ID;
  if (!appId) {
    console.warn('OneSignal app ID not configured');
    return;
  }

  await OneSignal.init({
    appId,
    allowLocalhostAsSecureOrigin: process.env.NODE_ENV === 'development',
  });
  initialized = true;
}

export async function loginOneSignal(userId: string) {
  if (!initialized) await initOneSignal();
  OneSignal.login(userId);  // Links device to Supabase user via external_id
}

export async function logoutOneSignal() {
  OneSignal.logout();
}
```

Install react-onesignal in web app: `cd apps/web && pnpm add react-onesignal`.

Add NEXT_PUBLIC_ONESIGNAL_APP_ID to apps/web/.env.local.example.

Note: Mobile OneSignal setup (react-native-onesignal + onesignal-expo-plugin) will be handled when mobile chat UI is built. Web-first per project strategy.
  </action>
  <verify>Run `pnpm turbo build --filter=web` to verify web app builds with new OneSignal imports. Verify OneSignalSDKWorker.js is accessible at /OneSignalSDKWorker.js in the build output. Check Edge Function deploys: `supabase functions deploy send-notification`.</verify>
  <done>send-notification Edge Function exists and handles push+email dispatch with preference checking. Web OneSignal SDK installed, service worker in public/, initialization helper created. All new code follows established patterns (CORS headers, service role auth, graceful degradation).</done>
</task>

</tasks>

<verification>
- send-notification Edge Function deploys successfully
- OneSignalSDKWorker.js accessible at /OneSignalSDKWorker.js
- Web app builds without errors after react-onesignal addition
- Edge Function helpers use correct modern APIs (include_aliases not include_external_user_ids, SESv2Client not v1, fetch not SDK for OneSignal)
</verification>

<success_criteria>
- Central send-notification Edge Function dispatches push (OneSignal) and email (SES) with preference checking
- Shared helpers (onesignal.ts, ses.ts, notifications.ts) are reusable by other Edge Functions
- Web OneSignal infrastructure ready (service worker, init helper, SDK installed)
- All notification types mapped to preference fields
- Graceful degradation when env vars not configured (dev environment)
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-02-SUMMARY.md`
</output>
