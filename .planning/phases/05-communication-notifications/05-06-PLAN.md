---
phase: 05-communication-notifications
plan: 06
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-04"]
files_modified:
  - supabase/functions/check-route-alerts/index.ts
  - supabase/migrations/00000000000027_route_alert_trigger.sql
  - apps/web/app/(app)/search/components/favorite-routes.tsx
  - apps/web/app/(app)/search/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enable push alerts on a saved route"
    - "When a new ride is posted matching a saved route with alerts enabled, the user receives a push notification"
    - "Route matching uses the same geospatial corridor logic as ride search"
    - "Alert toggle is visible and toggleable on the favorite routes UI"
  artifacts:
    - path: "supabase/functions/check-route-alerts/index.ts"
      provides: "Edge Function that checks new rides against saved routes with alerts"
      contains: "Deno.serve"
    - path: "supabase/migrations/00000000000027_route_alert_trigger.sql"
      provides: "Trigger on rides INSERT to check route alerts"
      contains: "net.http_post.*check-route-alerts"
    - path: "apps/web/app/(app)/search/components/favorite-routes.tsx"
      provides: "Updated favorite routes with alert toggle"
      contains: "alert_enabled"
  key_links:
    - from: "supabase/migrations/00000000000027_route_alert_trigger.sql"
      to: "supabase/functions/check-route-alerts/index.ts"
      via: "pg_net trigger on ride INSERT"
      pattern: "net\\.http_post.*check-route-alerts"
    - from: "supabase/functions/check-route-alerts/index.ts"
      to: "supabase/functions/send-notification/index.ts"
      via: "calls send-notification for matching users"
      pattern: "send-notification"
---

<objective>
Route alerts: users can enable push notifications on saved routes and receive alerts when new rides matching their route are posted (SRCH-09).

Purpose: Passive ride discovery â€” passengers don't have to keep searching; they get notified when a relevant ride appears.
Output: Alert toggle on favorite routes, trigger on new ride posts, route matching Edge Function.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md
@.planning/phases/05-communication-notifications/05-01-SUMMARY.md
@.planning/phases/05-communication-notifications/05-02-SUMMARY.md
@.planning/phases/05-communication-notifications/05-04-SUMMARY.md

@supabase/migrations/00000000000010_favorite_routes.sql
@supabase/migrations/00000000000012_ride_search_rpc.sql
@supabase/functions/send-notification/index.ts
@apps/web/app/(app)/search/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Route alert Edge Function and database trigger</name>
  <files>
    supabase/functions/check-route-alerts/index.ts
    supabase/migrations/00000000000027_route_alert_trigger.sql
  </files>
  <action>
**Create check-route-alerts Edge Function:**
Called via pg_net trigger when a new ride is inserted. Checks all favorite_routes with alert_enabled=true for geospatial matches.

Implementation:
- Import admin Supabase client from _shared/supabase-client.ts.
- Import CORS headers pattern from existing Edge Functions.
- Accept POST with body: { ride_id: string } (from trigger payload).
- Authenticate via service_role key in Authorization header.
- Fetch the new ride's origin/destination coordinates and details.
- Query favorite_routes WHERE alert_enabled = true AND user_id != ride.driver_id (don't alert the driver about their own ride).
- For each alert-enabled route: check if the ride's origin is within ~20km of the route's origin AND the ride's destination is within ~20km of the route's destination. Use a SQL query with ST_DWithin for efficiency:
  ```sql
  SELECT fr.user_id, fr.origin_address, fr.destination_address
  FROM favorite_routes fr
  WHERE fr.alert_enabled = true
    AND fr.user_id != $driver_id
    AND extensions.ST_DWithin(fr.origin_location, $ride_origin::geography, 20000)
    AND extensions.ST_DWithin(fr.destination_location, $ride_destination::geography, 20000)
  ```
  Pass ride origin/destination as geography points.
- For each matching user: call send-notification Edge Function (internal HTTP call) with type='route_alert', title="New ride on your route!", body="[origin] to [destination] on [date]", data: { ride_id }.
- Alternatively, call sendPush directly from _shared/onesignal.ts after checking preferences (more efficient, avoids extra HTTP hop). Check shouldSendPush for 'route_alert' from _shared/notifications.ts.
- Return count of alerts sent.

**Create migration 027:**
Trigger on rides INSERT to call check-route-alerts via pg_net:

```sql
CREATE OR REPLACE FUNCTION notify_on_new_ride()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = ''
AS $$
BEGIN
  -- Only check alerts for upcoming rides (not expired/cancelled)
  IF NEW.status = 'upcoming' THEN
    PERFORM extensions.net.http_post(
      url := 'https://xamctptqmpruhovhjcgm.supabase.co/functions/v1/check-route-alerts',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer ' || current_setting('supabase.service_role_key')
      ),
      body := jsonb_build_object('ride_id', NEW.id)
    );
  END IF;
  RETURN NEW;
END;
$$;

CREATE TRIGGER on_new_ride_check_alerts
  AFTER INSERT ON public.rides
  FOR EACH ROW
  EXECUTE FUNCTION notify_on_new_ride();
```
  </action>
  <verify>Run `supabase db push` for migration. Deploy: `supabase functions deploy check-route-alerts`. Verify trigger exists on rides table. Test by inserting a ride and checking Edge Function logs.</verify>
  <done>check-route-alerts Edge Function performs geospatial matching of new rides against alert-enabled favorite routes. Database trigger fires on ride INSERT. Matching users receive push notification with ride details.</done>
</task>

<task type="auto">
  <name>Task 2: Alert toggle on favorite routes UI</name>
  <files>
    apps/web/app/(app)/search/components/favorite-routes.tsx
    apps/web/app/(app)/search/page.tsx
  </files>
  <action>
**Update favorite-routes.tsx:**
Add an alert toggle (bell icon button) to each favorite route card.

- Each favorite route card should have a bell icon button (outline when alerts off, filled when alerts on).
- On toggle: update the favorite_routes row SET alert_enabled = !current_value via Supabase client.
- Optimistic UI: toggle immediately, revert on error with toast.
- Show tooltip or small label: "Get notified when new rides match this route".
- If alert_enabled is true, show a small badge or icon indicator on the card.

**Update search page.tsx (if needed):**
- Ensure the favorite routes component receives and displays the alert_enabled column.
- If the favorite routes query doesn't include alert_enabled, update it to include the column.
- Check that the query in the search page or favorite routes component selects alert_enabled from favorite_routes.

Style: Use a simple bell icon (SVG). Filled/primary color when enabled, outline/muted when disabled. Position: right side of the favorite route card, next to the existing delete/use actions.
  </action>
  <verify>Run `pnpm turbo build --filter=web`. Navigate to search page -> favorite routes section. Verify bell toggle appears on each saved route. Toggle and verify state persists (refresh page).</verify>
  <done>Favorite routes show alert toggle (bell icon). Users can enable/disable alerts per saved route. Toggle persists to database. Visual indicator shows when alerts are active.</done>
</task>

</tasks>

<verification>
- check-route-alerts Edge Function deploys successfully
- Database trigger fires on new ride INSERT
- Geospatial matching finds routes within 20km radius
- Alert toggle appears on favorite routes in search page
- Toggle state persists to favorite_routes.alert_enabled column
- Push notification sent to users with matching alert-enabled routes when new ride posted
</verification>

<success_criteria>
- SRCH-09: User can enable push alerts on saved route, receives notification when new matching ride is posted
- Route matching uses ST_DWithin geospatial logic (consistent with ride search)
- Drivers are not alerted about their own rides
- Notification preferences (push_route_alerts) respected
- Alert toggle is intuitive with clear visual feedback
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-06-SUMMARY.md`
</output>
