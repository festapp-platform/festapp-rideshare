---
phase: 05-communication-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000022_chat.sql
  - supabase/migrations/00000000000023_notification_preferences.sql
  - supabase/migrations/00000000000024_chat_rpcs.sql
  - packages/shared/src/types/database.ts
  - packages/shared/src/validation/chat.ts
  - packages/shared/src/validation/notification.ts
  - packages/shared/src/constants/notification.ts
  - packages/shared/src/queries/chat.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Chat conversations table exists with booking_id unique constraint"
    - "Chat messages table exists with content validation and message_type support"
    - "Notification preferences table exists with per-category push/email toggles"
    - "RPC functions enforce participant-only access for sending and reading messages"
    - "Realtime publication includes chat_messages for Postgres Changes subscriptions"
    - "Favorite routes have alert_enabled column for route alerts"
  artifacts:
    - path: "supabase/migrations/00000000000022_chat.sql"
      provides: "chat_conversations and chat_messages tables with indexes"
      contains: "CREATE TABLE public.chat_conversations"
    - path: "supabase/migrations/00000000000023_notification_preferences.sql"
      provides: "notification_preferences table and favorite_routes alert column"
      contains: "CREATE TABLE public.notification_preferences"
    - path: "supabase/migrations/00000000000024_chat_rpcs.sql"
      provides: "send_chat_message, mark_messages_read, get_or_create_conversation RPCs"
      contains: "CREATE OR REPLACE FUNCTION public.send_chat_message"
    - path: "packages/shared/src/validation/chat.ts"
      provides: "SendMessageSchema, ChatMessageSchema"
      exports: ["SendMessageSchema", "ChatMessageSchema"]
    - path: "packages/shared/src/queries/chat.ts"
      provides: "getConversationsForUser, getMessages, getUnreadCount"
      exports: ["getConversationsForUser", "getMessages", "getUnreadCount"]
  key_links:
    - from: "supabase/migrations/00000000000022_chat.sql"
      to: "supabase/migrations/00000000000024_chat_rpcs.sql"
      via: "RPCs reference chat tables"
      pattern: "public\\.chat_messages"
    - from: "packages/shared/src/queries/chat.ts"
      to: "packages/shared/src/types/database.ts"
      via: "typed SupabaseClient queries"
      pattern: "SupabaseClient<Database>"
---

<objective>
Database foundation for chat and notifications: tables, RPC functions, shared types, schemas, and query builders.

Purpose: All subsequent chat UI and notification plans depend on these database tables, RPCs, and shared TypeScript types being in place.
Output: 3 migrations, updated database types, shared validation schemas, constants, and query builders.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md

@supabase/migrations/00000000000014_bookings.sql
@supabase/migrations/00000000000015_booking_rpcs.sql
@supabase/migrations/00000000000010_favorite_routes.sql
@packages/shared/src/types/database.ts
@packages/shared/src/validation/booking.ts
@packages/shared/src/queries/bookings.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chat and notification database tables with RPC functions</name>
  <files>
    supabase/migrations/00000000000022_chat.sql
    supabase/migrations/00000000000023_notification_preferences.sql
    supabase/migrations/00000000000024_chat_rpcs.sql
  </files>
  <action>
Create three migration files:

**Migration 022 — Chat tables:**
- `chat_conversations` table: id (UUID PK), booking_id (UUID NOT NULL UNIQUE FK to bookings ON DELETE CASCADE), ride_id (UUID NOT NULL FK to rides ON DELETE CASCADE), driver_id (UUID NOT NULL FK to profiles), passenger_id (UUID NOT NULL FK to profiles), created_at (TIMESTAMPTZ default now()).
- `chat_messages` table: id (UUID PK default uuid_generate_v4()), conversation_id (UUID NOT NULL FK to chat_conversations ON DELETE CASCADE), sender_id (UUID NOT NULL FK to profiles), content (TEXT NOT NULL, CHECK char_length 1-2000), message_type (TEXT NOT NULL DEFAULT 'text', CHECK IN ('text', 'phone_share')), read_at (TIMESTAMPTZ nullable — null = unread), created_at (TIMESTAMPTZ default now()).
- Indexes: `idx_chat_messages_conversation` on (conversation_id, created_at), `idx_chat_messages_unread` on (conversation_id, read_at) WHERE read_at IS NULL.
- RLS on both tables: enable RLS. Policies: SELECT for participants only (driver_id or passenger_id = auth.uid() on conversations; conversation participant check via join for messages). No direct INSERT/UPDATE/DELETE policies — all mutations through SECURITY DEFINER RPCs (consistent with booking pattern).
- Add to Realtime publication: `ALTER PUBLICATION supabase_realtime ADD TABLE public.chat_messages;` (critical for Postgres Changes subscriptions — Pitfall 1 from research).

**Migration 023 — Notification preferences + route alerts:**
- `notification_preferences` table per research schema (user_id PK FK to profiles, push_booking_requests, push_booking_confirmations, push_booking_cancellations, push_new_messages, push_ride_reminders, push_route_alerts, email_booking_confirmations, email_ride_reminders, email_cancellations — all BOOLEAN DEFAULT true, updated_at TIMESTAMPTZ).
- RLS: enable. SELECT/UPDATE own row only (user_id = auth.uid()). INSERT own row only.
- ALTER TABLE public.favorite_routes ADD COLUMN alert_enabled BOOLEAN NOT NULL DEFAULT false; (for SRCH-09 route alerts).

**Migration 024 — Chat RPC functions:**
All SECURITY DEFINER SET search_path = '' (consistent with project pattern).

1. `send_chat_message(p_conversation_id UUID, p_content TEXT, p_message_type TEXT DEFAULT 'text')` RETURNS UUID:
   - Verify auth.uid() is participant in conversation.
   - Validate content length 1-2000.
   - Validate message_type IN ('text', 'phone_share').
   - INSERT into chat_messages, RETURN message id.

2. `mark_messages_read(p_conversation_id UUID)` RETURNS void:
   - UPDATE chat_messages SET read_at = now() WHERE conversation_id = param AND sender_id != auth.uid() AND read_at IS NULL.

3. `get_or_create_conversation(p_booking_id UUID)` RETURNS UUID:
   - Check booking exists and is confirmed, and auth.uid() is driver or passenger of the ride.
   - INSERT INTO chat_conversations ... ON CONFLICT (booking_id) DO NOTHING.
   - SELECT id FROM chat_conversations WHERE booking_id = p_booking_id, RETURN it.
   - This handles the eager/lazy creation question — conversation created on first access, with ON CONFLICT for race condition safety (Pitfall 4 from research).

4. `get_unread_count()` RETURNS BIGINT:
   - Count all unread messages across all conversations where auth.uid() is a participant and sender_id != auth.uid() and read_at IS NULL. For nav badge display.
  </action>
  <verify>Run `supabase db push` or `supabase db reset` successfully. Verify tables exist via `supabase db lint` or direct SQL query. Verify RPC functions are callable.</verify>
  <done>All 3 migrations applied without errors. chat_conversations, chat_messages, notification_preferences tables exist. 4 RPC functions exist. chat_messages is in supabase_realtime publication. favorite_routes has alert_enabled column.</done>
</task>

<task type="auto">
  <name>Task 2: Shared types, validation schemas, constants, and query builders for chat and notifications</name>
  <files>
    packages/shared/src/types/database.ts
    packages/shared/src/validation/chat.ts
    packages/shared/src/validation/notification.ts
    packages/shared/src/constants/notification.ts
    packages/shared/src/queries/chat.ts
    packages/shared/src/index.ts
  </files>
  <action>
**Update database.ts:**
- Add chat_conversations, chat_messages, notification_preferences table types to the Database interface, matching the migration schemas exactly.
- Add function type signatures for send_chat_message, mark_messages_read, get_or_create_conversation, get_unread_count.
- Derive ChatConversation, ChatMessage types from Database Tables.

**Create validation/chat.ts:**
- SendMessageSchema: z.object({ conversation_id: z.string().uuid(), content: z.string().min(1).max(2000), message_type: z.enum(['text', 'phone_share']).default('text') }).
- ChatMessageSchema for display (includes id, sender_id, created_at, read_at).
- Export inferred types: SendMessage, ChatMessage.

**Create validation/notification.ts:**
- NotificationPreferencesSchema: z.object with all boolean toggle fields (push_booking_requests, etc.), all .default(true).
- Export NotificationPreferences type.

**Create constants/notification.ts:**
- NOTIFICATION_TYPES enum/const: 'booking_request', 'booking_confirmation', 'booking_cancellation', 'new_message', 'ride_reminder', 'route_alert'.
- NOTIFICATION_CATEGORIES: mapping of type to push/email preference field names (for preference checking in Edge Functions).
- MESSAGE_TYPE const: 'text' | 'phone_share'.

**Create queries/chat.ts:**
Following existing query builder pattern (SupabaseClient<Database> as first arg):
- `getConversationsForUser(supabase, userId)`: SELECT from chat_conversations with joined ride info (origin_address, destination_address, departure_time) and both profiles (display_name, avatar_url) using FK hints (!chat_conversations_driver_id_fkey and !chat_conversations_passenger_id_fkey), ordered by created_at desc. Also select a subquery or count of unread messages.
- `getMessages(supabase, conversationId, limit=50, before?: string)`: SELECT from chat_messages WHERE conversation_id, ordered by created_at desc, with limit for pagination. Support cursor-based pagination with `before` (created_at < before).
- `getUnreadCount(supabase)`: Call get_unread_count RPC.
- `getNotificationPreferences(supabase)`: SELECT from notification_preferences WHERE user_id = current user.
- `upsertNotificationPreferences(supabase, prefs)`: UPSERT into notification_preferences.

**Update index.ts:**
- Re-export all new schemas, types, constants, and query builders.
  </action>
  <verify>Run `pnpm turbo build --filter=@festapp/shared` and `pnpm turbo typecheck` to verify no type errors. Verify exports are accessible from consuming apps.</verify>
  <done>All new types, schemas, constants, and query builders compile without errors. Database types match migration schemas. Exports available from @festapp/shared.</done>
</task>

</tasks>

<verification>
- `supabase db push` succeeds with all 3 new migrations
- `pnpm turbo typecheck` passes across entire monorepo
- chat_messages is in supabase_realtime publication (query: `SELECT * FROM pg_publication_tables WHERE tablename = 'chat_messages'`)
- All 4 RPC functions exist and are callable
- Shared package exports all new types and query builders
</verification>

<success_criteria>
- Database tables (chat_conversations, chat_messages, notification_preferences) exist with correct constraints
- RLS policies enforce participant-only access
- 4 RPC functions (send_chat_message, mark_messages_read, get_or_create_conversation, get_unread_count) work correctly
- Favorite routes table has alert_enabled column
- Shared package has typed query builders, Zod schemas, and constants for chat and notifications
- All monorepo type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-01-SUMMARY.md`
</output>
