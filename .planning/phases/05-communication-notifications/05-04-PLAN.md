---
phase: 05-communication-notifications
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - supabase/migrations/00000000000025_notification_triggers.sql
  - supabase/functions/send-ride-reminders/index.ts
  - supabase/migrations/00000000000026_ride_reminder_cron.sql
autonomous: true

must_haves:
  truths:
    - "Driver receives push notification when a passenger requests or books a seat"
    - "Passenger receives push notification when booking is confirmed or rejected"
    - "Both parties receive push notification when a booking or ride is cancelled"
    - "Recipient receives push notification for new chat messages (when not in conversation)"
    - "Driver and confirmed passengers receive ride reminder 1 hour before departure"
  artifacts:
    - path: "supabase/migrations/00000000000025_notification_triggers.sql"
      provides: "Database triggers that call send-notification via pg_net"
      contains: "net.http_post"
    - path: "supabase/functions/send-ride-reminders/index.ts"
      provides: "Cron-triggered Edge Function for ride reminders"
      contains: "Deno.serve"
    - path: "supabase/migrations/00000000000026_ride_reminder_cron.sql"
      provides: "pg_cron job running every 15 minutes"
      contains: "cron.schedule"
  key_links:
    - from: "supabase/migrations/00000000000025_notification_triggers.sql"
      to: "supabase/functions/send-notification/index.ts"
      via: "pg_net HTTP POST to Edge Function"
      pattern: "net\\.http_post.*send-notification"
    - from: "supabase/migrations/00000000000026_ride_reminder_cron.sql"
      to: "supabase/functions/send-ride-reminders/index.ts"
      via: "pg_cron scheduled HTTP call"
      pattern: "cron\\.schedule.*send-ride-reminders"
---

<objective>
Push notification triggers for all ride events: booking lifecycle notifications, new message notifications, and ride reminders via pg_cron.

Purpose: Users receive timely push notifications for booking requests, confirmations, cancellations, new messages, and upcoming ride reminders (NOTF-01, NOTF-02, NOTF-04, NOTF-07).
Output: Database triggers calling send-notification Edge Function via pg_net, plus ride reminder cron job.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md
@.planning/phases/05-communication-notifications/05-01-SUMMARY.md
@.planning/phases/05-communication-notifications/05-02-SUMMARY.md

@supabase/migrations/00000000000014_bookings.sql
@supabase/migrations/00000000000015_booking_rpcs.sql
@supabase/migrations/00000000000013_ride_expiry_cron.sql
@supabase/functions/send-notification/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database notification triggers via pg_net</name>
  <files>
    supabase/migrations/00000000000025_notification_triggers.sql
  </files>
  <action>
Create trigger functions and triggers that call send-notification Edge Function via pg_net (async, non-blocking â€” per research anti-pattern: never block RPCs waiting for notification response).

Enable pg_net extension if not already: `CREATE EXTENSION IF NOT EXISTS pg_net WITH SCHEMA extensions;`

**Trigger function: notify_on_booking_change()**
A single AFTER INSERT OR UPDATE trigger function on bookings table that handles all booking notification scenarios:

- **New booking with status='confirmed' (instant booking)**: Send 'booking_confirmation' to passenger AND 'booking_request' to driver. Include ride origin/destination in body, ride_id in data for deep link.
- **New booking with status='pending' (request booking)**: Send 'booking_request' to driver only. Body: "[Passenger name] requested to join your ride from [origin] to [destination]".
- **Status changed to 'confirmed' (driver accepted)**: Send 'booking_confirmation' to passenger. Body: "Your booking on [origin] to [destination] has been confirmed!".
- **Status changed to 'rejected'**: Send 'booking_cancellation' to passenger. Body: "Your booking request was declined".
- **Status changed to 'cancelled'**:
  - If cancelled_by = passenger: notify driver ('booking_cancellation').
  - If cancelled_by = driver (or ride cancellation cascade): notify passenger ('booking_cancellation').

For each notification, use `extensions.net.http_post()` (note: extensions schema prefix per project convention) to call:
`https://xamctptqmpruhovhjcgm.supabase.co/functions/v1/send-notification`

The pg_net call sends JSON body with: user_id, type, title, body, data (ride_id, booking_id for deep links).

Include Authorization header with service_role key from current_setting('supabase.service_role_key') or a stored secret. If current_setting is not available, store the URL and key as a database secret or use supabase_functions.http_request helper.

To get passenger/driver names and ride details for notification body text, JOIN with profiles and rides tables within the trigger function.

**Trigger function: notify_on_new_message()**
AFTER INSERT trigger on chat_messages:
- Look up conversation to find the OTHER participant (not the sender).
- Send 'new_message' notification to the other participant.
- Title: "[Sender name]", Body: message content (truncated to 100 chars).
- Data: conversation_id for deep link to chat.
- Do NOT send notification if message_type = 'phone_share' content, just use "Shared their phone number" as body.

**Create triggers:**
```sql
CREATE TRIGGER on_booking_change
  AFTER INSERT OR UPDATE OF status ON public.bookings
  FOR EACH ROW
  EXECUTE FUNCTION notify_on_booking_change();

CREATE TRIGGER on_new_message
  AFTER INSERT ON public.chat_messages
  FOR EACH ROW
  EXECUTE FUNCTION notify_on_new_message();
```

Important: Trigger functions should be SECURITY DEFINER SET search_path = '' for consistency and to access tables without RLS interference.
  </action>
  <verify>Run `supabase db push` to apply migration. Verify triggers exist: `SELECT * FROM information_schema.triggers WHERE trigger_schema = 'public'`. Test by inserting a test booking and checking Edge Function logs for the notification call.</verify>
  <done>Database triggers fire on booking INSERT/UPDATE and chat_messages INSERT, calling send-notification Edge Function via pg_net with correct payloads for each notification type.</done>
</task>

<task type="auto">
  <name>Task 2: Ride reminder Edge Function and pg_cron job</name>
  <files>
    supabase/functions/send-ride-reminders/index.ts
    supabase/migrations/00000000000026_ride_reminder_cron.sql
  </files>
  <action>
**Create send-ride-reminders Edge Function:**
Cron-triggered function that finds rides departing soon and sends reminder notifications (NOTF-07).

Implementation:
- Import admin Supabase client from _shared/supabase-client.ts.
- Import sendPush from _shared/onesignal.ts and getNotificationPreferences, shouldSendPush from _shared/notifications.ts.
- Query rides WHERE status = 'upcoming' AND departure_time BETWEEN now() AND now() + interval '75 minutes' (slightly wider than 1 hour to handle 15-min cron intervals without missing rides).
- To prevent duplicate reminders: add a `reminder_sent` column to rides OR track in a separate table. Simpler approach: add `reminder_sent_at TIMESTAMPTZ` column to rides table in this migration. Filter: `AND reminder_sent_at IS NULL`.
- For each matching ride:
  1. Get driver_id and all confirmed passenger_ids (from bookings WHERE status='confirmed').
  2. For each user: check shouldSendPush for 'ride_reminder'.
  3. Send push notification: Title: "Ride Reminder", Body: "Your ride from [origin] to [destination] departs in about 1 hour".
  4. Mark ride as reminder_sent_at = now().
- Authenticate via Authorization header (service_role key, same as send-notification).
- Include CORS headers.
- Return JSON with count of reminders sent.

**Create migration 026:**
```sql
-- Add reminder tracking column
ALTER TABLE public.rides ADD COLUMN reminder_sent_at TIMESTAMPTZ;

-- Schedule ride reminder cron job (every 15 minutes)
SELECT cron.schedule(
  'ride-reminders',
  '*/15 * * * *',
  $$
    SELECT extensions.net.http_post(
      url := 'https://xamctptqmpruhovhjcgm.supabase.co/functions/v1/send-ride-reminders',
      headers := jsonb_build_object(
        'Content-Type', 'application/json',
        'Authorization', 'Bearer ' || current_setting('supabase.service_role_key')
      ),
      body := '{}'::jsonb
    );
  $$
);
```

Note: Follow the same pg_cron pattern used in migration 013 (ride expiry cron). Use extensions.net.http_post with the project URL.
  </action>
  <verify>Run `supabase db push` for migration. Deploy: `supabase functions deploy send-ride-reminders`. Verify cron job exists: `SELECT * FROM cron.job WHERE jobname = 'ride-reminders'`. Check that rides table has reminder_sent_at column.</verify>
  <done>Ride reminder Edge Function queries upcoming rides departing in ~1 hour and sends push notifications to driver and passengers. pg_cron job runs every 15 minutes. Duplicate reminders prevented via reminder_sent_at column. Preferences respected.</done>
</task>

</tasks>

<verification>
- All migrations apply successfully
- Booking notification triggers fire on INSERT and UPDATE (test with RPC calls)
- Chat message trigger fires on INSERT (test with send_chat_message RPC)
- send-ride-reminders Edge Function deploys and runs
- pg_cron job 'ride-reminders' is scheduled
- rides table has reminder_sent_at column
- Notification payloads include correct deep link data
</verification>

<success_criteria>
- NOTF-01: Push notification on booking request (to driver) and confirmation (to passenger)
- NOTF-02: Push notification on new chat message (to other participant)
- NOTF-04: Push notification on booking/ride cancellation (to affected party)
- NOTF-07: Ride reminder push notification ~1 hour before departure
- All triggers use pg_net for async, non-blocking dispatch
- Duplicate reminders prevented
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-04-SUMMARY.md`
</output>
