---
phase: 05-communication-notifications
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - apps/web/app/(app)/settings/notifications/page.tsx
  - apps/web/app/(app)/settings/page.tsx
  - apps/web/app/(app)/layout.tsx
  - supabase/functions/send-notification/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view and toggle notification preferences (push and email categories) from settings"
    - "Preference changes persist to notification_preferences table"
    - "Email notifications are sent for booking confirmations, ride reminders, and cancellations"
    - "Email notifications respect user's notification preferences"
    - "OneSignal initializes on web app load and links device to authenticated user"
  artifacts:
    - path: "apps/web/app/(app)/settings/notifications/page.tsx"
      provides: "Notification preferences UI with category toggles"
      min_lines: 40
    - path: "apps/web/app/(app)/settings/page.tsx"
      provides: "Updated settings page with working notification link"
      contains: "notifications"
  key_links:
    - from: "apps/web/app/(app)/settings/notifications/page.tsx"
      to: "packages/shared/src/queries/chat.ts"
      via: "upsertNotificationPreferences query"
      pattern: "upsertNotificationPreferences"
    - from: "apps/web/app/(app)/layout.tsx"
      to: "apps/web/lib/onesignal.ts"
      via: "OneSignal initialization on auth"
      pattern: "initOneSignal|loginOneSignal"
---

<objective>
Email notification support in send-notification, notification preferences UI in settings, and OneSignal web initialization on app load.

Purpose: Users can control which notifications they receive, email channel works for important events, and web push is fully initialized (NOTF-05, NOTF-06, NOTF-08, NOTF-09).
Output: Notification preferences page, email templates in send-notification, OneSignal init in app layout.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md
@.planning/phases/05-communication-notifications/05-01-SUMMARY.md
@.planning/phases/05-communication-notifications/05-02-SUMMARY.md

@apps/web/app/(app)/settings/page.tsx
@apps/web/app/(app)/layout.tsx
@apps/web/lib/onesignal.ts
@supabase/functions/send-notification/index.ts
@packages/shared/src/queries/chat.ts
@packages/shared/src/validation/notification.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification preferences page and settings integration</name>
  <files>
    apps/web/app/(app)/settings/notifications/page.tsx
    apps/web/app/(app)/settings/page.tsx
  </files>
  <action>
**Create settings/notifications/page.tsx (client component):**
Notification preferences management page (NOTF-06).

Layout with two sections:

**Push Notifications section:**
Toggle switches for each push category:
- "Booking requests" (push_booking_requests) — "Get notified when someone wants to join your ride"
- "Booking confirmations" (push_booking_confirmations) — "Get notified when your booking is confirmed"
- "Cancellations" (push_booking_cancellations) — "Get notified when a booking or ride is cancelled"
- "New messages" (push_new_messages) — "Get notified when you receive a chat message"
- "Ride reminders" (push_ride_reminders) — "Get reminded before your ride departs"
- "Route alerts" (push_route_alerts) — "Get notified when a new ride matches your saved route"

**Email Notifications section:**
Toggle switches for email categories:
- "Booking confirmations" (email_booking_confirmations)
- "Ride reminders" (email_ride_reminders)
- "Cancellations" (email_cancellations)

Implementation:
- On mount: fetch current preferences via getNotificationPreferences. If null (no row yet), show all toggles as ON (default).
- Each toggle change: optimistically update local state, then call upsertNotificationPreferences with the full preferences object.
- Use sonner toast for save confirmation/error.
- Back link to /settings.
- Style consistent with existing settings page (rounded cards, border-pastel, text-text-main/secondary).
- Toggle component: simple checkbox or custom toggle switch with pastel accent color.

**Update settings/page.tsx:**
- Change the "Notifications" item onClick from `alert(...)` to `router.push('/settings/notifications')`.
- Keep all other settings items unchanged.
  </action>
  <verify>Run `pnpm turbo build --filter=web`. Navigate to /settings -> click Notifications -> verify preferences page loads. Toggle a preference and verify it persists (refresh page, toggle should retain state).</verify>
  <done>Notification preferences page exists at /settings/notifications with toggle switches for all push and email categories. Preferences persist via upsert to notification_preferences table. Settings page links to notification preferences.</done>
</task>

<task type="auto">
  <name>Task 2: Email templates in send-notification and OneSignal web initialization</name>
  <files>
    supabase/functions/send-notification/index.ts
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
**Update send-notification Edge Function:**
Add email dispatch logic. Currently the function checks shouldSendEmail but needs email content generation.

Add email template generation for supported types:
- `booking_confirmation`: Subject "Booking Confirmed - [origin] to [destination]". HTML body with ride details (date, origin, destination, driver name), a "View Ride" link, and app branding.
- `ride_reminder`: Subject "Ride Reminder - Departing in 1 hour". HTML body with ride details and departure time.
- `booking_cancellation`: Subject "Booking Cancelled - [origin] to [destination]". HTML body explaining the cancellation.

Email templates: simple HTML strings with inline CSS (no template engine — per research recommendation). Include:
- App logo/name header.
- Main content with ride details.
- Action button (link to ride detail page).
- Footer with unsubscribe hint ("Manage preferences in app settings").

The send-notification function should:
1. Accept optional `ride_data` in payload: { origin_address, destination_address, departure_time, other_party_name }.
2. If email_html is provided in payload, use it directly (for custom emails).
3. If not provided but type is email-eligible, generate from template using ride_data.
4. Look up user's email via admin auth client (admin.auth.admin.getUserById).
5. Call sendEmail with generated content.

For the ride reminder flow: update send-ride-reminders to also include email dispatch by either:
- Calling send-notification with email_subject/email_html for each user, OR
- Generating email content in send-ride-reminders and calling sendEmail directly.
Choose option A (calling send-notification) for consistency — single dispatch point.

**Update app layout.tsx:**
Add OneSignal initialization on the web app:
- Import initOneSignal and loginOneSignal from lib/onesignal.ts.
- Create a small client component `<OneSignalInit />` that:
  1. Calls initOneSignal() on mount (useEffect).
  2. Listens for auth state changes (supabase.auth.onAuthStateChange).
  3. On SIGNED_IN: call loginOneSignal(user.id).
  4. On SIGNED_OUT: call logoutOneSignal().
- Include `<OneSignalInit />` in the authenticated layout.
- This links the web browser/device to the Supabase user in OneSignal's system via external_id (Pattern 4 from research).
- Wrap in dynamic import with ssr: false to avoid SSR issues with OneSignal SDK.
  </action>
  <verify>Run `pnpm turbo build --filter=web`. Verify OneSignalInit component renders without errors in browser console (will show "OneSignal app ID not configured" warning in dev if env var not set — this is expected). Verify send-notification Edge Function still deploys: `supabase functions deploy send-notification`.</verify>
  <done>send-notification Edge Function generates and sends email notifications for booking confirmations, ride reminders, and cancellations with HTML templates. OneSignal initializes on web app load and links authenticated users via external_id. Email preferences are respected.</done>
</task>

</tasks>

<verification>
- Notification preferences page accessible at /settings/notifications
- All toggle switches work and persist state
- Settings page "Notifications" link navigates correctly
- send-notification Edge Function generates email content for eligible types
- OneSignal initializes without errors in browser
- Web app builds successfully
</verification>

<success_criteria>
- NOTF-05: OneSignal initialized on web, device linked to user
- NOTF-06: User can toggle all notification categories on/off from settings
- NOTF-08: Email notifications generated for booking confirmation, ride reminder, cancellation
- NOTF-09: Email dispatch checks user preferences before sending
- Email templates are simple, branded HTML with ride details and action links
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-05-SUMMARY.md`
</output>
