---
phase: 05-communication-notifications
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/app/(app)/messages/page.tsx
  - apps/web/app/(app)/messages/[conversationId]/page.tsx
  - apps/web/app/(app)/messages/components/conversation-list.tsx
  - apps/web/app/(app)/messages/components/chat-view.tsx
  - apps/web/app/(app)/messages/components/message-bubble.tsx
  - apps/web/app/(app)/messages/components/chat-input.tsx
  - apps/web/app/(app)/messages/components/contact-share-button.tsx
  - apps/web/app/(app)/messages/components/typing-indicator.tsx
  - apps/web/app/(app)/components/unread-badge.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a list of their conversations with other party name, ride info, last message preview, and unread count"
    - "User can open a conversation and see message history with real-time new message delivery"
    - "User can type and send a message which persists in the database and appears instantly for both parties"
    - "User sees typing indicator when the other party is typing"
    - "Messages show read receipts (read_at timestamp) and mark as read when conversation is opened"
    - "User can share their phone number via a special phone_share message type"
    - "Messages tab in navigation shows total unread badge count"
    - "Chat is accessible from ride detail page for confirmed bookings"
  artifacts:
    - path: "apps/web/app/(app)/messages/page.tsx"
      provides: "Conversation list page (replaces placeholder)"
      min_lines: 20
    - path: "apps/web/app/(app)/messages/[conversationId]/page.tsx"
      provides: "Chat detail page with real-time messages"
      min_lines: 30
    - path: "apps/web/app/(app)/messages/components/chat-view.tsx"
      provides: "Chat UI with message list, input, typing indicator"
      min_lines: 50
    - path: "apps/web/app/(app)/messages/components/contact-share-button.tsx"
      provides: "Phone number sharing button in chat"
      contains: "phone_share"
  key_links:
    - from: "apps/web/app/(app)/messages/components/chat-view.tsx"
      to: "supabase realtime"
      via: "Postgres Changes subscription on chat_messages"
      pattern: "postgres_changes.*chat_messages"
    - from: "apps/web/app/(app)/messages/components/chat-view.tsx"
      to: "supabase broadcast"
      via: "Broadcast channel for typing indicators"
      pattern: "broadcast.*typing"
    - from: "apps/web/app/(app)/messages/components/chat-view.tsx"
      to: "packages/shared/src/queries/chat.ts"
      via: "getMessages query builder"
      pattern: "getMessages"
---

<objective>
Full chat UI for web: conversation list, real-time chat detail with typing indicators, read receipts, phone number sharing, and unread badge in navigation.

Purpose: Enables driver-passenger coordination after booking. This is the core communication feature (CHAT-01 through CHAT-04, SRCH-09 partial).
Output: Messages page with conversation list, chat detail with real-time updates, contact sharing, and nav badge.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-communication-notifications/05-RESEARCH.md
@.planning/phases/05-communication-notifications/05-01-SUMMARY.md

@apps/web/app/(app)/messages/page.tsx
@apps/web/app/(app)/app-nav.tsx
@apps/web/app/(app)/layout.tsx
@apps/web/app/(app)/rides/[id]/page.tsx
@packages/shared/src/queries/chat.ts
@packages/shared/src/validation/chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Conversation list page and chat components</name>
  <files>
    apps/web/app/(app)/messages/page.tsx
    apps/web/app/(app)/messages/[conversationId]/page.tsx
    apps/web/app/(app)/messages/components/conversation-list.tsx
    apps/web/app/(app)/messages/components/chat-view.tsx
    apps/web/app/(app)/messages/components/message-bubble.tsx
    apps/web/app/(app)/messages/components/chat-input.tsx
    apps/web/app/(app)/messages/components/typing-indicator.tsx
  </files>
  <action>
**Replace messages/page.tsx (currently placeholder):**
Server component that fetches conversations for the authenticated user using getConversationsForUser query builder. Passes data to ConversationList client component. Shows empty state if no conversations ("No messages yet — book a ride to start chatting").

**Create conversation-list.tsx (client component):**
- Renders list of conversations as clickable cards.
- Each card shows: other party's avatar + display_name, ride origin -> destination, last message preview (truncated to ~60 chars), unread count badge (if > 0), relative timestamp (date-fns formatDistanceToNow).
- Link to /messages/[conversationId].
- Subscribe to Postgres Changes on chat_messages to update last message and unread counts in real-time (subscribe at list level, filter by user's conversations).

**Create [conversationId]/page.tsx:**
Server component that:
1. Fetches conversation details (verify user is participant, get other party info, ride info).
2. Fetches initial messages via getMessages (last 50, newest first).
3. Calls mark_messages_read RPC to mark existing messages as read.
4. Passes data to ChatView client component.
Include back link to /messages.

**Create chat-view.tsx (client component):**
The main chat interface. This is the most complex component:
- Display messages in chronological order (oldest at top, newest at bottom).
- Auto-scroll to bottom on new messages.
- Subscribe to Postgres Changes on chat_messages filtered by conversation_id for real-time new messages (Pattern 1 from research).
- Also subscribe to UPDATE events on chat_messages for read receipt updates.
- Subscribe to Broadcast channel for typing indicators (Pattern 2 from research).
- Handle optimistic updates: generate message UUID client-side, add to local state immediately, then INSERT via send_chat_message RPC. Use message ID for deduplication when Realtime delivers the same message (Pitfall 6 from research).
- Load older messages on scroll-to-top (cursor pagination with getMessages before param).
- Mark incoming messages as read when conversation is open (call mark_messages_read on new message arrival if sender is other party).
- Clean up Realtime subscriptions on unmount (removeChannel pattern from Phase 4).

**Create message-bubble.tsx:**
- Display single message with content, timestamp (date-fns format).
- Sent messages (sender_id = current user) aligned right with primary color background.
- Received messages aligned left with surface/gray background.
- Show read receipt indicator on sent messages: single check = sent, double check = read (read_at not null).
- Special rendering for message_type = 'phone_share': display phone number in a styled card with a "Call" link (tel: href) and "Copy" button.

**Create chat-input.tsx:**
- Text input with send button. Disable send when empty.
- On typing: broadcast typing indicator via Broadcast channel (debounce 500ms, auto-clear after 3s of no typing).
- On submit: call parent's onSendMessage callback, clear input.
- Enter key sends (Shift+Enter for newline).

**Create typing-indicator.tsx:**
- Small animated indicator ("Other user is typing...") with bouncing dots.
- Shown when Broadcast delivers is_typing=true for the other user.
- Auto-hide after 3 seconds of no typing signal (timeout fallback).
  </action>
  <verify>Run `pnpm turbo build --filter=web` to verify build. Navigate to /messages — should show conversation list (empty for new users). If test data exists with confirmed bookings, verify conversation appears after calling get_or_create_conversation RPC.</verify>
  <done>Messages page shows conversation list with unread counts. Chat detail page shows real-time messages with optimistic updates. Typing indicators work via Broadcast. Read receipts display on sent messages. Phone share messages render as styled cards.</done>
</task>

<task type="auto">
  <name>Task 2: Contact sharing, unread badge, and ride detail chat link</name>
  <files>
    apps/web/app/(app)/messages/components/contact-share-button.tsx
    apps/web/app/(app)/components/unread-badge.tsx
    apps/web/app/(app)/app-nav.tsx
    apps/web/app/(app)/rides/[id]/page.tsx
  </files>
  <action>
**Create contact-share-button.tsx:**
- Button that appears in the chat header (or as a chat action).
- On click: fetches current user's phone number from their profile.
- If phone number exists: sends a phone_share message via send_chat_message RPC with the phone number as content and message_type='phone_share'.
- If no phone number: show toast (sonner) saying "Add your phone number in Profile settings first".
- Only show button if booking is confirmed (not for cancelled/completed rides where chat is read-only).

**Create unread-badge.tsx (client component):**
- Subscribes to get_unread_count RPC on mount.
- Subscribes to Postgres Changes on chat_messages table (any INSERT where sender_id != current user) to update count in real-time.
- Renders a small red badge with count (or nothing if 0).
- Exposed as `<UnreadBadge />` component.

**Update app-nav.tsx:**
- Import UnreadBadge component.
- Add `<UnreadBadge />` next to the "Messages" tab label in both desktop sidebar and mobile bottom nav.
- The badge should be positioned as a small superscript number (like iOS notification badges).

**Update rides/[id]/page.tsx:**
- After the booking section, if user has a confirmed booking on this ride, show a "Message [driver/passenger name]" button/link.
- On click: call get_or_create_conversation RPC with the booking_id, then navigate to /messages/[conversationId].
- This makes chat accessible from ride history (CHAT-04) and the ride detail page.
- Only show for confirmed bookings (not pending, cancelled, or completed).
  </action>
  <verify>Run `pnpm turbo build --filter=web`. Verify: (1) Unread badge appears in nav when messages exist, (2) ride detail shows "Message" button for confirmed bookings, (3) contact share button sends phone_share message type.</verify>
  <done>Contact sharing via phone_share message works in chat. Unread badge shows in Messages nav tab with real-time updates. Ride detail page has "Message" link for confirmed bookings that creates/opens conversation.</done>
</task>

</tasks>

<verification>
- Web app builds without errors
- Messages page replaces placeholder with functional conversation list
- Chat detail shows real-time messages with Postgres Changes subscription
- Typing indicators work via Broadcast (test with two browser tabs)
- Read receipts update when recipient opens conversation
- Phone share message renders as styled card with call/copy actions
- Unread badge in nav updates in real-time
- Ride detail page links to chat for confirmed bookings
</verification>

<success_criteria>
- CHAT-01: Driver and passenger can chat 1:1 after booking confirmation
- CHAT-02: Typing indicators and read receipts functional
- CHAT-03: Phone number sharing via phone_share message type
- CHAT-04: Messages accessible from ride detail page
- Unread badge count in navigation with real-time updates
- Optimistic message sending with deduplication
- Cursor-based pagination for older messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-communication-notifications/05-03-SUMMARY.md`
</output>
