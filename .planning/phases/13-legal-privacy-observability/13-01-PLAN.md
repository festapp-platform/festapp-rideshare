---
phase: 13-legal-privacy-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260217000013_legal_observability.sql
  - supabase/functions/send-sms/index.ts
  - supabase/functions/send-email/index.ts
autonomous: true
requirements:
  - LOG-01
  - LOG-02
  - LOG-03
  - ADMIN-07

must_haves:
  truths:
    - "Every SMS sent via the send-sms auth hook is logged to the log_sms table with recipient_phone, type, and status"
    - "Every email sent via the send-email auth hook is logged to the log_emails table with recipient_email, type, and status"
    - "audit.record_version table has changed_fields JSONB column that stores only the diff of changed fields on UPDATE"
    - "audit.record_version table has actor_id UUID column populated from auth.uid() when available"
    - "Moderation tables (reports, user_blocks) have audit triggers"
    - "log_emails.user_id column is nullable to allow auth email logging for signup confirmations"
  artifacts:
    - path: "supabase/migrations/20260217000013_legal_observability.sql"
      provides: "Audit enhancement (changed_fields, actor_id), log_emails nullable fix, moderation triggers"
      contains: "changed_fields"
    - path: "supabase/functions/send-sms/index.ts"
      provides: "SMS logging to log_sms after SNS send"
      contains: "log_sms"
    - path: "supabase/functions/send-email/index.ts"
      provides: "Auth email logging to log_emails after SES send"
      contains: "log_emails"
  key_links:
    - from: "supabase/functions/send-sms/index.ts"
      to: "log_sms table"
      via: "REST API POST after sendSNS()"
      pattern: "rest/v1/log_sms"
    - from: "supabase/functions/send-email/index.ts"
      to: "log_emails table"
      via: "REST API POST after sendEmail()"
      pattern: "rest/v1/log_emails"
---

<objective>
Add communication logging to auth hooks and enhance the audit trail with JSON diffs.

Purpose: Complete observability for all outbound communications (email, SMS) and provide meaningful audit trail entries that show exactly what changed (not just full row snapshots).

Output:
- Migration adding changed_fields/actor_id to audit.record_version, making log_emails.user_id nullable, adding moderation audit triggers
- SMS logging in send-sms Edge Function
- Auth email logging in send-email Edge Function
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-legal-privacy-observability/13-RESEARCH.md
@supabase/migrations/00000000000010_audit.sql
@supabase/migrations/00000000000005_notifications.sql
@supabase/functions/send-sms/index.ts
@supabase/functions/send-email/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration for audit enhancement and logging fixes</name>
  <files>supabase/migrations/20260217000013_legal_observability.sql</files>
  <action>
Create a new migration file that does the following:

1. **Make log_emails.user_id nullable** (currently NOT NULL, which blocks auth email logging for signup confirmations where no profile row exists yet):
```sql
ALTER TABLE public.log_emails ALTER COLUMN user_id DROP NOT NULL;
```

2. **Add changed_fields and actor_id columns to audit.record_version:**
```sql
ALTER TABLE audit.record_version ADD COLUMN changed_fields JSONB;
ALTER TABLE audit.record_version ADD COLUMN actor_id UUID;
```

3. **Replace the audit trigger function** (`audit.fn_record_version`) with the enhanced version from the research that:
   - Captures `auth.uid()` into `actor_id` (wrapped in BEGIN/EXCEPTION for service_role operations where auth.uid() is unavailable)
   - On UPDATE: computes a `changed_fields` JSONB containing only fields that actually changed (each key maps to `{"old": ..., "new": ...}`)
   - Skips `updated_at` from the diff computation (noise field)
   - On INSERT: stores actor_id alongside record
   - On DELETE: stores actor_id alongside old_record
   Use `CREATE OR REPLACE FUNCTION audit.fn_record_version()` so existing triggers automatically use the new version.

4. **Add audit triggers for moderation tables** (reports and user_blocks):
```sql
CREATE TRIGGER trg_audit_reports
  AFTER INSERT OR UPDATE OR DELETE ON public.reports
  FOR EACH ROW EXECUTE FUNCTION audit.fn_record_version();

CREATE TRIGGER trg_audit_user_blocks
  AFTER INSERT OR UPDATE OR DELETE ON public.user_blocks
  FOR EACH ROW EXECUTE FUNCTION audit.fn_record_version();
```

5. **Add RLS policies for admin access to moderation audit entries:**
```sql
CREATE POLICY "audit_admin_all"
  ON audit.record_version FOR SELECT TO authenticated
  USING (
    EXISTS (SELECT 1 FROM public.profiles WHERE id = (SELECT auth.uid()) AND is_admin = true)
  );
```

The full trigger function is provided in 13-RESEARCH.md Pattern 3. Use it exactly as specified there, including the `SECURITY DEFINER SET search_path = ''` and the `v_changed` loop computation.
  </action>
  <verify>
Run `supabase db reset` or review the migration SQL for syntax correctness. Verify:
- `\d audit.record_version` shows changed_fields JSONB and actor_id UUID columns
- `\df audit.fn_record_version` shows the updated function
- `SELECT tgname FROM pg_trigger WHERE tgname LIKE 'trg_audit_%'` includes reports and user_blocks
  </verify>
  <done>
- audit.record_version has changed_fields and actor_id columns
- Enhanced trigger function computes JSON diffs on UPDATE
- log_emails.user_id is nullable
- reports and user_blocks tables have audit triggers
- Admin RLS policy allows admins to see all audit entries
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SMS and auth email logging to Edge Functions</name>
  <files>supabase/functions/send-sms/index.ts, supabase/functions/send-email/index.ts</files>
  <action>
**send-sms/index.ts** -- Add SMS logging after the `sendSNS()` call succeeds (before the test OTP store block). Use the same raw `fetch()` pattern already used for `_test_otp_codes` insertion (do NOT import Supabase client SDK). Insert into `log_sms` table:
```typescript
// After sendSNS() call, before test OTP store
try {
  const sbUrl = Deno.env.get("SUPABASE_URL") ?? "";
  const sbKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
  if (sbUrl && sbKey) {
    await fetch(`${sbUrl}/rest/v1/log_sms`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: sbKey,
        Authorization: `Bearer ${sbKey}`,
        Prefer: "return=minimal",
      },
      body: JSON.stringify({
        recipient_phone: user.phone,
        type: "otp",
        status: "sent",
      }),
    });
  }
} catch { /* best-effort, don't fail SMS delivery */ }
```
Place this block immediately after `await sendSNS(...)` and before the existing test OTP code block.

**send-email/index.ts** -- Add auth email logging after the `sendEmail()` call. Use raw `fetch()` (same pattern). Insert into `log_emails` table:
```typescript
// After sendEmail() call, log to log_emails (best-effort)
try {
  const sbUrl = Deno.env.get("SUPABASE_URL") ?? "";
  const sbKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
  if (sbUrl && sbKey) {
    await fetch(`${sbUrl}/rest/v1/log_emails`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        apikey: sbKey,
        Authorization: `Bearer ${sbKey}`,
        Prefer: "return=minimal",
      },
      body: JSON.stringify({
        user_id: user?.id ?? null,
        type: `auth_${actionType}`,
        recipient_email: recipientEmail,
        status: sent ? "sent" : "failed",
      }),
    });
  }
} catch { /* best-effort logging */ }
```
Place this block after the `const sent = await sendEmail(...)` call and the error logging, but before the final `return new Response(...)`.

IMPORTANT: Both logging blocks must be best-effort (wrapped in try/catch with empty catch). The auth hook must NEVER fail because of logging. Use `user?.id ?? null` for email logging since user_id is now nullable. Do NOT add any new imports to either file.
  </action>
  <verify>
Read both files and verify:
1. `send-sms/index.ts` has a `log_sms` POST fetch block after `sendSNS()` and before the test OTP block
2. `send-email/index.ts` has a `log_emails` POST fetch block after `sendEmail()`
3. Both blocks use try/catch with empty catch
4. No new imports added to either file
  </verify>
  <done>
- send-sms logs every SMS to log_sms table with recipient_phone, type="otp", status="sent"
- send-email logs every auth email to log_emails table with user_id, type="auth_{actionType}", recipient_email, status
- Both are best-effort (non-blocking, non-failing)
- LOG-01, LOG-02 requirements satisfied (LOG-03 was already done)
  </done>
</task>

</tasks>

<verification>
1. Migration SQL is syntactically valid and can be applied with `supabase db reset`
2. `send-sms/index.ts` contains `log_sms` REST API call
3. `send-email/index.ts` contains `log_emails` REST API call
4. Neither Edge Function has new imports (stays lightweight)
5. Audit trigger function includes changed_fields computation and actor_id capture
</verification>

<success_criteria>
- All outbound emails (auth) logged to log_emails with type, recipient, status
- All outbound SMS logged to log_sms with type, recipient, status
- Push notifications already logged (LOG-03 pre-existing)
- Audit trail captures JSON diff of changed fields and actor identity
- Moderation actions (reports, blocks) are audited
</success_criteria>

<output>
After completion, create `.planning/phases/13-legal-privacy-observability/13-01-SUMMARY.md`
</output>
