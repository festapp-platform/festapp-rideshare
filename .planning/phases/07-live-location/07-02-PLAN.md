---
phase: 07-live-location
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/web/app/(app)/components/live-location-map.tsx
  - apps/web/app/(app)/components/ride-detail.tsx
  - apps/web/app/(app)/rides/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Driver sees a 'Share My Location' button on upcoming rides they own (after departure time)"
    - "Clicking 'Share My Location' calls start_ride RPC and begins GPS tracking via useLiveLocation"
    - "Passenger with confirmed booking sees driver's real-time position as a moving marker on a map"
    - "Driver position marker animates smoothly between updates (CSS transition on transform)"
  artifacts:
    - path: "apps/web/app/(app)/components/live-location-map.tsx"
      provides: "Map with animated driver marker"
      contains: "LiveLocationMap"
    - path: "apps/web/app/(app)/components/ride-detail.tsx"
      provides: "Share location button and live map integration"
      contains: "useLiveLocation"
  key_links:
    - from: "apps/web/app/(app)/components/ride-detail.tsx"
      to: "apps/web/app/(app)/hooks/use-live-location.ts"
      via: "useLiveLocation hook"
      pattern: "useLiveLocation"
    - from: "apps/web/app/(app)/components/live-location-map.tsx"
      to: "driverPosition"
      via: "prop from useLiveLocation"
      pattern: "driverPosition"
---

<objective>
Build the driver activation UI and passenger-facing live location map. Driver can activate location sharing from the ride detail page; passenger sees a real-time map with the driver's moving marker.

Purpose: Delivers the visible user-facing feature -- driver shares location, passenger tracks on map.
Output: LiveLocationMap component, ride-detail integration with share/stop buttons
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-live-location/07-01-SUMMARY.md

# Existing ride detail component
@apps/web/app/(app)/components/ride-detail.tsx
# Existing ride map (AdvancedMarkerElement pattern)
@apps/web/app/(app)/components/ride-map.tsx
# Ride detail server page
@apps/web/app/(app)/rides/[id]/page.tsx
# Route map abstraction (Google vs Mapy)
@apps/web/app/(app)/components/route-map.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LiveLocationMap component with animated driver marker</name>
  <files>
    apps/web/app/(app)/components/live-location-map.tsx
  </files>
  <action>
Create `apps/web/app/(app)/components/live-location-map.tsx` -- a Google Map that shows the pickup area with a smoothly-animated driver marker.

Props:
```typescript
interface LiveLocationMapProps {
  pickupLat: number;      // ride origin
  pickupLng: number;      // ride origin
  driverPosition: LocationPayload | null;
  isDriver: boolean;      // changes label text
}
```

Implementation:
1. Use `Map` and `useMap` from `@vis.gl/react-google-maps` (same as ride-map.tsx pattern)
2. Show a pickup point marker (green dot, same style as ride-map.tsx origin marker)
3. Show a driver marker (blue pulsing dot) at driverPosition coordinates
   - Use `AdvancedMarkerElement` (same pattern as ride-map.tsx)
   - Driver marker: 18px blue circle with white border and a CSS pulse animation (keyframe via inline style)
   - When driverPosition updates, use `marker.position = { lat, lng }` -- the AdvancedMarkerElement handles smooth repositioning
4. Auto-fit bounds to include both pickup point and driver position (when driver position exists)
5. If no driverPosition yet, center on pickup location with zoom 15
6. Show a small info banner:
   - Driver view: "Sharing your location with passengers" (with a pulsing green dot)
   - Passenger view: "Driver is on the way" or "Waiting for driver's location..." if no position yet
7. Map height: 250px on mobile, 350px on desktop (responsive via Tailwind)
8. Mark as `"use client"`.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- component compiles cleanly.
    Verify AdvancedMarkerElement usage matches ride-map.tsx pattern.
  </verify>
  <done>LiveLocationMap renders pickup marker, animated driver marker, and info banner; responsive height; uses established Google Maps patterns</done>
</task>

<task type="auto">
  <name>Task 2: Integrate live location into ride detail page</name>
  <files>
    apps/web/app/(app)/components/ride-detail.tsx
    apps/web/app/(app)/rides/[id]/page.tsx
  </files>
  <action>
Integrate useLiveLocation hook and LiveLocationMap into the ride detail page.

**In ride-detail.tsx:**

1. Import `useLiveLocation` from `@/app/(app)/hooks/use-live-location` and `LiveLocationMap` from `./live-location-map`
2. Import `RIDE_STATUS` from `@festapp/shared`
3. Call the hook:
   ```typescript
   const { driverPosition, isSharing, error: locationError, stopSharing } = useLiveLocation({
     rideId: ride.id,
     isDriver: isOwner,
     enabled: liveLocationEnabled,
   });
   ```
   Where `liveLocationEnabled` is a local state, initially false.

4. Add a "Share My Location" section in the ride detail, shown when:
   - `isOwner` is true (driver only)
   - `ride.status === 'upcoming'` or `ride.status === 'in_progress'`
   - Departure time has passed (same gate pattern as complete ride button)

   The button:
   - If not sharing: "Share My Location" button (blue, with map-pin icon)
     - On click: call `supabase.rpc('start_ride', { p_ride_id: ride.id, p_driver_id: currentUserId })` then set `liveLocationEnabled = true` and update local ride status to 'in_progress'
     - If ride is already in_progress, just set `liveLocationEnabled = true` (skip RPC)
   - If sharing: "Stop Sharing" button (red/outline)
     - On click: call `stopSharing()`

5. Show LiveLocationMap when:
   - Driver is sharing (`isOwner && isSharing`), OR
   - Passenger has confirmed booking and ride is in_progress and driverPosition exists
   Replace the existing route map with LiveLocationMap in these scenarios (show route map otherwise)

6. For passenger view: check if `ride.status === 'in_progress'` and `currentUserBooking?.status === 'confirmed'` -- if so, enable the hook (set enabled=true) so they subscribe to Broadcast.

7. Show `locationError` as a toast if it occurs.

**In rides/[id]/page.tsx:**
- No changes needed -- ride status already passed, currentUserBooking already passed. The client component handles everything.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- passes.
    Verify ride-detail.tsx imports useLiveLocation and LiveLocationMap.
    Verify the "Share My Location" button is gated behind departure time and ownership.
  </verify>
  <done>Driver can tap "Share My Location" to start GPS sharing via Broadcast; passengers with confirmed bookings see live driver marker on map; sharing can be stopped manually</done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes
2. LiveLocationMap component exists and uses AdvancedMarkerElement
3. ride-detail.tsx has Share/Stop button with departure time gate
4. Passenger view shows live map when ride is in_progress
5. Driver position updates flow: GPS -> Broadcast -> LiveLocationMap marker
</verification>

<success_criteria>
- Driver can activate location sharing on their upcoming ride (after departure time)
- Activation transitions ride to in_progress via start_ride RPC
- Passenger sees driver's position on a map with pickup marker
- Driver can manually stop sharing
- Map shows smooth driver marker movement
</success_criteria>

<output>
After completion, create `.planning/phases/07-live-location/07-02-SUMMARY.md`
</output>
