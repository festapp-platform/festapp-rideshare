---
phase: 07-live-location
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - apps/web/app/(app)/hooks/use-live-location.ts
  - apps/web/app/(app)/components/ride-detail.tsx
  - packages/shared/src/constants/location.ts
  - apps/web/__tests__/hooks/use-live-location.test.ts
  - apps/web/__tests__/components/live-location-map.test.tsx
autonomous: true

must_haves:
  truths:
    - "GPS switches to high-frequency updates when driver is within 500m of pickup"
    - "GPS uses low-frequency updates when driver is far from pickup (battery efficient)"
    - "Location sharing automatically stops when ride is completed"
    - "Location sharing automatically stops when driver navigates away from ride detail"
    - "Unit tests verify adaptive GPS distance calculation and auto-stop logic"
  artifacts:
    - path: "apps/web/app/(app)/hooks/use-live-location.ts"
      provides: "Adaptive GPS with distance-based frequency switching"
      contains: "getDistanceMeters"
    - path: "apps/web/__tests__/hooks/use-live-location.test.ts"
      provides: "Unit tests for location hook"
      contains: "describe.*useLiveLocation"
    - path: "apps/web/__tests__/components/live-location-map.test.tsx"
      provides: "Integration tests for live location map"
      contains: "describe.*LiveLocationMap"
  key_links:
    - from: "apps/web/app/(app)/hooks/use-live-location.ts"
      to: "packages/shared/src/constants/location.ts"
      via: "GPS_CONFIG import"
      pattern: "GPS_CONFIG"
    - from: "apps/web/app/(app)/components/ride-detail.tsx"
      to: "complete_ride"
      via: "auto-stop on completion"
      pattern: "stopSharing"
---

<objective>
Add adaptive GPS frequency (battery optimization), auto-stop logic for location sharing, and comprehensive unit/integration tests covering the live location feature.

Purpose: Makes location sharing battery-efficient and ensures it stops automatically when no longer needed. Tests validate all Phase 7 behavior.
Output: Enhanced hook with adaptive GPS, auto-stop on ride completion, test suite
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-live-location/07-01-SUMMARY.md
@.planning/phases/07-live-location/07-02-SUMMARY.md

# Hook to enhance
@apps/web/app/(app)/hooks/use-live-location.ts
# Ride detail for auto-stop integration
@apps/web/app/(app)/components/ride-detail.tsx
# GPS config constants
@packages/shared/src/constants/location.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement adaptive GPS and auto-stop logic</name>
  <files>
    apps/web/app/(app)/hooks/use-live-location.ts
    apps/web/app/(app)/components/ride-detail.tsx
    packages/shared/src/constants/location.ts
  </files>
  <action>
**Enhance useLiveLocation hook with adaptive GPS:**

1. Add a `pickupLocation: { lat: number; lng: number } | null` param to the hook interface. This is the ride origin -- used to calculate distance for adaptive switching.

2. Add a pure helper function (exported for testing):
   ```typescript
   /** Haversine distance between two points in meters */
   export function getDistanceMeters(
     lat1: number, lng1: number,
     lat2: number, lng2: number
   ): number
   ```

3. Implement adaptive GPS switching in the watchPosition callback:
   - After each position update, calculate distance from current position to pickupLocation
   - If distance <= GPS_CONFIG.HIGH_ACCURACY_DISTANCE (500m): switch to near mode
   - If distance > GPS_CONFIG.HIGH_ACCURACY_DISTANCE: stay in far mode
   - "Switch" means: clear current watchPosition and restart with new options:
     - Far mode: `{ enableHighAccuracy: false, maximumAge: GPS_CONFIG.MAX_AGE_MS, timeout: GPS_CONFIG.TIMEOUT_MS }` + broadcast throttled to `GPS_CONFIG.FAR_INTERVAL_MS`
     - Near mode: `{ enableHighAccuracy: true, maximumAge: 0, timeout: GPS_CONFIG.TIMEOUT_MS }` + broadcast throttled to `GPS_CONFIG.NEAR_INTERVAL_MS`
   - Use a ref to track current mode ('far' | 'near') to avoid unnecessary restarts
   - Use a `lastBroadcastRef` timestamp to throttle broadcasts (don't broadcast more frequently than the interval)

4. Add distance filter: only broadcast if position moved more than DISTANCE_FILTER_FAR/DISTANCE_FILTER_NEAR meters since last broadcast (use getDistanceMeters to compare with lastBroadcastPosition ref).

**Auto-stop logic in ride-detail.tsx:**

5. Add a Postgres Changes subscription in ride-detail.tsx (or inside useLiveLocation) that listens for ride status changes:
   - When `ride.status` changes to 'completed' or 'cancelled', automatically call `stopSharing()`
   - This handles the case where another tab/device completes the ride

6. In the complete_ride handler in ride-detail.tsx, call `stopSharing()` after successful completion.

7. Hook cleanup already handles unmount (navigating away) -- verify watchPosition is cleared via the existing cleanup return.

**Update pickupLocation prop threading:**
8. In ride-detail.tsx, pass `pickupLocation: { lat: originLat, lng: originLng }` (already available as props) to useLiveLocation. Update the hook call accordingly.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- passes.
    Verify getDistanceMeters is exported from the hook file.
    Verify adaptive mode switching code exists (search for HIGH_ACCURACY_DISTANCE).
    Verify stopSharing is called in complete_ride handler.
  </verify>
  <done>GPS frequency adapts based on distance to pickup; location sharing auto-stops on ride completion/cancellation/unmount; distance filter prevents redundant broadcasts</done>
</task>

<task type="auto">
  <name>Task 2: Create unit and integration tests for live location</name>
  <files>
    apps/web/__tests__/hooks/use-live-location.test.ts
    apps/web/__tests__/components/live-location-map.test.tsx
  </files>
  <action>
Create test files using Vitest (already configured in the project per Phase 1 CI setup).

**Unit tests in `apps/web/__tests__/hooks/use-live-location.test.ts`:**

1. Test `getDistanceMeters`:
   - Same point returns 0
   - Known distance: Prague (50.08, 14.43) to Brno (49.19, 16.61) is ~185 km (allow 5% tolerance)
   - Short distance: two points 100m apart returns ~100 (allow 10% tolerance)

2. Test adaptive GPS constants:
   - GPS_CONFIG.HIGH_ACCURACY_DISTANCE is 500
   - GPS_CONFIG.FAR_INTERVAL_MS > GPS_CONFIG.NEAR_INTERVAL_MS
   - GPS_CONFIG.DISTANCE_FILTER_FAR > GPS_CONFIG.DISTANCE_FILTER_NEAR

3. Test channel naming:
   - LOCATION_CHANNEL_PREFIX + rideId produces expected channel name
   - LOCATION_BROADCAST_EVENT and LOCATION_STOPPED_EVENT are non-empty strings

4. Test LocationPayload type shape (compile-time test):
   - Valid payload accepted
   - Missing required fields rejected (ts-expect-error comments)

**Integration tests in `apps/web/__tests__/components/live-location-map.test.tsx`:**

5. Test LiveLocationMap component rendering:
   - Mock `@vis.gl/react-google-maps` Map and useMap (return null map -- just verify component renders without crash)
   - With driverPosition=null and isDriver=false: renders "Waiting for driver's location..." text
   - With driverPosition=null and isDriver=true: does not show waiting text
   - With driverPosition provided: verify the info text changes to "Driver is on the way" (for passenger)
   - With isDriver=true and driverPosition: shows "Sharing your location with passengers"

Use `@testing-library/react` for rendering tests. Mock Google Maps API globals if needed (or mock the entire @vis.gl/react-google-maps module). Follow the testing patterns from Phase 1 (check if __tests__ directory exists and if vitest.config exists).
  </action>
  <verify>
    Run `cd /Users/miakh/source/festapp-rideshare/apps/web && pnpm vitest run __tests__/hooks/use-live-location.test.ts __tests__/components/live-location-map.test.tsx` -- all tests pass.
    If vitest is not set up, run `pnpm test` or check package.json for test command.
  </verify>
  <done>Unit tests validate getDistanceMeters accuracy, GPS constants, and channel naming; integration tests verify LiveLocationMap rendering states; all tests pass</done>
</task>

</tasks>

<verification>
1. `pnpm turbo typecheck` passes
2. Tests pass: `pnpm vitest run` in apps/web
3. getDistanceMeters exported and tested with known distances
4. Adaptive mode uses GPS_CONFIG thresholds (HIGH_ACCURACY_DISTANCE = 500m)
5. stopSharing called on ride completion in ride-detail.tsx
6. Distance filter prevents broadcasts when position hasn't changed enough
7. Hook cleanup clears watchPosition on unmount
</verification>

<success_criteria>
- GPS frequency adapts: 10s updates when far, 3s when within 500m of pickup
- Distance filter: no broadcast if moved less than 50m (far) / 10m (near)
- Auto-stop on: ride completed, ride cancelled, component unmount
- Unit tests for Haversine distance calculation pass
- Integration tests for LiveLocationMap rendering states pass
- All typecheck passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-live-location/07-03-SUMMARY.md`
</output>
