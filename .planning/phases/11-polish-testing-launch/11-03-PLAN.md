---
phase: 11-polish-testing-launch
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/lib/sentry.ts
  - apps/web/app/layout.tsx
  - apps/web/lib/analytics.ts
  - apps/web/components/cookie-consent.tsx
  - apps/web/app/(app)/settings/data-export/page.tsx
  - apps/web/lib/force-update.ts
  - apps/web/components/force-update-banner.tsx
  - apps/web/app/(app)/layout.tsx
  - apps/web/__tests__/gdpr-analytics.test.ts
autonomous: true
user_setup:
  - service: sentry
    why: "Crash reporting and error monitoring in production"
    env_vars:
      - name: NEXT_PUBLIC_SENTRY_DSN
        source: "Sentry Dashboard -> Settings -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create a Next.js project in Sentry"
        location: "Sentry Dashboard -> Projects -> Create Project -> Next.js"

must_haves:
  truths:
    - "Unhandled errors are captured and reported to Sentry"
    - "Anonymous page view analytics are tracked when user consents"
    - "Cookie consent banner appears on first visit and preference is saved"
    - "User can export their personal data from settings (GDPR)"
    - "Force-update banner appears when a critical update is available"
  artifacts:
    - path: "apps/web/lib/sentry.ts"
      provides: "Sentry initialization and error capture helpers"
      contains: "initSentry"
    - path: "apps/web/lib/analytics.ts"
      provides: "Anonymous analytics tracking"
      contains: "trackPageView"
    - path: "apps/web/components/cookie-consent.tsx"
      provides: "GDPR cookie consent banner"
      contains: "CookieConsent"
    - path: "apps/web/app/(app)/settings/data-export/page.tsx"
      provides: "GDPR data export page"
    - path: "apps/web/components/force-update-banner.tsx"
      provides: "Force update prompt banner"
      contains: "ForceUpdateBanner"
    - path: "apps/web/__tests__/gdpr-analytics.test.ts"
      provides: "Tests for GDPR and analytics"
  key_links:
    - from: "apps/web/app/layout.tsx"
      to: "apps/web/components/cookie-consent.tsx"
      via: "CookieConsent rendered in root layout"
      pattern: "CookieConsent"
    - from: "apps/web/app/(app)/layout.tsx"
      to: "apps/web/components/force-update-banner.tsx"
      via: "ForceUpdateBanner in app layout"
      pattern: "ForceUpdateBanner"
---

<objective>
Add crash reporting (Sentry), anonymous analytics, GDPR compliance (cookie consent + data export), and force-update mechanism.

Purpose: PLAT-12 (crash reporting), PLAT-13 (analytics), PLAT-06 (GDPR), and PLAT-14 (force update) are operational requirements for production readiness. This plan implements lightweight versions of each — no heavy analytics SDK, just custom event tracking gated by consent.

Output: Sentry integration, analytics helpers, cookie consent banner, data export page, force-update banner, unit tests.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/layout.tsx
@apps/web/app/(app)/layout.tsx
@apps/web/app/(app)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sentry crash reporting, analytics, cookie consent, and force-update infrastructure</name>
  <files>
    apps/web/lib/sentry.ts
    apps/web/lib/analytics.ts
    apps/web/components/cookie-consent.tsx
    apps/web/lib/force-update.ts
    apps/web/components/force-update-banner.tsx
    apps/web/app/layout.tsx
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
1. Create `apps/web/lib/sentry.ts`:
   - Export `initSentry()`: initializes Sentry with NEXT_PUBLIC_SENTRY_DSN env var
   - Use `@sentry/browser` (lightweight, no Next.js plugin needed for basic error capture)
   - If DSN is not set, log a warning and return (no-op in development)
   - Export `captureError(error: Error, context?: Record<string, unknown>)` helper
   - Export `setUser(userId: string | null)` to associate errors with users (anonymized)
   - Install @sentry/browser: add to package.json dependencies

2. Create `apps/web/lib/analytics.ts`:
   - Lightweight custom analytics — NO third-party SDK
   - Export `ANALYTICS_CONSENT_KEY = 'festapp-analytics-consent'`
   - Export `hasAnalyticsConsent(): boolean` — reads from localStorage
   - Export `setAnalyticsConsent(value: boolean)` — writes to localStorage
   - Export `trackPageView(path: string)` — only fires if consent given, sends to `/api/analytics` endpoint (just a placeholder POST, can be connected to any backend later)
   - Export `trackEvent(name: string, data?: Record<string, unknown>)` — same consent gate
   - All tracking is anonymous: no PII, no user IDs, just page paths and event names
   - If consent is not given, functions are no-ops

3. Create `apps/web/components/cookie-consent.tsx`:
   - "use client" directive
   - Shows a fixed bottom banner on first visit (check localStorage for consent key)
   - Text: "We use cookies for analytics to improve your experience. No personal data is collected."
   - Two buttons: "Accept" (sets consent to true, hides banner) and "Decline" (sets consent to false, hides banner)
   - Compact design: bg-surface, rounded-t-2xl, shadow-lg, z-40, fixed bottom-0
   - Uses setAnalyticsConsent from analytics.ts
   - If consent already set (either true or false), don't show the banner

4. Create `apps/web/lib/force-update.ts`:
   - Export `APP_VERSION = '1.0.0'` (current app version)
   - Export `FORCE_UPDATE_KEY = 'festapp-force-update-dismissed'`
   - Export `checkForUpdate(): Promise<{ updateAvailable: boolean; minVersion: string } | null>`
   - This checks a static JSON file at `/api/version` or `/version.json` — for now, create a simple approach:
     - Read from `public/version.json` with `{ minVersion: "1.0.0", latestVersion: "1.0.0", updateUrl: "/" }`
     - Compare APP_VERSION against minVersion using simple semver comparison
   - Export `shouldShowUpdateBanner(): boolean` — true if update available and not dismissed
   - Export `dismissUpdateBanner()` — stores dismissal in sessionStorage (shows again next session)

5. Create `apps/web/components/force-update-banner.tsx`:
   - "use client" directive
   - On mount, calls checkForUpdate()
   - If update available and not dismissed, shows a banner at top of app content
   - Text: "A new version is available. Please refresh to update."
   - "Refresh" button (calls window.location.reload()) and "Dismiss" button
   - Uses warning color scheme, rounded-xl

6. Update `apps/web/app/layout.tsx`:
   - Import CookieConsent
   - Add `<CookieConsent />` after PwaInstallPrompt
   - Import and call initSentry() in a client-side effect (or add a SentryInit client component that runs initSentry on mount)

7. Update `apps/web/app/(app)/layout.tsx`:
   - Import ForceUpdateBanner
   - Add `<ForceUpdateBanner />` at top of content area

8. Create `apps/web/public/version.json`:
   - `{ "minVersion": "1.0.0", "latestVersion": "1.0.0", "updateUrl": "/" }`
  </action>
  <verify>
   - `pnpm --filter web typecheck` passes
   - Cookie consent banner renders on first visit
   - ForceUpdateBanner renders in app layout
   - Sentry initializes without errors when DSN is not set
  </verify>
  <done>
   - Sentry error capture is initialized (no-ops gracefully without DSN)
   - Analytics tracking is gated behind cookie consent
   - Cookie consent banner appears on first visit with accept/decline
   - Force-update banner infrastructure is in place with version.json
  </done>
</task>

<task type="auto">
  <name>Task 2: GDPR data export page, settings integration, and unit tests</name>
  <files>
    apps/web/app/(app)/settings/data-export/page.tsx
    apps/web/app/(app)/settings/page.tsx
    apps/web/__tests__/gdpr-analytics.test.ts
  </files>
  <action>
1. Create `apps/web/app/(app)/settings/data-export/page.tsx`:
   - "use client" directive
   - Page title: "Export Your Data"
   - Description: "Download a copy of all your personal data stored in Festapp Rideshare."
   - "Export Data" button that:
     - Calls Supabase RPC or fetches from a server action that queries: profile, vehicles, rides (as driver), bookings (as passenger), reviews (given/received), notification preferences
     - Compiles into a JSON object
     - Downloads as `festapp-data-export.json` using Blob + URL.createObjectURL + anchor click
   - Shows loading state while exporting
   - For simplicity, implement as a server action that queries each table with the user's ID and returns the combined JSON
   - Use createClient() from @/lib/supabase/client for authenticated queries
   - Back link to /settings

2. Update `apps/web/app/(app)/settings/page.tsx`:
   - Add "Export My Data" item to the Privacy section (alongside Blocked Users)
   - onClick navigates to "/settings/data-export"

3. Create `apps/web/__tests__/gdpr-analytics.test.ts`:
   - Test analytics consent: hasAnalyticsConsent returns false by default, setAnalyticsConsent(true) changes it
   - Test trackPageView: does not fire when consent is false (mock fetch, verify not called)
   - Test trackPageView: fires when consent is true (mock fetch, verify called)
   - Test trackEvent: same consent gating as trackPageView
   - Test cookie consent state: ANALYTICS_CONSENT_KEY is used correctly
   - Test force-update: APP_VERSION is a valid semver string
   - Test force-update: shouldShowUpdateBanner returns false when no update available
   - Test captureError: does not throw when Sentry is not initialized
   - At least 8 test cases
   - Mock localStorage for testing (happy-dom provides it)
  </action>
  <verify>
   - `cd apps/web && npx vitest run __tests__/gdpr-analytics.test.ts` — all tests pass
   - Data export page renders and shows export button
   - Settings page has "Export My Data" link in Privacy section
  </verify>
  <done>
   - GDPR data export page lets users download their personal data as JSON
   - Settings page links to data export
   - 8+ unit tests pass validating analytics consent gating and GDPR utilities
  </done>
</task>

</tasks>

<verification>
- Cookie consent banner shows on first visit, hides after choice
- Analytics only tracks when consent is given
- Data export page downloads user data as JSON
- Force-update banner shows when version.json has higher minVersion
- Sentry initializes gracefully (no-op without DSN)
- Tests pass: `cd apps/web && npx vitest run __tests__/gdpr-analytics.test.ts`
</verification>

<success_criteria>
- PLAT-12 satisfied: Sentry crash reporting initialized
- PLAT-13 satisfied: Anonymous analytics with consent gating
- PLAT-06 satisfied: Cookie consent banner + data export
- PLAT-14 satisfied: Force-update mechanism via version.json
- 8+ unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-testing-launch/11-03-SUMMARY.md`
</output>
