---
phase: 11-polish-testing-launch
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/components/skeleton-card.tsx
  - apps/web/components/empty-state.tsx
  - apps/web/components/error-boundary.tsx
  - apps/web/components/offline-banner.tsx
  - apps/web/app/not-found.tsx
  - apps/web/app/error.tsx
  - apps/web/app/(app)/layout.tsx
  - apps/web/__tests__/ui-states.test.tsx
autonomous: true

must_haves:
  truths:
    - "App shows skeleton loading cards while data loads on list pages"
    - "Empty states show helpful messages with icons when no data exists"
    - "Custom 404 page renders with navigation back to home"
    - "Custom error page renders with retry option"
    - "Offline banner appears when network connectivity is lost"
  artifacts:
    - path: "apps/web/components/skeleton-card.tsx"
      provides: "Reusable skeleton loading card component"
      contains: "SkeletonCard"
    - path: "apps/web/components/empty-state.tsx"
      provides: "Reusable empty state component with icon and message"
      contains: "EmptyState"
    - path: "apps/web/components/error-boundary.tsx"
      provides: "React error boundary for catching render errors"
      contains: "ErrorBoundary"
    - path: "apps/web/components/offline-banner.tsx"
      provides: "Offline connectivity banner"
      contains: "OfflineBanner"
    - path: "apps/web/app/not-found.tsx"
      provides: "Custom 404 page"
    - path: "apps/web/app/error.tsx"
      provides: "Custom error page with retry"
    - path: "apps/web/__tests__/ui-states.test.tsx"
      provides: "Tests for UI state components"
  key_links:
    - from: "apps/web/app/(app)/layout.tsx"
      to: "apps/web/components/offline-banner.tsx"
      via: "OfflineBanner rendered in app layout"
      pattern: "OfflineBanner"
    - from: "apps/web/app/error.tsx"
      to: "apps/web/components/error-boundary.tsx"
      via: "Error page uses error boundary pattern"
      pattern: "reset"
---

<objective>
Add offline handling, skeleton loading states, empty states, and error pages.

Purpose: PLAT-05 (offline handling), PLAT-07 (empty states and error pages), and PLAT-11 (skeleton loading) require graceful degradation. This plan creates reusable UI components for loading, empty, error, and offline states.

Output: SkeletonCard, EmptyState, ErrorBoundary, OfflineBanner components, custom 404/error pages, unit tests.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/layout.tsx
@apps/web/app/(app)/layout.tsx
@apps/web/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reusable UI state components — skeleton, empty state, error boundary, offline banner</name>
  <files>
    apps/web/components/skeleton-card.tsx
    apps/web/components/empty-state.tsx
    apps/web/components/error-boundary.tsx
    apps/web/components/offline-banner.tsx
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
1. Create `apps/web/components/skeleton-card.tsx`:
   - Export `SkeletonCard` component — a pulsing placeholder card matching ride card dimensions
   - Props: `variant?: 'ride' | 'message' | 'profile'` (default 'ride')
   - 'ride' variant: rectangle with 3 shimmer lines (origin, destination, details row)
   - 'message' variant: avatar circle + 2 text lines
   - 'profile' variant: large circle + 2 text lines + badge placeholder
   - Use Tailwind `animate-pulse` on `bg-border-pastel/50` rounded shapes
   - Export `SkeletonList` that renders N (default 3) SkeletonCards in a column
   - Card uses rounded-2xl, bg-surface, border border-border-pastel (matching existing card design)

2. Create `apps/web/components/empty-state.tsx`:
   - Export `EmptyState` component
   - Props: `icon?: React.ReactNode`, `title: string`, `description?: string`, `action?: { label: string; onClick: () => void }`
   - Centered layout with large icon (64px), title below, optional description, optional action button
   - Action button uses primary color, rounded-xl, matching existing button styles
   - Muted text colors (text-secondary for description)

3. Create `apps/web/components/error-boundary.tsx`:
   - "use client" directive
   - Export `ErrorBoundary` as a class component (React error boundaries require class components)
   - Props: `children`, `fallback?: React.ReactNode`
   - State: `hasError: boolean`, `error: Error | null`
   - On error: renders fallback or default error UI with "Something went wrong" message and "Try again" button
   - "Try again" calls `this.setState({ hasError: false })` to re-render children
   - Use design system colors and rounded-2xl card style

4. Create `apps/web/components/offline-banner.tsx`:
   - "use client" directive
   - Uses `navigator.onLine` + 'online'/'offline' event listeners
   - When offline: renders a fixed banner at top of viewport (above everything) with warning color background
   - Text: "You're offline. Some features may not work." with a dismiss X button
   - When back online: banner auto-hides
   - Uses z-50 positioning, full width, py-2 px-4, flex with justify-between
   - Warning color from design system (--warning)

5. Update `apps/web/app/(app)/layout.tsx`:
   - Import OfflineBanner
   - Add `<OfflineBanner />` at the top of the layout content (before main content area)
   - Keep it outside the main scrollable area so it overlays
  </action>
  <verify>
   - `pnpm --filter web typecheck` passes or no TS compilation errors
   - OfflineBanner appears in layout
   - Components render without errors
  </verify>
  <done>
   - SkeletonCard renders pulsing placeholder cards in 3 variants
   - EmptyState renders centered message with optional icon and action
   - ErrorBoundary catches render errors and shows retry UI
   - OfflineBanner shows when network is lost, hides when restored
  </done>
</task>

<task type="auto">
  <name>Task 2: Custom 404/error pages and unit tests</name>
  <files>
    apps/web/app/not-found.tsx
    apps/web/app/error.tsx
    apps/web/__tests__/ui-states.test.tsx
  </files>
  <action>
1. Create `apps/web/app/not-found.tsx`:
   - Next.js special not-found page (no "use client" needed unless interactive)
   - Centered layout with large 404 heading
   - Friendly message: "This page doesn't exist or has been removed"
   - A link button to go back to home ("/search") using Next.js Link
   - Use design system colors: text-text-main for heading, text-text-secondary for message
   - Illustration: a simple SVG or lucide-react icon (e.g., MapPinOff or SearchX)
   - Card-style container: bg-surface, rounded-2xl, shadow-sm, max-w-md, mx-auto, mt-20

2. Create `apps/web/app/error.tsx`:
   - "use client" directive (required for Next.js error pages)
   - Receives `error: Error & { digest?: string }` and `reset: () => void` props
   - Centered layout similar to not-found page
   - Title: "Something went wrong"
   - Description: "An unexpected error occurred. Please try again."
   - Shows error.message in a small muted text block (for debugging, could be hidden in production)
   - "Try again" button that calls reset()
   - "Go home" link to "/search"
   - Card-style container matching not-found page

3. Create `apps/web/__tests__/ui-states.test.tsx`:
   - Test SkeletonCard: renders with default variant, renders each variant (ride, message, profile), applies animate-pulse class
   - Test SkeletonList: renders correct number of skeleton cards
   - Test EmptyState: renders title, renders description when provided, renders action button when provided, calls onClick when action clicked
   - Test ErrorBoundary: renders children when no error, renders fallback on error (use a component that throws)
   - Test OfflineBanner: initially hidden when online (mock navigator.onLine = true)
   - Use @testing-library/react for rendering, vitest for assertions
   - Use inline JSX pattern (consistent with existing tests that avoid pnpm dual-React imports)
   - At least 10 test cases
  </action>
  <verify>
   - `cd apps/web && npx vitest run __tests__/ui-states.test.tsx` — all tests pass
   - Navigating to a non-existent route shows custom 404
   - Error page has reset functionality
  </verify>
  <done>
   - Custom 404 page at /not-found with navigation to home
   - Custom error page with retry and home navigation
   - 10+ unit tests pass validating all UI state components
  </done>
</task>

</tasks>

<verification>
- SkeletonCard, EmptyState, ErrorBoundary, OfflineBanner components exist and render correctly
- Custom 404 and error pages render with proper design system styling
- OfflineBanner integrated into app layout
- Tests pass: `cd apps/web && npx vitest run __tests__/ui-states.test.tsx`
</verification>

<success_criteria>
- PLAT-05 satisfied: OfflineBanner shows connectivity status
- PLAT-07 satisfied: EmptyState component + custom 404 + custom error page
- PLAT-11 satisfied: SkeletonCard with variants for loading states
- 10+ unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-polish-testing-launch/11-02-SUMMARY.md`
</output>
