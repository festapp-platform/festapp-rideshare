---
phase: 16-ui-polish-route-features
plan: 04
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - apps/web/app/(app)/components/ride-form.tsx
  - apps/web/app/(app)/components/route-map.tsx
  - apps/web/app/(app)/components/ride-map-mapy.tsx
  - apps/web/app/(app)/components/ride-map.tsx
  - apps/web/app/(app)/components/ride-detail.tsx
  - packages/shared/src/i18n/translations/cs.ts
  - packages/shared/src/i18n/translations/sk.ts
  - packages/shared/src/i18n/translations/en.ts
autonomous: true
requirements:
  - ROUTE-01
  - ROUTE-02

must_haves:
  truths:
    - "Driver can add up to 5 intermediate waypoints when creating a ride"
    - "Waypoints are inserted into ride_waypoints table after ride creation"
    - "Waypoints appear as blue circle markers on the route map"
    - "Waypoints added in ride form do NOT trigger route recalculation"
  artifacts:
    - path: "apps/web/app/(app)/components/ride-form.tsx"
      provides: "Waypoint input UI in Step 1 with add/remove, max 5"
      contains: "waypoint"
    - path: "apps/web/app/(app)/components/ride-map-mapy.tsx"
      provides: "Blue circle markers for waypoint positions on Leaflet map"
      contains: "waypoint"
    - path: "apps/web/app/(app)/components/route-map.tsx"
      provides: "RouteMap passes waypoints prop through to map implementations"
      contains: "waypoint"
  key_links:
    - from: "apps/web/app/(app)/components/ride-form.tsx"
      to: "supabase ride_waypoints table"
      via: "Sequential inserts after ride creation succeeds"
      pattern: "ride_waypoints.*insert"
    - from: "apps/web/app/(app)/components/ride-detail.tsx"
      to: "apps/web/app/(app)/components/route-map.tsx"
      via: "waypoints prop passed from ride detail to route map"
      pattern: "waypoints.*RouteMap"
---

<objective>
Add waypoint input UI to the ride creation form (max 5 intermediate waypoints) and display waypoint markers on route maps. Waypoints are informational pickup points -- they do NOT trigger route recalculation.

Purpose: Enable drivers to specify intermediate pickup points and passengers to see them on the route map.
Output: Waypoint management in ride form + waypoint markers on route map components.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-polish-route-features/16-RESEARCH.md
@.planning/phases/16-ui-polish-route-features/16-01-SUMMARY.md
@apps/web/app/(app)/components/ride-form.tsx
@apps/web/app/(app)/components/route-map.tsx
@apps/web/app/(app)/components/ride-map-mapy.tsx
@apps/web/app/(app)/components/ride-map.tsx
@apps/web/app/(app)/components/ride-detail.tsx
@apps/web/app/(app)/rides/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Waypoint input UI in ride creation form</name>
  <files>
    apps/web/app/(app)/components/ride-form.tsx
    packages/shared/src/i18n/translations/cs.ts
    packages/shared/src/i18n/translations/sk.ts
    packages/shared/src/i18n/translations/en.ts
  </files>
  <action>
    1. Read `ride-form.tsx` fully (981 lines). Understand the wizard step structure. Step 1 is the route step with origin/destination inputs.

    2. **Add waypoint state** near the existing origin/destination state:
       ```typescript
       interface WaypointInput {
         address: string;
         lat: number;
         lng: number;
       }
       const [waypoints, setWaypoints] = useState<WaypointInput[]>([]);
       const MAX_WAYPOINTS = 5;
       ```

    3. **Add waypoint UI in Step 1** (route step), between the origin and destination inputs. The UI should include:
       - A list of current waypoints, each showing the address and an X button to remove.
       - An "Add waypoint" button (disabled when waypoints.length >= MAX_WAYPOINTS) that adds a new empty waypoint slot.
       - Each waypoint uses the same `AddressInput` (or `AddressAutocomplete`) component used by origin/destination, with an `onSelect` handler that sets lat/lng/address.
       - Optionally, each waypoint can have a small map pin icon button to open the MapLocationPicker for manual pin placement (reuse the same `showMapPicker` pattern but for waypoints).
       - Waypoints are displayed in order. Support reordering is NOT required for v1.1.
       - Use MapPin icon from lucide-react for the waypoint list items and X for remove.

    4. **Insert waypoints after ride creation.** Find the ride creation submit handler. After the ride is successfully created and `ride.id` is available:
       ```typescript
       // Insert waypoints sequentially
       for (let i = 0; i < waypoints.length; i++) {
         await supabase.from('ride_waypoints').insert({
           ride_id: ride.id,
           location: `POINT(${waypoints[i].lng} ${waypoints[i].lat})`,
           address: waypoints[i].address,
           order_index: i,
           type: 'pickup',
         });
       }
       ```
       If a waypoint insert fails, log a warning but do NOT block navigation (the ride exists, waypoints are secondary).

    5. **Do NOT trigger route recalculation** when waypoints are added/removed. Waypoints are informational pickup points along the existing route. The Google Routes API is called only for origin/destination.

    6. Add translation keys:
       - `rideForm.addWaypoint` / `rideForm.waypoints` / `rideForm.maxWaypoints` / `rideForm.removeWaypoint`
       - In cs/sk/en translation files.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes.
    2. Grep for `WaypointInput` in ride-form.tsx confirms the type exists.
    3. Grep for `ride_waypoints` in ride-form.tsx confirms insert logic.
    4. Grep for `MAX_WAYPOINTS` confirms the 5-waypoint limit.
    5. No call to the route computation API when waypoints change (grep for `computeRoute` or `compute-route` to verify no new invocations).
  </verify>
  <done>
    Ride form Step 1 shows waypoint input UI (add/remove, max 5) and inserts waypoints to ride_waypoints table after ride creation. No route recalculation triggered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Display waypoint markers on route maps</name>
  <files>
    apps/web/app/(app)/components/route-map.tsx
    apps/web/app/(app)/components/ride-map-mapy.tsx
    apps/web/app/(app)/components/ride-map.tsx
    apps/web/app/(app)/components/ride-detail.tsx
  </files>
  <action>
    1. Read `route-map.tsx` (27 lines -- it's a switcher component). Understand how it delegates to `RideMapMapy` or `RideMap`.
    2. Read `ride-map-mapy.tsx` (Leaflet-based map) and `ride-map.tsx` (Google Maps-based map).
    3. Read `ride-detail.tsx` to see how it already receives `waypoints` prop and passes data to the route map.

    4. **Extend RouteMap props** in `route-map.tsx`:
       - Add `waypoints?: { lat: number; lng: number; address: string }[]` to the props type.
       - Pass `waypoints` through to both `RideMapMapy` and `RideMap`.

    5. **Add waypoint markers to RideMapMapy** (Leaflet):
       - Accept `waypoints` prop.
       - For each waypoint, add a `L.circleMarker` at the waypoint coordinates with:
         - Blue fill color (e.g., `fillColor: '#3B82F6'`, `color: '#2563EB'`, `radius: 8`)
         - A tooltip or popup showing the waypoint address.
       - Add markers after the route polyline is drawn.
       - Extend the map bounds to include waypoint positions (so all waypoints are visible).

    6. **Add waypoint markers to RideMap** (Google Maps):
       - Accept `waypoints` prop.
       - For each waypoint, add a marker (blue circle marker or standard pin with blue color) at the waypoint coordinates.
       - Include the waypoint address in the marker's info window or title.
       - Extend bounds to include waypoints.

    7. **Wire up ride-detail.tsx:**
       - Check that `ride-detail.tsx` already passes `waypoints` to the RouteMap component. If not, add the prop passing.
       - The ride detail page (`rides/[id]/page.tsx`) already fetches waypoints -- verify this data flows through to the map.
       - Transform the fetched waypoints to match the expected `{ lat: number; lng: number; address: string }[]` format (the DB returns geography objects that may need coordinate extraction).
  </action>
  <verify>
    1. `npx tsc --noEmit` passes.
    2. Grep for `waypoints` in route-map.tsx, ride-map-mapy.tsx, and ride-map.tsx confirms prop threading.
    3. Grep for `circleMarker` or `L.circleMarker` in ride-map-mapy.tsx confirms Leaflet markers.
    4. ride-detail.tsx passes waypoints to RouteMap.
  </verify>
  <done>
    Waypoints appear as blue circle markers on both Leaflet and Google Maps route displays. Ride detail page correctly shows waypoint markers on the map.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Waypoint input UI visible in ride form Step 1
- Max 5 waypoints enforced
- Waypoints inserted to ride_waypoints after ride creation
- Route maps show blue markers at waypoint positions
- ride-detail.tsx threads waypoint data to route map
</verification>

<success_criteria>
- Driver can add 1-5 waypoints via AddressInput in ride form
- Waypoints persist in ride_waypoints table with correct order_index
- Route map displays waypoints as blue circles with address tooltips
- No route API calls triggered by waypoint changes
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-polish-route-features/16-04-SUMMARY.md`
</output>
