---
phase: 16-ui-polish-route-features
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000012_waypoint_search.sql
autonomous: true
requirements:
  - ROUTE-03

must_haves:
  truths:
    - "Passengers can find rides where a waypoint is near their origin or destination"
    - "nearby_rides RPC returns rides matching by waypoint proximity in addition to existing origin/destination/route matching"
  artifacts:
    - path: "supabase/migrations/00000000000012_waypoint_search.sql"
      provides: "Extended nearby_rides RPC with waypoint proximity matching"
      contains: "ride_waypoints"
  key_links:
    - from: "supabase/migrations/00000000000012_waypoint_search.sql"
      to: "public.ride_waypoints"
      via: "EXISTS subquery with ST_DWithin on waypoint locations"
      pattern: "ST_DWithin.*ride_waypoints"
---

<objective>
Extend the `nearby_rides` RPC to also match rides where any waypoint is within the search radius of the passenger's origin or destination.

Purpose: Enable passengers to find rides that pass through intermediate points, not just rides matching origin/destination directly.
Output: New SQL migration that replaces/extends the nearby_rides function.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-ui-polish-route-features/16-RESEARCH.md
@supabase/migrations/00000000000008_ride_search.sql
@supabase/migrations/00000000000002_rides.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend nearby_rides RPC with waypoint proximity matching</name>
  <files>
    supabase/migrations/00000000000012_waypoint_search.sql
  </files>
  <action>
    1. Read `supabase/migrations/00000000000008_ride_search.sql` to understand the current `nearby_rides` RPC signature and WHERE clauses. Note the exact function signature, return type, and all existing matching logic.
    2. Read `supabase/migrations/00000000000002_rides.sql` to confirm the `ride_waypoints` table schema and its GIST index on `location`.
    3. Create a new migration file `00000000000012_waypoint_search.sql` that uses `CREATE OR REPLACE FUNCTION` to extend `nearby_rides`.
    4. The function signature and return type MUST remain identical to the existing one (backward compatible).
    5. Add two additional OR clauses to the WHERE condition:
       - **Origin waypoint match:** `OR EXISTS (SELECT 1 FROM public.ride_waypoints rw WHERE rw.ride_id = r.id AND extensions.ST_DWithin(rw.location, extensions.ST_SetSRID(extensions.ST_MakePoint(origin_lng, origin_lat), 4326)::extensions.geography, radius_km * 1000))`
       - **Destination waypoint match:** `OR EXISTS (SELECT 1 FROM public.ride_waypoints rw WHERE rw.ride_id = r.id AND extensions.ST_DWithin(rw.location, extensions.ST_SetSRID(extensions.ST_MakePoint(dest_lng, dest_lat), 4326)::extensions.geography, radius_km * 1000))`
    6. Use `EXISTS` (not JOIN) to avoid row multiplication per research pitfall #3. The GIST index on `ride_waypoints.location` ensures fast spatial lookup.
    7. Keep ALL existing matching logic intact (origin_location, destination_location, route_geometry matching). The waypoint clauses are purely additive OR conditions.
    8. Add a comment explaining the waypoint matching extension.
    9. Check the migration numbering: look at existing migrations to find the correct next number. Use `00000000000012` or whatever follows the last existing migration file.
  </action>
  <verify>
    1. The migration file exists and contains valid SQL.
    2. `CREATE OR REPLACE FUNCTION` is used (not DROP + CREATE).
    3. The function signature matches the existing one exactly.
    4. Both origin and destination waypoint EXISTS subqueries are present.
    5. `extensions.ST_DWithin` is used (not plain `ST_DWithin`) per Supabase convention.
    6. Run `supabase db reset` or verify SQL syntax if local Supabase is available.
  </verify>
  <done>
    nearby_rides RPC returns rides matching by waypoint proximity (in addition to existing origin/destination/route matching). No breaking changes to the function signature.
  </done>
</task>

</tasks>

<verification>
- Migration file has valid SQL syntax
- Function signature unchanged (backward compatible)
- EXISTS subqueries use GIST-indexed ride_waypoints.location column
- extensions. prefix used for all PostGIS functions
</verification>

<success_criteria>
- nearby_rides RPC matches rides where ANY waypoint is within radius of passenger's origin or destination
- No changes to existing matching logic (additive only)
- Migration file follows project conventions
</success_criteria>

<output>
After completion, create `.planning/phases/16-ui-polish-route-features/16-03-SUMMARY.md`
</output>
