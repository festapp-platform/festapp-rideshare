---
phase: 09-ai-voice
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/ai-assistant/index.ts
  - supabase/functions/_shared/ai-tools.ts
  - packages/shared/src/constants/ai.ts
  - packages/shared/src/validation/ai.ts
  - packages/shared/src/index.ts
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for natural language intent parsing via tool_use"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create Key"

must_haves:
  truths:
    - "AI Edge Function receives natural language text and returns structured intent with parsed parameters"
    - "AI correctly parses ride creation, search, booking, cancellation, edit, and completion intents"
    - "AI handles Czech, Slovak, and English input and responds in the same language"
    - "AI returns confirmation-ready structured data (not raw execution) for all mutation actions"
  artifacts:
    - path: "supabase/functions/ai-assistant/index.ts"
      provides: "AI intent parsing Edge Function using Claude tool_use"
      contains: "tool_use"
    - path: "supabase/functions/_shared/ai-tools.ts"
      provides: "Claude tool definitions for all ride operations"
      contains: "create_ride"
    - path: "packages/shared/src/constants/ai.ts"
      provides: "AI intent types, action constants"
      contains: "AI_ACTIONS"
    - path: "packages/shared/src/validation/ai.ts"
      provides: "Zod schemas for AI request/response"
      contains: "AiRequestSchema"
  key_links:
    - from: "supabase/functions/ai-assistant/index.ts"
      to: "supabase/functions/_shared/ai-tools.ts"
      via: "import tool definitions"
      pattern: "import.*ai-tools"
    - from: "supabase/functions/ai-assistant/index.ts"
      to: "Claude API"
      via: "Anthropic SDK messages.create with tools"
      pattern: "messages\\.create"
---

<objective>
AI processing Edge Function that uses Claude's tool_use feature to parse natural language ride commands into structured intents.

Purpose: This is the brain of the AI assistant. It receives free-text input (in Czech, Slovak, or English), sends it to Claude with tool definitions for all ride operations, and returns a structured intent with parsed parameters ready for user confirmation.

Output: Edge Function `ai-assistant` + shared tool definitions + AI types/validation in shared package
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/functions/_shared/supabase-client.ts
@supabase/functions/send-notification/index.ts
@packages/shared/src/validation/ride.ts
@packages/shared/src/validation/search.ts
@packages/shared/src/validation/booking.ts
@packages/shared/src/constants/ride.ts
@packages/shared/src/constants/booking.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Shared AI types, constants, and validation schemas</name>
  <files>
    packages/shared/src/constants/ai.ts
    packages/shared/src/validation/ai.ts
    packages/shared/src/index.ts
  </files>
  <action>
Create `packages/shared/src/constants/ai.ts`:
- Define `AI_ACTIONS` constant object with action keys: `create_ride`, `search_rides`, `book_seat`, `cancel_booking`, `edit_ride`, `complete_ride`, `general_chat` (for non-action queries)
- Define `AiAction` type from the keys
- Define `AI_SUPPORTED_LANGUAGES` = ['cs', 'sk', 'en'] as const
- Define `AiLanguage` type
- Define `MAX_AI_MESSAGE_LENGTH` = 500

Create `packages/shared/src/validation/ai.ts`:
- `AiRequestSchema` — Zod schema: `{ message: z.string().max(500), conversation_history?: z.array(z.object({ role: z.enum(['user', 'assistant']), content: z.string() })).max(10) }`
- `AiParsedIntent` — Zod schema for the structured response: `{ action: z.enum([...AI_ACTIONS values]), confidence: z.number().min(0).max(1), language: z.enum(AI_SUPPORTED_LANGUAGES), params: z.record(z.unknown()), display_text: z.string(), needs_confirmation: z.boolean() }`
- `AiResponseSchema` — Zod schema: `{ intent: AiParsedIntent.nullable(), reply: z.string(), error?: z.string() }`
- Export inferred types: `AiRequest`, `AiParsedIntent`, `AiResponse`

Update `packages/shared/src/index.ts`:
- Add exports for AI constants (AI_ACTIONS, AI_SUPPORTED_LANGUAGES, MAX_AI_MESSAGE_LENGTH)
- Add exports for AI types (AiAction, AiLanguage)
- Add exports for AI validation schemas (AiRequestSchema, AiResponseSchema) and types (AiRequest, AiParsedIntent, AiResponse)
  </action>
  <verify>Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck --filter=@festapp/shared` — should pass with no errors.</verify>
  <done>AI_ACTIONS, AiRequestSchema, AiParsedIntent, AiResponseSchema exported from shared package and type-check passes.</done>
</task>

<task type="auto">
  <name>Task 2: AI assistant Edge Function with Claude tool_use</name>
  <files>
    supabase/functions/_shared/ai-tools.ts
    supabase/functions/ai-assistant/index.ts
  </files>
  <action>
Create `supabase/functions/_shared/ai-tools.ts`:
Define Claude tool definitions array (Anthropic tool_use format) for each ride operation:

1. `create_ride` — params: origin_address (string, required), destination_address (string, required), departure_date (string ISO, required), departure_time (string HH:MM, required), available_seats (integer 1-8), price_per_seat (number, optional), notes (string, optional)
2. `search_rides` — params: origin_address (string, required), destination_address (string, required), date (string ISO, optional), max_results (integer, default 5)
3. `book_seat` — params: ride_id (string UUID, required), seats (integer 1-4, default 1)
4. `cancel_booking` — params: booking_id (string UUID, required), reason (string, optional)
5. `edit_ride` — params: ride_id (string UUID, required), plus all optional create_ride fields
6. `complete_ride` — params: ride_id (string UUID, required)

Each tool has a descriptive `description` in English explaining what it does and when to use it. Export as `AI_TOOL_DEFINITIONS`.

Also export `SYSTEM_PROMPT` — a carefully crafted system prompt that:
- Instructs Claude to act as a rideshare assistant for a Czech/Slovak rideshare app
- Tells it to detect the user's language (Czech/Slovak/English) and respond in the SAME language
- Tells it to use tool_use to parse actions; if no action is needed, respond conversationally
- Tells it to extract dates relative to today, handle Czech date formats ("zítra", "v pátek", "příští týden")
- Tells it to handle Czech city names, addresses, and common abbreviations
- Tells it that it should ALWAYS use a tool call when it detects an actionable intent

Create `supabase/functions/ai-assistant/index.ts`:
- Auth: Accept user JWT (via Authorization header) — use `createUserClient(authHeader)` to verify user, extract user_id from getUser(). Return 401 if invalid.
- Parse request body using the same pattern as send-notification: CORS headers, OPTIONS preflight, POST only.
- Validate input against AiRequestSchema-equivalent validation (inline, since Edge Functions can't import from shared package — replicate the shape).
- Call Anthropic API:
  ```
  const anthropic = new Anthropic({ apiKey: Deno.env.get("ANTHROPIC_API_KEY") });
  const response = await anthropic.messages.create({
    model: "claude-sonnet-4-20250514",
    max_tokens: 1024,
    system: SYSTEM_PROMPT,
    tools: AI_TOOL_DEFINITIONS,
    messages: [...conversation_history, { role: "user", content: message }],
  });
  ```
- Import Anthropic SDK: `import Anthropic from "https://esm.sh/@anthropic-ai/sdk@0.52.0";`
- Parse response: Check for tool_use content blocks. If tool_use found, extract tool name (= action), input (= params). Build structured intent: `{ action, confidence: 1.0, language: detected_from_response, params, display_text: assistant_text_block, needs_confirmation: action !== 'search_rides' && action !== 'general_chat' }`. Mutations always need confirmation; search does not.
- If no tool_use, return as general_chat with reply text.
- Detect language from Claude's response text (heuristic: check for Czech/Slovak diacritics and common words; default to the language Claude responded in).
- Return JSON response: `{ intent, reply }` with 200 status.
- Error handling: 400 for bad input, 401 for auth failure, 500 for Anthropic API errors (with generic message, log details).
  </action>
  <verify>Deploy locally with `cd /Users/miakh/source/festapp-rideshare && supabase functions serve ai-assistant --no-verify-jwt` and test with curl:
```
curl -X POST http://localhost:54321/functions/v1/ai-assistant \
  -H "Authorization: Bearer $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"message": "Jedu zítra z Prahy do Brna ve 3 odpoledne, mám 3 místa"}'
```
Should return JSON with intent.action = "create_ride" and parsed params.</verify>
  <done>Edge Function parses Czech/Slovak/English natural language into structured ride intents using Claude tool_use. Mutations return needs_confirmation=true, searches return needs_confirmation=false.</done>
</task>

</tasks>

<verification>
1. Shared package type-checks: `pnpm turbo typecheck --filter=@festapp/shared`
2. Edge Function deploys without syntax errors
3. Natural language input in Czech returns structured create_ride intent with correct params
4. English input "Find rides from Prague to Brno on Friday" returns search_rides intent
5. Non-action input "How does the app work?" returns general_chat with no intent
</verification>

<success_criteria>
- AI Edge Function receives natural language in CZ/SK/EN and returns structured intents via Claude tool_use
- All 6 ride operation tools defined with proper parameter schemas
- Mutations (create, book, cancel, edit, complete) require confirmation; search does not
- Shared AI types and validation schemas exported from @festapp/shared
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-voice/09-01-SUMMARY.md`
</output>
