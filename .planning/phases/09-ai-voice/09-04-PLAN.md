---
phase: 09-ai-voice
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02"]
files_modified:
  - packages/shared/src/validation/__tests__/ai.test.ts
  - packages/mcp-server/src/__tests__/tools.test.ts
  - apps/web/app/(app)/assistant/__tests__/voice-input.test.tsx
  - apps/web/app/(app)/assistant/__tests__/intent-confirmation.test.tsx
autonomous: true

must_haves:
  truths:
    - "AI validation schemas correctly parse valid requests and reject invalid ones"
    - "MCP tool definitions have correct input schemas and handler routing works"
    - "Voice input component handles supported/unsupported browsers and recording states"
    - "Intent confirmation component renders params and handles confirm/reject"
  artifacts:
    - path: "packages/shared/src/validation/__tests__/ai.test.ts"
      provides: "Unit tests for AI Zod schemas"
      contains: "AiRequestSchema"
    - path: "packages/mcp-server/src/__tests__/tools.test.ts"
      provides: "Unit tests for MCP tool registration and input validation"
      contains: "registerTools"
    - path: "apps/web/app/(app)/assistant/__tests__/voice-input.test.tsx"
      provides: "Unit tests for VoiceInput component"
      contains: "VoiceInput"
    - path: "apps/web/app/(app)/assistant/__tests__/intent-confirmation.test.tsx"
      provides: "Unit tests for IntentConfirmation component"
      contains: "IntentConfirmation"
  key_links:
    - from: "packages/shared/src/validation/__tests__/ai.test.ts"
      to: "packages/shared/src/validation/ai.ts"
      via: "import and test validation schemas"
      pattern: "import.*ai"
---

<objective>
Unit and integration tests for the AI pipeline, MCP server tools, and assistant UI components.

Purpose: Verify that AI schemas validate correctly, MCP tools register and route properly, and UI components handle all states (recording, confirmation, error). Ensures the AI + MCP + Voice features work as designed.

Output: Test files for shared AI validation, MCP tools, and assistant UI components
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/09-ai-voice/09-01-SUMMARY.md
@.planning/phases/09-ai-voice/09-02-SUMMARY.md
@.planning/phases/09-ai-voice/09-03-SUMMARY.md
@packages/shared/src/constants/ai.ts
@packages/shared/src/validation/ai.ts
@packages/mcp-server/src/tools.ts
@apps/web/app/(app)/assistant/components/voice-input.tsx
@apps/web/app/(app)/assistant/components/intent-confirmation.tsx
@apps/web/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI validation schema tests and MCP tool tests</name>
  <files>
    packages/shared/src/validation/__tests__/ai.test.ts
    packages/mcp-server/src/__tests__/tools.test.ts
  </files>
  <action>
Create `packages/shared/src/validation/__tests__/ai.test.ts` using vitest:

Test `AiRequestSchema`:
- Valid: `{ message: "Jedu z Prahy do Brna" }` — passes
- Valid: `{ message: "Find rides", conversation_history: [{ role: "user", content: "hi" }] }` — passes
- Invalid: `{ message: "" }` — fails (empty)
- Invalid: `{ message: "x".repeat(501) }` — fails (too long)
- Invalid: `{ conversation_history: [{ role: "invalid", content: "hi" }] }` — fails (bad role)
- Invalid: missing message — fails

Test `AiResponseSchema` (AiParsedIntent embedded):
- Valid: complete response with intent (action, confidence, language, params, display_text, needs_confirmation) + reply
- Valid: response with null intent (general chat)
- Invalid: intent with unknown action — fails
- Invalid: confidence > 1 — fails
- Invalid: unsupported language — fails

Test AI_ACTIONS constant:
- Has all 7 expected action keys
- Values match expected strings

Create `packages/mcp-server/src/__tests__/tools.test.ts`:

NOTE: MCP server may not have vitest configured. Add vitest as devDependency to packages/mcp-server/package.json if not present. Add `"test": "vitest run"` script. Create a minimal vitest.config.ts.

Test tool definitions (mock the Server):
- Create a mock Server object that captures setRequestHandler calls
- Call registerTools(mockServer)
- Verify tools/list handler returns 8 tools (create_ride, search_rides, book_seat, cancel_booking, edit_ride, complete_ride, my_rides, my_bookings)
- Verify each tool has name, description, and inputSchema
- Verify create_ride inputSchema requires origin_address, destination_address, departure_date, departure_time
- Verify search_rides inputSchema requires origin_address, destination_address
- Verify book_seat inputSchema requires ride_id

Test input validation (unit test the handler logic):
- call_tool with unknown tool name returns error
- call_tool with missing required params returns error message
  </action>
  <verify>Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo test --filter=@festapp/shared` and `cd packages/mcp-server && pnpm test` — all tests pass.</verify>
  <done>AI schema tests validate request/response shapes. MCP tool tests verify tool registration, required schemas, and error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Voice input and intent confirmation component tests</name>
  <files>
    apps/web/app/(app)/assistant/__tests__/voice-input.test.tsx
    apps/web/app/(app)/assistant/__tests__/intent-confirmation.test.tsx
  </files>
  <action>
Create `apps/web/app/(app)/assistant/__tests__/voice-input.test.tsx` using vitest + @testing-library/react (consistent with 07-03 test pattern using happy-dom):

Test VoiceInput component:
- Renders microphone button
- When SpeechRecognition not available: button is hidden or shows "not supported" state
- Mock window.webkitSpeechRecognition as a class with start/stop/addEventListener methods
- Click mic button starts recognition (mock.start called)
- Click again while recording stops recognition (mock.stop called)
- On recognition result event: calls onTranscript with transcript text
- On recognition error event: shows error state (check for error indicator)
- Disabled prop: button is disabled, click does nothing

Create `apps/web/app/(app)/assistant/__tests__/intent-confirmation.test.tsx`:

Test IntentConfirmation component:
- Renders action badge (e.g., "Create Ride")
- Renders param list (origin, destination, date, seats)
- Renders display_text from AI
- Renders Confirm and Cancel buttons
- Click Confirm calls onConfirm
- Click Cancel calls onReject
- When isExecuting=true: Confirm button shows spinner and is disabled
- Different action types render appropriate labels (Book Seat, Cancel Booking, etc.)

Use inline JSX rendering (consistent with 07-03 pattern for avoiding dual-React issues with pnpm):
```tsx
import { render, screen, fireEvent } from '@testing-library/react';
// Render directly, not via component import if dual-React issues arise
```
  </action>
  <verify>Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo test --filter=@festapp/web` — all tests pass including new assistant tests.</verify>
  <done>VoiceInput tests cover supported/unsupported browsers, recording states, and transcript callback. IntentConfirmation tests cover rendering, confirm/reject actions, and loading state.</done>
</task>

</tasks>

<verification>
1. All shared package tests pass: `pnpm turbo test --filter=@festapp/shared`
2. MCP server tests pass: `cd packages/mcp-server && pnpm test`
3. Web app tests pass: `pnpm turbo test --filter=@festapp/web`
4. Test count: minimum 20 tests across all suites
</verification>

<success_criteria>
- AI validation schemas tested with valid and invalid inputs (at least 10 test cases)
- MCP tool registration tested with tool count and schema verification
- VoiceInput component tested for browser support detection and recording flow
- IntentConfirmation component tested for rendering and user interaction
- All tests pass in CI-compatible mode (vitest run)
</success_criteria>

<output>
After completion, create `.planning/phases/09-ai-voice/09-04-SUMMARY.md`
</output>
