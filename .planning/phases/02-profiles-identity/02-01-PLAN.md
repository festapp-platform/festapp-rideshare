---
phase: 02-profiles-identity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000003_vehicles.sql
  - supabase/migrations/00000000000004_storage_buckets.sql
  - supabase/migrations/00000000000005_profile_updates.sql
  - packages/shared/src/validation/profile.ts
  - packages/shared/src/constants/storage.ts
  - packages/shared/src/types/database.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Vehicles table exists with make, model, color, license_plate, photo_url, owner_id columns and RLS policies"
    - "Storage buckets 'avatars' and 'vehicles' exist with public access and user-scoped upload RLS"
    - "Profiles table has user_role, id_verified, and id_document_url columns"
    - "Shared validation schemas for profile and vehicle data are importable from @festapp/shared"
    - "Database types include vehicles table and updated profiles columns"
  artifacts:
    - path: "supabase/migrations/00000000000003_vehicles.sql"
      provides: "Vehicles table with RLS"
      contains: "CREATE TABLE public.vehicles"
    - path: "supabase/migrations/00000000000004_storage_buckets.sql"
      provides: "Avatars and vehicles storage buckets with RLS"
      contains: "INSERT INTO storage.buckets"
    - path: "supabase/migrations/00000000000005_profile_updates.sql"
      provides: "Profile verification and role columns"
      contains: "ALTER TABLE public.profiles"
    - path: "packages/shared/src/validation/profile.ts"
      provides: "Zod schemas for profile and vehicle"
      exports: ["ProfileUpdateSchema", "VehicleSchema", "UserRoleSchema", "SocialLinksSchema", "DisplayNameSchema", "BioSchema"]
    - path: "packages/shared/src/constants/storage.ts"
      provides: "Storage bucket names and image constraints"
      exports: ["STORAGE_BUCKETS", "IMAGE_CONSTRAINTS", "getAvatarPath", "getVehiclePhotoPath"]
    - path: "packages/shared/src/types/database.ts"
      provides: "Updated Database types with vehicles table and profile columns"
      contains: "vehicles"
  key_links:
    - from: "packages/shared/src/validation/profile.ts"
      to: "packages/shared/src/index.ts"
      via: "re-export"
      pattern: "export.*from.*validation/profile"
    - from: "packages/shared/src/constants/storage.ts"
      to: "packages/shared/src/index.ts"
      via: "re-export"
      pattern: "export.*from.*constants/storage"
---

<objective>
Create the database foundation and shared package schemas for Phase 2.

Purpose: All profile, vehicle, and image upload features depend on database tables, storage buckets, and shared validation schemas existing first. This plan creates the entire data layer.

Output: 3 SQL migrations (vehicles table, storage buckets, profile columns), shared Zod schemas, storage constants, and updated TypeScript types.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profiles-identity/02-RESEARCH.md
@supabase/migrations/00000000000001_profiles.sql
@supabase/migrations/00000000000002_rls_policies.sql
@packages/shared/src/types/database.ts
@packages/shared/src/index.ts
@packages/shared/src/validation/auth.ts
@packages/shared/src/constants/onboarding.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for vehicles, storage buckets, and profile updates</name>
  <files>
    supabase/migrations/00000000000003_vehicles.sql
    supabase/migrations/00000000000004_storage_buckets.sql
    supabase/migrations/00000000000005_profile_updates.sql
  </files>
  <action>
Create three SQL migration files:

**00000000000003_vehicles.sql** -- Vehicles table (PROF-07):
- `id` UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- `owner_id` UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE
- `make` TEXT NOT NULL, `model` TEXT NOT NULL, `color` TEXT NOT NULL, `license_plate` TEXT NOT NULL
- `photo_url` TEXT (nullable)
- `is_primary` BOOLEAN DEFAULT true
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT now(), `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()
- Enable RLS
- Trigger: reuse `update_updated_at_column()` (already exists from 00000000000000_initial_setup.sql)
- RLS policies: authenticated SELECT (anyone), INSERT/UPDATE/DELETE restricted to owner_id = auth.uid()

**00000000000004_storage_buckets.sql** -- Storage buckets (PLAT-17):
- Create public bucket 'avatars': 2MB limit, JPEG/PNG/WebP only
- Create public bucket 'vehicles': 5MB limit, JPEG/PNG/WebP only
- RLS on storage.objects for each bucket:
  - INSERT: authenticated, bucket match, `(storage.foldername(name))[1] = (select auth.uid()::text)`
  - UPDATE: same pattern (for upsert/overwrite)
  - DELETE: same pattern (for cleanup)
- Note: SELECT is allowed by default on public buckets, no policy needed

**00000000000005_profile_updates.sql** -- Profile verification columns (PROF-04, PROF-10, ONBR-03):
- ALTER TABLE public.profiles ADD COLUMN IF NOT EXISTS:
  - `user_role` TEXT DEFAULT 'rider' CHECK (user_role IN ('rider', 'driver', 'both'))
  - `id_verified` BOOLEAN DEFAULT false
  - `id_document_url` TEXT
- Create `is_phone_verified(user_id UUID)` function: SECURITY DEFINER SET search_path = '', returns boolean from auth.users.phone_confirmed_at IS NOT NULL
- Note: Do NOT add a phone_verified column -- derive from auth.users at query time via the function (per research pitfall #4)

Run `supabase db push` or verify migration syntax is correct.
  </action>
  <verify>
Run `supabase migration list` to confirm all 6 migrations are recognized (3 existing + 3 new). Verify SQL syntax by running `supabase db reset` if local Supabase is available, or verify files parse correctly.
  </verify>
  <done>Three migration files exist with correct SQL. Vehicles table has full CRUD RLS. Storage buckets have user-scoped upload policies. Profiles table has user_role, id_verified, and id_document_url columns plus is_phone_verified function.</done>
</task>

<task type="auto">
  <name>Task 2: Create shared validation schemas, storage constants, and update database types</name>
  <files>
    packages/shared/src/validation/profile.ts
    packages/shared/src/constants/storage.ts
    packages/shared/src/types/database.ts
    packages/shared/src/index.ts
  </files>
  <action>
**packages/shared/src/validation/profile.ts** -- Zod schemas for profiles and vehicles:
- `DisplayNameSchema`: z.string().min(1).max(50) -- NOTE: DisplayNameSchema already exists in validation/auth.ts as z.string().min(2).max(50). Remove it from auth.ts and import from profile.ts instead (single source of truth). Update min to 1 to be more permissive for single-character names.
- `BioSchema`: z.string().max(300).optional()
- `SocialLinksSchema`: z.object({ instagram: z.string().url().optional().or(z.literal('')), facebook: z.string().url().optional().or(z.literal('')) })
- `UserRoleSchema`: z.enum(['rider', 'driver', 'both'])
- `ProfileUpdateSchema`: z.object({ display_name: DisplayNameSchema, bio: BioSchema, social_links: SocialLinksSchema.optional() })
- `VehicleSchema`: z.object({ make: z.string().min(1).max(50), model: z.string().min(1).max(50), color: z.string().min(1).max(30), license_plate: z.string().min(1).max(20) })
- Export all schemas and their inferred types (e.g., `type ProfileUpdate = z.infer<typeof ProfileUpdateSchema>`)

**packages/shared/src/constants/storage.ts** -- Storage bucket names and image constraints:
- `STORAGE_BUCKETS = { avatars: 'avatars', vehicles: 'vehicles' } as const`
- `IMAGE_CONSTRAINTS = { avatar: { maxSizeMB: 0.5, maxWidthOrHeight: 800 }, vehicle: { maxSizeMB: 1, maxWidthOrHeight: 1200 } } as const`
- `ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp'] as const`
- Helper functions: `getAvatarPath(userId: string)` returns `${userId}/avatar-${Date.now()}.jpg` (cache-busting per research pitfall #3), `getVehiclePhotoPath(userId: string, vehicleId: string)` returns `${userId}/${vehicleId}-${Date.now()}.jpg`

**packages/shared/src/types/database.ts** -- Update with vehicles table and profile columns:
- Add `vehicles` table type to Database.public.Tables with Row, Insert, Update, Relationships (foreignKeyName to profiles)
- Add to profiles Row/Insert/Update: `user_role: string` (Row), `user_role?: string` (Insert/Update), `id_verified: boolean` (Row), `id_verified?: boolean` (Insert/Update), `id_document_url: string | null` (Row), `id_document_url?: string | null` (Insert/Update)
- Add to Database.public.Functions: `is_phone_verified: { Args: { user_id: string }, Returns: boolean }`

**packages/shared/src/index.ts** -- Add re-exports:
- Export all from validation/profile.ts (schemas and types)
- Export all from constants/storage.ts
- Update DisplayNameSchema export: remove from auth.ts re-exports, add from profile.ts re-exports
- Ensure no duplicate exports

Run `pnpm turbo build` from root to verify shared package compiles.
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=@festapp/shared` to verify the shared package compiles without errors. Run `pnpm turbo typecheck` to verify no type errors across the monorepo.
  </verify>
  <done>Shared package exports ProfileUpdateSchema, VehicleSchema, UserRoleSchema, SocialLinksSchema, BioSchema, DisplayNameSchema (from profile.ts), STORAGE_BUCKETS, IMAGE_CONSTRAINTS, getAvatarPath, getVehiclePhotoPath, and updated Database types. Monorepo typechecks clean.</done>
</task>

</tasks>

<verification>
1. All 6 migrations listed by `supabase migration list`
2. `pnpm turbo typecheck` passes across all workspaces
3. Shared package exports are importable: `import { ProfileUpdateSchema, VehicleSchema, STORAGE_BUCKETS, getAvatarPath } from '@festapp/shared'`
4. Database types include vehicles table and updated profiles columns
</verification>

<success_criteria>
- Vehicles table migration exists with proper schema and RLS
- Storage buckets migration creates 'avatars' and 'vehicles' with user-scoped policies
- Profiles migration adds user_role, id_verified, id_document_url columns
- is_phone_verified SQL function derives verification from auth.users
- Zod schemas validate profile and vehicle data
- Storage constants provide bucket names, constraints, and path helpers
- Database types match the new schema
- Monorepo compiles without type errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-profiles-identity/02-01-SUMMARY.md`
</output>
