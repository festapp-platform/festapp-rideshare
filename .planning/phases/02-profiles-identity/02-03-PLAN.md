---
phase: 02-profiles-identity
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/app/(app)/vehicles/page.tsx
  - apps/web/app/(app)/vehicles/new/page.tsx
  - apps/mobile/app/vehicles/index.tsx
  - apps/mobile/app/vehicles/new.tsx
autonomous: true

must_haves:
  truths:
    - "Driver can add a vehicle with make, model, color, and license plate"
    - "Driver can upload a car photo that is compressed and stored in Supabase Storage"
    - "Driver can view their vehicles list and edit or delete existing vehicles"
    - "Vehicle info (including photo) persists in the vehicles table"
  artifacts:
    - path: "apps/web/app/(app)/vehicles/page.tsx"
      provides: "Vehicle list page for web"
      contains: "vehicles"
    - path: "apps/web/app/(app)/vehicles/new/page.tsx"
      provides: "Add/edit vehicle form for web"
      contains: "VehicleSchema"
    - path: "apps/mobile/app/vehicles/index.tsx"
      provides: "Vehicle list screen for mobile"
      contains: "vehicles"
    - path: "apps/mobile/app/vehicles/new.tsx"
      provides: "Add/edit vehicle form for mobile"
      contains: "VehicleSchema"
  key_links:
    - from: "apps/web/app/(app)/vehicles/new/page.tsx"
      to: "apps/web/lib/supabase/storage.ts"
      via: "import uploadVehiclePhoto"
      pattern: "import.*uploadVehiclePhoto"
    - from: "apps/mobile/app/vehicles/new.tsx"
      to: "apps/mobile/lib/image-upload.ts"
      via: "import pickAndUploadVehiclePhoto"
      pattern: "import.*pickAndUploadVehiclePhoto"
---

<objective>
Build vehicle management UI for drivers on both web and mobile.

Purpose: Drivers need to add and manage vehicle information (PROF-07, PROF-08, PROF-09) with car photos. Vehicle data will be shown to passengers on ride details in Phase 3.

Output: Vehicle list and add/edit pages on both platforms, using the upload helpers from 02-02 for car photos.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profiles-identity/02-RESEARCH.md
@.planning/phases/02-profiles-identity/02-01-SUMMARY.md
@packages/shared/src/validation/profile.ts
@packages/shared/src/constants/storage.ts
@packages/shared/src/constants/design.ts
@apps/web/lib/supabase/storage.ts
@apps/mobile/lib/image-upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build web vehicle list and add/edit pages</name>
  <files>
    apps/web/app/(app)/vehicles/page.tsx
    apps/web/app/(app)/vehicles/new/page.tsx
  </files>
  <action>
**apps/web/app/(app)/vehicles/page.tsx** -- Vehicle list page ('use client'):
- Fetch user's vehicles: supabase.from('vehicles').select().eq('owner_id', user.id).order('is_primary', { ascending: false })
- Display as cards: each card shows car photo (or placeholder), make + model as title, color, license plate, primary badge if is_primary
- "Add Vehicle" button links to /vehicles/new
- Each card has Edit (links to /vehicles/new?id=vehicleId) and Delete actions
- Delete: confirm inline, then supabase.from('vehicles').delete().eq('id', vehicleId), also delete storage files at `${userId}/${vehicleId}*`
- Empty state: "No vehicles yet. Add your car to start offering rides." with add button
- Style with existing CSS custom properties, card layout with rounded-2xl border

**apps/web/app/(app)/vehicles/new/page.tsx** -- Add/edit vehicle form ('use client'):
- If `?id=` query param exists, fetch existing vehicle and pre-fill form (edit mode)
- react-hook-form with zodResolver(VehicleSchema), fields: make, model, color, license_plate
- Car photo: file input (hidden, triggered by photo area click), preview with URL.createObjectURL
- On submit (new): insert into vehicles table with owner_id = user.id, if photo selected call uploadVehiclePhoto with the new vehicle ID, update vehicle.photo_url
- On submit (edit): update vehicle row, if new photo selected upload and update photo_url
- Set is_primary = true if this is the user's first vehicle
- After save: redirect to /vehicles
- Loading/error states, inline success message
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web` to verify build. Navigate to /vehicles to see empty state, then /vehicles/new to test add form.
  </verify>
  <done>Web vehicle list shows user's vehicles with photo, details, edit/delete actions. Add/edit form validates with VehicleSchema and uploads car photo to Supabase Storage.</done>
</task>

<task type="auto">
  <name>Task 2: Build mobile vehicle list and add/edit screens</name>
  <files>
    apps/mobile/app/vehicles/index.tsx
    apps/mobile/app/vehicles/new.tsx
  </files>
  <action>
**apps/mobile/app/vehicles/index.tsx** -- Vehicle list screen:
- Create as a Stack screen under `app/vehicles/` directory (not a tab -- accessed from profile)
- Add a `_layout.tsx` in `app/vehicles/` with Stack navigator and appropriate header titles
- Fetch user's vehicles same as web
- FlatList of vehicle cards: Image (or placeholder), make + model, color, license plate, primary badge
- "Add Vehicle" button at top or as FAB
- Swipe-to-delete or long-press with confirmation Alert
- Edit: navigate to /vehicles/new?id=vehicleId (pass via router.push with params)
- Empty state with add prompt
- Style with design tokens (theme.surface, theme.border, etc.)

**apps/mobile/app/vehicles/new.tsx** -- Add/edit vehicle form:
- Read `id` from route params (useLocalSearchParams). If present, fetch and pre-fill (edit mode)
- react-hook-form with zodResolver(VehicleSchema)
- TextInput fields for make, model, color, license_plate
- Car photo: TouchableOpacity triggers pickAndUploadVehiclePhoto. Show Image preview or placeholder
- On submit: same logic as web (insert or update, upload photo if selected)
- Set is_primary = true if first vehicle
- After save: router.back() to vehicles list
- ActivityIndicator during save, inline error display
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=mobile` to verify build. Check that the vehicles directory has _layout.tsx, index.tsx, and new.tsx.
  </verify>
  <done>Mobile vehicle list shows user's vehicles. Add/edit screen validates with VehicleSchema and uploads car photo via expo-image-picker + expo-image-manipulator. Delete removes vehicle and storage files.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes for both web and mobile
2. Web /vehicles page shows vehicle list (or empty state)
3. Web /vehicles/new creates a new vehicle with photo upload
4. Mobile vehicles screen accessible from profile, shows list
5. Mobile add vehicle screen creates vehicle with photo
6. Edit and delete work on both platforms
</verification>

<success_criteria>
- Drivers can add vehicles with make, model, color, license plate, and car photo
- Car photos are compressed client-side before upload
- Vehicle list shows all user's vehicles with photos
- Edit updates existing vehicle data and photo
- Delete removes vehicle record and associated storage files
- Both platforms follow existing design system conventions
</success_criteria>

<output>
After completion, create `.planning/phases/02-profiles-identity/02-03-SUMMARY.md`
</output>
