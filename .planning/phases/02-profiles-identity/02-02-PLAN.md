---
phase: 02-profiles-identity
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/web/lib/supabase/storage.ts
  - apps/web/app/(app)/profile/page.tsx
  - apps/mobile/lib/image-upload.ts
  - apps/mobile/app/(tabs)/profile/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit their display name and bio on the profile page and changes persist after refresh"
    - "User can upload an avatar photo that is compressed client-side and stored in Supabase Storage"
    - "Profile page shows the user's current avatar, display name, and bio with an edit mode toggle"
    - "Avatar upload works on both web (file input + browser-image-compression) and mobile (expo-image-picker + expo-image-manipulator)"
  artifacts:
    - path: "apps/web/lib/supabase/storage.ts"
      provides: "Web image compression and Supabase Storage upload helpers"
      exports: ["uploadAvatar", "uploadVehiclePhoto"]
    - path: "apps/web/app/(app)/profile/page.tsx"
      provides: "Profile view and edit page for web"
      contains: "ProfileUpdateSchema"
    - path: "apps/mobile/lib/image-upload.ts"
      provides: "Mobile image picking, compression, and upload helpers"
      exports: ["pickAndUploadAvatar", "pickAndUploadVehiclePhoto"]
    - path: "apps/mobile/app/(tabs)/profile/index.tsx"
      provides: "Profile view and edit screen for mobile"
      contains: "ProfileUpdateSchema"
  key_links:
    - from: "apps/web/lib/supabase/storage.ts"
      to: "supabase storage avatars bucket"
      via: "supabase.storage.from('avatars').upload"
      pattern: "from\\('avatars'\\)"
    - from: "apps/web/app/(app)/profile/page.tsx"
      to: "apps/web/lib/supabase/storage.ts"
      via: "import uploadAvatar"
      pattern: "import.*uploadAvatar"
    - from: "apps/mobile/lib/image-upload.ts"
      to: "supabase storage avatars bucket"
      via: "supabase.storage.from('avatars').upload"
      pattern: "from\\('avatars'\\)"
---

<objective>
Build the profile editing UI with avatar upload for both web and mobile platforms.

Purpose: Users need to create and maintain their profiles (PROF-01, PROF-02, PROF-09). The avatar upload pipeline is the most technically complex part -- client-side compression before Supabase Storage upload.

Output: Profile edit pages on web and mobile with image upload helpers, replacing current placeholder screens.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profiles-identity/02-RESEARCH.md
@.planning/phases/02-profiles-identity/02-01-SUMMARY.md
@apps/web/app/(app)/profile/page.tsx
@apps/mobile/app/(tabs)/profile/index.tsx
@apps/web/lib/supabase/client.ts
@apps/mobile/lib/supabase.ts
@packages/shared/src/validation/profile.ts
@packages/shared/src/constants/storage.ts
@packages/shared/src/constants/design.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create image upload helpers and build web profile page</name>
  <files>
    apps/web/lib/supabase/storage.ts
    apps/web/app/(app)/profile/page.tsx
  </files>
  <action>
**Install dependency:**
```bash
cd apps/web && npm install browser-image-compression
```

**apps/web/lib/supabase/storage.ts** -- Image upload helpers for web:
- `uploadAvatar(file: File, userId: string): Promise<string>` -- compress with browser-image-compression (maxSizeMB: 0.5, maxWidthOrHeight: 800, useWebWorker: true), upload to Supabase Storage 'avatars' bucket at `getAvatarPath(userId)` with `upsert: true`, `contentType: 'image/jpeg'`, update profiles.avatar_url with public URL, return the URL
- `uploadVehiclePhoto(file: File, userId: string, vehicleId: string): Promise<string>` -- compress (maxSizeMB: 1, maxWidthOrHeight: 1200), upload to 'vehicles' bucket at `getVehiclePhotoPath(userId, vehicleId)` with upsert, return public URL
- Both functions use `createClient()` from `@/lib/supabase/client`, import constraints from `@festapp/shared`
- Handle errors: throw descriptive errors for compression failure, upload failure, profile update failure

**apps/web/app/(app)/profile/page.tsx** -- Replace placeholder with full profile page:
- Make it a client component ('use client')
- Fetch current user profile on mount via Supabase client (profiles table where id = user.id)
- Display mode (default): show avatar (or placeholder icon), display name, bio, settings link (keep existing)
- Edit mode (toggle): react-hook-form with zodResolver(ProfileUpdateSchema), inputs for display_name and bio
- Avatar: file input (hidden, triggered by clicking avatar), preview with URL.createObjectURL, upload on save via `uploadAvatar`
- On save: call supabase.from('profiles').update() with form data, refresh profile state
- Loading states: skeleton while profile loads, spinner on save button
- Style with existing CSS custom properties (bg-surface, text-text-main, etc.) matching Phase 1 design system
- Keep the settings link at the bottom (same as current placeholder)
- Show toast/inline message on save success/error (simple inline message, not a toast library)
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web` to verify web app builds. Manually verify the profile page renders at /profile with edit functionality.
  </verify>
  <done>Web profile page shows user's avatar, display name, and bio. User can toggle edit mode, change name/bio, upload a new avatar (compressed client-side), and save. Changes persist after page refresh.</done>
</task>

<task type="auto">
  <name>Task 2: Create mobile image upload helpers and build mobile profile screen</name>
  <files>
    apps/mobile/lib/image-upload.ts
    apps/mobile/app/(tabs)/profile/index.tsx
  </files>
  <action>
**Install dependencies:**
```bash
cd apps/mobile && npx expo install expo-image-picker expo-image-manipulator
```

**apps/mobile/lib/image-upload.ts** -- Image picking and upload helpers for mobile:
- `pickAndUploadAvatar(userId: string): Promise<string | null>` -- launch ImagePicker.launchImageLibraryAsync with mediaTypes: ['images'], allowsEditing: true, aspect: [1,1], quality: 0.8. If canceled return null. Resize with ImageManipulator.manipulateAsync (width: 800, compress: 0.7, JPEG format). Convert to blob via fetch(uri).then(r => r.blob()). Upload to 'avatars' bucket at getAvatarPath(userId) with upsert. Update profiles.avatar_url. Return public URL.
- `pickAndUploadVehiclePhoto(userId: string, vehicleId: string): Promise<string | null>` -- same pattern but aspect: [4,3], resize width: 1200, upload to 'vehicles' bucket at getVehiclePhotoPath(userId, vehicleId)
- Import supabase client from `@/lib/supabase`, import constants from `@festapp/shared`
- Handle permission: check ImagePicker.requestMediaLibraryPermissionsAsync(), show alert if denied

**apps/mobile/app/(tabs)/profile/index.tsx** -- Replace placeholder with full profile screen:
- Fetch profile on mount (supabase.from('profiles').select().eq('id', user.id).single())
- Display mode: avatar image (or placeholder icon), display name, bio, settings button (keep existing)
- Edit mode: toggle via edit button in header area. Use react-hook-form with zodResolver(ProfileUpdateSchema)
- TextInput for display_name, multiline TextInput for bio (max 300 chars with counter)
- Avatar: TouchableOpacity on avatar triggers pickAndUploadAvatar, show ActivityIndicator during upload
- On save: update profile via supabase, exit edit mode, refresh state
- Style with design tokens from @festapp/shared (theme.primary, theme.surface, etc.) matching Phase 1 patterns
- Keep settings button at bottom (same as current)
- Show inline success/error message after save
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=mobile` to verify mobile app builds. Check that expo-image-picker and expo-image-manipulator are in package.json.
  </verify>
  <done>Mobile profile screen shows user's avatar, display name, and bio. User can toggle edit mode, change name/bio, pick and upload a new avatar (resized client-side), and save. Changes persist after app restart.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes for both web and mobile
2. Web profile page at /profile shows current user data and supports editing
3. Mobile profile screen shows current user data and supports editing
4. Avatar upload compresses images before uploading to Supabase Storage
5. Profile changes persist across page refresh / app restart
</verification>

<success_criteria>
- Web and mobile profile pages replace placeholders with functional edit UIs
- Avatar upload works via browser-image-compression (web) and expo-image-manipulator (mobile)
- Profile data (display_name, bio, avatar_url) persists in Supabase profiles table
- Image compression reduces file size before upload (max 500KB avatar)
- Both platforms show loading states during fetch and save operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-profiles-identity/02-02-SUMMARY.md`
</output>
