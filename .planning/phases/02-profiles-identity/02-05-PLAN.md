---
phase: 02-profiles-identity
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - packages/shared/src/constants/onboarding.ts
  - packages/shared/src/index.ts
  - apps/web/app/(app)/onboarding/page.tsx
  - apps/mobile/app/onboarding.tsx
autonomous: true

must_haves:
  truths:
    - "New user sees profile creation step (name + photo) after welcome during onboarding"
    - "New user sees role selection step (rider, driver, both) during onboarding"
    - "If driver role selected, user sees optional vehicle setup step during onboarding"
    - "Onboarding saves profile data, role, and optional vehicle to Supabase"
    - "Existing users who already completed onboarding are not forced through new steps"
  artifacts:
    - path: "packages/shared/src/constants/onboarding.ts"
      provides: "Extended onboarding step definitions including profile, role, and vehicle steps"
      contains: "profile"
    - path: "apps/web/app/(app)/onboarding/page.tsx"
      provides: "Extended web onboarding with profile + role + vehicle steps"
      contains: "profile_onboarding_completed"
    - path: "apps/mobile/app/onboarding.tsx"
      provides: "Extended mobile onboarding with profile + role + vehicle steps"
      contains: "profile_onboarding_completed"
  key_links:
    - from: "apps/web/app/(app)/onboarding/page.tsx"
      to: "supabase profiles table"
      via: "profiles update with display_name and user_role"
      pattern: "from\\('profiles'\\).update"
    - from: "apps/mobile/app/onboarding.tsx"
      to: "supabase profiles table"
      via: "profiles update with display_name and user_role"
      pattern: "from\\('profiles'\\).update"
---

<objective>
Extend the onboarding flow to include profile creation, role selection, and optional vehicle setup.

Purpose: New users need guided profile setup (ONBR-02, ONBR-03, ONBR-04) to ensure they have a display name, photo, and role before using the app. This builds on the existing permissions-focused onboarding.

Output: Extended onboarding flows on both platforms with 3 new steps inserted between welcome and permissions.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-profiles-identity/02-RESEARCH.md
@.planning/phases/02-profiles-identity/02-01-SUMMARY.md
@.planning/phases/02-profiles-identity/02-02-SUMMARY.md
@.planning/phases/02-profiles-identity/02-03-SUMMARY.md
@packages/shared/src/constants/onboarding.ts
@apps/web/app/(app)/onboarding/page.tsx
@apps/mobile/app/onboarding.tsx
@apps/web/lib/supabase/storage.ts
@apps/mobile/lib/image-upload.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend onboarding step definitions and update web onboarding flow</name>
  <files>
    packages/shared/src/constants/onboarding.ts
    packages/shared/src/index.ts
    apps/web/app/(app)/onboarding/page.tsx
  </files>
  <action>
**packages/shared/src/constants/onboarding.ts** -- Add new steps:
- Add new step types to OnboardingStepType: 'profile' | 'role' | 'vehicle'
- Add `PROFILE_ONBOARDING_COMPLETED_KEY = 'profile_onboarding_completed'` (separate from existing ONBOARDING_COMPLETED_KEY per research pitfall #5 -- existing users keep their completed state)
- Add new steps to onboardingSteps array (insert after 'welcome', before 'location'):
  1. `{ id: 'profile', title: 'Set up your profile', description: 'Add your name and photo so others know who they are riding with.', buttonText: 'Continue', illustration: '#A8D8B9' }` (ONBR-02)
  2. `{ id: 'role', title: 'How will you use Rideshare?', description: 'Let us know if you want to offer rides, find rides, or both. You can change this anytime.', buttonText: 'Continue', illustration: '#F4C2C2' }` (ONBR-03)
  3. `{ id: 'vehicle', title: 'Add your vehicle', description: 'Add your car details so passengers know what to look for. You can skip this and add later from your profile.', buttonText: 'Add Vehicle', skipText: 'Skip for now', illustration: '#B5D5E8' }` (ONBR-04)
- Export PROFILE_ONBOARDING_COMPLETED_KEY from index.ts

**apps/web/app/(app)/onboarding/page.tsx** -- Extend with new steps:
- Keep existing structure but handle new step types
- Filter logic: skip 'location' (existing), skip 'vehicle' if user did not select 'driver' or 'both' role in the role step
- Profile step (ONBR-02): show display_name text input and avatar upload area (file input). On "Continue": upload avatar if selected (via uploadAvatar), update profile display_name. Validation: name is required (use DisplayNameSchema).
- Role step (ONBR-03): show 3 large selectable cards: "I want to ride" (rider), "I want to drive" (driver), "Both" (both). On "Continue": update profile.user_role. Store selected role in component state to conditionally show vehicle step.
- Vehicle step (ONBR-04): show VehicleSchema form (make, model, color, license_plate) + car photo upload. On "Add Vehicle": create vehicle record, upload photo. Skip button skips without saving.
- Ready step: save PROFILE_ONBOARDING_COMPLETED_KEY to localStorage (in addition to existing ONBOARDING_COMPLETED_KEY), then navigate to /search
- Onboarding detection: check if PROFILE_ONBOARDING_COMPLETED_KEY exists. If existing user already has ONBOARDING_COMPLETED_KEY=true but no PROFILE_ONBOARDING_COMPLETED_KEY, they should see ONLY the new steps (profile, role, vehicle, ready) -- not the welcome/permissions steps again. If both keys exist, skip onboarding entirely.
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web` to verify build. Check that the onboarding flow includes profile, role, and conditional vehicle steps.
  </verify>
  <done>Web onboarding includes profile creation (name + avatar), role selection (rider/driver/both), conditional vehicle setup, and properly handles existing users who completed old onboarding.</done>
</task>

<task type="auto">
  <name>Task 2: Update mobile onboarding flow with profile, role, and vehicle steps</name>
  <files>
    apps/mobile/app/onboarding.tsx
  </files>
  <action>
**apps/mobile/app/onboarding.tsx** -- Extend with new steps:
- Same logic as web but adapted for mobile UI patterns
- The FlatList horizontal swipe approach needs adjustment since new steps have form inputs. Two approaches:
  Option A: Keep FlatList but make profile/role/vehicle steps non-swipeable (only advance via button)
  Option B: Switch to a simple state machine with animated transitions
  **Use Option A** -- keep FlatList but disable scrollEnabled during form steps. Re-enable for passive steps.
- Profile step: TextInput for display_name, TouchableOpacity on avatar area triggers pickAndUploadAvatar. On "Continue": validate name, upload avatar if selected, update profile.
- Role step: 3 large TouchableOpacity cards with icons (car for driver, passenger seat for rider, both icons for both). Visual selection state (highlighted border). On "Continue": update profile.user_role.
- Vehicle step: TextInput fields for make, model, color, license_plate + photo picker. On "Add Vehicle": create vehicle, upload photo. "Skip for now" advances without saving.
- Filter steps: skip 'vehicle' if role is not 'driver' or 'both'
- Ready step: save PROFILE_ONBOARDING_COMPLETED_KEY to AsyncStorage + ONBOARDING_COMPLETED_KEY, navigate to /(tabs)/search
- Same backward compat: check PROFILE_ONBOARDING_COMPLETED_KEY to determine if new onboarding is needed. Existing users see only new steps.
- Step indicators (dots) should reflect the filtered step count
  </action>
  <verify>
Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=mobile` to verify build. Verify the onboarding screen handles all step types.
  </verify>
  <done>Mobile onboarding includes profile creation (name + avatar via image picker), role selection (3 tappable cards), conditional vehicle setup, and handles existing users correctly.</done>
</task>

</tasks>

<verification>
1. `pnpm turbo build` passes for both web and mobile
2. New user onboarding flow: welcome -> profile (name+avatar) -> role -> [vehicle if driver] -> location -> notifications -> ready
3. Profile step saves display_name and avatar_url to Supabase
4. Role step saves user_role to profiles table
5. Vehicle step creates a vehicle record with photo (if not skipped)
6. Existing users with ONBOARDING_COMPLETED_KEY but no PROFILE_ONBOARDING_COMPLETED_KEY see only new steps
7. Users with both keys skip onboarding entirely
</verification>

<success_criteria>
- Onboarding guides new users through profile creation and role selection
- Driver/both role users see optional vehicle setup step
- Profile data and role persist in Supabase
- Vehicle created during onboarding appears in vehicle list
- Backward compatible: existing users prompted for new steps without repeating permissions
- Step indicators correctly reflect filtered step count
</success_criteria>

<output>
After completion, create `.planning/phases/02-profiles-identity/02-05-SUMMARY.md`
</output>
