---
phase: 10-web-platform-seo
plan: 04
type: execute
wave: 2
depends_on: [01, 02, 03]
files_modified:
  - apps/web/__tests__/pwa.test.ts
  - apps/web/__tests__/seo.test.ts
  - apps/web/__tests__/rate-limit.test.ts
  - apps/web/app/(app)/components/onesignal-init.tsx
  - apps/web/next.config.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests verify PWA manifest, service worker registration, and install banner behavior"
    - "Unit tests verify OG meta tag generation for ride and profile pages"
    - "Unit tests verify rate limiting logic (allow, reject, retry-after)"
    - "Web push notifications via OneSignal work from authenticated pages"
    - "Web app feature parity verified for core flows"
  artifacts:
    - path: "apps/web/__tests__/pwa.test.ts"
      provides: "PWA test suite"
      contains: "manifest"
    - path: "apps/web/__tests__/seo.test.ts"
      provides: "SEO and OG meta test suite"
      contains: "openGraph"
    - path: "apps/web/__tests__/rate-limit.test.ts"
      provides: "Rate limiting test suite"
      contains: "checkRateLimit"
  key_links:
    - from: "apps/web/__tests__/pwa.test.ts"
      to: "apps/web/lib/register-sw.ts"
      via: "imports registerServiceWorker"
      pattern: "register-sw"
    - from: "apps/web/__tests__/seo.test.ts"
      to: "apps/web/lib/short-id.ts"
      via: "tests short ID format"
      pattern: "short-id|shortId"
---

<objective>
Write unit and integration tests for all Phase 10 deliverables, finalize web push notifications, and verify feature parity.

Purpose: Testing requirement for Phase 10. Verify PWA, SEO, rate limiting, and web push all work correctly. WEB-02 (feature parity) and WEB-06 (web push) addressed here.

Output: Test suites for PWA, SEO, and rate limiting. OneSignal web push finalization.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-web-platform-seo/10-01-SUMMARY.md
@.planning/phases/10-web-platform-seo/10-02-SUMMARY.md
@.planning/phases/10-web-platform-seo/10-03-SUMMARY.md
@apps/web/vitest.config.ts
@apps/web/__tests__
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for PWA, SEO, and rate limiting</name>
  <files>
    apps/web/__tests__/pwa.test.ts
    apps/web/__tests__/seo.test.ts
    apps/web/__tests__/rate-limit.test.ts
  </files>
  <action>
1. Create `apps/web/__tests__/pwa.test.ts`:
   Test the PWA infrastructure (not browser APIs -- those need E2E):
   - **manifest.json validation**: Read and parse `public/manifest.json`, verify:
     - `name` is "Festapp Rideshare"
     - `display` is "standalone"
     - `start_url` is "/search"
     - `icons` array has entries with sizes "192x192" and "512x512"
     - `theme_color` is set
   - **Service worker file exists**: Verify `public/sw.js` exists and contains `caches.open`
   - **Offline page exists**: Verify `public/offline.html` exists and contains "offline" text
   - **registerServiceWorker function**: Import from `@/lib/register-sw`, mock `navigator.serviceWorker`, verify it calls `register('/sw.js')`
   - **Install banner logic**: Test that:
     - Banner hides when `display-mode: standalone` matches (mock matchMedia)
     - Banner hides when localStorage `pwa-install-dismissed` is "true"
     - Banner shows when `beforeinstallprompt` event is available and not dismissed
   - Use vitest with happy-dom environment

2. Create `apps/web/__tests__/seo.test.ts`:
   Test SEO utilities and metadata:
   - **Short ID format**: Import/verify short ID character set contains only unambiguous chars (no 0, 1, i, l, o)
   - **Short ID length**: Verify generated IDs are 6 characters
   - **SEO constants**: Import from `@festapp/shared`, verify SITE_URL, SITE_NAME, SITE_DESCRIPTION are non-empty strings
   - **OG meta structure for rides**: Mock a ride object, call the metadata generation logic, verify:
     - Title contains origin and destination
     - Description contains price and seats
     - openGraph.type is "website"
     - twitter.card is "summary_large_image"
   - **robots.txt content**: Verify Disallow paths include /api/, /admin/, /settings/
   - **Sitemap structure**: Verify sitemap entries have url, lastModified, changeFrequency

3. Create `apps/web/__tests__/rate-limit.test.ts`:
   Test rate limiting logic in isolation (mock Supabase):
   - **checkRateLimit allows requests under limit**: Mock supabase.from('api_rate_limits') to return count < maxRequests, verify `{ limited: false }`
   - **checkRateLimit blocks requests over limit**: Mock to return count >= maxRequests, verify `{ limited: true, retryAfter: number }`
   - **rateLimitResponse returns correct status**: Verify status 429, Retry-After header present, JSON body has error message
   - **Identifier extraction**: Test x-forwarded-for extraction from Request headers
   - **Window calculation**: Verify window boundaries are computed correctly (floored to windowSeconds)

Use inline JSX test pattern (no hooks) where testing components, consistent with Phase 09 testing decisions. Mock Supabase client consistently across test files.

Target: ~25-35 tests total across all 3 files.
  </action>
  <verify>
    - `cd /Users/miakh/source/festapp-rideshare && pnpm --filter @festapp/web test -- --run` passes all tests
    - `grep -c "test\|it(" apps/web/__tests__/pwa.test.ts` shows 8+ tests
    - `grep -c "test\|it(" apps/web/__tests__/seo.test.ts` shows 8+ tests
    - `grep -c "test\|it(" apps/web/__tests__/rate-limit.test.ts` shows 8+ tests
  </verify>
  <done>
    All PWA tests pass: manifest validation, SW registration, install banner logic. All SEO tests pass: short ID format, OG meta structure, robots/sitemap. All rate limit tests pass: allow/block/retry-after/identifier extraction. Total 25+ tests passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Web push finalization and feature parity check</name>
  <files>
    apps/web/app/(app)/components/onesignal-init.tsx
    apps/web/next.config.ts
  </files>
  <action>
1. Review and finalize `apps/web/app/(app)/components/onesignal-init.tsx`:
   - Ensure OneSignal initialization includes:
     - `appId` from env var `NEXT_PUBLIC_ONESIGNAL_APP_ID`
     - `allowLocalhostAsSecureOrigin: true` for dev
     - `serviceWorkerPath`: "/OneSignalSDKWorker.js" (already exists in public/)
     - `serviceWorkerUpdaterPath`: "/OneSignalSDKWorker.js"
   - After initialization, if user is authenticated:
     - Set external user ID: `OneSignal.login(userId)`
     - Set email tag if available
   - On unmount or logout: no explicit cleanup needed (OneSignal persists)
   - Verify the component is already rendered in (app)/layout.tsx (it is -- from Phase 05-05)
   - If the existing implementation already covers all of the above, make minimal/no changes

2. Update `apps/web/next.config.ts` for PWA and security headers:
   - Add `headers()` async function to return security headers:
     ```typescript
     async headers() {
       return [
         {
           source: '/(.*)',
           headers: [
             { key: 'X-Content-Type-Options', value: 'nosniff' },
             { key: 'X-Frame-Options', value: 'DENY' },
             { key: 'X-XSS-Protection', value: '1; mode=block' },
             { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
           ],
         },
         {
           source: '/sw.js',
           headers: [
             { key: 'Cache-Control', value: 'public, max-age=0, must-revalidate' },
             { key: 'Service-Worker-Allowed', value: '/' },
           ],
         },
       ];
     },
     ```
   - Keep existing `transpilePackages` config

3. Feature parity check (WEB-02):
   - Verify all core flows exist in the web app by checking page files:
     - Search: /search page exists
     - Book: /rides/[id] page with BookingButton exists
     - Chat: /messages page exists
     - Profile: /profile page exists
   - These are all already built in prior phases. This task confirms they exist and documents the parity status in the summary
   - If any core flow page is missing, create a placeholder page with TODO

NOTE: WEB-06 (web push) was already implemented in Phase 05-05 (OneSignal web init). This task only validates it works correctly with the new service worker and doesn't need reimplementation.
  </action>
  <verify>
    - `grep "OneSignal" apps/web/app/(app)/components/onesignal-init.tsx` shows initialization
    - `grep "X-Content-Type-Options" apps/web/next.config.ts` shows security headers
    - `grep "Service-Worker-Allowed" apps/web/next.config.ts` shows SW header
    - `pnpm --filter @festapp/web build` succeeds
    - `cd /Users/miakh/source/festapp-rideshare && pnpm --filter @festapp/web test -- --run` passes
  </verify>
  <done>
    OneSignal web push works with new service worker (non-conflicting). Security headers applied via next.config.ts. Service worker served with correct Cache-Control. Feature parity confirmed: search, book, chat, profile all exist in web app. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @festapp/web test -- --run` passes all tests (new + existing)
- `pnpm --filter @festapp/web build` succeeds
- OneSignal initialization does not conflict with new service worker
- Security headers present in next.config.ts
- Feature parity documented for all core flows
</verification>

<success_criteria>
- 25+ new tests passing across PWA, SEO, and rate limiting test files
- All existing tests still pass
- Web push notifications functional (OneSignal + service worker coexist)
- Security headers configured in Next.js
- Feature parity confirmed for search, book, chat, profile flows
- `pnpm --filter @festapp/web build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/10-web-platform-seo/10-04-SUMMARY.md`
</output>
