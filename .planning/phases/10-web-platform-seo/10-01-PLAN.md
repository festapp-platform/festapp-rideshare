---
phase: 10-web-platform-seo
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/public/manifest.json
  - apps/web/public/sw.js
  - apps/web/app/layout.tsx
  - apps/web/components/pwa-install-prompt.tsx
  - apps/web/lib/register-sw.ts
  - apps/web/app/(app)/components/pwa-install-banner.tsx
  - apps/web/app/(app)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Web app is installable as a PWA on mobile and desktop via browser install prompt"
    - "Service worker caches static assets and app shell for offline support"
    - "Mobile browser users see a prominent install banner prompting PWA installation"
    - "Offline fallback page shows when user has no network connectivity"
  artifacts:
    - path: "apps/web/public/manifest.json"
      provides: "PWA manifest with app name, icons, theme color, display standalone"
      contains: "display.*standalone"
    - path: "apps/web/public/sw.js"
      provides: "Service worker with cache-first strategy for static assets"
      contains: "caches.open"
    - path: "apps/web/components/pwa-install-prompt.tsx"
      provides: "Client component that registers service worker on mount"
      contains: "serviceWorker.register"
    - path: "apps/web/app/(app)/components/pwa-install-banner.tsx"
      provides: "Install prompt banner for mobile browsers"
      contains: "beforeinstallprompt"
  key_links:
    - from: "apps/web/app/layout.tsx"
      to: "apps/web/public/manifest.json"
      via: "link rel=manifest in head"
      pattern: "rel.*manifest"
    - from: "apps/web/components/pwa-install-prompt.tsx"
      to: "apps/web/public/sw.js"
      via: "navigator.serviceWorker.register"
      pattern: "serviceWorker\\.register"
---

<objective>
Make the web app a fully installable PWA with service worker caching and install prompt.

Purpose: WEB-01 (installable PWA), WEB-07 (service worker caching), PLAT-18 (install prompt banner). Users on mobile browsers should be prompted to install the app, and the app should work offline for previously visited pages.

Output: manifest.json, service worker, install prompt banner, offline fallback page.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/layout.tsx
@apps/web/app/(app)/layout.tsx
@apps/web/next.config.ts
@apps/web/public/OneSignalSDKWorker.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: PWA manifest, service worker, and offline fallback</name>
  <files>
    apps/web/public/manifest.json
    apps/web/public/sw.js
    apps/web/public/offline.html
    apps/web/app/layout.tsx
    apps/web/components/pwa-install-prompt.tsx
    apps/web/lib/register-sw.ts
  </files>
  <action>
1. Create `apps/web/public/manifest.json`:
   - `name`: "Festapp Rideshare", `short_name`: "Rideshare"
   - `description`: "Free community ride-sharing platform"
   - `start_url`: "/search", `scope`: "/"
   - `display`: "standalone", `orientation`: "portrait-primary"
   - `theme_color`: "#6B8F71" (pastel green from design tokens), `background_color`: "#FAFAFA"
   - `icons`: array with placeholder paths `/icons/icon-192.png` and `/icons/icon-512.png` (sizes "192x192" and "512x512", type "image/png", purpose "any maskable")
   - `categories`: ["travel", "social"]

2. Create `apps/web/public/sw.js` (vanilla JS, not TypeScript):
   - Cache name: `festapp-v1`
   - On `install`: precache offline fallback page `/offline.html`
   - On `activate`: clean up old caches (any cache not matching current version)
   - On `fetch`:
     - For navigation requests: network-first with offline fallback (try network, on failure serve `/offline.html` from cache)
     - For static assets (`_next/static/`, images, fonts): cache-first (serve from cache, update cache in background)
     - For API requests (`/api/`, `supabase`): network-only (never cache)
   - IMPORTANT: Do NOT interfere with OneSignalSDKWorker.js -- check `event.request.url` does not include `OneSignal`

3. Create `apps/web/public/offline.html`:
   - Simple standalone HTML page (no React) with inline CSS
   - Shows "You're offline" message with Festapp branding
   - "Try again" button that calls `window.location.reload()`
   - Uses same pastel green color scheme

4. Create `apps/web/lib/register-sw.ts`:
   - Export `registerServiceWorker()` function
   - Checks `'serviceWorker' in navigator`
   - Registers `/sw.js` with scope `/`
   - Logs registration success/failure to console

5. Create `apps/web/components/pwa-install-prompt.tsx`:
   - "use client" component
   - On mount, call `registerServiceWorker()`
   - This is a headless component (renders null) -- just handles SW registration
   - Import from `@/lib/register-sw`

6. Update `apps/web/app/layout.tsx`:
   - Add `<link rel="manifest" href="/manifest.json" />` in head metadata
   - Add `<meta name="theme-color" content="#6B8F71" />` to metadata export
   - Add `<meta name="apple-mobile-web-app-capable" content="yes" />`
   - Add `<meta name="apple-mobile-web-app-status-bar-style" content="default" />`
   - Add `<meta name="apple-mobile-web-app-title" content="Rideshare" />`
   - Import and render `<PwaInstallPrompt />` inside body (after children)
   - Use Next.js metadata export for the link/meta tags where possible

IMPORTANT: The existing OneSignalSDKWorker.js in public/ must remain untouched. The new sw.js must not conflict with it.
  </action>
  <verify>
    - `cat apps/web/public/manifest.json | npx -y json` parses valid JSON
    - `grep -c "caches.open" apps/web/public/sw.js` returns at least 1
    - `grep "manifest" apps/web/app/layout.tsx` shows manifest link
    - `pnpm --filter @festapp/web build` succeeds
  </verify>
  <done>
    manifest.json is served at /manifest.json with correct PWA fields, service worker caches static assets with offline fallback, root layout includes manifest link and meta tags, PwaInstallPrompt registers SW on mount.
  </done>
</task>

<task type="auto">
  <name>Task 2: PWA install banner for mobile browsers</name>
  <files>
    apps/web/app/(app)/components/pwa-install-banner.tsx
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
1. Create `apps/web/app/(app)/components/pwa-install-banner.tsx`:
   - "use client" component
   - Listen for `beforeinstallprompt` event on window
   - Store the event in state via `useState`
   - Show a fixed bottom banner (above mobile nav, z-40) when:
     a. `beforeinstallprompt` event was captured (browser supports install)
     b. User has NOT dismissed it (check localStorage key `pwa-install-dismissed`)
     c. App is NOT already installed (check `window.matchMedia('(display-mode: standalone)').matches` is false)
   - Banner content:
     - Left: app icon placeholder (green circle with car icon SVG) + text "Install Rideshare on your phone"
     - Right: "Install" button (pastel green bg, white text) + "X" dismiss button
   - On "Install" click: call `deferredPrompt.prompt()`, await `userChoice`, hide banner
   - On "X" click: set localStorage `pwa-install-dismissed` = "true", hide banner
   - Style: white background, shadow-lg, rounded-t-xl, px-4 py-3, flex items-center gap-3
   - Position: fixed bottom-16 (above bottom nav on mobile), left-0 right-0, md:bottom-4 md:left-auto md:right-4 md:max-w-sm md:rounded-xl (floating card on desktop)

2. Update `apps/web/app/(app)/layout.tsx`:
   - Import `PwaInstallBanner` from `./components/pwa-install-banner`
   - Add `<PwaInstallBanner />` after the `<Toaster />` component
   - No other changes to existing layout structure
  </action>
  <verify>
    - `grep "beforeinstallprompt" apps/web/app/(app)/components/pwa-install-banner.tsx` returns match
    - `grep "PwaInstallBanner" apps/web/app/(app)/layout.tsx` returns match
    - `pnpm --filter @festapp/web build` succeeds
  </verify>
  <done>
    Mobile browser users see a prominent "Install Rideshare" banner at the bottom of the screen. Banner can be dismissed (persisted to localStorage). Install button triggers native browser install flow. Banner does not show if app is already installed in standalone mode.
  </done>
</task>

</tasks>

<verification>
- Web app build succeeds with no errors
- manifest.json is valid and served from /manifest.json
- Service worker registers without errors (check browser console)
- Offline page loads when network is disabled after initial visit
- Install banner appears on mobile Chrome (when not already installed)
- OneSignal push notifications still work (SW doesn't interfere)
</verification>

<success_criteria>
- manifest.json has all required PWA fields (name, icons, display: standalone, start_url)
- Service worker caches static assets with cache-first and navigations with network-first + offline fallback
- Install banner shows on mobile browsers with dismiss persistence
- `pnpm --filter @festapp/web build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/10-web-platform-seo/10-01-SUMMARY.md`
</output>
