---
phase: 10-web-platform-seo
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/(public)/ride/[shortId]/page.tsx
  - apps/web/app/(public)/layout.tsx
  - apps/web/app/(public)/u/[shortId]/page.tsx
  - apps/web/lib/short-id.ts
  - supabase/migrations/042_short_ids.sql
  - packages/shared/src/constants/seo.ts
  - apps/web/app/robots.ts
  - apps/web/app/sitemap.ts
  - apps/web/app/(app)/rides/[id]/page.tsx
  - apps/web/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Ride pages at /ride/{shortId} are server-rendered with full OG meta tags for social previews"
    - "Shared ride links show rich preview on WhatsApp, Facebook, and Twitter"
    - "Short URL structure uses random IDs (e.g., /ride/x7k9m2) for clean sharing"
    - "Public profile pages at /u/{shortId} are accessible without authentication"
    - "Search engines can discover and index ride pages via robots.txt and sitemap"
  artifacts:
    - path: "apps/web/app/(public)/ride/[shortId]/page.tsx"
      provides: "Public SSR ride page with OG meta tags"
      contains: "generateMetadata"
    - path: "apps/web/lib/short-id.ts"
      provides: "Short ID generation and lookup utilities"
      contains: "generateShortId"
    - path: "supabase/migrations/042_short_ids.sql"
      provides: "short_id columns on rides and profiles tables"
      contains: "short_id"
    - path: "apps/web/app/robots.ts"
      provides: "robots.txt for search engine crawling"
      contains: "sitemap"
    - path: "apps/web/app/sitemap.ts"
      provides: "Dynamic sitemap for ride pages"
      contains: "sitemap"
  key_links:
    - from: "apps/web/app/(public)/ride/[shortId]/page.tsx"
      to: "supabase rides table"
      via: "query by short_id column"
      pattern: "short_id.*eq"
    - from: "apps/web/app/(app)/rides/[id]/page.tsx"
      to: "apps/web/app/(public)/ride/[shortId]/page.tsx"
      via: "canonical URL and OG url pointing to public short URL"
      pattern: "canonical|og:url"
---

<objective>
Create SEO-optimized public ride and profile pages with short URLs and Open Graph meta tags for rich social previews.

Purpose: WEB-03 (SSR/SEO), WEB-05 (OG meta tags), WEB-08 (short URL structure). Ride links shared on WhatsApp/Facebook/Twitter should show rich previews with origin, destination, price, date, and driver info.

Output: Public route group with SSR ride/profile pages, short ID system, OG metadata, robots.txt, sitemap.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/app/(app)/rides/[id]/page.tsx
@apps/web/app/layout.tsx
@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Short ID migration, generation utility, and public route group</name>
  <files>
    supabase/migrations/042_short_ids.sql
    apps/web/lib/short-id.ts
    packages/shared/src/constants/seo.ts
    packages/shared/src/index.ts
    apps/web/app/(public)/layout.tsx
    apps/web/middleware.ts
  </files>
  <action>
1. Create `supabase/migrations/042_short_ids.sql`:
   - Add `short_id VARCHAR(8) UNIQUE` column to `public.rides` table with DEFAULT NULL
   - Add `short_id VARCHAR(8) UNIQUE` column to `public.profiles` table with DEFAULT NULL
   - Create function `generate_short_id()` that generates a random 6-char alphanumeric string (lowercase a-z, 0-9, excluding ambiguous chars like 0/o/l/1)
   - Create trigger `set_ride_short_id` on rides BEFORE INSERT that sets `short_id = generate_short_id()` if NULL
   - Create trigger `set_profile_short_id` on profiles BEFORE INSERT that sets `short_id = generate_short_id()` if NULL
   - Backfill existing rows: `UPDATE public.rides SET short_id = generate_short_id() WHERE short_id IS NULL`
   - Backfill existing rows: `UPDATE public.profiles SET short_id = generate_short_id() WHERE short_id IS NULL`
   - After backfill, alter columns to NOT NULL
   - Character set for IDs: `abcdefghjkmnpqrstuvwxyz23456789` (no 0, 1, i, l, o to avoid ambiguity)

2. Create `apps/web/lib/short-id.ts`:
   - Export `getRideByShortId(supabase, shortId)`: queries rides table by short_id, selects ride with driver profile join (same select as getRideById but filtered by short_id)
   - Export `getProfileByShortId(supabase, shortId)`: queries profiles by short_id
   - Both return `{ data, error }` pattern consistent with existing query builders

3. Create `packages/shared/src/constants/seo.ts`:
   - Export `SITE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://rideshare.festapp.cz'`
   - Export `SITE_NAME = 'Festapp Rideshare'`
   - Export `SITE_DESCRIPTION = 'Free community ride-sharing platform'`
   - Export `DEFAULT_OG_IMAGE = '/og-default.png'` (placeholder path)
   - Re-export from `packages/shared/src/index.ts`

4. Create `apps/web/app/(public)/layout.tsx`:
   - Simple layout that renders children without auth check (public pages)
   - No nav, no sidebar -- clean page for SEO crawlers and unauthenticated visitors
   - Include a minimal header with Festapp logo/name linking to /search
   - Include a CTA banner at bottom: "Join Festapp Rideshare" linking to /signup

5. Update `apps/web/middleware.ts`:
   - Add `/ride/` and `/u/` to the public route allowlist so they don't require auth
   - Also allow `/robots.txt` and `/sitemap.xml`
   - The existing matcher pattern should already exclude static files; just ensure the updateSession function does not redirect these paths
  </action>
  <verify>
    - `cat supabase/migrations/042_short_ids.sql | grep "short_id"` shows column additions
    - `grep "getRideByShortId" apps/web/lib/short-id.ts` returns match
    - `grep "SITE_URL" packages/shared/src/constants/seo.ts` returns match
    - `pnpm --filter @festapp/web build` succeeds
  </verify>
  <done>
    Short IDs are generated for all rides and profiles (existing + new). Public route group exists at (public)/ without auth. Short ID lookup utilities work for rides and profiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Public ride page with OG meta, public profile page, robots, sitemap</name>
  <files>
    apps/web/app/(public)/ride/[shortId]/page.tsx
    apps/web/app/(public)/u/[shortId]/page.tsx
    apps/web/app/robots.ts
    apps/web/app/sitemap.ts
    apps/web/app/(app)/rides/[id]/page.tsx
    apps/web/app/layout.tsx
  </files>
  <action>
1. Create `apps/web/app/(public)/ride/[shortId]/page.tsx`:
   - Server component with `generateMetadata` for full OG tags
   - Fetch ride by short_id using `getRideByShortId`
   - `generateMetadata` returns:
     - `title`: "{origin} -> {destination} | Festapp Rideshare"
     - `description`: "{price} CZK, {seats} seats, {formatted date}"
     - `openGraph`:
       - `title`, `description` (same as above)
       - `url`: `${SITE_URL}/ride/${shortId}`
       - `siteName`: SITE_NAME
       - `type`: "website"
       - `images`: [{ url: `${SITE_URL}/api/og/ride/${shortId}`, width: 1200, height: 630, alt: title }] (future OG image endpoint -- for now use DEFAULT_OG_IMAGE)
     - `twitter`:
       - `card`: "summary_large_image"
       - `title`, `description`
     - `alternates.canonical`: `${SITE_URL}/ride/${shortId}`
   - Page body: render ride info in a clean, readable format
     - Driver name + avatar + rating
     - Origin -> Destination with date/time
     - Price, available seats, booking mode
     - "Book this ride" CTA button linking to `/rides/${ride.id}` (authenticated page)
     - Route map (static, no interaction needed -- can use a simple origin/destination display)
   - If ride not found: return `notFound()`

2. Create `apps/web/app/(public)/u/[shortId]/page.tsx`:
   - Server component with `generateMetadata`
   - Fetch profile by short_id using `getProfileByShortId`
   - OG meta: user display_name, bio, rating, verification badges
   - Page body: public profile view (display name, avatar, bio, rating, badges, vehicle info)
   - "View full profile" CTA linking to `/profile/${profile.id}`
   - If profile not found: `notFound()`

3. Create `apps/web/app/robots.ts`:
   - Next.js Route Handler format (export default function)
   - Allow all crawlers on public pages
   - Disallow: /api/, /admin/, /settings/, /onboarding/, /messages/
   - Sitemap: `${SITE_URL}/sitemap.xml`

4. Create `apps/web/app/sitemap.ts`:
   - Next.js dynamic sitemap format
   - Import createClient (service role or server) to query recent rides
   - Query rides with status 'active' or 'completed', ordered by departure_time DESC, limit 1000
   - Generate sitemap entries for each ride: `/ride/${short_id}` with lastModified from updated_at
   - Also include static pages: /search, /community, /events
   - Set changeFrequency: 'daily' for rides, 'weekly' for static pages

5. Update `apps/web/app/(app)/rides/[id]/page.tsx`:
   - In `generateMetadata`, add `alternates.canonical` pointing to the public short URL: `${SITE_URL}/ride/${ride.short_id}`
   - Add `openGraph.url` pointing to public short URL
   - This ensures search engines consolidate to the public URL

6. Update `apps/web/app/layout.tsx`:
   - Add default OG metadata to the root layout metadata export:
     - `metadataBase`: new URL(SITE_URL)
     - `openGraph.siteName`: SITE_NAME
     - `openGraph.locale`: "cs_CZ"
   - These provide fallback OG tags for pages without specific metadata
  </action>
  <verify>
    - `grep "openGraph" apps/web/app/(public)/ride/[shortId]/page.tsx` shows OG meta
    - `grep "twitter" apps/web/app/(public)/ride/[shortId]/page.tsx` shows Twitter card
    - `grep "Disallow" apps/web/app/robots.ts` shows private routes blocked
    - `grep "sitemap" apps/web/app/sitemap.ts` or file exists
    - `pnpm --filter @festapp/web build` succeeds
  </verify>
  <done>
    Public ride page at /ride/{shortId} renders with full OG meta tags for rich social previews. Public profile page at /u/{shortId} is SEO-friendly. robots.txt allows crawling of public pages and blocks private routes. Dynamic sitemap lists active rides. Canonical URLs point authenticated ride pages to public short URLs.
  </done>
</task>

</tasks>

<verification>
- `pnpm --filter @festapp/web build` succeeds
- Public ride page renders server-side with correct OG meta
- Sharing a /ride/{shortId} link on social media shows rich preview
- robots.txt blocks /api/, /admin/, /settings/
- Sitemap lists ride pages with correct URLs
- Short IDs are 6 chars, unambiguous, unique
</verification>

<success_criteria>
- Public ride page has og:title, og:description, og:url, og:image, twitter:card meta tags
- Short URLs use 6-char random IDs from unambiguous character set
- robots.txt and sitemap.xml are served correctly
- Canonical URLs on authenticated pages point to public short URLs
- `pnpm --filter @festapp/web build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/10-web-platform-seo/10-02-SUMMARY.md`
</output>
