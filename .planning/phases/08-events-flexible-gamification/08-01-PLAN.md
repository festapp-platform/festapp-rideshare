---
phase: 08-events-flexible-gamification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000033_events.sql
  - packages/shared/src/types/database.ts
  - packages/shared/src/constants/event.ts
  - packages/shared/src/validation/event.ts
  - packages/shared/src/queries/events.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Events table exists with pending/approved/rejected status workflow"
    - "Admin can approve or reject events via RPCs with is_admin() guard"
    - "Rides table has nullable event_id column for linking rides to events"
    - "Shared package has event types, constants, Zod schemas, and query builders"
  artifacts:
    - path: "supabase/migrations/00000000000033_events.sql"
      provides: "Events table, RLS, admin approval RPCs, event-linked rides"
      contains: "CREATE TABLE public.events"
    - path: "packages/shared/src/validation/event.ts"
      provides: "Event creation and update Zod schemas"
    - path: "packages/shared/src/queries/events.ts"
      provides: "Event query builders for approved, by-id, pending-admin"
    - path: "packages/shared/src/constants/event.ts"
      provides: "Event status constants and limits"
  key_links:
    - from: "packages/shared/src/queries/events.ts"
      to: "supabase events table"
      via: "supabase client queries"
      pattern: "supabase.*events"
    - from: "packages/shared/src/types/database.ts"
      to: "supabase/migrations/00000000000033_events.sql"
      via: "TypeScript types matching migration schema"
      pattern: "events.*Row"
---

<objective>
Create the events database migration and shared package foundation: events table with admin approval workflow, rides.event_id column, admin RPCs, and shared types/schemas/queries.

Purpose: Foundation layer for the events system. Events require admin approval before becoming visible, and rides can be linked to events so passengers find all rides to a specific event.

Output: Events migration with RLS and RPCs, shared package event constants, Zod schemas, database types, and query builders.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md
@.planning/phases/06-ratings-trust-safety/06-05-SUMMARY.md
@packages/shared/src/index.ts
@packages/shared/src/types/database.ts
@supabase/migrations/00000000000031_admin_moderation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Events database migration</name>
  <files>
    supabase/migrations/00000000000033_events.sql
  </files>
  <action>
    **Migration (00000000000033_events.sql):**

    1. Create `events` table:
       - id UUID PK DEFAULT gen_random_uuid()
       - creator_id UUID NOT NULL REFERENCES profiles(id)
       - name TEXT NOT NULL (CHECK length 3-200)
       - description TEXT (max 2000 chars)
       - location_address TEXT NOT NULL
       - location GEOGRAPHY(POINT, 4326) NOT NULL
       - event_date TIMESTAMPTZ NOT NULL
       - event_end_date TIMESTAMPTZ (optional, for multi-day events)
       - status TEXT NOT NULL DEFAULT 'pending' CHECK IN ('pending', 'approved', 'rejected')
       - admin_notes TEXT (for rejection reason)
       - approved_by UUID REFERENCES profiles(id)
       - approved_at TIMESTAMPTZ
       - created_at TIMESTAMPTZ DEFAULT NOW()
       - updated_at TIMESTAMPTZ DEFAULT NOW()
       - GIST index on location column

    2. Add `event_id UUID REFERENCES events(id)` nullable column to `rides` table (ALTER TABLE). Add index on rides(event_id) WHERE event_id IS NOT NULL.

    3. RLS on events:
       - SELECT: anyone can read approved events; creators can read own pending/rejected events; admins can read all
       - INSERT: authenticated users can insert with creator_id = auth.uid()
       - UPDATE: only admins (via RPCs)
       - DELETE: creators can delete their own pending events

    4. RPCs (all SECURITY DEFINER SET search_path = ''):
       - `admin_approve_event(p_event_id UUID)` — sets status='approved', approved_by, approved_at. Uses is_admin() check. Calls _notify() to notify creator.
       - `admin_reject_event(p_event_id UUID, p_reason TEXT DEFAULT NULL)` — sets status='rejected', admin_notes. Uses is_admin() check. Calls _notify() to notify creator.
       - `get_event_rides(p_event_id UUID)` — returns rides for an approved event with driver profile info (similar shape to nearby_rides return type: ride_id, driver_id, driver_name, driver_avatar, driver_rating, origin_address, destination_address, departure_time, seats_available, price_czk, booking_mode). Only returns rides with status='active' for approved events. Respects block filtering.

    5. Trigger: update updated_at on events modification.
  </action>
  <verify>
    Check migration SQL syntax is valid (no SQL syntax errors in the file). Verify events table, rides.event_id column, RLS policies, and admin RPCs are all present.
  </verify>
  <done>
    Events table exists in migration with pending/approved/rejected status workflow. Rides table has event_id column. Admin approval RPCs use is_admin() guard. get_event_rides RPC returns ride listings for an event.
  </done>
</task>

<task type="auto">
  <name>Task 2: Events shared package (types, constants, schemas, queries)</name>
  <files>
    packages/shared/src/types/database.ts
    packages/shared/src/constants/event.ts
    packages/shared/src/validation/event.ts
    packages/shared/src/queries/events.ts
    packages/shared/src/index.ts
  </files>
  <action>
    **Constants (event.ts):**
    - EVENT_STATUS: { PENDING: 'pending', APPROVED: 'approved', REJECTED: 'rejected' }
    - EVENT_NAME_MIN/MAX: 3/200
    - EVENT_DESCRIPTION_MAX: 2000

    **Validation (event.ts):**
    - CreateEventSchema: { name, description?, location_address, location_lat, location_lng, event_date, event_end_date? }
    - UpdateEventSchema: partial of CreateEventSchema

    **Database types:** Add events table types (Row, Insert, Update, Relationships), add event_id to rides Row/Insert/Update, add admin_approve_event/admin_reject_event/get_event_rides function signatures. Add Event derived type.

    **Queries (events.ts):**
    - getApprovedEvents(client) — list approved events ordered by event_date
    - getEventById(client, id) — single event with creator profile
    - getMyEvents(client, userId) — user's created events (all statuses)
    - getPendingEventsForAdmin(client) — all pending events for admin review
    - getEventRides(client, eventId) — calls get_event_rides RPC

    **Index.ts:** Export all new event constants, schemas, types, queries.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/shared` to verify shared package compiles.
  </verify>
  <done>
    Shared package has event constants, Zod schemas, Database types, and query builders all exported from index.ts. Package compiles successfully.
  </done>
</task>

</tasks>

<verification>
1. Events migration has valid SQL with events table, rides.event_id column, RLS policies, and admin RPCs
2. Shared package builds with event types, schemas, constants, queries
3. All exports accessible from @festapp/shared
</verification>

<success_criteria>
- Events table with pending/approved/rejected status workflow in migration
- Rides table has event_id nullable FK column
- Admin approval RPCs with is_admin() guard
- Shared package compiles with event types, schemas, constants, queries
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-flexible-gamification/08-01-SUMMARY.md`
</output>
