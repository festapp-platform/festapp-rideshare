---
phase: 08-events-flexible-gamification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000033_events.sql
  - packages/shared/src/types/database.ts
  - packages/shared/src/constants/event.ts
  - packages/shared/src/validation/event.ts
  - packages/shared/src/queries/events.ts
  - packages/shared/src/index.ts
  - apps/web/app/(app)/events/page.tsx
  - apps/web/app/(app)/events/new/page.tsx
  - apps/web/app/(app)/events/[id]/page.tsx
  - apps/web/app/(app)/events/[id]/event-detail.tsx
  - apps/web/app/(app)/rides/new/ride-form.tsx
  - apps/web/app/admin/events/page.tsx
  - apps/web/app/admin/events/[id]/page.tsx
  - apps/web/app/admin/components/admin-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an event with name, location, and date that goes to admin for approval"
    - "Admin can approve or reject a pending event from the admin panel"
    - "Approved event has a dedicated page showing name, location, date, and list of rides"
    - "Driver can post a ride linked to an event and it appears on both search and event page"
    - "Passenger can browse rides for a specific event from the event page"
  artifacts:
    - path: "supabase/migrations/00000000000033_events.sql"
      provides: "Events table, RLS, admin approval RPCs, event-linked rides"
      contains: "CREATE TABLE public.events"
    - path: "apps/web/app/(app)/events/[id]/page.tsx"
      provides: "Event detail page with ride listings"
    - path: "apps/web/app/admin/events/page.tsx"
      provides: "Admin event approval interface"
    - path: "packages/shared/src/validation/event.ts"
      provides: "Event creation and update Zod schemas"
  key_links:
    - from: "apps/web/app/(app)/events/new/page.tsx"
      to: "supabase events table"
      via: "INSERT with status=pending"
      pattern: "supabase.*events.*insert"
    - from: "apps/web/app/admin/events/page.tsx"
      to: "admin_approve_event RPC"
      via: "supabase.rpc('admin_approve_event')"
      pattern: "admin_approve_event"
    - from: "apps/web/app/(app)/events/[id]/event-detail.tsx"
      to: "rides table with event_id"
      via: "supabase query filtering rides by event_id"
      pattern: "event_id.*eq"
    - from: "apps/web/app/(app)/rides/new/ride-form.tsx"
      to: "events table"
      via: "optional event_id field on ride creation"
      pattern: "event_id"
---

<objective>
Create the events system: database tables for events with admin approval workflow, event creation and browsing UI, admin event management, and event-linked rides.

Purpose: Users can organize rides around events (festivals, concerts, gatherings). Events require admin approval before becoming visible, and drivers can link rides to events so passengers can find all rides to a specific event.

Output: Events migration, shared types/schemas/queries, event creation page, event detail page with ride listings, admin event management, and ride form event linking.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md
@.planning/phases/06-ratings-trust-safety/06-05-SUMMARY.md
@packages/shared/src/index.ts
@packages/shared/src/types/database.ts
@apps/web/app/admin/layout.tsx
@apps/web/app/admin/components/admin-sidebar.tsx
@apps/web/app/(app)/rides/new/ride-form.tsx
@supabase/migrations/00000000000031_admin_moderation.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Events database migration and shared package</name>
  <files>
    supabase/migrations/00000000000033_events.sql
    packages/shared/src/types/database.ts
    packages/shared/src/constants/event.ts
    packages/shared/src/validation/event.ts
    packages/shared/src/queries/events.ts
    packages/shared/src/index.ts
  </files>
  <action>
    **Migration (00000000000033_events.sql):**

    1. Create `events` table:
       - id UUID PK DEFAULT gen_random_uuid()
       - creator_id UUID NOT NULL REFERENCES profiles(id)
       - name TEXT NOT NULL (CHECK length 3-200)
       - description TEXT (max 2000 chars)
       - location_address TEXT NOT NULL
       - location GEOGRAPHY(POINT, 4326) NOT NULL
       - event_date TIMESTAMPTZ NOT NULL
       - event_end_date TIMESTAMPTZ (optional, for multi-day events)
       - status TEXT NOT NULL DEFAULT 'pending' CHECK IN ('pending', 'approved', 'rejected')
       - admin_notes TEXT (for rejection reason)
       - approved_by UUID REFERENCES profiles(id)
       - approved_at TIMESTAMPTZ
       - created_at TIMESTAMPTZ DEFAULT NOW()
       - updated_at TIMESTAMPTZ DEFAULT NOW()
       - GIST index on location column

    2. Add `event_id UUID REFERENCES events(id)` nullable column to `rides` table (ALTER TABLE). Add index on rides(event_id) WHERE event_id IS NOT NULL.

    3. RLS on events:
       - SELECT: anyone can read approved events; creators can read own pending/rejected events; admins can read all
       - INSERT: authenticated users can insert with creator_id = auth.uid()
       - UPDATE: only admins (via RPCs)
       - DELETE: creators can delete their own pending events

    4. RPCs (all SECURITY DEFINER SET search_path = ''):
       - `admin_approve_event(p_event_id UUID)` — sets status='approved', approved_by, approved_at. Uses is_admin() check. Calls _notify() to notify creator.
       - `admin_reject_event(p_event_id UUID, p_reason TEXT DEFAULT NULL)` — sets status='rejected', admin_notes. Uses is_admin() check. Calls _notify() to notify creator.
       - `get_event_rides(p_event_id UUID)` — returns rides for an approved event with driver profile info (similar shape to nearby_rides return type: ride_id, driver_id, driver_name, driver_avatar, driver_rating, origin_address, destination_address, departure_time, seats_available, price_czk, booking_mode). Only returns rides with status='active' for approved events. Respects block filtering.

    5. Trigger: update updated_at on events modification.

    **Shared package:**

    Constants (event.ts):
    - EVENT_STATUS: { PENDING: 'pending', APPROVED: 'approved', REJECTED: 'rejected' }
    - EVENT_NAME_MIN/MAX: 3/200
    - EVENT_DESCRIPTION_MAX: 2000

    Validation (event.ts):
    - CreateEventSchema: { name, description?, location_address, location_lat, location_lng, event_date, event_end_date? }
    - UpdateEventSchema: partial of CreateEventSchema

    Database types: Add events table types (Row, Insert, Update, Relationships), add event_id to rides Row/Insert/Update, add admin_approve_event/admin_reject_event/get_event_rides function signatures. Add Event derived type.

    Queries (events.ts):
    - getApprovedEvents(client) — list approved events ordered by event_date
    - getEventById(client, id) — single event with creator profile
    - getMyEvents(client, userId) — user's created events (all statuses)
    - getPendingEventsForAdmin(client) — all pending events for admin review
    - getEventRides(client, eventId) — calls get_event_rides RPC

    Index.ts: Export all new event constants, schemas, types, queries.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/shared` to verify shared package compiles. Check migration SQL syntax is valid (no SQL syntax errors in the file).
  </verify>
  <done>
    Events table exists in migration with pending/approved/rejected status workflow. Rides table has event_id column. Admin approval RPCs use is_admin() guard. Shared package has event constants, Zod schemas, Database types, and query builders all exported from index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Event UI pages and admin management</name>
  <files>
    apps/web/app/(app)/events/page.tsx
    apps/web/app/(app)/events/new/page.tsx
    apps/web/app/(app)/events/[id]/page.tsx
    apps/web/app/(app)/events/[id]/event-detail.tsx
    apps/web/app/(app)/rides/new/ride-form.tsx
    apps/web/app/admin/events/page.tsx
    apps/web/app/admin/events/[id]/page.tsx
    apps/web/app/admin/components/admin-sidebar.tsx
  </files>
  <action>
    **Events browsing page (/events):**
    - Server component fetching approved events via getApprovedEvents query
    - Grid of event cards showing name, location, date, ride count
    - Link to /events/new for creating new events
    - Search/filter by name (client-side) and date range

    **Event creation page (/events/new):**
    - react-hook-form + zodResolver(CreateEventSchema)
    - Name, description (optional), location (AddressAutocomplete reuse from rides), event date (datetime-local input), optional end date
    - Location uses the same AddressAutocomplete component from ride creation for Google Places integration
    - On submit: insert into events table with status='pending', location as WKT POINT(lng lat) (same pattern as rides)
    - Show success message: "Event submitted for admin approval"
    - Redirect to /events after creation

    **Event detail page (/events/[id]):**
    - Server component fetching event by ID + rides via getEventRides
    - SSR page with event name, description, location, date(s)
    - "Rides to this event" section showing ride cards (reuse RideCard component from search)
    - "Offer a ride to this event" button linking to /rides/new?eventId={id} (pre-fills event link)
    - Share button for deep link (copy to clipboard: /events/{id})
    - If user is creator and event is pending, show "Pending approval" badge
    - If rejected, show rejection reason

    **Ride form event linking:**
    - Modify existing ride-form.tsx to accept optional eventId from URL search params
    - Add optional "Link to event" dropdown/field that shows approved events
    - When eventId is in URL params, pre-select that event and auto-fill destination from event location
    - On ride creation, include event_id in the INSERT

    **Admin events management:**
    - Add "Events" link to admin-sidebar.tsx (Calendar icon from lucide-react, route: /admin/events)
    - Admin events list page (/admin/events): table of pending events with name, creator, date, created_at. Tabs for pending/approved/rejected.
    - Admin event detail page (/admin/events/[id]): show full event details, creator profile link, map preview of location. Approve button (calls admin_approve_event RPC) and Reject button with optional reason textarea (calls admin_reject_event RPC). Use two-click confirm pattern consistent with moderation actions.

    **Styling:** Follow existing app patterns -- Tailwind classes, pastel design system, consistent with ride/search pages.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/web` to verify web app compiles. Visually confirm /events, /events/new, /events/[id], /admin/events routes exist.
  </verify>
  <done>
    User can create an event at /events/new, see approved events at /events, view event detail with rides at /events/[id]. Admin can approve/reject events at /admin/events. Driver can link a ride to an event from ride creation form. Event can be shared via URL.
  </done>
</task>

</tasks>

<verification>
1. Events migration has valid SQL with events table, rides.event_id column, RLS policies, and admin RPCs
2. Shared package builds with event types, schemas, constants, queries
3. Web app builds with all event pages and admin event management
4. Event creation form submits with pending status
5. Admin can approve/reject events
6. Event detail page shows linked rides
7. Ride form accepts optional event linking
</verification>

<success_criteria>
- User can create an event (name, location, date) that enters pending status
- Admin can approve or reject events from /admin/events
- Approved event page at /events/[id] shows event details and linked rides
- Driver can post a ride linked to an event via ride creation form
- Events browsable at /events with event cards
- Event shareable via /events/{id} URL
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-flexible-gamification/08-01-SUMMARY.md`
</output>
