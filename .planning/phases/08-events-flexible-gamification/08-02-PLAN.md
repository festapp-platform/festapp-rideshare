---
phase: 08-events-flexible-gamification
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/web/app/(app)/events/page.tsx
  - apps/web/app/(app)/events/new/page.tsx
  - apps/web/app/(app)/events/[id]/page.tsx
  - apps/web/app/(app)/events/[id]/event-detail.tsx
  - apps/web/app/(app)/rides/new/ride-form.tsx
  - apps/web/app/admin/events/page.tsx
  - apps/web/app/admin/events/[id]/page.tsx
  - apps/web/app/admin/components/admin-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an event with name, location, and date that goes to admin for approval"
    - "Admin can approve or reject a pending event from the admin panel"
    - "Approved event has a dedicated page showing name, location, date, and list of rides"
    - "Driver can post a ride linked to an event and it appears on both search and event page"
    - "Passenger can browse rides for a specific event from the event page"
  artifacts:
    - path: "apps/web/app/(app)/events/page.tsx"
      provides: "Events browsing page with approved event cards"
    - path: "apps/web/app/(app)/events/new/page.tsx"
      provides: "Event creation form with location autocomplete"
    - path: "apps/web/app/(app)/events/[id]/event-detail.tsx"
      provides: "Event detail page with ride listings"
    - path: "apps/web/app/admin/events/page.tsx"
      provides: "Admin event approval interface"
  key_links:
    - from: "apps/web/app/(app)/events/new/page.tsx"
      to: "supabase events table"
      via: "INSERT with status=pending"
      pattern: "supabase.*events.*insert"
    - from: "apps/web/app/admin/events/page.tsx"
      to: "admin_approve_event RPC"
      via: "supabase.rpc('admin_approve_event')"
      pattern: "admin_approve_event"
    - from: "apps/web/app/(app)/events/[id]/event-detail.tsx"
      to: "rides table with event_id"
      via: "supabase query filtering rides by event_id"
      pattern: "event_id.*eq"
    - from: "apps/web/app/(app)/rides/new/ride-form.tsx"
      to: "events table"
      via: "optional event_id field on ride creation"
      pattern: "event_id"
---

<objective>
Create event UI pages, admin event management, and ride form event linking.

Purpose: Users can create events, browse approved events with linked rides, and admins can approve/reject events. Drivers can link rides to events from the ride creation form.

Output: Event creation page, event browsing page, event detail page with ride listings, admin event management pages, ride form event linking.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-events-flexible-gamification/08-01-SUMMARY.md
@packages/shared/src/index.ts
@apps/web/app/admin/layout.tsx
@apps/web/app/admin/components/admin-sidebar.tsx
@apps/web/app/(app)/rides/new/ride-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Event browsing, creation, and detail pages</name>
  <files>
    apps/web/app/(app)/events/page.tsx
    apps/web/app/(app)/events/new/page.tsx
    apps/web/app/(app)/events/[id]/page.tsx
    apps/web/app/(app)/events/[id]/event-detail.tsx
    apps/web/app/(app)/rides/new/ride-form.tsx
  </files>
  <action>
    **Events browsing page (/events):**
    - Server component fetching approved events via getApprovedEvents query
    - Grid of event cards showing name, location, date, ride count
    - Link to /events/new for creating new events
    - Search/filter by name (client-side) and date range

    **Event creation page (/events/new):**
    - react-hook-form + zodResolver(CreateEventSchema)
    - Name, description (optional), location (AddressAutocomplete reuse from rides), event date (datetime-local input), optional end date
    - Location uses the same AddressAutocomplete component from ride creation for Google Places integration
    - On submit: insert into events table with status='pending', location as WKT POINT(lng lat) (same pattern as rides)
    - Show success message: "Event submitted for admin approval"
    - Redirect to /events after creation

    **Event detail page (/events/[id]):**
    - Server component fetching event by ID + rides via getEventRides
    - SSR page with event name, description, location, date(s)
    - "Rides to this event" section showing ride cards (reuse RideCard component from search)
    - "Offer a ride to this event" button linking to /rides/new?eventId={id} (pre-fills event link)
    - Share button for deep link (copy to clipboard: /events/{id})
    - If user is creator and event is pending, show "Pending approval" badge
    - If rejected, show rejection reason

    **Ride form event linking:**
    - Modify existing ride-form.tsx to accept optional eventId from URL search params
    - Add optional "Link to event" dropdown/field that shows approved events
    - When eventId is in URL params, pre-select that event and auto-fill destination from event location
    - On ride creation, include event_id in the INSERT

    **Styling:** Follow existing app patterns -- Tailwind classes, pastel design system, consistent with ride/search pages.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/web` to verify web app compiles. Visually confirm /events, /events/new, /events/[id] routes exist.
  </verify>
  <done>
    User can create an event at /events/new, see approved events at /events, view event detail with rides at /events/[id]. Driver can link a ride to an event from ride creation form. Event can be shared via URL.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin event management pages</name>
  <files>
    apps/web/app/admin/events/page.tsx
    apps/web/app/admin/events/[id]/page.tsx
    apps/web/app/admin/components/admin-sidebar.tsx
  </files>
  <action>
    **Admin sidebar:**
    - Add "Events" link to admin-sidebar.tsx (Calendar icon from lucide-react, route: /admin/events)

    **Admin events list page (/admin/events):**
    - Table of pending events with name, creator, date, created_at
    - Tabs for pending/approved/rejected

    **Admin event detail page (/admin/events/[id]):**
    - Show full event details, creator profile link, map preview of location
    - Approve button (calls admin_approve_event RPC) and Reject button with optional reason textarea (calls admin_reject_event RPC)
    - Use two-click confirm pattern consistent with moderation actions

    **Styling:** Follow existing admin panel patterns.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/web` to verify web app compiles. Verify /admin/events and /admin/events/[id] routes exist.
  </verify>
  <done>
    Admin can approve/reject events at /admin/events. Admin sidebar has Events link. Admin event detail page shows full event info with approve/reject actions using two-click confirm pattern.
  </done>
</task>

</tasks>

<verification>
1. Web app builds with all event pages and admin event management
2. Event creation form submits with pending status
3. Admin can approve/reject events
4. Event detail page shows linked rides
5. Ride form accepts optional event linking
</verification>

<success_criteria>
- User can create an event (name, location, date) that enters pending status
- Admin can approve or reject events from /admin/events
- Approved event page at /events/[id] shows event details and linked rides
- Driver can post a ride linked to an event via ride creation form
- Events browsable at /events with event cards
- Event shareable via /events/{id} URL
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-flexible-gamification/08-02-SUMMARY.md`
</output>
