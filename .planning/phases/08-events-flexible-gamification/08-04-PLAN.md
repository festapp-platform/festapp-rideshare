---
phase: 08-events-flexible-gamification
plan: 04
type: execute
wave: 2
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - supabase/migrations/00000000000036_community_stats.sql
  - apps/web/app/(app)/community/page.tsx
  - apps/web/app/(app)/community/community-stats.tsx
  - apps/web/app/(app)/impact/impact-dashboard.tsx
  - apps/web/app/(app)/events/[id]/event-detail.tsx
  - apps/web/app/(app)/components/share-button.tsx
  - packages/shared/src/queries/gamification.ts
  - packages/shared/src/types/database.ts
  - packages/shared/src/index.ts
  - packages/shared/src/validation/__tests__/gamification.test.ts
autonomous: true

must_haves:
  truths:
    - "Community stats page shows platform-wide totals (total CO2 saved, rides completed, users)"
    - "Impact stats are shareable via native share or clipboard"
    - "Event can be shared via deep link"
    - "getUserLevel correctly computes user level from rides and rating"
    - "Unit tests verify gamification logic"
  artifacts:
    - path: "apps/web/app/(app)/community/page.tsx"
      provides: "Community stats page with platform-wide impact"
    - path: "apps/web/app/(app)/components/share-button.tsx"
      provides: "Reusable share component for impact and events"
    - path: "packages/shared/src/validation/__tests__/gamification.test.ts"
      provides: "Unit tests for getUserLevel and CO2 calculations"
  key_links:
    - from: "apps/web/app/(app)/community/community-stats.tsx"
      to: "get_community_impact RPC"
      via: "supabase.rpc('get_community_impact')"
      pattern: "get_community_impact"
    - from: "apps/web/app/(app)/components/share-button.tsx"
      to: "navigator.share or clipboard"
      via: "Web Share API with clipboard fallback"
      pattern: "navigator.share"
---

<objective>
Create community stats page with platform-wide impact totals, implement shareable impact/event functionality, and add comprehensive unit and integration tests for Phase 8 gamification logic.

Purpose: The community stats page motivates users by showing collective impact. Share functionality enables social proof and viral growth. Tests ensure gamification calculations and level thresholds are correct.

Output: Community stats page, reusable share component, deep link sharing for events, and test suite for gamification business logic.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-events-flexible-gamification/08-01-SUMMARY.md
@.planning/phases/08-events-flexible-gamification/08-02-SUMMARY.md
@.planning/phases/08-events-flexible-gamification/08-03-SUMMARY.md
@packages/shared/src/index.ts
@packages/shared/src/constants/gamification.ts
@packages/shared/src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Community stats page, share component, and event deep links</name>
  <files>
    supabase/migrations/00000000000036_community_stats.sql
    apps/web/app/(app)/community/page.tsx
    apps/web/app/(app)/community/community-stats.tsx
    apps/web/app/(app)/impact/impact-dashboard.tsx
    apps/web/app/(app)/events/[id]/event-detail.tsx
    apps/web/app/(app)/components/share-button.tsx
    packages/shared/src/queries/gamification.ts
    packages/shared/src/types/database.ts
    packages/shared/src/index.ts
  </files>
  <action>
    **Migration (00000000000036_community_stats.sql):**

    Create RPC `get_community_impact()` (SECURITY DEFINER, STABLE):
    - Calculates platform-wide totals from completed rides:
      - total_rides: COUNT of completed rides
      - total_users: COUNT of profiles
      - total_co2_saved_kg: SUM(distance_meters * confirmed_passengers_count) * 0.000120
        - For each completed ride, multiply distance by number of confirmed passengers (each passenger saves one solo car trip)
      - total_distance_km: SUM(distance_meters * confirmed_passengers_count) / 1000
      - total_money_shared_czk: SUM(price_czk * confirmed_passengers_count) for completed rides with price
      - active_drivers: COUNT DISTINCT driver_id on rides with status='completed'
    - Uses a subquery to count confirmed bookings per ride
    - Returns single row

    Add get_community_impact function signature to Database types.

    **Community stats page (/community):**
    - Server component fetching community impact via getCommunityImpact query
    - CommunityStats client component:
      - Large hero banner: "Together we've saved {X} kg CO2" with visual tree/earth illustration (CSS/Tailwind art, no external images)
      - Stats grid (similar style to admin dashboard stats cards but public-facing with pastel colors):
        - Total Rides Shared
        - Total CO2 Saved (with "equivalent to {X} trees planted" conversion -- 1 tree absorbs ~22kg CO2/year)
        - Total Distance Shared
        - Active Drivers
        - Total Users
        - Money Exchanged
      - "Join the community" CTA for non-authenticated users, "View your impact" link for authenticated users
      - Animate counters on page load (simple CSS counter animation or requestAnimationFrame)

    **ShareButton component (reusable):**
    - Props: { title: string, text: string, url: string }
    - Uses Web Share API (navigator.share) if available, falls back to clipboard copy with toast notification
    - Styled as an icon button (Share2 from lucide-react) with optional text label
    - Works on both mobile (native share sheet) and desktop (clipboard)

    **Impact dashboard share integration:**
    - Update impact-dashboard.tsx to use ShareButton component
    - Share text: "I've saved {co2} kg CO2 and completed {rides} shared rides on Festapp! ðŸŒ±"
    - Share URL: /impact (public link, though data is per-user)

    **Event deep link sharing:**
    - Update event-detail.tsx to include ShareButton
    - Share title: event name
    - Share text: "{event_name} on {date} - Find rides to this event!"
    - Share URL: /events/{id}

    **Queries update:**
    - Add getCommunityImpact(client) to gamification.ts queries
    - Add CommunityImpact type to database.ts

    **Navigation:**
    - Add /community link to app navigation (consider adding to footer or as a tab sub-item -- check existing nav structure and add appropriately, perhaps in the profile section or as a linked page from impact)
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/web` to verify web app compiles. Verify /community route exists and renders stats.
  </verify>
  <done>
    Community stats page at /community shows platform-wide CO2 saved, rides, users, and distance. ShareButton component uses Web Share API with clipboard fallback. Impact dashboard has share functionality. Events have deep link sharing. Community page has animated stat counters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit and integration tests for Phase 8 gamification logic</name>
  <files>
    packages/shared/src/validation/__tests__/gamification.test.ts
  </files>
  <action>
    **Test file: gamification.test.ts**

    Using vitest (already configured in the shared package -- see existing test pattern in validation/__tests__/).

    **getUserLevel tests:**
    - Test all level boundaries:
      - 0 rides, 0 rating -> "New"
      - 2 rides, 4.5 rating -> "New" (not enough rides for Regular)
      - 3 rides, 3.0 rating -> "Regular"
      - 3 rides, 2.9 rating -> "New" (rating too low for Regular)
      - 15 rides, 4.0 rating -> "Experienced"
      - 15 rides, 3.9 rating -> "Regular" (rating too low for Experienced)
      - 50 rides, 4.5 rating -> "Ambassador"
      - 50 rides, 4.4 rating -> "Experienced" (rating too low for Ambassador)
      - 100 rides, 5.0 rating -> "Ambassador" (highest level, can't exceed)
      - Edge case: 0 rides, 5.0 rating -> "New" (rating alone doesn't promote)

    **CO2 calculation tests:**
    - CO2_SAVINGS_PER_KM * 1000 (1000km) = 120 kg
    - CO2_SAVINGS_PER_KM * 0 = 0 kg
    - CO2_SAVINGS_PER_KM * 150 (150km typical Prague-Brno) = 18 kg

    **Validation schema tests (if CreateEventSchema and ConfirmRouteIntentSchema are testable):**
    - CreateEventSchema: valid event passes, missing name fails, event_date in past fails (if validated), name too short fails
    - ConfirmRouteIntentSchema: valid confirmation passes, departure_time in past fails, missing departure_time fails
    - CreateRouteIntentSchema: valid intent passes, invalid seats (0, 9) fails

    **Badge threshold tests (if badge data is in shared constants):**
    - Test that badge thresholds are in ascending order for ride badges
    - Test that getUserLevel thresholds are monotonically increasing

    Run via: `pnpm turbo test --filter=@festapp/shared`
  </action>
  <verify>
    Run `pnpm turbo test --filter=@festapp/shared` and verify all tests pass. Should see gamification tests in output.
  </verify>
  <done>
    Test suite covers getUserLevel at all boundary conditions, CO2 calculation constants, event/flexible ride validation schemas, and badge threshold ordering. All tests pass via `pnpm turbo test`.
  </done>
</task>

</tasks>

<verification>
1. Community stats migration has valid SQL with get_community_impact RPC
2. Community page displays platform-wide stats with animated counters
3. ShareButton works with Web Share API and clipboard fallback
4. Impact dashboard and events have share functionality
5. All gamification unit tests pass
6. Event deep links work (/events/{id})
</verification>

<success_criteria>
- Community stats page at /community shows platform-wide CO2, rides, users, distance
- Impact dashboard has working share button
- Events shareable via deep link with Web Share API
- getUserLevel tests cover all level boundaries and edge cases
- CO2 calculation tests verify correct constants
- Validation schema tests for events and flexible rides pass
- All tests pass via `pnpm turbo test`
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-flexible-gamification/08-04-SUMMARY.md`
</output>
