---
phase: 08-events-flexible-gamification
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000035_gamification.sql
  - packages/shared/src/types/database.ts
  - packages/shared/src/constants/gamification.ts
  - packages/shared/src/validation/gamification.ts
  - packages/shared/src/queries/gamification.ts
  - packages/shared/src/index.ts
  - apps/web/app/(app)/impact/page.tsx
  - apps/web/app/(app)/impact/impact-dashboard.tsx
  - apps/web/app/(app)/profile/components/badges-section.tsx
  - apps/web/app/(app)/profile/components/level-badge.tsx
  - apps/web/app/(app)/profile/[id]/page.tsx
  - apps/web/app/(app)/search/ride-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their personal impact dashboard showing CO2 saved, money saved, and rides completed"
    - "Users earn achievement badges through real activity (first ride, 10 rides, etc.)"
    - "Badges are displayed on user profile and visible to other users"
    - "User level (New/Regular/Experienced/Ambassador) is based on completed rides and average rating"
    - "User level is shown on profile and in search results ride cards"
    - "Route streaks track consecutive weeks of sharing a specific route"
  artifacts:
    - path: "supabase/migrations/00000000000035_gamification.sql"
      provides: "Achievement badges, user levels, route streaks, impact stats calculation, nearby_rides extension for completed_rides_count"
      contains: "CREATE TABLE public.user_achievements"
    - path: "apps/web/app/(app)/impact/page.tsx"
      provides: "Personal impact dashboard page"
    - path: "apps/web/app/(app)/profile/components/badges-section.tsx"
      provides: "Achievement badges display on profile"
    - path: "apps/web/app/(app)/profile/components/level-badge.tsx"
      provides: "User level badge component"
  key_links:
    - from: "apps/web/app/(app)/impact/impact-dashboard.tsx"
      to: "get_user_impact RPC"
      via: "supabase.rpc('get_user_impact')"
      pattern: "get_user_impact"
    - from: "apps/web/app/(app)/profile/components/level-badge.tsx"
      to: "get_user_level function"
      via: "computed from completed_rides_count and rating_avg"
      pattern: "getUserLevel"
    - from: "supabase/migrations/00000000000035_gamification.sql"
      to: "profiles.completed_rides_count"
      via: "trigger on ride completion awards badges"
      pattern: "check_and_award_badges"
    - from: "apps/web/app/(app)/search/ride-card.tsx"
      to: "nearby_rides RPC"
      via: "completed_rides_count field from extended nearby_rides return type"
      pattern: "completed_rides_count"
---

<objective>
Create the gamification system: impact stats calculation, achievement badges with automatic awarding, user levels based on activity, route streaks tracking, and profile/search result integration.

Purpose: Motivate users through visible impact metrics (CO2 and money saved), achievement badges earned through real activity, progressive user levels, and route streak tracking. These elements appear on profiles and search results to build trust and engagement.

Output: Gamification migration (including nearby_rides extension), shared types/constants/queries, impact dashboard page, badges and level components integrated into profiles and ride cards.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/shared/src/index.ts
@packages/shared/src/types/database.ts
@packages/shared/src/constants/ride.ts
@packages/shared/src/constants/pricing.ts
@apps/web/app/(app)/profile/[id]/page.tsx
@apps/web/app/(app)/search/ride-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gamification database migration, nearby_rides extension, and shared package</name>
  <files>
    supabase/migrations/00000000000035_gamification.sql
    packages/shared/src/types/database.ts
    packages/shared/src/constants/gamification.ts
    packages/shared/src/validation/gamification.ts
    packages/shared/src/queries/gamification.ts
    packages/shared/src/index.ts
  </files>
  <action>
    **Migration (00000000000035_gamification.sql):**

    1. Create `badge_definitions` table (reference data, seeded in migration):
       - id TEXT PK (e.g., 'first_ride', 'rides_10', 'rides_50', 'rides_100', 'first_review', 'five_star', 'streak_4', 'streak_12')
       - name TEXT NOT NULL (display name: "First Ride", "Road Warrior", etc.)
       - description TEXT NOT NULL
       - icon TEXT NOT NULL (emoji or icon identifier)
       - category TEXT NOT NULL CHECK IN ('rides', 'reviews', 'streaks', 'special')
       - threshold INT (the number needed to earn it, e.g., 10 for rides_10)
       - created_at TIMESTAMPTZ DEFAULT NOW()
       - INSERT seed data for ~10 badges:
         - first_ride: "First Ride" / "Completed your first ride" / threshold 1
         - rides_10: "Regular Rider" / "Completed 10 rides" / threshold 10
         - rides_25: "Road Warrior" / "Completed 25 rides" / threshold 25
         - rides_50: "Highway Hero" / "Completed 50 rides" / threshold 50
         - rides_100: "Legend of the Road" / "Completed 100 rides" / threshold 100
         - first_review: "First Feedback" / "Left your first review" / threshold 1
         - five_star: "Perfect Score" / "Received a 5-star rating" / threshold 1
         - streak_4: "Month Streak" / "Shared same route 4 consecutive weeks" / threshold 4
         - streak_12: "Quarter Streak" / "Shared same route 12 consecutive weeks" / threshold 12
         - streak_26: "Half Year Streak" / "Shared same route 26 consecutive weeks" / threshold 26

    2. Create `user_achievements` table:
       - id UUID PK DEFAULT gen_random_uuid()
       - user_id UUID NOT NULL REFERENCES profiles(id)
       - badge_id TEXT NOT NULL REFERENCES badge_definitions(id)
       - earned_at TIMESTAMPTZ DEFAULT NOW()
       - UNIQUE(user_id, badge_id)

    3. Create `route_streaks` table:
       - id UUID PK DEFAULT gen_random_uuid()
       - user_id UUID NOT NULL REFERENCES profiles(id)
       - origin_address TEXT NOT NULL
       - destination_address TEXT NOT NULL
       - current_streak INT NOT NULL DEFAULT 1
       - longest_streak INT NOT NULL DEFAULT 1
       - last_ride_week TEXT NOT NULL (ISO week: '2026-W07')
       - created_at TIMESTAMPTZ DEFAULT NOW()
       - updated_at TIMESTAMPTZ DEFAULT NOW()
       - UNIQUE(user_id, origin_address, destination_address)

    4. RLS:
       - badge_definitions: SELECT for everyone (public reference data), no INSERT/UPDATE/DELETE for users
       - user_achievements: SELECT for everyone (badges are public), INSERT only via trigger/RPC
       - route_streaks: SELECT own only, INSERT/UPDATE via trigger/RPC

    5. RPCs (SECURITY DEFINER):
       - `get_user_impact(p_user_id UUID DEFAULT auth.uid())`:
         - Calculates from completed rides where user was driver or had confirmed booking:
           - total_rides_completed: COUNT of completed rides
           - total_co2_saved_kg: SUM(distance_meters) * 0.000120 (120g CO2/km saved per passenger vs solo driving -- standard EU average)
           - total_money_saved_czk: SUM(price_czk) for rides as passenger, SUM(price_czk * confirmed_bookings) for rides as driver (money earned)
           - total_distance_km: SUM(distance_meters) / 1000
           - total_passengers_carried: SUM of confirmed bookings on driver's completed rides
         - Returns single row with these stats

       - `get_user_badges(p_user_id UUID DEFAULT auth.uid())`:
         - Returns user_achievements JOIN badge_definitions for the user
         - Ordered by earned_at DESC

       - `get_route_streaks(p_user_id UUID DEFAULT auth.uid())`:
         - Returns route_streaks for the user ordered by current_streak DESC

    6. Trigger function `check_and_award_badges()`:
       - Fires AFTER UPDATE on rides WHERE NEW.status = 'completed'
       - For the driver:
         - Check completed_rides_count on profile against ride badge thresholds (1, 10, 25, 50, 100)
         - Award any newly earned badges via INSERT ... ON CONFLICT DO NOTHING
       - For confirmed passengers of this ride:
         - Check their completed_rides_count and award ride badges similarly
       - Route streak logic for driver:
         - Calculate ISO week from ride departure_time
         - UPSERT into route_streaks: if last_ride_week is previous week, increment current_streak; if same week, skip; otherwise reset to 1
         - Update longest_streak = GREATEST(longest_streak, current_streak)
         - Check streak badges (4, 12, 26) and award

    7. Trigger function for review badges:
       - Fires AFTER INSERT on reviews
       - Award 'first_review' badge to reviewer if not already earned
       - If rating = 5 and revealed_at IS NOT NULL, award 'five_star' to reviewee

    8. **ALTER nearby_rides function (CREATE OR REPLACE)** to include `completed_rides_count` in the return type by joining with profiles table. This allows RideCard to compute user level from completed_rides_count and rating. This change MUST be in the migration, not in the UI task, because it modifies a database function.

    **Shared package:**

    Constants (gamification.ts):
    - USER_LEVELS definition:
      ```
      { NEW: { name: 'New', minRides: 0, minRating: 0 },
        REGULAR: { name: 'Regular', minRides: 3, minRating: 3.0 },
        EXPERIENCED: { name: 'Experienced', minRides: 15, minRating: 4.0 },
        AMBASSADOR: { name: 'Ambassador', minRides: 50, minRating: 4.5 } }
      ```
    - getUserLevel(completedRides: number, ratingAvg: number): returns the highest level the user qualifies for
    - CO2_SAVINGS_PER_KM: 0.120 (kg CO2 saved per km of shared ride)
    - BADGE_CATEGORIES: { RIDES: 'rides', REVIEWS: 'reviews', STREAKS: 'streaks', SPECIAL: 'special' }

    Validation (gamification.ts): (minimal -- no user input for gamification)
    - Just type exports for impact stats and badge types

    Database types: Add badge_definitions, user_achievements, route_streaks table types. Add get_user_impact, get_user_badges, get_route_streaks function signatures. Update nearby_rides return type to include completed_rides_count. Add derived types: BadgeDefinition, UserAchievement, RouteStreak, UserImpact (from get_user_impact return).

    Queries (gamification.ts):
    - getUserImpact(client, userId?) — calls get_user_impact RPC
    - getUserBadges(client, userId?) — calls get_user_badges RPC
    - getRouteStreaks(client, userId?) — calls get_route_streaks RPC
    - getAllBadges(client) — fetches all badge_definitions for displaying progress

    Index.ts: Export all gamification constants, types, queries.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/shared` to verify shared package compiles. Check migration SQL syntax. Verify nearby_rides ALTER is present with completed_rides_count in return type.
  </verify>
  <done>
    Gamification tables exist (badge_definitions with seed data, user_achievements, route_streaks). Impact stats RPC calculates CO2/money/rides. Badges auto-awarded on ride completion and review submission. Route streaks tracked per week. getUserLevel function computes level from rides+rating. nearby_rides function extended with completed_rides_count. Shared package exports all gamification types and queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Impact dashboard, badges, and level integration into profile and search</name>
  <files>
    apps/web/app/(app)/impact/page.tsx
    apps/web/app/(app)/impact/impact-dashboard.tsx
    apps/web/app/(app)/profile/components/badges-section.tsx
    apps/web/app/(app)/profile/components/level-badge.tsx
    apps/web/app/(app)/profile/[id]/page.tsx
    apps/web/app/(app)/search/ride-card.tsx
  </files>
  <action>
    **Impact dashboard page (/impact):**
    - Server component fetching user impact via getUserImpact, badges via getUserBadges, streaks via getRouteStreaks
    - ImpactDashboard client component:
      - Hero section with large stats cards:
        - CO2 Saved: "{X} kg" with tree icon (Leaf from lucide-react -- already installed)
        - Money Saved/Earned: "{X} CZK" with wallet icon
        - Rides Completed: "{X}" with car icon
        - Distance Shared: "{X} km" with road icon
        - Passengers Carried: "{X}" (for drivers)
      - Badges section: grid of earned badges with icon, name, date earned. Unearned badges shown grayed out with progress hint (e.g., "Complete 10 more rides")
      - Route Streaks section: list of active streaks with route name, current streak (weeks), longest streak, visual streak bar
      - User level prominently displayed with progress to next level
      - Share button (copies a summary text + URL to clipboard) -- "I've saved {X} kg CO2 by sharing rides on Festapp!"

    **BadgesSection component:**
    - Receives userId prop, fetches badges if not provided via props
    - Shows earned badges as colored pill/cards with emoji icon and name
    - Used on both own profile and public profile view

    **LevelBadge component:**
    - Receives completedRides and ratingAvg props
    - Calls getUserLevel() from shared constants to determine level
    - Renders a colored badge: New (gray), Regular (blue), Experienced (purple), Ambassador (gold)
    - Small variant for ride cards (just icon + level name)
    - Large variant for profile (icon + level name + progress bar to next level)

    **Profile integration:**
    - Modify public profile page (/profile/[id]/page.tsx) to:
      - Show LevelBadge (large variant) next to display name/rating
      - Add BadgesSection below existing profile info (after verification badges, before reviews)
      - Fetch badges in the server component parallel data loading

    **Search results integration:**
    - Modify RideCard component to show driver's LevelBadge (small variant) next to driver name
    - Use the driver's completed_rides_count now available from the extended nearby_rides return type (added in Task 1 migration) along with driver_rating to compute the user level via getUserLevel()

    **Styling:** Stats cards with soft gradients matching pastel design. Badge pills with category-specific colors. Level badge with distinct colors per level.
  </action>
  <verify>
    Run `pnpm turbo build --filter=@festapp/web` to verify web app compiles. Verify /impact route exists and profile pages render with badges/levels.
  </verify>
  <done>
    Impact dashboard at /impact shows CO2 saved, money saved, rides completed, distance, and passengers carried. Badges display on profile with earned/unearned states. User level badge appears on profile (large) and ride cards (small). RideCard uses completed_rides_count from nearby_rides to compute level. Route streaks visible on impact dashboard. Share button copies impact summary to clipboard.
  </done>
</task>

</tasks>

<verification>
1. Gamification migration has valid SQL with badge_definitions (seeded), user_achievements, route_streaks tables
2. nearby_rides function extended with completed_rides_count in return type
3. Auto-award triggers fire on ride completion and review submission
4. get_user_impact RPC returns correct CO2/money/distance calculations
5. getUserLevel returns correct level based on rides+rating thresholds
6. Impact dashboard displays all stats, badges, and streaks
7. Badges visible on public profiles
8. User level shown on ride cards in search results using completed_rides_count from nearby_rides
9. Share button copies impact text to clipboard
</verification>

<success_criteria>
- User sees personal impact stats (CO2, money, rides, distance) at /impact
- Badges auto-awarded on ride completion (first_ride, rides_10, etc.) and review submission
- Badges displayed on profile pages (own and public)
- User level (New/Regular/Experienced/Ambassador) shown on profile and ride cards
- RideCard computes level from completed_rides_count (from nearby_rides) and driver_rating
- Route streaks tracked weekly and displayed on impact dashboard
- Impact shareable via clipboard copy
</success_criteria>

<output>
After completion, create `.planning/phases/08-events-flexible-gamification/08-04-SUMMARY.md`
</output>
