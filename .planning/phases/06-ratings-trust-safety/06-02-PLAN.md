---
phase: 06-ratings-trust-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/constants/review.ts
  - packages/shared/src/constants/moderation.ts
  - packages/shared/src/constants/index.ts
  - packages/shared/src/validation/review.ts
  - packages/shared/src/validation/index.ts
  - packages/shared/src/queries/reviews.ts
  - packages/shared/src/queries/index.ts
  - packages/shared/src/types/database.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Shared constants for review constraints and moderation types are available"
    - "Zod schemas validate review submission, report submission, and admin actions"
    - "Query builders for reviews and reports use typed SupabaseClient pattern"
    - "Database types include all Phase 6 tables and RPC function signatures"
  artifacts:
    - path: "packages/shared/src/constants/review.ts"
      provides: "REVIEW_MAX_COMMENT_LENGTH, REVIEW_DEADLINE_DAYS, RATING_MIN/MAX"
      exports: ["REVIEW_MAX_COMMENT_LENGTH", "REVIEW_DEADLINE_DAYS"]
    - path: "packages/shared/src/constants/moderation.ts"
      provides: "ACCOUNT_STATUS, MODERATION_ACTION_TYPE, REPORT_STATUS, SUSPENSION_DURATIONS"
      exports: ["ACCOUNT_STATUS", "MODERATION_ACTION_TYPE"]
    - path: "packages/shared/src/validation/review.ts"
      provides: "SubmitReviewSchema, ReportUserSchema, AdminModerationSchema"
      exports: ["SubmitReviewSchema", "ReportUserSchema"]
    - path: "packages/shared/src/queries/reviews.ts"
      provides: "getReviewsForUser, getPendingReviews, getReportsForAdmin, getBlockedUsers"
      exports: ["getReviewsForUser", "getPendingReviews"]
    - path: "packages/shared/src/types/database.ts"
      provides: "Reviews, Reports, UserBlocks, ModerationActions, PlatformStatsDaily types + RPC signatures"
      contains: "reviews"
  key_links:
    - from: "packages/shared/src/validation/review.ts"
      to: "packages/shared/src/constants/review.ts"
      via: "Zod schemas use review constants for validation limits"
      pattern: "REVIEW_MAX_COMMENT_LENGTH"
    - from: "packages/shared/src/queries/reviews.ts"
      to: "packages/shared/src/types/database.ts"
      via: "Query builders use SupabaseClient<Database> type"
      pattern: "SupabaseClient"
---

<objective>
Create the shared package foundation for Phase 6: TypeScript types, Zod validation schemas, constants, and query builders for reviews, reports, blocks, and admin moderation.

Purpose: All Phase 6 UI plans depend on shared types, validation, and queries being available.
Output: Shared constants, validation schemas, query builders, and updated Database types.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-RESEARCH.md

@packages/shared/src/constants/index.ts
@packages/shared/src/constants/booking.ts
@packages/shared/src/validation/index.ts
@packages/shared/src/validation/booking.ts
@packages/shared/src/queries/bookings.ts
@packages/shared/src/queries/index.ts
@packages/shared/src/types/database.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Constants, validation schemas, and Database types for Phase 6</name>
  <files>
    packages/shared/src/constants/review.ts
    packages/shared/src/constants/moderation.ts
    packages/shared/src/constants/index.ts
    packages/shared/src/validation/review.ts
    packages/shared/src/validation/index.ts
    packages/shared/src/types/database.ts
    packages/shared/src/index.ts
  </files>
  <action>
**1. Constants — packages/shared/src/constants/review.ts:**
```typescript
export const REVIEW_MAX_COMMENT_LENGTH = 500;
export const REVIEW_DEADLINE_DAYS = 14;
export const RATING_MIN = 1;
export const RATING_MAX = 5;
export const REVIEW_REMINDER_HOURS = [0, 24, 168]; // immediate, 24h, 7d
```

**2. Constants — packages/shared/src/constants/moderation.ts:**
```typescript
export const ACCOUNT_STATUS = { ACTIVE: 'active', SUSPENDED: 'suspended', BANNED: 'banned' } as const;
export type AccountStatus = (typeof ACCOUNT_STATUS)[keyof typeof ACCOUNT_STATUS];

export const MODERATION_ACTION_TYPE = { WARNING: 'warning', SUSPENSION: 'suspension', BAN: 'ban', UNBAN: 'unban', UNSUSPEND: 'unsuspend' } as const;
export type ModerationActionType = (typeof MODERATION_ACTION_TYPE)[keyof typeof MODERATION_ACTION_TYPE];

export const REPORT_STATUS = { OPEN: 'open', REVIEWING: 'reviewing', RESOLVED: 'resolved', DISMISSED: 'dismissed' } as const;
export type ReportStatus = (typeof REPORT_STATUS)[keyof typeof REPORT_STATUS];

export const SUSPENSION_DURATIONS = [
  { label: '3 days', days: 3 },
  { label: '7 days', days: 7 },
  { label: '30 days', days: 30 },
] as const;

export const EXPERIENCED_BADGE_THRESHOLD = 10; // completed rides
```

Export both from constants/index.ts.

**3. Validation — packages/shared/src/validation/review.ts:**
- SubmitReviewSchema: { booking_id: z.string().uuid(), rating: z.number().int().min(1).max(5), comment: z.string().max(500).optional().nullable() }
- ReportUserSchema: { reported_user_id: z.string().uuid(), description: z.string().min(10).max(2000), ride_id: z.string().uuid().optional().nullable(), booking_id: z.string().uuid().optional().nullable(), review_id: z.string().uuid().optional().nullable() }
- AdminWarnSchema: { user_id: z.string().uuid(), reason: z.string().min(1).max(2000), report_id: z.string().uuid().optional().nullable() }
- AdminSuspendSchema: extends AdminWarnSchema + duration_days: z.number().int().min(1).max(365)
- AdminBanSchema: extends AdminWarnSchema + cancel_rides: z.boolean().default(false)
- AdminResolveReportSchema: { report_id: z.string().uuid(), status: z.enum(['resolved', 'dismissed']), admin_notes: z.string().max(2000).optional().nullable() }

Export inferred types alongside schemas. Use the existing Zod version pattern from the codebase (check if v3 or v4 and match).

Export from validation/index.ts.

**4. Database types — packages/shared/src/types/database.ts:**
Update the Database interface to add:
- Tables: reviews, reports, user_blocks, moderation_actions, platform_stats_daily
- Each with Row, Insert, Update types following existing patterns
- Add new profile columns: account_status, suspended_until, completed_rides_count
- Functions: submit_review (Args: { p_booking_id, p_rating, p_comment? }, Returns: Json), get_pending_reviews (Args: Record<string, never>, Returns: { booking_id, ride_id, other_user_id, other_user_name, other_user_avatar, origin_address, destination_address, ride_completed_at }), block_user (Args: { p_blocked_id }, Returns: void), unblock_user (Args: { p_blocked_id }, Returns: void), get_blocked_users (Args: Record<string, never>, Returns: { id, display_name, avatar_url, blocked_at }), report_user (Args: matching RPC params, Returns: string), admin RPCs

Derive convenience types: Review, Report, UserBlock, ModerationAction, PlatformStatDaily, PendingReview from Database['public']['Tables'] and Functions.

**5. Update index.ts files:**
- packages/shared/src/constants/index.ts: export * from './review' and './moderation'
- packages/shared/src/validation/index.ts: export * from './review' (the review validation file)
- packages/shared/src/index.ts: ensure constants, validation, queries, types all re-exported

Follow existing patterns exactly — check how booking constants and validation are structured and mirror that approach.
  </action>
  <verify>Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck` to verify all types compile. Verify exports resolve correctly.</verify>
  <done>Shared package has Phase 6 constants (review limits, moderation types, account statuses), Zod validation schemas (submit review, report user, admin actions), updated Database types with all Phase 6 tables and RPCs, all correctly exported from package index.</done>
</task>

<task type="auto">
  <name>Task 2: Query builders for reviews, reports, blocks, and admin data + install recharts</name>
  <files>
    packages/shared/src/queries/reviews.ts
    packages/shared/src/queries/index.ts
  </files>
  <action>
**1. Install recharts for admin dashboard charts:**
```bash
cd apps/web && pnpm add recharts
```

**2. Query builders — packages/shared/src/queries/reviews.ts:**

Follow the existing pattern from queries/bookings.ts — functions take SupabaseClient as first arg, return query builders.

```typescript
// Reviews for a user's profile page (only revealed)
export function getReviewsForUser(supabase: SupabaseClient<Database>, userId: string) {
  return supabase
    .from('reviews')
    .select('id, rating, comment, created_at, revealed_at, reviewer:reviewer_id(id, display_name, avatar_url)')
    .eq('reviewee_id', userId)
    .not('revealed_at', 'is', null)
    .order('created_at', { ascending: false });
}

// Check if current user has already reviewed a specific booking
export function getExistingReview(supabase: SupabaseClient<Database>, bookingId: string, userId: string) {
  return supabase
    .from('reviews')
    .select('id, rating, comment')
    .eq('booking_id', bookingId)
    .eq('reviewer_id', userId)
    .maybeSingle();
}

// Admin: get all reports with reporter and reported user info
export function getReportsForAdmin(supabase: SupabaseClient<Database>, status?: string) {
  let query = supabase
    .from('reports')
    .select('*, reporter:reporter_id(id, display_name, avatar_url), reported_user:reported_user_id(id, display_name, avatar_url)')
    .order('created_at', { ascending: false });
  if (status) query = query.eq('status', status);
  return query;
}

// Admin: get single report with full context
export function getReportById(supabase: SupabaseClient<Database>, reportId: string) {
  return supabase
    .from('reports')
    .select('*, reporter:reporter_id(id, display_name, avatar_url, account_status), reported_user:reported_user_id(id, display_name, avatar_url, account_status, rating_avg, rating_count, completed_rides_count)')
    .eq('id', reportId)
    .single();
}

// Admin: get moderation history for a user
export function getModerationHistory(supabase: SupabaseClient<Database>, userId: string) {
  return supabase
    .from('moderation_actions')
    .select('*, admin:admin_id(display_name)')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
}

// Admin: get platform stats for date range
export function getPlatformStats(supabase: SupabaseClient<Database>, startDate: string, endDate: string) {
  return supabase
    .from('platform_stats_daily')
    .select('*')
    .gte('date', startDate)
    .lte('date', endDate)
    .order('date', { ascending: true });
}

// Admin: get platform overview (latest stats + summary counts)
export function getPlatformOverview(supabase: SupabaseClient<Database>) {
  return supabase
    .from('platform_stats_daily')
    .select('*')
    .order('date', { ascending: false })
    .limit(1)
    .maybeSingle();
}

// Admin: search users for moderation (by name or email)
export function searchUsersForAdmin(supabase: SupabaseClient<Database>, query: string) {
  return supabase
    .from('profiles')
    .select('id, display_name, avatar_url, account_status, rating_avg, rating_count, completed_rides_count, created_at')
    .ilike('display_name', `%${query}%`)
    .order('created_at', { ascending: false })
    .limit(50);
}

// Admin: get all reviews (for review management, including hidden)
export function getReviewsForAdmin(supabase: SupabaseClient<Database>) {
  return supabase
    .from('reviews')
    .select('*, reviewer:reviewer_id(id, display_name, avatar_url), reviewee:reviewee_id(id, display_name, avatar_url)')
    .order('created_at', { ascending: false });
}
```

**3. Update queries/index.ts:**
Export * from './reviews'.

Follow the exact SupabaseClient<Database> typing pattern used in the existing query builders (check queries/bookings.ts for import patterns).
  </action>
  <verify>Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck`. Verify recharts is in apps/web/package.json. Verify query builders are exported from @festapp/shared.</verify>
  <done>Query builders for reviews (profile display, existing check), reports (admin list/detail), moderation history, platform stats, user search, and admin review management exist. recharts installed in web app.</done>
</task>

</tasks>

<verification>
- `pnpm turbo typecheck` passes across all packages
- All constants, schemas, queries, and types are importable from `@festapp/shared`
- recharts appears in apps/web/package.json dependencies
- SubmitReviewSchema validates rating 1-5, comment max 500
- ReportUserSchema validates description 10-2000
- Database types include reviews, reports, user_blocks, moderation_actions, platform_stats_daily tables
</verification>

<success_criteria>
The shared package provides all TypeScript types, validation schemas, constants, and query builders needed by the rating UI (Plan 03), report/block UI (Plan 04), and admin panel (Plan 05). recharts is installed for admin dashboard charts.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ratings-trust-safety/06-02-SUMMARY.md`
</output>
