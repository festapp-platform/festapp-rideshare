---
phase: 06-ratings-trust-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000029_reviews.sql
  - supabase/migrations/00000000000030_reports_blocks.sql
  - supabase/migrations/00000000000031_admin_moderation.sql
autonomous: true

must_haves:
  truths:
    - "Reviews table exists with dual-reveal mechanism (revealed_at column)"
    - "submit_review RPC validates booking status, participant, 14-day window, and inserts review"
    - "Dual-reveal trigger sets revealed_at on both reviews when counter-review is inserted"
    - "pg_cron reveals unrevealed reviews older than 14 days"
    - "Rating aggregation trigger updates profiles.rating_avg and rating_count when review is revealed"
    - "Reports, user_blocks, moderation_actions tables exist with proper RLS"
    - "block_user and unblock_user RPCs work correctly"
    - "Admin RPCs (warn, suspend, ban) enforce is_admin() check"
    - "Suspension auto-expiry via pg_cron"
    - "Platform stats daily snapshot via pg_cron"
    - "Block-aware nearby_rides excludes blocked users from search"
  artifacts:
    - path: "supabase/migrations/00000000000029_reviews.sql"
      provides: "Reviews table, dual-reveal trigger, rating aggregation trigger, submit_review RPC, get_pending_reviews RPC, reveal cron job, completed_rides_count tracking"
      contains: "CREATE TABLE public.reviews"
    - path: "supabase/migrations/00000000000030_reports_blocks.sql"
      provides: "Reports, user_blocks tables with RLS, block/unblock/report RPCs, block-aware search/booking/chat modifications"
      contains: "CREATE TABLE public.reports"
    - path: "supabase/migrations/00000000000031_admin_moderation.sql"
      provides: "moderation_actions table, is_admin() function, admin RPCs, platform_stats_daily, admin RLS, suspension expiry cron"
      contains: "CREATE TABLE public.moderation_actions"
  key_links:
    - from: "reviews.check_review_reveal trigger"
      to: "reviews.revealed_at"
      via: "AFTER INSERT trigger checks for counter-review"
      pattern: "check_review_reveal"
    - from: "reviews.update_rating_aggregates trigger"
      to: "profiles.rating_avg"
      via: "AFTER INSERT OR UPDATE OF revealed_at recalculates average"
      pattern: "update_rating_aggregates"
    - from: "user_blocks"
      to: "nearby_rides RPC"
      via: "NOT EXISTS subquery filters blocked users"
      pattern: "NOT EXISTS.*user_blocks"
---

<objective>
Create the complete database foundation for Phase 6: reviews with dual-reveal mechanism, reports, user blocks, admin moderation actions, platform stats, and all associated RPCs, triggers, cron jobs, and RLS policies.

Purpose: All Phase 6 features (ratings UI, report/block UI, admin panel) depend on this database layer existing first.
Output: Three migration files covering reviews, reports/blocks, and admin moderation.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-RESEARCH.md

@supabase/migrations/00000000000012_ride_search_rpc.sql
@supabase/migrations/00000000000015_booking_rpcs.sql
@supabase/migrations/00000000000024_chat_rpcs.sql
@supabase/migrations/00000000000001_profiles.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reviews migration — table, dual-reveal trigger, rating aggregation, submit_review RPC, pending reviews RPC, reveal cron, completed_rides_count</name>
  <files>supabase/migrations/00000000000029_reviews.sql</files>
  <action>
Create migration `00000000000029_reviews.sql` with:

**1. Reviews table:**
- id UUID PK, booking_id (FK bookings), ride_id (FK rides), reviewer_id (FK profiles), reviewee_id (FK profiles)
- rating INT CHECK 1-5, comment TEXT CHECK <= 500 chars, revealed_at TIMESTAMPTZ (NULL = hidden)
- created_at TIMESTAMPTZ DEFAULT now()
- UNIQUE(booking_id, reviewer_id) — one review per user per booking
- Indexes: idx_reviews_reviewee (reviewee_id, revealed_at DESC WHERE revealed_at IS NOT NULL), idx_reviews_ride (ride_id), idx_reviews_booking (booking_id), idx_reviews_unrevealed (created_at WHERE revealed_at IS NULL)

**2. Profile columns:**
- ALTER TABLE profiles ADD COLUMN account_status TEXT DEFAULT 'active' CHECK IN ('active', 'suspended', 'banned')
- ALTER TABLE profiles ADD COLUMN suspended_until TIMESTAMPTZ
- ALTER TABLE profiles ADD COLUMN completed_rides_count INT DEFAULT 0

**3. Dual-reveal trigger (check_review_reveal):**
- AFTER INSERT on reviews, SECURITY DEFINER SET search_path = ''
- Find counter-review (same booking_id, reviewer is the new row's reviewee and vice versa) with SELECT ... FOR UPDATE to prevent race condition (Pitfall 2)
- If counter-review found: UPDATE both reviews SET revealed_at = now()
- Use the pattern from research but add FOR UPDATE on the counter-review query

**4. Rating aggregation trigger (update_rating_aggregates):**
- AFTER INSERT OR UPDATE OF revealed_at on reviews
- WHEN (NEW.revealed_at IS NOT NULL)
- Recalculates rating_avg and rating_count on profiles from all revealed reviews for the reviewee
- SECURITY DEFINER SET search_path = ''

**5. Completed rides count triggers:**
- On bookings status UPDATE to 'completed': increment completed_rides_count for passenger
- On rides status UPDATE to 'completed': increment completed_rides_count for driver
- Both SECURITY DEFINER SET search_path = ''

**6. submit_review RPC:**
- Takes p_booking_id UUID, p_rating INT, p_comment TEXT DEFAULT NULL
- Returns JSONB with review_id and both_reviewed boolean
- Validates: booking exists, booking status = 'completed', caller is participant, 14-day window not expired, no duplicate review
- Determines other_user_id based on caller role (driver vs passenger)
- Inserts review, checks if counter-review exists for both_reviewed response

**7. get_pending_reviews RPC:**
- Returns TABLE (booking_id, ride_id, other_user_id, other_user_name, other_user_avatar, origin_address, destination_address, ride_completed_at)
- SQL STABLE function
- Finds completed bookings where auth.uid() is participant and hasn't reviewed yet, within 14-day window

**8. RLS policies on reviews:**
- SELECT: revealed_at IS NOT NULL OR reviewer_id = auth.uid() (users see revealed reviews + their own unrevealed)
- INSERT: reviewer_id = auth.uid()
- No UPDATE/DELETE for regular users (immutable reviews per user decision)

**9. pg_cron: reveal-expired-reviews:**
- Schedule '0 3 * * *' (daily 3 AM)
- UPDATE reviews SET revealed_at = now() WHERE revealed_at IS NULL AND created_at < now() - interval '14 days'

Follow existing migration patterns: SECURITY DEFINER SET search_path = '' on all functions, extensions. prefix for PostGIS functions where needed.
  </action>
  <verify>Run `supabase db reset` or review SQL syntax. Verify: reviews table created, submit_review function exists, check_review_reveal trigger exists, update_rating_aggregates trigger exists, get_pending_reviews function exists, RLS enabled on reviews, cron job scheduled.</verify>
  <done>Reviews table with dual-reveal trigger, rating aggregation, submit/pending RPCs, completed_rides_count tracking, and reveal cron job all exist and have correct RLS policies.</done>
</task>

<task type="auto">
  <name>Task 2: Reports, blocks, and admin moderation migration — tables, RPCs, block-aware search/booking/chat, admin functions, platform stats, suspension expiry</name>
  <files>supabase/migrations/00000000000030_reports_blocks.sql, supabase/migrations/00000000000031_admin_moderation.sql</files>
  <action>
**Migration 00000000000030_reports_blocks.sql:**

**1. Reports table:**
- id UUID PK, reporter_id (FK profiles), reported_user_id (FK profiles)
- ride_id (FK rides ON DELETE SET NULL), booking_id (FK bookings ON DELETE SET NULL), review_id (FK reviews ON DELETE SET NULL) — optional context
- description TEXT CHECK length 10-2000
- status TEXT DEFAULT 'open' CHECK IN ('open', 'reviewing', 'resolved', 'dismissed')
- admin_notes TEXT, resolved_by (FK profiles), resolved_at TIMESTAMPTZ
- created_at DEFAULT now()
- Indexes: idx_reports_status (status, created_at DESC), idx_reports_reported_user (reported_user_id)

**2. User blocks table:**
- id UUID PK, blocker_id (FK profiles ON DELETE CASCADE), blocked_id (FK profiles ON DELETE CASCADE)
- created_at DEFAULT now()
- UNIQUE(blocker_id, blocked_id), CHECK blocker_id != blocked_id
- Indexes: idx_blocks_blocker (blocker_id), idx_blocks_blocked (blocked_id)

**3. Report user RPC (report_user):**
- Takes p_reported_user_id UUID, p_description TEXT, p_ride_id UUID DEFAULT NULL, p_booking_id UUID DEFAULT NULL, p_review_id UUID DEFAULT NULL
- Validates: not reporting self, description length
- Returns report id

**4. Block/unblock RPCs:**
- block_user(p_blocked_id UUID): INSERT with ON CONFLICT DO NOTHING, validates not blocking self
- unblock_user(p_blocked_id UUID): DELETE from user_blocks where blocker_id = auth.uid()
- get_blocked_users(): Returns TABLE of blocked user profiles (id, display_name, avatar_url, created_at from user_blocks)

**5. RLS policies:**
- Reports: INSERT by authenticated (reporter_id = auth.uid()), SELECT own reports (reporter_id = auth.uid() OR is_admin()), UPDATE by admin only
- User blocks: ALL for own blocks (blocker_id = auth.uid())

**6. Block-aware modifications to existing RPCs:**
- Create a new version of nearby_rides or add a wrapper that adds NOT EXISTS (SELECT 1 FROM user_blocks WHERE (blocker_id = auth.uid() AND blocked_id = r.driver_id) OR (blocker_id = r.driver_id AND blocked_id = auth.uid())) to the WHERE clause.
  IMPORTANT: Read the existing nearby_rides function in 00000000000012_ride_search_rpc.sql first and use CREATE OR REPLACE to add block filtering. Preserve all existing logic.
- Add block check to book_ride_instant and request_ride_booking RPCs: before proceeding, verify no block exists between auth.uid() and the ride's driver_id. Use CREATE OR REPLACE preserving existing logic, just adding the block check at the beginning.
- Add block check to send_chat_message RPC (in 00000000000024_chat_rpcs.sql pattern): before inserting message, verify no block exists between sender and other conversation participant.

**Migration 00000000000031_admin_moderation.sql:**

**1. Moderation actions table:**
- id UUID PK, user_id (FK profiles), admin_id (FK profiles)
- action_type TEXT CHECK IN ('warning', 'suspension', 'ban', 'unban', 'unsuspend')
- reason TEXT NOT NULL, expires_at TIMESTAMPTZ, report_id (FK reports ON DELETE SET NULL)
- created_at DEFAULT now()
- Index: idx_mod_actions_user (user_id, created_at DESC)

**2. is_admin() helper function:**
- SQL STABLE, returns BOOLEAN
- Reads auth.jwt() -> 'app_metadata' ->> 'is_admin' coalesced to false

**3. Admin RPCs:**
- admin_warn_user(p_user_id, p_reason, p_report_id DEFAULT NULL): checks is_admin(), inserts moderation_action
- admin_suspend_user(p_user_id, p_reason, p_duration_days INT, p_report_id DEFAULT NULL): checks is_admin(), updates profile account_status='suspended' + suspended_until, inserts action
- admin_ban_user(p_user_id, p_reason, p_cancel_rides BOOLEAN DEFAULT false, p_report_id DEFAULT NULL): checks is_admin(), updates profile account_status='banned', optionally cancels upcoming rides and their bookings, inserts action
- admin_unban_user(p_user_id, p_reason): checks is_admin(), updates profile account_status='active', inserts action with type 'unban'
- admin_resolve_report(p_report_id, p_status TEXT, p_admin_notes TEXT DEFAULT NULL): checks is_admin(), updates report status/resolved_by/resolved_at
- admin_hide_review(p_review_id): checks is_admin(), sets revealed_at = NULL (hides review, triggers rating recalculation)
- admin_delete_review(p_review_id): checks is_admin(), deletes review, triggers rating recalculation via manual UPDATE of reviewee profile

**4. Platform stats daily table:**
- date DATE PK, total_users, new_users, total_rides, new_rides, total_bookings, new_bookings, active_reports — all INT DEFAULT 0
- created_at DEFAULT now()

**5. pg_cron jobs:**
- daily-platform-stats: '0 1 * * *' — snapshot counts into platform_stats_daily with ON CONFLICT DO UPDATE
- expire-suspensions: '*/15 * * * *' — every 15 min: UPDATE profiles SET account_status='active', suspended_until=NULL WHERE account_status='suspended' AND suspended_until < now()

**6. RLS policies:**
- moderation_actions: ALL for admins (is_admin()), SELECT for users on own records (user_id = auth.uid())
- platform_stats_daily: SELECT for admins only (is_admin())
- Add admin SELECT policies on log_notifications and log_emails tables

**7. Admin notification trigger on reports INSERT:**
- AFTER INSERT on reports, call _notify() for each admin user (query profiles where is_admin() or simpler: use a direct pg_net call to send-notification targeting admin users)
- Use the existing _notify() helper pattern from notification_triggers migration

All functions use SECURITY DEFINER SET search_path = '' pattern.
  </action>
  <verify>Run `supabase db reset` or review SQL syntax. Verify: reports, user_blocks, moderation_actions, platform_stats_daily tables created with RLS. All RPCs exist (report_user, block_user, unblock_user, get_blocked_users, admin_warn_user, admin_suspend_user, admin_ban_user, admin_unban_user, admin_resolve_report, admin_hide_review, admin_delete_review). Cron jobs scheduled. Block filtering in nearby_rides works.</verify>
  <done>Reports/blocks/moderation tables with full RLS, all RPCs for reporting, blocking, admin moderation, platform stats cron, suspension expiry cron, block-aware search/booking/chat, and admin notification on new reports all exist.</done>
</task>

</tasks>

<verification>
- `supabase db reset` completes without errors
- reviews table has revealed_at column and dual-reveal trigger
- submit_review function validates all constraints
- get_pending_reviews returns correct results for test data
- block_user/unblock_user work without errors
- nearby_rides filters out blocked users
- is_admin() returns false for regular users
- Admin RPCs reject non-admin callers
- platform_stats_daily cron job scheduled
- expire-suspensions cron job scheduled
</verification>

<success_criteria>
All three migrations apply cleanly. The database layer supports: mutual reviews with dual-reveal, user reporting, silent blocking with bidirectional invisibility in search/booking/chat, admin moderation actions (warn/suspend/ban), platform stats snapshots, and automatic suspension expiry.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md`
</output>
