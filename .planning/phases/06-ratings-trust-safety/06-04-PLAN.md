---
phase: 06-ratings-trust-safety
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/web/app/(app)/components/report-dialog.tsx
  - apps/web/app/(app)/components/block-button.tsx
  - apps/web/app/(app)/profile/[id]/page.tsx
  - apps/web/app/(app)/settings/blocked-users/page.tsx
  - apps/web/app/(app)/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can report another user with free text description"
    - "User can silently block another user (no notification sent)"
    - "Blocked user's rides are invisible in search results"
    - "Blocked user cannot book the blocker's rides"
    - "Blocked user cannot send messages to the blocker"
    - "User can view and manage blocked users from settings"
    - "User can unblock a previously blocked user"
    - "Reports and blocks are independent actions"
  artifacts:
    - path: "apps/web/app/(app)/components/report-dialog.tsx"
      provides: "Report user dialog with free text description"
      exports: ["ReportDialog"]
    - path: "apps/web/app/(app)/components/block-button.tsx"
      provides: "Block/unblock toggle button"
      exports: ["BlockButton"]
    - path: "apps/web/app/(app)/settings/blocked-users/page.tsx"
      provides: "Blocked users management page"
      contains: "unblock"
  key_links:
    - from: "apps/web/app/(app)/components/report-dialog.tsx"
      to: "report_user RPC"
      via: "supabase.rpc('report_user') on submit"
      pattern: "report_user"
    - from: "apps/web/app/(app)/components/block-button.tsx"
      to: "block_user / unblock_user RPCs"
      via: "supabase.rpc('block_user') or supabase.rpc('unblock_user')"
      pattern: "block_user"
    - from: "apps/web/app/(app)/settings/blocked-users/page.tsx"
      to: "get_blocked_users RPC"
      via: "supabase.rpc('get_blocked_users') to list blocked users"
      pattern: "get_blocked_users"
---

<objective>
Build the user reporting and blocking features: report dialog, block/unblock button, blocked users management in settings, and integration into the profile page.

Purpose: Implements RATE-04 and RATE-05 — users can report bad behavior and block other users for safety.
Output: Report dialog, block button, blocked users settings page, updated profile page with report/block actions.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-RESEARCH.md
@.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md
@.planning/phases/06-ratings-trust-safety/06-02-SUMMARY.md

@apps/web/app/(app)/profile/[id]/page.tsx
@apps/web/app/(app)/settings/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report dialog, block button, and blocked users settings page</name>
  <files>
    apps/web/app/(app)/components/report-dialog.tsx
    apps/web/app/(app)/components/block-button.tsx
    apps/web/app/(app)/settings/blocked-users/page.tsx
  </files>
  <action>
**1. ReportDialog component (report-dialog.tsx):**
- "use client"
- Props: reportedUserId, reportedUserName, isOpen, onClose, rideId? (optional context), bookingId? (optional context), reviewId? (optional context)
- Modal/dialog overlay with:
  - Header: "Report [userName]"
  - Textarea for description (free text, 10-2000 chars, per ReportUserSchema validation)
  - Character count indicator
  - Cancel and Submit buttons
- On submit: validate with ReportUserSchema, call supabase.rpc('report_user', { p_reported_user_id, p_description, p_ride_id, p_booking_id, p_review_id })
- Success: toast.success('Report submitted. Our team will review it.'), close dialog
- Error handling: show toast with error message
- Loading state on submit button

**2. BlockButton component (block-button.tsx):**
- "use client"
- Props: userId (the user to block/unblock), initialBlocked? (boolean, for optimistic UI)
- On mount or when userId changes, check if user is blocked: query user_blocks table for blocker_id = current user and blocked_id = userId
- Toggle button:
  - Not blocked: shows "Block" (red text or icon) — on click, call supabase.rpc('block_user', { p_blocked_id: userId })
  - Blocked: shows "Unblock" — on click, call supabase.rpc('unblock_user', { p_blocked_id: userId })
- Confirm dialog before blocking: "Are you sure you want to block [name]? They won't be notified, but their rides and messages will become invisible to you."
- No confirmation for unblocking (instant)
- Use optimistic UI: toggle state immediately, revert on error
- Silent blocking per user decision: no notification sent to the blocked user

**3. Blocked users settings page (settings/blocked-users/page.tsx):**
- Server component that fetches blocked users via get_blocked_users RPC (or client component with useEffect)
- List of blocked users showing: avatar, display name, "Blocked on [date]"
- Unblock button on each row — calls supabase.rpc('unblock_user', { p_blocked_id })
- On unblock success: remove from list with optimistic update, toast.success('[name] unblocked')
- Empty state: "You haven't blocked anyone"
- Back navigation to settings
  </action>
  <verify>ReportDialog submits report via RPC. BlockButton toggles block state with confirmation. Blocked users page lists and allows unblocking. All toast notifications work.</verify>
  <done>Report dialog validates free text 10-2000 chars and submits via report_user RPC. Block button checks block status and toggles via block_user/unblock_user RPCs with confirmation dialog. Blocked users settings page shows list with unblock capability.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate report/block into profile page and add blocked users link to settings</name>
  <files>
    apps/web/app/(app)/profile/[id]/page.tsx
    apps/web/app/(app)/settings/page.tsx
  </files>
  <action>
**1. Update profile page (profile/[id]/page.tsx):**
- Add Report and Block buttons visible ONLY when viewing another user's profile (not own profile)
- Position: action area near the top of the profile, perhaps as a dropdown menu (three dots / ellipsis icon) with "Report" and "Block" options, or as secondary action buttons below the main profile info
- Report button opens ReportDialog with the viewed user's ID and name
- Block button uses BlockButton component
- If the viewed user IS blocked by the current user, show a banner: "You have blocked this user" with an unblock option. Optionally hide most of their profile content (just show name and the block banner)
- Pass optional context to ReportDialog: if viewing profile from a ride detail page, the ride_id could be in the URL — but for simplicity, just pass the user context

**2. Update settings page (settings/page.tsx):**
- Add "Blocked Users" item to the settings list, linking to /settings/blocked-users
- Position: in the account/privacy section of settings
- Show a count badge if there are blocked users (optional, can be deferred for simplicity)
- Use the existing settings section/item pattern from the current settings page

**3. Handle suspended/banned user visibility:**
- When viewing a profile, check if the viewed user's account_status is 'suspended' or 'banned'
- For suspended users: show the profile normally but with a subtle indicator (only visible to the user themselves when they view their own profile)
- For banned users: show a "This account has been suspended" message and hide profile content
- When the CURRENT user is suspended: show a banner at the top of the app indicating their suspension and when it expires. They can still view the app but ride posting/booking RPCs will reject them server-side. Add this check in the app layout by reading the user's profile.account_status.
  </action>
  <verify>Other user's profile shows Report (three-dot menu or buttons) and Block options. Own profile does not show these. Blocked user profile shows block banner. Settings page has Blocked Users link. Suspended user sees suspension banner.</verify>
  <done>Profile page shows report/block actions on other users' profiles, blocked users see a "blocked" banner. Settings page links to blocked users management. Suspended users see a suspension banner with expiry date. Banned users' profiles show "suspended" message to visitors.</done>
</task>

</tasks>

<verification>
- Visit another user's profile -> report and block options visible
- Submit a report -> toast confirmation, report created in DB
- Block a user -> confirmation dialog -> block saved -> toast
- Blocked user's rides no longer appear in search (server-side via RPC)
- Visit blocked user's profile -> shows block banner
- Settings -> Blocked Users -> shows blocked user -> unblock works
- Unblock -> user's rides reappear in search
- Own profile does not show report/block buttons
</verification>

<success_criteria>
Users can report another user for inappropriate behavior with free text description. Users can silently block another user, making their rides and messages invisible. Blocked users list is manageable from settings with unblock capability. All actions integrated into the profile page UI.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ratings-trust-safety/06-04-SUMMARY.md`
</output>
