---
phase: 06-ratings-trust-safety
plan: 05
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/web/middleware.ts
  - apps/web/app/admin/layout.tsx
  - apps/web/app/admin/page.tsx
  - apps/web/app/admin/reports/page.tsx
  - apps/web/app/admin/reports/[id]/page.tsx
  - apps/web/app/admin/users/page.tsx
  - apps/web/app/admin/users/[id]/page.tsx
  - apps/web/app/admin/reviews/page.tsx
  - apps/web/app/admin/components/stats-cards.tsx
  - apps/web/app/admin/components/trend-chart.tsx
  - apps/web/app/admin/components/admin-sidebar.tsx
  - apps/web/app/admin/components/moderation-action-form.tsx
autonomous: true

must_haves:
  truths:
    - "Admin panel at /admin is protected by middleware (non-admins redirected to /)"
    - "Admin dashboard shows platform stats: total users, rides, bookings, active reports"
    - "Admin dashboard shows daily/weekly trend graphs for signups, rides, bookings"
    - "Admin can view reports list filtered by status (open, reviewing, resolved, dismissed)"
    - "Admin can resolve or dismiss a report with notes"
    - "Admin can warn, suspend (3/7/30 days), or ban a user"
    - "Admin can hide or delete offensive reviews"
    - "Admin panel is responsive (works on mobile for quick moderation)"
    - "Admin data is protected by RLS (is_admin() check)"
  artifacts:
    - path: "apps/web/middleware.ts"
      provides: "Admin route protection checking app_metadata.is_admin"
      contains: "/admin"
    - path: "apps/web/app/admin/layout.tsx"
      provides: "Admin layout with sidebar navigation"
      exports: ["default"]
    - path: "apps/web/app/admin/page.tsx"
      provides: "Dashboard with stats cards and trend charts"
      contains: "StatsCards"
    - path: "apps/web/app/admin/reports/page.tsx"
      provides: "Reports list with status filter"
      contains: "getReportsForAdmin"
    - path: "apps/web/app/admin/users/[id]/page.tsx"
      provides: "User detail with moderation actions"
      contains: "ModerationActionForm"
  key_links:
    - from: "apps/web/middleware.ts"
      to: "auth.getUser()"
      via: "Check app_metadata.is_admin on /admin routes"
      pattern: "is_admin"
    - from: "apps/web/app/admin/page.tsx"
      to: "getPlatformStats query builder"
      via: "Server-side data fetch for trend charts"
      pattern: "getPlatformStats"
    - from: "apps/web/app/admin/users/[id]/page.tsx"
      to: "admin_warn_user / admin_suspend_user / admin_ban_user RPCs"
      via: "supabase.rpc() calls from moderation form"
      pattern: "admin_warn_user|admin_suspend_user|admin_ban_user"
---

<objective>
Build the admin moderation panel: protected dashboard at /admin with platform stats, report management, user moderation (warn/suspend/ban), and review management.

Purpose: Implements ADMN-01, ADMN-02, ADMN-03, ADMN-04 — admin panel for platform moderation.
Output: Complete admin panel with dashboard, reports, user moderation, and review management pages.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-RESEARCH.md
@.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md
@.planning/phases/06-ratings-trust-safety/06-02-SUMMARY.md

@apps/web/middleware.ts
@apps/web/app/(app)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin middleware protection, layout with sidebar, dashboard with stats cards and trend charts</name>
  <files>
    apps/web/middleware.ts
    apps/web/app/admin/layout.tsx
    apps/web/app/admin/page.tsx
    apps/web/app/admin/components/stats-cards.tsx
    apps/web/app/admin/components/trend-chart.tsx
    apps/web/app/admin/components/admin-sidebar.tsx
  </files>
  <action>
**1. Middleware update (middleware.ts):**
- Read the existing middleware file first to understand the current pattern
- Add admin route protection: if pathname starts with '/admin', check user.app_metadata.is_admin === true
- If not admin: redirect to '/' (home page)
- The auth user should already be available from the existing middleware logic (getUser())
- Keep all existing middleware logic intact, just add the admin check

**2. Admin layout (admin/layout.tsx):**
- Server component (or client component if needed for sidebar state)
- IMPORTANT: admin routes are at /admin (NOT inside (app) group) so they get their own layout without the regular app shell
- Sidebar navigation using AdminSidebar component
- Main content area with proper padding
- Responsive: sidebar collapses to top nav or hamburger menu on mobile
- Admin-specific styling: slightly different from main app (professional/minimal)
- Links: Dashboard (/admin), Reports (/admin/reports), Users (/admin/users), Reviews (/admin/reviews)
- Show admin user avatar and name in sidebar header
- Include authentication — create Supabase server client and fetch user in layout

**3. AdminSidebar component (admin/components/admin-sidebar.tsx):**
- "use client" (needs usePathname for active state)
- Navigation items: Dashboard, Reports (with count badge for open reports), Users, Reviews
- Active state highlighting based on current pathname
- Responsive: full sidebar on desktop (md+), collapsible on mobile
- Use lucide-react icons for each nav item: LayoutDashboard, Flag, Users, Star

**4. Dashboard page (admin/page.tsx):**
- Server component fetching platform stats
- Fetch latest stats from platform_stats_daily + live counts for current state
- For live counts (more accurate than daily snapshot): run COUNT queries via Supabase for total_users, total_rides, total_bookings, active_reports (open+reviewing)
- Fetch trend data: getPlatformStats for last 30 days
- Display:
  - StatsCards row at top: 4 cards (Total Users, Total Rides, Total Bookings, Active Reports) with values and change indicators (vs yesterday)
  - TrendChart below: line chart showing daily signups, new rides, new bookings over last 30 days
  - Quick links: "View open reports" count, "Recent moderation actions" count

**5. StatsCards component (admin/components/stats-cards.tsx):**
- Props: stats object with { total_users, total_rides, total_bookings, active_reports, new_users_today, new_rides_today, new_bookings_today }
- 4 cards in a responsive grid (2x2 on mobile, 4x1 on desktop)
- Each card: icon, label, value (large number), and change badge (+N today)
- Clean design with subtle colors matching the pastel system

**6. TrendChart component (admin/components/trend-chart.tsx):**
- "use client" (recharts needs client rendering)
- Props: data array of platform_stats_daily rows
- Use dynamic import for recharts to avoid SSR issues and keep bundle size from affecting regular users: const { LineChart, Line, XAxis, YAxis, Tooltip, ResponsiveContainer } = await import('recharts')
- Actually, use next/dynamic with ssr: false for the chart wrapper
- Line chart with 3 lines: new_users (blue), new_rides (green), new_bookings (purple)
- X-axis: dates. Y-axis: counts. Tooltip showing values on hover
- Responsive container filling parent width
- Date range selector: Last 7 days / Last 30 days / Last 90 days (filter data client-side)
  </action>
  <verify>Navigate to /admin as non-admin -> redirected to /. Navigate to /admin as admin -> dashboard loads. Stats cards show real data. Trend chart renders with recharts. Sidebar navigation works. Responsive layout on mobile.</verify>
  <done>Admin panel is middleware-protected, has a responsive sidebar layout, dashboard shows live platform stats in cards and daily trend graphs using recharts, sidebar highlights active section.</done>
</task>

<task type="auto">
  <name>Task 2: Reports management, user moderation (warn/suspend/ban), and review management pages</name>
  <files>
    apps/web/app/admin/reports/page.tsx
    apps/web/app/admin/reports/[id]/page.tsx
    apps/web/app/admin/users/page.tsx
    apps/web/app/admin/users/[id]/page.tsx
    apps/web/app/admin/reviews/page.tsx
    apps/web/app/admin/components/moderation-action-form.tsx
  </files>
  <action>
**1. Reports list page (admin/reports/page.tsx):**
- Server component or client with data fetching
- Fetch reports using getReportsForAdmin query builder
- Status filter tabs: All, Open, Reviewing, Resolved, Dismissed
- Reports table/list showing: reported user name+avatar, reporter name, description (truncated), status badge, date
- Click row -> navigate to /admin/reports/[id]
- Badge with count of open reports
- Sort by newest first

**2. Report detail page (admin/reports/[id]/page.tsx):**
- Server component fetching report by ID via getReportById
- Shows: full description, reporter profile link, reported user profile link, context links (ride/booking/review if provided)
- Reported user section: avatar, name, account status, rating, completed rides, link to user detail
- Moderation actions section:
  - "Mark as Reviewing" button (if open)
  - "Resolve" button with admin notes textarea -> calls admin_resolve_report RPC with status 'resolved'
  - "Dismiss" button with optional notes -> calls admin_resolve_report RPC with status 'dismissed'
  - Quick action links: "Warn this user", "Suspend this user", "Ban this user" -> navigate to /admin/users/[reported_user_id] with action pre-selected
- Show resolution info if already resolved: resolved_by admin name, resolved_at date, admin_notes

**3. Users list page (admin/users/page.tsx):**
- Search bar at top: search by display name using searchUsersForAdmin query builder
- Results table: avatar, display name, account status badge (active/suspended/banned), rating, completed rides, joined date
- Click row -> navigate to /admin/users/[id]
- Status filter: All, Active, Suspended, Banned
- Pagination or infinite scroll for large user lists (limit 50 per page)

**4. User detail page (admin/users/[id]/page.tsx):**
- Server-side: fetch profile, moderation history, reports against this user, and reviews by/about this user
- Profile section: avatar, name, account status, rating, completed rides, joined date, phone verified, ID verified
- Moderation history: timeline of past actions (warnings, suspensions, bans) with dates and admin who took action
- Reports section: list of reports filed against this user (linked to report detail)
- Reviews section: reviews written by and about this user
- Action section: ModerationActionForm component for taking new moderation action

**5. ModerationActionForm component (admin/components/moderation-action-form.tsx):**
- "use client"
- Props: userId, userName, currentStatus
- Action type selector:
  - If active: Warning, Suspension, Ban
  - If suspended: Unsuspend (early lift), Ban (escalate)
  - If banned: Unban
- For Warning: reason textarea (required) -> calls supabase.rpc('admin_warn_user')
- For Suspension: reason textarea + duration dropdown (3/7/30 days from SUSPENSION_DURATIONS constant) -> calls supabase.rpc('admin_suspend_user')
- For Ban: reason textarea + checkbox "Auto-cancel active rides?" -> calls supabase.rpc('admin_ban_user', { ..., p_cancel_rides })
- For Unban: reason textarea -> calls supabase.rpc('admin_unban_user')
- Confirm dialog before executing any action (especially ban)
- Success: toast with action confirmation, reload page data
- Optional: link to the report that triggered this action (if navigated from report detail)

**6. Reviews management page (admin/reviews/page.tsx):**
- Fetch all reviews using getReviewsForAdmin query builder
- Table: reviewer name, reviewee name, rating (stars), comment (truncated), date, status (revealed/hidden)
- Filter: All, Revealed, Hidden
- Actions per review:
  - "Hide" button (for revealed reviews): calls supabase.rpc('admin_hide_review') -> sets revealed_at to NULL, recalculates rating
  - "Delete" button: confirm dialog -> calls supabase.rpc('admin_delete_review') -> permanently removes
  - "View reporter profile" / "View reviewee profile" links
- This page is for proactive moderation of reviews that may have been flagged via reports

All pages follow responsive design — usable on mobile for quick moderation on the go per user decision.
  </action>
  <verify>Reports page shows filterable list. Report detail shows full context and resolution actions. Users page has search and status filter. User detail shows profile, history, and moderation form. Reviews page allows hiding/deleting. All admin RPCs are called correctly. Responsive layout works on mobile.</verify>
  <done>Admin panel has complete moderation tools: reports management with status filter and resolution workflow, user search with moderation history and warn/suspend/ban actions (with configurable suspension durations and optional ride cancellation on ban), and review management with hide/delete capabilities. All pages are responsive.</done>
</task>

</tasks>

<verification>
- Non-admin users cannot access /admin (redirected by middleware)
- Admin dashboard shows correct stats and trend charts
- Reports list filters by status, report detail shows full context
- Admin can resolve/dismiss reports with notes
- Admin can warn a user (creates moderation_action record)
- Admin can suspend a user for 3/7/30 days (profile.account_status changes)
- Admin can ban a user with optional ride cancellation
- Admin can hide a review (revealed_at set to NULL, rating recalculated)
- Admin can delete a review permanently
- All admin pages work on mobile viewport
</verification>

<success_criteria>
Admin panel at /admin is fully functional with dashboard (stats + trends), reports management (view/resolve/dismiss), user moderation (warn/suspend/ban with configurable durations), and review management (hide/delete). Panel is protected by middleware + RLS and responsive for mobile use.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ratings-trust-safety/06-05-SUMMARY.md`
</output>
