---
phase: 06-ratings-trust-safety
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - apps/web/app/(app)/components/rating-modal.tsx
  - apps/web/app/(app)/components/review-card.tsx
  - apps/web/app/(app)/components/review-list.tsx
  - apps/web/app/(app)/components/experienced-badge.tsx
  - apps/web/app/(app)/profile/[id]/page.tsx
  - apps/web/app/(app)/rides/[id]/page.tsx
  - apps/web/app/(app)/components/ride-card.tsx
autonomous: true

must_haves:
  truths:
    - "After completing a ride, driver sees rating modal with 1-5 stars and optional comment"
    - "Rating modal appears on ride detail page when ?justCompleted=true query param is present"
    - "Pending ratings are detected on app open and prompt users who haven't rated"
    - "User profile page shows list of revealed reviews (newest first) with reviewer name, stars, comment, date"
    - "Users with 0 ratings show 'New' label instead of stars"
    - "'Experienced' badge shows on profiles with 10+ completed rides"
    - "Rating is displayed on ride cards in search results"
  artifacts:
    - path: "apps/web/app/(app)/components/rating-modal.tsx"
      provides: "Post-ride rating modal with 1-5 star picker and optional comment textarea"
      exports: ["RatingModal"]
    - path: "apps/web/app/(app)/components/review-list.tsx"
      provides: "Review list component for profile page"
      exports: ["ReviewList"]
    - path: "apps/web/app/(app)/profile/[id]/page.tsx"
      provides: "Updated profile page with reviews section, experienced badge"
      contains: "ReviewList"
  key_links:
    - from: "apps/web/app/(app)/components/rating-modal.tsx"
      to: "submit_review RPC"
      via: "supabase.rpc('submit_review') call on form submit"
      pattern: "submit_review"
    - from: "apps/web/app/(app)/profile/[id]/page.tsx"
      to: "getReviewsForUser query builder"
      via: "Server-side data fetch for review list"
      pattern: "getReviewsForUser"
    - from: "apps/web/app/(app)/rides/[id]/page.tsx"
      to: "apps/web/app/(app)/components/rating-modal.tsx"
      via: "justCompleted query param triggers modal display"
      pattern: "justCompleted"
---

<objective>
Build the rating submission flow and review display: rating modal after ride completion, review list on profiles, experienced badge, and pending rating detection.

Purpose: Implements RATE-01, RATE-02, RATE-03 — the core rating/review user experience.
Output: Rating modal component, review display components, updated profile and ride detail pages.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ratings-trust-safety/06-RESEARCH.md
@.planning/phases/06-ratings-trust-safety/06-01-SUMMARY.md
@.planning/phases/06-ratings-trust-safety/06-02-SUMMARY.md

@apps/web/app/(app)/profile/[id]/page.tsx
@apps/web/app/(app)/rides/[id]/page.tsx
@apps/web/app/(app)/components/ride-card.tsx
@apps/web/app/(app)/rides/[id]/manage/manage-ride-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rating modal, review card, review list, and experienced badge components</name>
  <files>
    apps/web/app/(app)/components/rating-modal.tsx
    apps/web/app/(app)/components/review-card.tsx
    apps/web/app/(app)/components/review-list.tsx
    apps/web/app/(app)/components/experienced-badge.tsx
  </files>
  <action>
**1. RatingModal component (rating-modal.tsx):**
- Props: bookingId, otherUserName, otherUserAvatar (optional), isOpen, onClose, onSubmitted
- "use client" — uses state and supabase browser client
- Star rating picker: 5 clickable star icons (filled/empty), large touch targets. Use inline SVG or lucide-react Star/StarHalf icons
- Optional comment textarea with character count (max 500, from REVIEW_MAX_COMMENT_LENGTH constant)
- Submit button calls supabase.rpc('submit_review', { p_booking_id, p_rating, p_comment })
- Handle errors: "already reviewed", "window has expired", generic error — show via toast (sonner)
- On success: toast.success('Rating submitted!'), if both_reviewed === true show toast.info('Both ratings are now visible on your profiles')
- Loading state on submit button
- Modal overlay with centered card, close X button. Use the existing dialog/modal pattern from the codebase (check if there's a Dialog component or use a simple portal-based modal)

**2. ReviewCard component (review-card.tsx):**
- Props: review (from getReviewsForUser result type) — includes rating, comment, created_at, reviewer.display_name, reviewer.avatar_url
- Displays: reviewer avatar (small circle), reviewer display_name, star rating (filled/empty icons), comment text (if any), relative date (date-fns formatDistanceToNow)
- Compact card style matching the app's pastel design

**3. ReviewList component (review-list.tsx):**
- Props: userId (string)
- "use client" — fetches reviews using getReviewsForUser query builder
- Shows loading skeleton while fetching
- Empty state: "No reviews yet" with a subtle message
- Maps reviews to ReviewCard components
- Ordered newest first (query builder handles this)

**4. ExperiencedBadge component (experienced-badge.tsx):**
- Props: completedRidesCount (number)
- Shows "Experienced" badge (like existing verification badges) when count >= EXPERIENCED_BADGE_THRESHOLD (10)
- Style: amber/gold pill badge to distinguish from verification badges (green phone, blue ID)
- Returns null if below threshold

**5. Star rating display helper:**
- Create a small StarRating component or utility that renders filled/empty stars for a given rating value
- Used by both ReviewCard and ride cards
- Props: rating (number), count (number, optional), size ('sm' | 'md')
- 'sm' format for ride cards: [star icon] 4.5 (12)
- 'md' format for profile: [5 stars filled/empty] 4.5 (12 ratings)
- When rating is null/0 and count is 0, show "New" label instead of stars
  </action>
  <verify>Components render without errors. RatingModal calls submit_review RPC. ReviewCard shows star rating and comment. ExperiencedBadge only shows when threshold met. StarRating shows "New" for unrated users.</verify>
  <done>Rating modal with 1-5 star picker and comment, review card, review list, experienced badge, and star rating display components all exist and use the shared package types/constants.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate rating/review components into profile page, ride detail page, and ride cards</name>
  <files>
    apps/web/app/(app)/profile/[id]/page.tsx
    apps/web/app/(app)/rides/[id]/page.tsx
    apps/web/app/(app)/components/ride-card.tsx
    apps/web/app/(app)/rides/[id]/manage/manage-ride-content.tsx
  </files>
  <action>
**1. Update profile page (profile/[id]/page.tsx):**
- Replace the existing ratings placeholder section with the actual ReviewList component
- Add ExperiencedBadge next to existing verification badges (phone verified, ID verified) — show when profile.completed_rides_count >= 10
- Fetch completed_rides_count from profile data (should already be in the profile query or add it)
- Use the StarRating component in the profile header to show rating_avg and rating_count (replacing any existing placeholder)
- Show "New" label for users with 0 ratings
- Reviews section with ReviewList below the bio/social links section
- Add pending rating detection: if viewing own profile, check for pending reviews via get_pending_reviews RPC. If any exist, show a banner "You have rides to rate" linking to the first pending rating (or show the rating modal inline)

**2. Update ride detail page (rides/[id]/page.tsx):**
- Read `justCompleted` query parameter from URL
- If justCompleted=true and current user was a participant (driver or passenger), show the RatingModal
- Determine the other user from the ride/booking data to pass otherUserName/otherUserAvatar to the modal
- The modal should appear for the driver immediately; for passengers, it should appear when they visit the ride detail after it's marked completed
- Also check: if the ride is completed and user hasn't rated yet (check via getExistingReview), show a "Rate this ride" button that opens the modal
- On modal close/submit, remove the justCompleted param from URL (via router.replace)

**3. Update manage-ride-content.tsx:**
- After the `complete_ride` RPC succeeds, redirect to `/rides/${rideId}?justCompleted=true` instead of just `/rides/${rideId}` (Pitfall 1 from research)
- This ensures the rating modal appears after completion

**4. Update ride-card.tsx:**
- Add driver rating display to ride cards in search results
- Use StarRating component in 'sm' format: [star icon] 4.5 (12)
- Show "New" for drivers with no ratings
- Position: near the driver name/avatar, consistent with BlaBlaCar pattern
- The ride card should already have access to driver profile data including rating_avg and rating_count — verify this from the existing component and add to the query if missing

**5. Pending rating detection on app open:**
- In the app layout or a dedicated PendingRatingProvider, call get_pending_reviews on mount
- If pending reviews exist, store in state/context
- Show a non-intrusive banner or toast suggesting the user rate their completed rides
- Link to the ride detail page where they can open the rating modal
- Store dismissed state in localStorage to avoid repeated nagging within the same session
  </action>
  <verify>Profile page shows review list and experienced badge. Ride detail shows rating modal after completion. Manage page redirects with justCompleted param. Ride cards show driver rating. Pending rating detection works on app open.</verify>
  <done>Rating modal appears after ride completion (via justCompleted redirect). Profile page shows individual reviews with star ratings, experienced badge for 10+ rides, and "New" label for unrated users. Ride cards display driver rating. Pending rating prompt appears on app open for unrated completed rides.</done>
</task>

</tasks>

<verification>
- Complete ride -> redirected to ride detail with justCompleted=true -> rating modal appears
- Submit rating via modal -> toast success -> modal closes
- Both parties rate -> both reviews become visible on profiles
- Profile page shows reviews newest first with star ratings and comments
- Profile shows "New" for users with 0 ratings
- Profile shows "Experienced" badge when completed_rides_count >= 10
- Ride cards in search show driver rating
- App open with pending ratings shows prompt
</verification>

<success_criteria>
After a completed ride, both driver and passenger can rate each other (1-5 stars) with an optional text review. Ratings and reviews are visible on user profiles, ordered newest first. Unrated users show "New" label. Experienced badge shows for active users. Rating prompt appears both immediately after completion and as a reminder.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ratings-trust-safety/06-03-SUMMARY.md`
</output>
