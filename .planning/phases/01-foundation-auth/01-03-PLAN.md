---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - apps/web/app/(auth)/layout.tsx
  - apps/web/app/(auth)/login/page.tsx
  - apps/web/app/(auth)/signup/page.tsx
  - apps/web/app/(auth)/reset-password/page.tsx
  - apps/web/app/auth/callback/route.ts
  - apps/web/app/auth/confirm/route.ts
  - apps/mobile/app/(auth)/_layout.tsx
  - apps/mobile/app/(auth)/login.tsx
  - apps/mobile/app/(auth)/signup.tsx
  - apps/mobile/app/(auth)/verify-otp.tsx
  - apps/mobile/app/(auth)/reset-password.tsx
  - apps/mobile/app/_layout.tsx
  - packages/shared/src/validation/auth.ts
autonomous: true
must_haves:
  truths:
    - "User can sign up with phone number and receive SMS OTP (AUTH-01)"
    - "User can verify OTP and land on the home screen (AUTH-01)"
    - "User can sign up and log in with email and password (AUTH-02)"
    - "User can sign up and log in with Google (AUTH-02)"
    - "User can sign up and log in with Apple (AUTH-02)"
    - "User can reset password via email link (AUTH-06)"
    - "Auth session persists across app restart and browser refresh (AUTH-03)"
    - "Auth gate redirects unauthenticated users to login and authenticated users away from auth screens"
  artifacts:
    - path: "apps/web/app/(auth)/login/page.tsx"
      provides: "Web login page with email, Google, Apple options"
    - path: "apps/web/app/(auth)/signup/page.tsx"
      provides: "Web signup page with email and social options"
    - path: "apps/web/app/auth/callback/route.ts"
      provides: "OAuth callback handler for web (PKCE code exchange)"
    - path: "apps/mobile/app/(auth)/login.tsx"
      provides: "Mobile login with phone, email, Google, Apple"
    - path: "apps/mobile/app/(auth)/verify-otp.tsx"
      provides: "OTP verification screen for phone auth"
    - path: "apps/mobile/app/_layout.tsx"
      provides: "Root layout with auth state gate"
  key_links:
    - from: "apps/web/app/(auth)/login/page.tsx"
      to: "apps/web/lib/supabase/client.ts"
      via: "signInWithPassword, signInWithOAuth"
      pattern: "supabase\\.auth\\.sign"
    - from: "apps/mobile/app/(auth)/login.tsx"
      to: "apps/mobile/lib/supabase.ts"
      via: "signInWithOtp, signInWithIdToken"
      pattern: "supabase\\.auth\\.sign"
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/lib/supabase.ts"
      via: "onAuthStateChange listener"
      pattern: "onAuthStateChange"
    - from: "apps/web/app/auth/callback/route.ts"
      to: "apps/web/lib/supabase/server.ts"
      via: "exchangeCodeForSession"
      pattern: "exchangeCodeForSession"
---

<objective>
Implement all authentication flows: phone OTP (primary), email/password, Google, and Apple sign-in for both web and mobile platforms, plus password reset and auth state gating.

Purpose: AUTH-01 through AUTH-06 form the core of Phase 1. Users must be able to sign up, log in, and maintain sessions across platforms.
Output: Working auth screens on both web and mobile with persistent sessions and proper routing guards.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement web auth screens (login, signup, reset-password, OAuth callback)</name>
  <files>
    apps/web/app/(auth)/layout.tsx
    apps/web/app/(auth)/login/page.tsx
    apps/web/app/(auth)/signup/page.tsx
    apps/web/app/(auth)/reset-password/page.tsx
    apps/web/app/auth/callback/route.ts
    apps/web/app/auth/confirm/route.ts
  </files>
  <action>
    **Auth layout (apps/web/app/(auth)/layout.tsx):**
    - Centered card layout for auth pages
    - Check for existing session on load -- if authenticated, redirect to /search
    - App name/logo at top

    **Login page:**
    - Email + password form using react-hook-form with Zod resolver (EmailSchema, PasswordSchema from @festapp/shared)
    - "Sign in" button calling supabase.auth.signInWithPassword({ email, password })
    - Google sign-in button using @react-oauth/google GoogleLogin component. On credential response, call supabase.auth.signInWithIdToken({ provider: 'google', token: credential })
    - Apple sign-in button using supabase.auth.signInWithOAuth({ provider: 'apple', options: { redirectTo: window.location.origin + '/auth/callback' } })
    - "Forgot password?" link to /reset-password
    - "Don't have an account? Sign up" link to /signup
    - Error display for auth failures
    - Note: Phone auth on web redirects to /signup with phone tab (phone is primary on mobile, secondary on web)

    **Signup page:**
    - Two tabs or sections: "Email" and "Phone"
    - Email tab: display_name + email + password form. Call supabase.auth.signUp({ email, password, options: { data: { display_name } } }). Show "Check your email for confirmation" message.
    - Phone tab: Phone number input (international format). Call supabase.auth.signInWithOtp({ phone }). On success, show OTP input inline (6-digit). Verify with supabase.auth.verifyOtp({ phone, token, type: 'sms' }).
    - Social sign-in buttons (Google, Apple) same as login
    - Use shared validation schemas for all inputs

    **Reset password page:**
    - Email input + "Send reset link" button
    - Call supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/auth/confirm' })
    - Show success message after sending

    **OAuth callback handler (apps/web/app/auth/callback/route.ts):**
    - GET handler: Extract `code` from searchParams
    - Create server Supabase client, call exchangeCodeForSession(code)
    - Redirect to /search on success, /login?error=auth on failure

    **Email confirm handler (apps/web/app/auth/confirm/route.ts):**
    - GET handler: Extract `token_hash` and `type` from searchParams
    - Call supabase.auth.verifyOtp({ token_hash, type }) for email confirmation and password reset
    - For password reset type, redirect to a page where user can set new password
    - Redirect to /search on success

    All forms use react-hook-form with @hookform/resolvers/zod for validation. Display loading states during async operations. Show error messages from Supabase auth errors.
  </action>
  <verify>
    Run `pnpm turbo typecheck --filter=@festapp/web` -- must pass.
    Run `pnpm turbo build --filter=@festapp/web` -- must compile.
    Manual verification: Login page renders with email form and social buttons.
  </verify>
  <done>Web has complete auth screens: login (email + social), signup (email + phone + social), reset-password, OAuth callback handler, and email confirm handler. All forms use shared Zod validation. Auth errors displayed to user.</done>
</task>

<task type="auto">
  <name>Task 2: Implement mobile auth screens with auth state gate and phone OTP flow</name>
  <files>
    apps/mobile/app/(auth)/_layout.tsx
    apps/mobile/app/(auth)/login.tsx
    apps/mobile/app/(auth)/signup.tsx
    apps/mobile/app/(auth)/verify-otp.tsx
    apps/mobile/app/(auth)/reset-password.tsx
    apps/mobile/app/_layout.tsx
    packages/shared/src/validation/auth.ts
  </files>
  <action>
    **Root layout with auth gate (apps/mobile/app/_layout.tsx):**
    Follow research Pattern (Auth State Gate) exactly:
    - useState for session and isLoading
    - useEffect to get initial session via supabase.auth.getUser() (not getSession)
    - Subscribe to onAuthStateChange for real-time session updates
    - useSegments() and useRouter() for navigation guard:
      - If no session and not in (auth) group -> redirect to /(auth)/login
      - If session and in (auth) group -> redirect to /(tabs)/search (tabs come in Plan 04, use / for now)
    - Show null or splash while loading
    - Wrap children in necessary providers (SafeAreaProvider)
    - Cleanup subscription on unmount

    **Auth layout (apps/mobile/app/(auth)/_layout.tsx):**
    - Stack navigator for auth screens
    - Clean header with back button where appropriate
    - No tab bar visible

    **Login screen (apps/mobile/app/(auth)/login.tsx):**
    - Phone number input as PRIMARY method (ONBR-01: minimal sign-up, phone or social on one screen)
    - Phone input with country code picker or prefix (+420 default for CZ)
    - "Continue with phone" button: validate with PhoneSchema, call supabase.auth.signInWithOtp({ phone }), navigate to verify-otp screen passing phone as param
    - Divider: "or continue with"
    - Google sign-in button: Use native Google Sign In SDK to get idToken, then supabase.auth.signInWithIdToken({ provider: 'google', token: idToken })
    - Apple sign-in button: Use @invertase/react-native-apple-authentication to get identityToken, then supabase.auth.signInWithIdToken({ provider: 'apple', token: identityToken, nonce })
    - "Sign in with email" link -> navigates to signup screen with email tab active
    - Note: For initial implementation, Google and Apple native SDKs require additional native config. Create the buttons and auth flow code, but wrap the native SDK calls in try/catch with a TODO for native configuration. The signInWithIdToken calls are correct -- the native SDK setup is a device-specific concern.

    **Signup screen (apps/mobile/app/(auth)/signup.tsx):**
    - Email signup form: display_name + email + password
    - Call supabase.auth.signUp({ email, password, options: { data: { display_name } } })
    - Show confirmation message after successful signup
    - "Already have an account? Log in" link back to login
    - Uses react-hook-form + Zod validation

    **OTP verification screen (apps/mobile/app/(auth)/verify-otp.tsx):**
    - Receive phone number from navigation params
    - 6-digit OTP input (individual digit boxes for UX)
    - Auto-submit when 6 digits entered
    - Call supabase.auth.verifyOtp({ phone, token, type: 'sms' })
    - On success: session is automatically set, auth gate in root layout redirects to home
    - "Resend code" button with 60-second cooldown (OTP_EXPIRY from shared constants)
    - Error handling for invalid/expired codes

    **Reset password screen (apps/mobile/app/(auth)/reset-password.tsx):**
    - Email input + "Send reset link" button
    - Call supabase.auth.resetPasswordForEmail(email)
    - Show success message, link back to login

    **Update shared validation (packages/shared/src/validation/auth.ts):**
    - Add SignUpSchema = z.object({ display_name: DisplayNameSchema, email: EmailSchema, password: PasswordSchema })
    - Add LoginSchema = z.object({ email: EmailSchema, password: PasswordSchema })
    - Export all schemas

    Use NativeWind/Tailwind classes for styling where possible. Use react-hook-form for all forms. Import validation from @festapp/shared.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- all packages must pass.
    Run `pnpm turbo build --filter=@festapp/mobile` -- must compile (Expo export).
    Verify auth gate logic: root _layout.tsx listens to onAuthStateChange and redirects correctly.
    Verify OTP screen receives phone param and calls verifyOtp with correct type 'sms'.
    Verify no usage of getSession() on server/middleware side.
  </verify>
  <done>Mobile has complete auth flow: login (phone primary + social + email link), OTP verification with auto-submit and resend, email signup, password reset. Root layout implements auth state gate with session persistence. All forms use shared Zod schemas from @festapp/shared. AUTH-01 through AUTH-06 are implemented across both platforms.</done>
</task>

</tasks>

<verification>
- Web: Login, signup, reset-password pages render and compile
- Web: OAuth callback handler exchanges code for session
- Mobile: Phone -> OTP -> Session flow completes
- Mobile: Auth gate redirects correctly based on session state
- Both: Social auth buttons exist with correct signInWithIdToken calls
- Both: Shared validation schemas used for all form inputs
- No getSession() usage on server side
- AUTH-01 (phone), AUTH-02 (email, Google, Apple), AUTH-03 (session persistence), AUTH-06 (password reset) covered
</verification>

<success_criteria>
Users can sign up and log in via phone OTP, email/password, Google, or Apple on both web and mobile. Sessions persist across restarts. Password reset works via email. Auth state gate routes users correctly. Ready for navigation and design in Plan 04.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
