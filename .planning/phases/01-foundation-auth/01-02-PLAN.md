---
phase: 01-foundation-auth
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/config.toml
  - supabase/migrations/00000000000000_initial_setup.sql
  - supabase/migrations/00000000000001_profiles.sql
  - supabase/migrations/00000000000002_rls_policies.sql
  - supabase/functions/_shared/auth.ts
  - supabase/functions/_shared/supabase-client.ts
  - supabase/functions/send-sms/index.ts
  - supabase/functions/delete-account/index.ts
  - supabase/seed.sql
  - apps/web/lib/supabase/client.ts
  - apps/web/lib/supabase/server.ts
  - apps/web/lib/supabase/middleware.ts
  - apps/web/.env.local.example
  - apps/mobile/lib/supabase.ts
  - apps/mobile/lib/large-secure-store.ts
  - apps/mobile/.env.local.example
  - packages/shared/src/types/database.ts
autonomous: true
user_setup:
  - service: supabase
    why: "Database and authentication backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Settings -> API -> anon public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Settings -> API -> service_role secret key (NEVER expose to client)"
      - name: EXPO_PUBLIC_SUPABASE_URL
        source: "Same as NEXT_PUBLIC_SUPABASE_URL"
      - name: EXPO_PUBLIC_SUPABASE_ANON_KEY
        source: "Same as NEXT_PUBLIC_SUPABASE_ANON_KEY"
    dashboard_config:
      - task: "Enable Phone Auth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Phone"
      - task: "Enable Email Auth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"
      - task: "Configure Send SMS Hook to point to send-sms Edge Function"
        location: "Supabase Dashboard -> Authentication -> Hooks -> Send SMS"
  - service: aws
    why: "SMS delivery via SNS for phone OTP"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "AWS IAM user with SNS publish permissions"
      - name: AWS_SECRET_ACCESS_KEY
        source: "AWS IAM user credentials"
      - name: AWS_REGION
        source: "AWS region (e.g., eu-central-1)"
must_haves:
  truths:
    - "Supabase local dev starts with correct schema"
    - "Profiles table auto-creates a row when a user signs up"
    - "RLS policies allow users to read any profile but only update their own"
    - "send-sms Edge Function accepts Supabase hook payload and calls AWS SNS"
    - "delete-account Edge Function deletes user via admin API"
    - "Web Supabase client uses cookie-based sessions via @supabase/ssr"
    - "Mobile Supabase client uses LargeSecureStore for encrypted token storage"
  artifacts:
    - path: "supabase/migrations/00000000000001_profiles.sql"
      provides: "Profiles table with trigger for auto-creation"
      contains: "handle_new_user"
    - path: "supabase/functions/send-sms/index.ts"
      provides: "AWS SNS SMS delivery Edge Function"
      contains: "SNSClient"
    - path: "supabase/functions/delete-account/index.ts"
      provides: "Account deletion Edge Function"
      contains: "admin.deleteUser"
    - path: "apps/web/lib/supabase/server.ts"
      provides: "Server-side Supabase client with cookie handling"
      contains: "createServerClient"
    - path: "apps/mobile/lib/large-secure-store.ts"
      provides: "AES-encrypted session storage adapter"
      contains: "LargeSecureStore"
  key_links:
    - from: "supabase/migrations/00000000000001_profiles.sql"
      to: "auth.users"
      via: "AFTER INSERT trigger"
      pattern: "on_auth_user_created"
    - from: "apps/web/lib/supabase/server.ts"
      to: "@supabase/ssr"
      via: "createServerClient with cookie adapter"
      pattern: "createServerClient"
    - from: "apps/mobile/lib/supabase.ts"
      to: "apps/mobile/lib/large-secure-store.ts"
      via: "storage option in createClient"
      pattern: "storage.*LargeSecureStore"
---

<objective>
Set up Supabase project with database schema (profiles table + triggers), Edge Functions (send-sms, delete-account), and platform-specific Supabase client initialization for both web and mobile.

Purpose: Establish the data layer and auth infrastructure that Plan 03 (auth flows) will build on. The profiles table trigger ensures every signup automatically creates a profile row.
Output: Working Supabase schema, Edge Functions, and platform-specific clients ready for auth implementation.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/research/FESTAPP_PATTERNS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase migrations, Edge Functions, and seed data</name>
  <files>
    supabase/config.toml
    supabase/migrations/00000000000000_initial_setup.sql
    supabase/migrations/00000000000001_profiles.sql
    supabase/migrations/00000000000002_rls_policies.sql
    supabase/functions/_shared/auth.ts
    supabase/functions/_shared/supabase-client.ts
    supabase/functions/send-sms/index.ts
    supabase/functions/delete-account/index.ts
    supabase/seed.sql
  </files>
  <action>
    Run `supabase init` in the repo root to create the supabase/ directory and config.toml.

    **Migrations:**

    00000000000000_initial_setup.sql:
    - Enable uuid-ossp extension
    - Create update_updated_at_column() trigger function (from Festapp patterns)

    00000000000001_profiles.sql:
    - Create profiles table per research schema:
      - id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE
      - display_name TEXT NOT NULL DEFAULT 'User'
      - avatar_url TEXT
      - phone TEXT
      - bio TEXT
      - social_links JSONB DEFAULT '{}'
      - rating_avg NUMERIC(3,2) DEFAULT 0
      - rating_count INT DEFAULT 0
      - created_at TIMESTAMPTZ NOT NULL DEFAULT now()
      - updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    - Enable RLS on profiles
    - Add updated_at trigger
    - Create handle_new_user() function with SECURITY DEFINER SET search_path = '' (CRITICAL -- without this, the trigger cannot access public schema and ALL signups will fail)
    - Use COALESCE for nullable metadata fields
    - Create on_auth_user_created trigger on auth.users

    00000000000002_rls_policies.sql:
    - "Users can view any profile": SELECT for authenticated, USING (true)
    - "Users can update their own profile": UPDATE for authenticated, USING (id = auth.uid()) WITH CHECK (id = auth.uid())
    - No INSERT policy (trigger handles creation)
    - No DELETE policy (CASCADE from auth.users handles deletion)

    **Edge Functions:**

    _shared/auth.ts: AuthError class with status code (from Festapp patterns).

    _shared/supabase-client.ts: Export createAdminClient() and createUserClient(authHeader) functions using Deno.env for SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, SUPABASE_ANON_KEY.

    send-sms/index.ts: Custom SMS hook Edge Function per research Pattern 2:
    - Import SNSClient from @aws-sdk/client-sns
    - Parse request JSON for { user: { phone }, sms: { otp } }
    - Send SMS via SNS PublishCommand with PhoneNumber, Message ("Your Festapp Rideshare code is: {otp}"), SMSType Transactional
    - Return 200 with empty JSON body on success
    - Return 500 with error on failure
    - Use environment variables: AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY

    delete-account/index.ts: Account deletion Edge Function per research Pattern 5:
    - Verify caller identity via Authorization header using user-scoped client
    - Create admin client with service_role key
    - Call adminClient.auth.admin.deleteUser(user.id)
    - CASCADE on profiles FK handles data cleanup automatically
    - Return 200 on success, 401 on unauthorized, 500 on error

    **Seed data:**
    supabase/seed.sql: Comment-only file explaining that test data is created via auth signup (profiles auto-created by trigger).
  </action>
  <verify>
    Run `supabase db lint` (if available) or manually review SQL syntax.
    Verify trigger function includes SECURITY DEFINER SET search_path = ''.
    Verify Edge Functions have correct Deno imports and structure.
  </verify>
  <done>Three migration files exist with correct SQL. Two Edge Functions exist with correct Deno/TypeScript code. Shared utilities exist. All follow Festapp naming conventions (snake_case tables, p_ params, verb-first RPCs).</done>
</task>

<task type="auto">
  <name>Task 2: Create platform-specific Supabase clients and environment config</name>
  <files>
    apps/web/lib/supabase/client.ts
    apps/web/lib/supabase/server.ts
    apps/web/lib/supabase/middleware.ts
    apps/web/middleware.ts
    apps/web/.env.local.example
    apps/mobile/lib/supabase.ts
    apps/mobile/lib/large-secure-store.ts
    apps/mobile/.env.local.example
    packages/shared/src/types/database.ts
  </files>
  <action>
    **Web Supabase clients (apps/web/lib/supabase/):**

    client.ts: Browser client using createBrowserClient from @supabase/ssr with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY. Export as function createClient().

    server.ts: Server component client using createServerClient from @supabase/ssr with cookie adapter. Import cookies from next/headers. Follow the exact pattern from research (getAll/setAll cookie handlers). Export as async function createClient().

    middleware.ts: Export updateSession(request) function following exact research pattern. Use getUser() in middleware (not getClaims() -- per research open question #2, getUser() is the proven middleware pattern). Redirect unauthenticated users to /login. Allow /login, /signup, /reset-password, /auth/callback without auth.

    apps/web/middleware.ts: Import updateSession from lib/supabase/middleware. Export middleware function and config with matcher excluding static files, images, favicon.

    Add @supabase/ssr to apps/web/package.json dependencies.

    **Mobile Supabase client (apps/mobile/lib/):**

    large-secure-store.ts: Exact LargeSecureStore implementation from research Pattern 1. AES encryption with key in SecureStore, encrypted data in AsyncStorage. Import 'react-native-get-random-values' at top (polyfill must load first).

    supabase.ts: Create Supabase client with LargeSecureStore as storage adapter. Set autoRefreshToken: true, persistSession: true, detectSessionInUrl: false. Add AppState listener for foreground/background auto-refresh toggle (Platform.OS !== 'web' guard). Use EXPO_PUBLIC_SUPABASE_URL and EXPO_PUBLIC_SUPABASE_ANON_KEY.

    Add to apps/mobile/package.json dependencies: expo-secure-store, @react-native-async-storage/async-storage, aes-js, react-native-get-random-values.

    **Environment examples:**

    apps/web/.env.local.example:
    ```
    NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
    NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
    ```

    apps/mobile/.env.local.example:
    ```
    EXPO_PUBLIC_SUPABASE_URL=your_supabase_url
    EXPO_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
    ```

    **Shared types:**
    Update packages/shared/src/types/database.ts with a proper placeholder type structure that matches Supabase generated types shape. Add a comment: "Run `supabase gen types typescript --local > packages/shared/src/types/database.ts` to regenerate".

    Run `pnpm install` after adding new dependencies.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- all packages must compile.
    Verify web middleware.ts exports match Next.js middleware API.
    Verify LargeSecureStore implements the StorageAdapter interface (getItem, setItem, removeItem).
    Verify no import of getSession() on server side (use getUser() in middleware).
  </verify>
  <done>Web has three Supabase clients (browser, server, middleware) using cookie-based auth. Mobile has Supabase client with LargeSecureStore encryption. Both have .env.local.example files. All typecheck passes.</done>
</task>

</tasks>

<verification>
- SQL migrations are syntactically valid
- Trigger function has SECURITY DEFINER SET search_path = ''
- Edge Functions have correct Deno syntax (Deno.serve, Deno.env)
- Web uses @supabase/ssr (NOT deprecated auth-helpers)
- Server-side uses getUser() (NOT getSession())
- Mobile uses LargeSecureStore (NOT raw expo-secure-store)
- `pnpm turbo typecheck` passes
- .env.local.example files document required variables
</verification>

<success_criteria>
Database schema ready with profiles table and auto-creation trigger. Edge Functions for SMS and account deletion exist. Platform-specific Supabase clients configured correctly (cookie-based web, encrypted-storage mobile). Ready for auth flow implementation in Plan 03.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-02-SUMMARY.md`
</output>
