---
phase: 01-foundation-auth
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - apps/mobile/app/onboarding.tsx
  - apps/mobile/app/_layout.tsx
  - apps/web/app/(app)/onboarding/page.tsx
  - apps/web/app/(app)/layout.tsx
  - packages/shared/src/constants/onboarding.ts
  - apps/mobile/assets/splash.png
  - apps/mobile/assets/icon.png
  - apps/mobile/assets/adaptive-icon.png
  - apps/mobile/app.json
autonomous: false
must_haves:
  truths:
    - "New user sees onboarding screens after first signup (ONBR-01, ONBR-07)"
    - "Onboarding shows permission request screens for location and notifications with context (ONBR-05, ONBR-06)"
    - "After onboarding, user lands on home/search screen (ONBR-07)"
    - "Returning user skips onboarding on subsequent logins"
    - "App has branded splash screen and icon (PLAT-10)"
  artifacts:
    - path: "apps/mobile/app/onboarding.tsx"
      provides: "Multi-step onboarding flow for mobile"
      contains: "onboarding"
    - path: "apps/web/app/(app)/onboarding/page.tsx"
      provides: "Web onboarding flow"
    - path: "packages/shared/src/constants/onboarding.ts"
      provides: "Onboarding step definitions and copy"
    - path: "apps/mobile/assets/icon.png"
      provides: "App icon for PLAT-10"
  key_links:
    - from: "apps/mobile/app/_layout.tsx"
      to: "apps/mobile/app/onboarding.tsx"
      via: "redirect if onboarding not completed"
      pattern: "onboarding"
    - from: "apps/mobile/app/onboarding.tsx"
      to: "packages/shared/src/constants/onboarding.ts"
      via: "import step definitions"
      pattern: "onboardingSteps"
---

<objective>
Create the post-signup onboarding flow (welcome, permission requests for location and notifications), branded splash screen and app icon, and integration tests for auth flows.

Purpose: ONBR-01/05/06/07 ensure new users have a guided first experience. PLAT-10 provides brand identity. TEST-04 validates auth flows work end-to-end.
Output: Working onboarding skeleton, branded assets, and auth integration tests.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
@.planning/phases/01-foundation-auth/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding flow, splash screen assets, and auth integration tests</name>
  <files>
    apps/mobile/app/onboarding.tsx
    apps/mobile/app/_layout.tsx
    apps/web/app/(app)/onboarding/page.tsx
    apps/web/app/(app)/layout.tsx
    packages/shared/src/constants/onboarding.ts
    packages/shared/src/index.ts
    apps/mobile/assets/splash.png
    apps/mobile/assets/icon.png
    apps/mobile/assets/adaptive-icon.png
    apps/mobile/app.json
  </files>
  <action>
    **Onboarding step definitions (packages/shared/src/constants/onboarding.ts):**
    Define onboarding steps as a constant array:
    1. Welcome: "Welcome to Festapp Rideshare" -- brief value prop (share rides, save money, meet people). Illustration placeholder.
    2. Location Permission: "Find rides near you" -- explain why location is needed (to find nearby rides and pickup points). "Enable Location" button. "Skip" option. (ONBR-05)
    3. Notifications Permission: "Never miss a ride" -- explain why notifications matter (booking confirmations, ride reminders, messages). "Enable Notifications" button. "Skip" option. (ONBR-06)
    4. Ready: "You're all set!" -- brief instruction to search or post a ride. "Get Started" button. (ONBR-07)

    Export step type and steps array. Export ONBOARDING_COMPLETED_KEY = 'onboarding_completed' for AsyncStorage/localStorage key.
    Update packages/shared/src/index.ts to export onboarding constants.

    **Mobile onboarding (apps/mobile/app/onboarding.tsx):**
    - Horizontal swipeable flow (FlatList with horizontal pagination or ScrollView with paging)
    - Each step renders its content from the shared step definitions
    - Step indicators (dots) at bottom
    - "Next" button advances, "Skip" option on permission steps
    - Location step: Call expo-location requestForegroundPermissionsAsync() when "Enable Location" tapped. Handle permission denied gracefully (show "You can enable later in Settings"). Do NOT block onboarding if denied.
    - Notification step: Call expo-notifications requestPermissionsAsync() when "Enable Notifications" tapped. Handle denial gracefully.
    - Final "Get Started": Save onboarding completion flag to AsyncStorage (key: ONBOARDING_COMPLETED_KEY, value: 'true'), navigate to /(tabs)/search
    - Style with pastel design system (soft backgrounds, rounded cards, gentle illustrations can be placeholder colored shapes for now)

    **Mobile root layout update (apps/mobile/app/_layout.tsx):**
    After auth check, add onboarding check:
    - Read ONBOARDING_COMPLETED_KEY from AsyncStorage
    - If authenticated AND onboarding not completed AND not already on onboarding screen -> redirect to /onboarding
    - If authenticated AND onboarding completed -> proceed to tabs
    - This check runs after the auth gate (auth gate handles unauthenticated users)

    **Web onboarding (apps/web/app/(app)/onboarding/page.tsx):**
    Simpler version for web (no native permissions to request):
    - Welcome step with value prop
    - Notification permission: Use browser Notification API to request permission (web push prep for later)
    - Location permission: Not needed on web during onboarding (browser will prompt when needed)
    - "Get Started" saves completion to localStorage, redirects to /search
    - Client component ('use client')

    **Web layout update (apps/web/app/(app)/layout.tsx):**
    Add onboarding check: If user hasn't completed onboarding (check cookie or API), redirect to /onboarding. Use a simple flag in the user's profile metadata or localStorage.

    **Splash screen and app icon (PLAT-10):**
    - Create placeholder splash screen (1284x2778px): Pastel purple (#7C6FA0) background with "Festapp Rideshare" text centered in white. Use a simple script or canvas to generate a PNG, OR create a minimal SVG-based splash. The visual design is a placeholder -- the structure and configuration matter.
    - Create placeholder app icon (1024x1024px): Pastel purple background with a simple car/ride icon silhouette in white. Again, placeholder quality is fine.
    - Create adaptive icon (1024x1024px): Same as app icon with appropriate padding for Android adaptive icon format.
    - Update apps/mobile/app.json: Set splash.image, icon, android.adaptiveIcon.foregroundImage, and splash.backgroundColor to #7C6FA0.

    **Auth integration tests (TEST-04):**
    Create test files:
    - packages/shared/src/validation/__tests__/auth.test.ts: Test all Zod schemas (PhoneSchema, EmailSchema, OtpSchema, PasswordSchema, DisplayNameSchema, SignUpSchema, LoginSchema). Test valid inputs pass, invalid inputs fail with correct error messages.
    - Add vitest as devDependency to packages/shared. Add test script to package.json.
    - Update turbo.json test task if needed.

    Note: Full integration tests for Supabase auth flows (signInWithOtp, verifyOtp, signInWithPassword) require a running Supabase instance and are better suited for CI with Supabase CLI local dev. For now, test the validation layer thoroughly and add a TODO comment for e2e auth tests with Supabase local in CI.

    Add expo-location and expo-notifications as dependencies in apps/mobile/package.json.
    Run `pnpm install` after adding dependencies.
  </action>
  <verify>
    Run `pnpm turbo typecheck` -- must pass.
    Run `pnpm turbo build` -- must compile all packages.
    Run `pnpm turbo test` -- shared package validation tests must pass.
    Verify onboarding steps are defined with correct content for ONBR-05 and ONBR-06.
    Verify root layout has onboarding redirect logic.
    Verify app.json references splash and icon assets.
  </verify>
  <done>Onboarding flow exists on both mobile (swipeable with permission requests) and web (simplified). Root layouts redirect new users to onboarding. Splash screen and icon placeholders configured. Auth validation tests pass. ONBR-01, ONBR-05, ONBR-06, ONBR-07, PLAT-10, TEST-04 addressed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 1 auth and navigation flow</name>
  <files>none</files>
  <action>
    Human verification of the complete Phase 1 implementation. All automated work is done in Tasks 1 through Plan 05 Task 1.
    What was built: Complete Phase 1 -- monorepo with web + mobile apps, Supabase auth (phone, email, social), tab navigation with pastel design system, onboarding flow, settings with logout/delete account.
  </action>
  <verify>
    1. Run `pnpm turbo build` from repo root -- should succeed with no errors
    2. Run `pnpm turbo test` -- validation tests should pass
    3. Start web dev server: `pnpm --filter @festapp/web dev` -- visit http://localhost:3000
       - Should redirect to /login (not authenticated)
       - Login page should show email/password form and social buttons
       - Signup page should show email and phone tabs
       - Design should use pastel purple color scheme
    4. Start mobile dev server: `pnpm --filter @festapp/mobile start`
       - Should show login screen with phone number input and social buttons
       - Verify OTP screen layout (6-digit input boxes)
       - Tab navigation should show 4 tabs with correct icons
       - Settings should show logout and delete account
       - Onboarding flow should be swipeable
    5. Verify dark mode: Toggle system dark mode and confirm colors update
    6. Verify file structure matches the architecture from research
  </verify>
  <done>User has visually verified the complete Phase 1 implementation: auth screens, tab navigation, pastel design, onboarding, settings with logout/delete. Approved or issues identified for fixing.</done>
</task>

</tasks>

<verification>
- Onboarding flow guides new users through welcome, permissions, and landing
- Permission requests include contextual explanation (not just system prompt)
- Onboarding completion persists (returning users skip it)
- Splash screen and icon configured in app.json
- Validation tests pass for all auth schemas
- Complete Phase 1 flow: signup -> onboarding -> home screen
- Logout returns to login screen
- Delete account calls Edge Function and signs out
</verification>

<success_criteria>
Phase 1 complete: Users can sign up (phone, email, social), go through onboarding, navigate the app shell with 4 tabs, access settings, log out, and delete their account. Pastel design system applied throughout. App has branded splash/icon. All 5 success criteria from the phase definition are met.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-05-SUMMARY.md`
</output>
