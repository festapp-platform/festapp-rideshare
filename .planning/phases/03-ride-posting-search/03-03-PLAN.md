---
phase: 03-ride-posting-search
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/compute-route/index.ts
autonomous: true

user_setup:
  - service: google-maps
    why: "Route computation and address autocomplete require Google Maps API keys"
    env_vars:
      - name: GOOGLE_ROUTES_API_KEY
        source: "Google Cloud Console -> APIs & Services -> Credentials -> Create API Key (restrict to Routes API)"
      - name: NEXT_PUBLIC_GOOGLE_MAPS_API_KEY
        source: "Google Cloud Console -> APIs & Services -> Credentials -> Create API Key (restrict to Maps JS API + Places API New, restrict by HTTP referrer)"
    dashboard_config:
      - task: "Enable Routes API"
        location: "Google Cloud Console -> APIs & Services -> Library -> Routes API -> Enable"
      - task: "Enable Places API (New)"
        location: "Google Cloud Console -> APIs & Services -> Library -> Places API (New) -> Enable"
      - task: "Enable Maps JavaScript API"
        location: "Google Cloud Console -> APIs & Services -> Library -> Maps JavaScript API -> Enable"
      - task: "Set Supabase secret for Edge Function"
        location: "Run: supabase secrets set GOOGLE_ROUTES_API_KEY=<your-key>"

must_haves:
  truths:
    - "Edge Function accepts origin/destination coordinates and returns distance, duration, encoded polyline, and price suggestion"
    - "Google Routes API key is kept server-side in the Edge Function, never exposed to clients"
    - "Price suggestion formula matches the shared calculateSuggestedPrice logic"
  artifacts:
    - path: "supabase/functions/compute-route/index.ts"
      provides: "Route computation proxy Edge Function"
      contains: "routes.googleapis.com"
  key_links:
    - from: "supabase/functions/compute-route/index.ts"
      to: "Google Routes API"
      via: "HTTP POST to computeRoutes endpoint"
      pattern: "directions/v2:computeRoutes"
---

<objective>
Create the Supabase Edge Function that proxies Google Routes API for route computation and price suggestion.

Purpose: The compute-route Edge Function keeps the Google Routes API key server-side while providing distance, duration, polyline, and price suggestion to the ride posting form. Called once per ride creation after origin/destination selection.

Output: Deployed Edge Function at `compute-route` endpoint.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@supabase/functions/_shared/
@supabase/functions/delete-account/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create compute-route Edge Function</name>
  <files>
    supabase/functions/compute-route/index.ts
  </files>
  <action>
Create the Edge Function following research Pattern 4 and the existing Edge Function patterns in `supabase/functions/delete-account/index.ts` (for CORS handling, error responses).

**supabase/functions/compute-route/index.ts:**
- Import serve from Deno std HTTP server (use same version as existing functions)
- Read `GOOGLE_ROUTES_API_KEY` from Deno.env
- Read fuel cost env vars with defaults: `FUEL_PRICE_CZK` (default 35), `FUEL_CONSUMPTION` (default 7)
- COST_SHARING_FACTOR = 0.6
- Handle CORS preflight (OPTIONS) -- check existing _shared/ for CORS helpers; if exists, reuse them
- Require POST method
- Parse request body: `{ originLat, originLng, destLat, destLng }` -- validate all 4 are numbers
- Call Google Routes API exactly per research Pattern 4:
  - URL: `https://routes.googleapis.com/directions/v2:computeRoutes`
  - Headers: Content-Type, X-Goog-Api-Key, X-Goog-FieldMask for distanceMeters, duration, polyline.encodedPolyline
  - Body: origin/destination as latLng locations, travelMode: DRIVE, routingPreference: TRAFFIC_AWARE
- Extract route[0]: distanceMeters, duration (parse seconds from "Ns" format), encodedPolyline
- If no route found, return 404 with `{ error: "No route found" }`
- Calculate price suggestion using same formula as shared `calculateSuggestedPrice`:
  - fuelCost = (distanceKm / 100) * consumption * fuelPrice
  - suggestedPriceCzk = Math.round(fuelCost * COST_SHARING_FACTOR)
  - min = Math.max(20, Math.round(suggested * 0.5))
  - max = Math.round(suggested * 2.0)
- Return JSON: `{ distanceMeters, durationSeconds, encodedPolyline, suggestedPriceCzk, priceMinCzk, priceMaxCzk }`

**Auth:** The function should verify the user is authenticated by checking the Authorization header with Supabase client (use the _shared/supabase.ts user client factory if it exists). Only authenticated users should be able to compute routes.

**Deploy:**
```bash
supabase functions deploy compute-route --no-verify-jwt
```
Note: We handle JWT verification manually inside the function (consistent with other functions like delete-account). The `--no-verify-jwt` flag is needed because Supabase Edge Functions auto-verify JWT by default, but we want to control error responses.
  </action>
  <verify>
```bash
supabase functions deploy compute-route --no-verify-jwt
# Test with curl (will fail without real API key, but should deploy successfully)
```
Verify the function deploys without errors. If GOOGLE_ROUTES_API_KEY is not set, the function should return a 500 with a meaningful error when called.
  </verify>
  <done>compute-route Edge Function deployed. Accepts POST with origin/destination coordinates, returns distance, duration, polyline, and price suggestion. Auth-gated to authenticated users only.</done>
</task>

</tasks>

<verification>
- Edge Function deploys without errors
- Function code matches research Pattern 4 structure
- CORS handling present for web clients
- Auth check prevents unauthenticated access
- Price calculation formula matches shared PRICING constants
</verification>

<success_criteria>
- compute-route Edge Function is deployed and accessible
- Returns correct JSON structure: distanceMeters, durationSeconds, encodedPolyline, suggestedPriceCzk, priceMinCzk, priceMaxCzk
- Google API key is server-side only, never in client bundle
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-03-SUMMARY.md`
</output>
