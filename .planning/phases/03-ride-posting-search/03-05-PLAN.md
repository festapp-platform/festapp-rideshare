---
phase: 03-ride-posting-search
plan: 05
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/web/app/(app)/search/page.tsx
  - apps/web/app/(app)/components/search-form.tsx
  - apps/web/app/(app)/components/search-filters.tsx
  - apps/web/app/(app)/components/ride-card.tsx
autonomous: true

must_haves:
  truths:
    - "Passenger can enter origin, destination, and date to search for rides"
    - "Search results come from the nearby_rides RPC function with geospatial matching"
    - "Results display driver name, avatar, rating, vehicle info, price, seats, and departure time"
    - "Passenger can filter by price range and sort by price, time, or rating"
  artifacts:
    - path: "apps/web/app/(app)/search/page.tsx"
      provides: "Search results page replacing placeholder"
      min_lines: 30
    - path: "apps/web/app/(app)/components/search-form.tsx"
      provides: "Search form with autocomplete and date picker"
      contains: "AddressAutocomplete"
    - path: "apps/web/app/(app)/components/ride-card.tsx"
      provides: "Ride result card component"
      contains: "seats_available"
    - path: "apps/web/app/(app)/components/search-filters.tsx"
      provides: "Filter and sort controls"
      contains: "sort"
  key_links:
    - from: "apps/web/app/(app)/search/page.tsx"
      to: "packages/shared/src/queries/search.ts"
      via: "searchNearbyRides query builder"
      pattern: "searchNearbyRides"
    - from: "apps/web/app/(app)/components/search-form.tsx"
      to: "apps/web/app/(app)/components/address-autocomplete.tsx"
      via: "Reuses autocomplete for origin/dest input"
      pattern: "AddressAutocomplete"
---

<objective>
Build the ride search page with autocomplete search form, geospatial results from nearby_rides RPC, and ride cards with filtering and sorting.

Purpose: The search page is the main passenger experience -- finding rides. It reuses the AddressAutocomplete from plan 04 and calls the nearby_rides RPC for geospatial corridor matching.

Output: Working search page at /search with autocomplete form, ride result cards, and filter/sort controls.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@.planning/phases/03-ride-posting-search/03-01-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-02-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-04-SUMMARY.md
@apps/web/app/(app)/components/address-autocomplete.tsx
@packages/shared/src/queries/search.ts
@packages/shared/src/validation/search.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create search form and ride card components</name>
  <files>
    apps/web/app/(app)/components/search-form.tsx
    apps/web/app/(app)/components/ride-card.tsx
  </files>
  <action>
**apps/web/app/(app)/components/search-form.tsx:**
- 'use client' component
- Props: onSearch(params: SearchParams) callback, isLoading boolean
- Two AddressAutocomplete inputs (origin, destination) -- reuse from plan 04
- Date input (type="date") defaulting to today
- "Search" button
- On submit: validate with SearchRidesSchema from @festapp/shared, call onSearch with {originLat, originLng, destLat, destLng, searchDate}
- Compact layout: origin and destination side-by-side on desktop, stacked on mobile. Date and search button in a row below.
- Style consistent with existing design system (pastel borders, rounded-xl, shadows)

**apps/web/app/(app)/components/ride-card.tsx:**
- 'use client' component
- Props: ride data matching NearbyRideResult type from @festapp/shared
- Card layout showing:
  - Driver avatar (small circle), display name, rating (stars or number + count)
  - Route: origin_address -> destination_address (with arrow)
  - Departure time formatted with date-fns (e.g., "Fri, Feb 20 at 3:00 PM")
  - Price in CZK (prominent)
  - Seats available (e.g., "3 seats left")
  - Vehicle info: make + model + color (if available)
  - Booking mode badge: "Instant" (green) or "Request" (amber)
  - Distance from search origin displayed subtly (e.g., "2.3 km from your pickup")
- Entire card is a clickable link to `/rides/[ride_id]`
- Responsive: stacked on mobile, horizontal card on desktop
- Style with pastel design tokens
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck --filter=web
```
  </verify>
  <done>SearchForm component renders autocomplete inputs and date picker. RideCard component displays all ride info in a clean card layout with link to detail page.</done>
</task>

<task type="auto">
  <name>Task 2: Create search filters and assemble search page</name>
  <files>
    apps/web/app/(app)/components/search-filters.tsx
    apps/web/app/(app)/search/page.tsx
  </files>
  <action>
**apps/web/app/(app)/components/search-filters.tsx:**
- 'use client' component
- Props: onFilterChange callback, currentFilters object
- Sort options: "Earliest departure" (default), "Lowest price", "Highest rated", "Closest pickup"
- Filter options:
  - Price range: min/max CZK inputs
  - Booking mode: "All", "Instant only", "Request only"
  - Min seats: number input (default 1)
- Filters apply client-side to the RPC results (the RPC already does spatial filtering; client-side filtering handles price/mode/seats refinement)
- Compact horizontal layout with dropdowns/selects
- Collapsible on mobile (show/hide toggle)

**apps/web/app/(app)/search/page.tsx:**
- REPLACE the existing placeholder page
- 'use client' page (needs state for search results and filters)
- State: searchResults (NearbyRideResult[]), isLoading, filters, sortBy
- Layout:
  1. SearchForm at top
  2. SearchFilters bar below
  3. Results grid: RideCard components in a list/grid
  4. Empty state when no results: "No rides found. Try expanding your search radius or changing the date."
  5. Loading state: skeleton cards while searching
- On search: call `searchNearbyRides(supabase, params)` from @festapp/shared queries
- Apply client-side filters and sorting to results before rendering
- Show result count: "X rides found"
- URL params: persist search params in URL query string (origin, dest, date) so search is shareable/bookmarkable via `useSearchParams`
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web
```
Build must pass. Search page should render at /search.
  </verify>
  <done>Search page at /search with autocomplete form, geospatial results from nearby_rides RPC, ride cards with driver/vehicle info, filtering by price/mode/seats, and sorting by time/price/rating/distance.</done>
</task>

</tasks>

<verification>
- `pnpm turbo build --filter=web` passes
- /search page renders with SearchForm and empty state
- RideCard component displays all required ride information
- Filters and sorting work client-side on search results
- Search params are persisted in URL for shareability
</verification>

<success_criteria>
- Passenger can enter origin, destination, and date on the search page
- Search calls nearby_rides RPC and displays matching rides as cards
- Each card shows driver profile, rating, vehicle, price, seats, departure time
- Client-side filtering by price range, booking mode, and minimum seats works
- Sorting by departure time, price, rating, and proximity works
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-05-SUMMARY.md`
</output>
