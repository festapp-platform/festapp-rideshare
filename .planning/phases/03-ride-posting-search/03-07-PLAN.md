---
phase: 03-ride-posting-search
plan: 07
type: execute
wave: 3
depends_on: ["03-04", "03-05", "03-06"]
files_modified:
  - apps/web/app/(app)/components/post-ride-fab.tsx
  - apps/web/app/(app)/components/favorite-routes.tsx
  - apps/web/app/(app)/rides/new/recurring/page.tsx
  - apps/web/app/(app)/search/page.tsx
  - apps/web/app/(app)/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Post a Ride FAB is visible on all authenticated screens and navigates to /rides/new"
    - "Passenger can save a route as favorite from search results"
    - "Passenger can view and manage saved favorite routes"
    - "Driver can create a recurring ride pattern that auto-generates rides"
    - "Deep links to ride pages work (URL structure /rides/[id])"
  artifacts:
    - path: "apps/web/app/(app)/components/post-ride-fab.tsx"
      provides: "Floating action button for ride posting"
      contains: "rides/new"
    - path: "apps/web/app/(app)/components/favorite-routes.tsx"
      provides: "Favorite routes save/manage component"
      contains: "favorite_routes"
    - path: "apps/web/app/(app)/rides/new/recurring/page.tsx"
      provides: "Recurring ride pattern creation page"
      contains: "recurring_ride_patterns"
  key_links:
    - from: "apps/web/app/(app)/components/post-ride-fab.tsx"
      to: "apps/web/app/(app)/rides/new/page.tsx"
      via: "Navigation link"
      pattern: "rides/new"
    - from: "apps/web/app/(app)/components/favorite-routes.tsx"
      to: "packages/shared/src/types/database.ts"
      via: "Supabase client insert/delete on favorite_routes table"
      pattern: "favorite_routes"
---

<objective>
Add the Post-a-Ride FAB, favorite routes functionality, recurring ride patterns, and verify deep link structure.

Purpose: These features complete the Phase 3 success criteria: the FAB makes ride posting accessible from any screen (NAV-07), favorite routes enable quick repeat searches (SRCH-07), recurring patterns automate regular commute rides (RIDE-13), and the URL structure at /rides/[id] serves as a deep link (SRCH-06).

Output: FAB on all screens, favorite routes CRUD, recurring ride creation page, deep link verification.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@.planning/phases/03-ride-posting-search/03-04-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-05-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-06-SUMMARY.md
@apps/web/app/(app)/layout.tsx
@apps/web/app/(app)/search/page.tsx
@apps/web/app/(app)/components/ride-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Post-a-Ride FAB and add favorite routes functionality</name>
  <files>
    apps/web/app/(app)/components/post-ride-fab.tsx
    apps/web/app/(app)/components/favorite-routes.tsx
    apps/web/app/(app)/layout.tsx
    apps/web/app/(app)/search/page.tsx
  </files>
  <action>
**apps/web/app/(app)/components/post-ride-fab.tsx:**
- 'use client' component
- Fixed-position floating action button in bottom-right corner
- Shows a "+" icon with "Post a Ride" tooltip/label
- Links to /rides/new via Next.js Link
- Pastel primary color (from design tokens), rounded-full, shadow-lg
- Hide on /rides/new page itself (check usePathname) to avoid redundancy
- Hide on mobile if bottom nav is visible (use `hidden md:flex` or similar responsive class, OR position above bottom nav with appropriate bottom offset like bottom-20)
- Accessible: aria-label="Post a ride"

**apps/web/app/(app)/layout.tsx:**
- Add `<PostRideFab />` component to the layout, positioned after children
- Existing layout structure: auth check, nav sidebar/bottom tabs, children
- FAB renders on all authenticated pages

**apps/web/app/(app)/components/favorite-routes.tsx:**
- 'use client' component
- Two sub-components or modes:
  1. **SaveRouteButton**: Props: origin (Location), destination (Location). Shows a heart/star icon button. On click: inserts into favorite_routes table via Supabase client. Toggle state (filled=saved, outline=not saved). Check if route already saved on mount.
  2. **FavoriteRoutesList**: Fetches user's favorite routes from Supabase. Shows list with origin -> destination labels. Click pre-fills the search form with the saved route's coordinates. Delete button to remove a favorite.
- Optional label input when saving (e.g., "Home to Work")

**apps/web/app/(app)/search/page.tsx:**
- Add SaveRouteButton to each search result (or to the search form area after search is performed)
- Add FavoriteRoutesList section: show above or beside the search form as "Saved Routes" quick-access panel. Click a saved route to auto-fill search form and trigger search.
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web
```
  </verify>
  <done>Post-a-Ride FAB visible on all authenticated pages (except /rides/new). Favorite routes can be saved from search results and managed in a panel on the search page.</done>
</task>

<task type="auto">
  <name>Task 2: Create recurring ride pattern page and verify deep links</name>
  <files>
    apps/web/app/(app)/rides/new/recurring/page.tsx
  </files>
  <action>
**apps/web/app/(app)/rides/new/recurring/page.tsx:**
- 'use client' page for creating recurring ride patterns
- Form fields:
  - Origin and destination (reuse AddressAutocomplete -- compute route once)
  - Day of week (select: Monday through Sunday)
  - Departure time (time input, e.g., "08:00")
  - Seats total (number input 1-8)
  - Price CZK (with suggestion from compute-route if available)
  - Booking mode (instant/request)
  - Generate weeks ahead (number input, default 2, max 4)
  - Vehicle selection (optional)
- On submit:
  - Insert into `recurring_ride_patterns` table via Supabase client
  - Include route_geometry and route_encoded_polyline from compute-route response
  - The pg_cron job (from plan 03-01) will auto-generate ride instances
  - Show success message: "Recurring ride created! Rides will be automatically generated for the next X weeks."
  - Link to /my-rides to see generated rides
- Link to this page from /rides/new: "Create a recurring ride instead" link below the standard ride form

**Deep link verification:**
- The ride detail page at /rides/[id] already serves as the deep link target (created in plan 06)
- generateMetadata provides OG tags for social previews
- No additional work needed for web deep links -- the URL structure IS the deep link
- Add a "Share" button to the ride detail page (apps/web/app/(app)/components/ride-detail.tsx):
  - Uses `navigator.share()` API if available (mobile browsers), falls back to "Copy link" button
  - Copies `window.location.href` to clipboard
  - Shows toast/notification "Link copied!"
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web
```
Verify /rides/new/recurring page renders. Verify ride detail page has Share button.
  </verify>
  <done>Recurring ride pattern creation page at /rides/new/recurring with day-of-week schedule. Share button on ride detail page uses navigator.share or copy-to-clipboard. Deep link URL structure (/rides/[id]) confirmed working with OG metadata.</done>
</task>

</tasks>

<verification>
- `pnpm turbo build --filter=web` passes
- Post-a-Ride FAB appears on authenticated pages
- Favorite routes can be saved and used to quick-fill search
- Recurring ride pattern form submits to database
- Ride detail Share button copies link / triggers native share
- /rides/[id] URL works as deep link with OG metadata
</verification>

<success_criteria>
- NAV-07: Post a Ride FAB accessible from any authenticated screen
- SRCH-06: Ride shareable via URL deep link with social preview
- SRCH-07: Favorite routes can be saved and used for quick searches
- RIDE-13: Recurring ride pattern can be created with auto-generation
- All Phase 3 requirements covered by combined plans 01-07
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-07-SUMMARY.md`
</output>
