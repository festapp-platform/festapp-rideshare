---
phase: 03-ride-posting-search
plan: 06
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - apps/web/app/(app)/rides/[id]/page.tsx
  - apps/web/app/(app)/rides/[id]/edit/page.tsx
  - apps/web/app/(app)/my-rides/page.tsx
  - apps/web/app/(app)/components/ride-detail.tsx
  - apps/web/app/(app)/components/ride-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "Passenger can view a ride detail page showing route on map, driver profile, pickup points, co-passengers placeholder, and booking action placeholder"
    - "Ride detail page has Open Graph metadata for rich social previews when shared"
    - "Driver can edit their ride's details (time, seats, price, notes) from the detail page"
    - "Driver can delete/cancel a ride from the detail page"
    - "My Rides page shows the driver's upcoming and past rides with status badges"
  artifacts:
    - path: "apps/web/app/(app)/rides/[id]/page.tsx"
      provides: "SSR ride detail page with OG metadata"
      contains: "generateMetadata"
    - path: "apps/web/app/(app)/rides/[id]/edit/page.tsx"
      provides: "Ride editing page"
      contains: "UpdateRideSchema"
    - path: "apps/web/app/(app)/my-rides/page.tsx"
      provides: "My Rides page with upcoming and past rides"
      min_lines: 30
    - path: "apps/web/app/(app)/components/ride-detail.tsx"
      provides: "Ride detail display component"
      contains: "RideMap"
  key_links:
    - from: "apps/web/app/(app)/rides/[id]/page.tsx"
      to: "packages/shared/src/queries/rides.ts"
      via: "getRideById for SSR data fetch"
      pattern: "getRideById"
    - from: "apps/web/app/(app)/rides/[id]/edit/page.tsx"
      to: "packages/shared/src/queries/rides.ts"
      via: "updateRide for form submission"
      pattern: "updateRide"
    - from: "apps/web/app/(app)/my-rides/page.tsx"
      to: "packages/shared/src/queries/rides.ts"
      via: "getDriverRides for ride list"
      pattern: "getDriverRides"
---

<objective>
Build the ride detail page with map and driver info, ride editing, ride deletion/cancellation, and the My Rides management page.

Purpose: The ride detail page is the landing page for shared ride links (with OG metadata for social previews). It shows the complete ride information with map. The My Rides page gives drivers visibility into their posted rides. Edit and delete complete the ride lifecycle management.

Output: Ride detail page at /rides/[id], edit page at /rides/[id]/edit, and My Rides page at /my-rides.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@.planning/phases/03-ride-posting-search/03-04-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-05-SUMMARY.md
@apps/web/app/(app)/components/ride-map.tsx
@apps/web/app/(app)/components/ride-card.tsx
@packages/shared/src/queries/rides.ts
@packages/shared/src/constants/ride.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ride detail page with SSR, OG metadata, map, and driver info</name>
  <files>
    apps/web/app/(app)/rides/[id]/page.tsx
    apps/web/app/(app)/components/ride-detail.tsx
    apps/web/app/(app)/components/ride-status-badge.tsx
  </files>
  <action>
**apps/web/app/(app)/components/ride-status-badge.tsx:**
- Small badge component showing ride status with color coding
- upcoming: blue, in_progress: green, completed: gray, cancelled: red
- Use RIDE_STATUS constants from @festapp/shared

**apps/web/app/(app)/components/ride-detail.tsx:**
- 'use client' component
- Props: ride data (from getRideById), isOwner boolean, waypoints array
- Layout sections:
  1. **Route header**: Origin -> Destination with arrow, departure time, status badge
  2. **Map**: RideMap component showing route polyline (reuse from plan 04). If waypoints exist, show markers for pickup points.
  3. **Trip info**: Distance (km), Duration (formatted), Luggage size
  4. **Price**: Prominent price display in CZK
  5. **Driver section**: Avatar, display name, rating stars, verification badges (phone/ID). Link to public profile `/profile/[driver_id]`.
  6. **Vehicle section**: If vehicle linked, show make/model/color/photo
  7. **Preferences**: Icons for smoking/pets/music/chat preferences
  8. **Notes**: Driver's notes if any
  9. **Booking section**: seats_available display. Placeholder "Book this ride" button (actual booking in Phase 4). Show booking mode (instant/request).
  10. **Co-passengers**: Placeholder section "Passengers will appear here after booking" (Phase 4)
  11. **Actions (if isOwner)**: "Edit" link to /rides/[id]/edit, "Cancel ride" button with confirmation (inline second-click pattern like Phase 2 delete)
- On cancel: call deleteRide or update status to 'cancelled' via updateRide

**apps/web/app/(app)/rides/[id]/page.tsx:**
- Server component with `generateMetadata` for Open Graph exactly per research Pattern 7
- Fetch ride data server-side with getRideById (include driver profile + vehicle join)
- Also fetch waypoints with getRideWaypoints
- Determine isOwner by comparing ride.driver_id to current user
- `generateMetadata`: title = "Origin -> Destination", description = "X CZK, Y seats, date", openGraph with title, description, url
- Pass data to RideDetail client component
- 404 handling: if ride not found, return notFound()
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web
```
Build must pass. /rides/[id] should render with SSR.
  </verify>
  <done>Ride detail page renders server-side with Open Graph metadata. Shows route map, driver info, vehicle, price, preferences, and owner actions (edit/cancel). 404 for invalid ride IDs.</done>
</task>

<task type="auto">
  <name>Task 2: Create ride edit page and My Rides management page</name>
  <files>
    apps/web/app/(app)/rides/[id]/edit/page.tsx
    apps/web/app/(app)/my-rides/page.tsx
  </files>
  <action>
**apps/web/app/(app)/rides/[id]/edit/page.tsx:**
- Server component that fetches ride data and verifies ownership
- Only the ride driver can access edit page (redirect to ride detail if not owner)
- Render a modified version of RideForm (from plan 04) pre-populated with existing ride data:
  - Pre-fill all fields (origin, destination, time, seats, price, luggage, booking mode, notes, vehicle)
  - Origin/destination autocomplete fields show current addresses
  - If driver changes origin or destination, re-compute route via Edge Function
  - If not changed, keep existing route data
- On submit: call updateRide from @festapp/shared queries
- After successful update: redirect to /rides/[id]
- Include "Delete ride" button at bottom with confirmation
- On delete: call deleteRide, redirect to /my-rides

**apps/web/app/(app)/my-rides/page.tsx:**
- REPLACE the existing placeholder page
- 'use client' page (needs state for rides list)
- Fetch rides for current user as driver: getDriverRides(supabase, userId)
- Also fetch rides where user is a passenger (placeholder query for Phase 4 -- for now just show driver rides)
- Two tabs/sections:
  1. **Upcoming**: rides with status='upcoming' sorted by departure_time ASC
  2. **Past**: rides with status in ('completed','cancelled') sorted by departure_time DESC
- Each ride shown as a compact card (reuse RideCard component or create a simplified version):
  - Origin -> Destination, departure time, price, seats total/available, status badge
  - Click navigates to /rides/[id]
- Empty states: "No upcoming rides. Post a ride to get started!" with link to /rides/new
- Show count of upcoming/past rides in tab headers
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web
```
  </verify>
  <done>Ride edit page pre-fills form with existing data and updates on submit. My Rides page shows upcoming/past rides for the current driver with links to detail pages.</done>
</task>

</tasks>

<verification>
- `pnpm turbo build --filter=web` passes
- /rides/[id] renders with SSR and correct OG metadata
- /rides/[id]/edit pre-fills form and allows updating
- /my-rides shows driver's rides in upcoming/past sections
- Ride cancellation updates status and reflects in My Rides
</verification>

<success_criteria>
- Ride detail page shows full ride info with map, driver profile, vehicle, price, and booking placeholder
- Open Graph metadata generates correct social previews
- Driver can edit ride details (redirected back to detail on save)
- Driver can cancel/delete a ride with confirmation
- My Rides page lists driver's upcoming and past rides with correct status
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-06-SUMMARY.md`
</output>
