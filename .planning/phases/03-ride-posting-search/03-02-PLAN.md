---
phase: 03-ride-posting-search
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/validation/ride.ts
  - packages/shared/src/validation/search.ts
  - packages/shared/src/constants/pricing.ts
  - packages/shared/src/constants/ride.ts
  - packages/shared/src/queries/rides.ts
  - packages/shared/src/queries/search.ts
  - packages/shared/src/types/database.ts
  - packages/shared/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Zod schemas validate ride creation, update, and search inputs"
    - "Price suggestion function calculates CZK price from distance using Czech fuel costs"
    - "Query builders wrap Supabase .from() and .rpc() calls for rides"
    - "Database types include rides, ride_waypoints, recurring_ride_patterns, and favorite_routes tables"
  artifacts:
    - path: "packages/shared/src/validation/ride.ts"
      provides: "CreateRideSchema, UpdateRideSchema, LocationSchema"
      exports: ["CreateRideSchema", "UpdateRideSchema", "LocationSchema"]
    - path: "packages/shared/src/validation/search.ts"
      provides: "SearchRidesSchema validation"
      exports: ["SearchRidesSchema"]
    - path: "packages/shared/src/constants/pricing.ts"
      provides: "PRICING constants and calculateSuggestedPrice function"
      exports: ["PRICING", "calculateSuggestedPrice"]
    - path: "packages/shared/src/types/database.ts"
      provides: "Full Database types for all Phase 3 tables"
      contains: "rides:"
  key_links:
    - from: "packages/shared/src/queries/search.ts"
      to: "packages/shared/src/types/database.ts"
      via: "Typed Supabase client for RPC calls"
      pattern: "SupabaseClient<Database>"
    - from: "packages/shared/src/constants/pricing.ts"
      to: "Edge Function compute-route"
      via: "Same formula used server-side and client-side"
      pattern: "calculateSuggestedPrice"
---

<objective>
Create all shared TypeScript code for rides: Zod validation schemas, pricing constants/functions, ride status constants, database types, and Supabase query builders.

Purpose: The shared package provides type-safe validation, pricing logic, and query builders that both web and mobile apps consume. This is the TypeScript foundation that ride posting and search UI depend on.

Output: Validation schemas, pricing logic, query builders, and updated database types in @festapp/shared.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@packages/shared/src/index.ts
@packages/shared/src/types/database.ts
@packages/shared/src/validation/profile.ts
@packages/shared/src/constants/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ride validation schemas, pricing constants, and ride status constants</name>
  <files>
    packages/shared/src/validation/ride.ts
    packages/shared/src/validation/search.ts
    packages/shared/src/constants/pricing.ts
    packages/shared/src/constants/ride.ts
  </files>
  <action>
**packages/shared/src/validation/ride.ts:**
- Create exactly per research "Ride Zod validation schema" example:
  - `LocationSchema`: lat (-90 to 90), lng (-180 to 180), address (1-500 chars), placeId (optional string)
  - `CreateRideSchema`: origin (LocationSchema), destination (LocationSchema), departureTime (datetime string), seatsTotal (int 1-8), priceCzk (number 0-10000, optional), luggageSize (enum), bookingMode (enum), preferences (object with smoking/pets/music/chat booleans, optional), notes (max 500, optional), vehicleId (uuid, optional)
  - `UpdateRideSchema`: CreateRideSchema.partial() with required id (uuid)
  - Export inferred types: Location, CreateRide, UpdateRide

**packages/shared/src/validation/search.ts:**
- `SearchRidesSchema`: origin (LocationSchema), destination (LocationSchema), date (date string), radiusKm (number 1-100, default 15)
- Export inferred type: SearchRides

**packages/shared/src/constants/pricing.ts:**
- Create exactly per research "Price suggestion constants" example:
  - `PRICING` const object with FUEL_PRICE_CZK_PER_LITER (35), AVG_CONSUMPTION_L_PER_100KM (7), COST_SHARING_FACTOR (0.6), MIN_PRICE_FACTOR (0.5), MAX_PRICE_FACTOR (2.0), MIN_PRICE_CZK (20), CURRENCY ('CZK'), CURRENCY_SYMBOL ('Kc')
  - `calculateSuggestedPrice(distanceMeters: number)` function returning {suggested, min, max}

**packages/shared/src/constants/ride.ts:**
- `RIDE_STATUS` const: { upcoming: 'upcoming', in_progress: 'in_progress', completed: 'completed', cancelled: 'cancelled' }
- `BOOKING_MODE` const: { instant: 'instant', request: 'request' }
- `LUGGAGE_SIZE` const: { none: 'none', small: 'small', medium: 'medium', large: 'large' }
- `MAX_SEATS` = 8, `MIN_SEATS` = 1
- `SEARCH_RADIUS_DEFAULT_KM` = 15, `SEARCH_RADIUS_MAX_KM` = 100
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck --filter=@festapp/shared
```
  </verify>
  <done>All validation schemas parse valid/invalid inputs correctly. Pricing function returns correct CZK values. TypeScript compiles with no errors.</done>
</task>

<task type="auto">
  <name>Task 2: Update database types and create query builders, then re-export from shared index</name>
  <files>
    packages/shared/src/types/database.ts
    packages/shared/src/queries/rides.ts
    packages/shared/src/queries/search.ts
    packages/shared/src/index.ts
  </files>
  <action>
**packages/shared/src/types/database.ts:**
- Add `rides` table types (Row, Insert, Update, Relationships) matching the migration schema exactly. Include all columns. Relationships: driver_id -> profiles, vehicle_id -> vehicles.
- Add `ride_waypoints` table types. Relationships: ride_id -> rides.
- Add `recurring_ride_patterns` table types. Relationships: driver_id -> profiles, vehicle_id -> vehicles.
- Add `favorite_routes` table types. Relationships: user_id -> profiles.
- Add `nearby_rides` to Functions with correct Args and Returns types matching the RPC function signature.
- Keep existing profiles, vehicles, and is_phone_verified types unchanged.

**packages/shared/src/queries/rides.ts:**
- Create a `queries` directory under `src/` (new directory)
- `getRideById(client, id)` -- select ride with driver profile and vehicle join, single()
- `getDriverRides(client, driverId, options?: {status?, limit?})` -- select driver's rides ordered by departure_time DESC
- `createRide(client, data: CreateRide & route fields)` -- insert ride row, return single
- `updateRide(client, id, data)` -- update ride by id
- `deleteRide(client, id)` -- delete ride by id
- `getRideWaypoints(client, rideId)` -- select waypoints ordered by order_index
- All functions take `SupabaseClient<Database>` as first arg for type safety

**packages/shared/src/queries/search.ts:**
- `searchNearbyRides(client, params: SearchParams)` exactly per research "Calling nearby_rides RPC" example
- `SearchParams` interface: originLat, originLng, destLat, destLng, searchDate (string), radiusKm?, maxResults?
- `NearbyRideResult` type matching the RPC return columns

**packages/shared/src/index.ts:**
- Add re-exports for all new schemas, types, constants, and query builders:
  - From validation/ride.ts: LocationSchema, CreateRideSchema, UpdateRideSchema + types
  - From validation/search.ts: SearchRidesSchema + type
  - From constants/pricing.ts: PRICING, calculateSuggestedPrice
  - From constants/ride.ts: RIDE_STATUS, BOOKING_MODE, LUGGAGE_SIZE, etc.
  - From queries/rides.ts: all query functions
  - From queries/search.ts: searchNearbyRides, SearchParams, NearbyRideResult
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck
```
Typecheck must pass across all packages (shared, web, mobile).
  </verify>
  <done>Database types cover all 4 new tables plus nearby_rides function. Query builders are typed against Database. All exports available from @festapp/shared. Full monorepo typecheck passes.</done>
</task>

</tasks>

<verification>
- `pnpm turbo typecheck` passes across all packages
- All new exports are importable from `@festapp/shared`
- `calculateSuggestedPrice(200000)` returns reasonable CZK values (200km ~= 29 CZK suggested)
- CreateRideSchema.parse() validates correct input, rejects invalid input
</verification>

<success_criteria>
- Zod schemas for ride creation, update, and search are complete and type-safe
- Pricing function correctly calculates CZK from distance
- Database types match the 8 new migrations
- Query builders are ready for UI consumption
- No TypeScript errors in any package
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-02-SUMMARY.md`
</output>
