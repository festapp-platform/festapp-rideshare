---
phase: 03-ride-posting-search
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - apps/web/app/(app)/rides/new/page.tsx
  - apps/web/app/(app)/components/address-autocomplete.tsx
  - apps/web/app/(app)/components/ride-form.tsx
  - apps/web/app/(app)/components/ride-map.tsx
  - apps/web/app/(app)/layout.tsx
  - apps/web/lib/google-maps-provider.tsx
autonomous: true

must_haves:
  truths:
    - "Driver can type an origin and destination with autocomplete suggestions biased toward CZ/SK"
    - "After selecting origin and destination, route is computed and displayed on a map with distance, duration, and price suggestion"
    - "Driver can adjust price within min/max bounds, select seats, luggage size, booking mode, and add notes"
    - "Submitting the form creates a ride in the database with correct geography columns"
    - "Google Maps API provider wraps the app layout for Places + Maps libraries"
  artifacts:
    - path: "apps/web/app/(app)/rides/new/page.tsx"
      provides: "Ride posting page"
      min_lines: 20
    - path: "apps/web/app/(app)/components/address-autocomplete.tsx"
      provides: "Google Places autocomplete input using new API"
      contains: "fetchAutocompleteSuggestions"
    - path: "apps/web/app/(app)/components/ride-form.tsx"
      provides: "Ride posting form with all fields"
      contains: "CreateRideSchema"
    - path: "apps/web/app/(app)/components/ride-map.tsx"
      provides: "Map component showing route polyline"
      contains: "google.maps.Polyline"
  key_links:
    - from: "apps/web/app/(app)/components/ride-form.tsx"
      to: "supabase/functions/compute-route"
      via: "Fetch to Edge Function after origin/destination selected"
      pattern: "compute-route"
    - from: "apps/web/app/(app)/components/ride-form.tsx"
      to: "packages/shared/src/queries/rides.ts"
      via: "createRide query builder for form submission"
      pattern: "createRide"
    - from: "apps/web/app/(app)/components/address-autocomplete.tsx"
      to: "Google Places API (New)"
      via: "fetchAutocompleteSuggestions programmatic call"
      pattern: "AutocompleteSuggestion\\.fetchAutocompleteSuggestions"
---

<objective>
Build the ride posting form with Google Places address autocomplete, route computation, map display, and price suggestion on web.

Purpose: This is the core driver experience -- posting a ride. The form uses the new Google Places API for address input, calls the compute-route Edge Function for distance/price, and displays the route on a Google Map.

Output: Working ride posting page at /rides/new with autocomplete, map, price suggestion, and database insertion.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ride-posting-search/03-RESEARCH.md
@.planning/phases/03-ride-posting-search/03-01-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-02-SUMMARY.md
@.planning/phases/03-ride-posting-search/03-03-SUMMARY.md
@apps/web/app/(app)/layout.tsx
@apps/web/app/(app)/profile/page.tsx
@packages/shared/src/validation/ride.ts
@packages/shared/src/constants/pricing.ts
@packages/shared/src/queries/rides.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Google Maps dependencies and create Maps provider + autocomplete component</name>
  <files>
    apps/web/lib/google-maps-provider.tsx
    apps/web/app/(app)/components/address-autocomplete.tsx
    apps/web/app/(app)/layout.tsx
  </files>
  <action>
**Install dependencies:**
```bash
cd apps/web && pnpm add @vis.gl/react-google-maps @googlemaps/polyline-codec date-fns
cd packages/shared && pnpm add date-fns
```

**apps/web/lib/google-maps-provider.tsx:**
- 'use client' component
- Import `APIProvider` from `@vis.gl/react-google-maps`
- Read API key from `process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY`
- Wrap children in `<APIProvider apiKey={key} libraries={['places']}>` (include `places` library for autocomplete)
- Export as default or named `GoogleMapsProvider`

**apps/web/app/(app)/components/address-autocomplete.tsx:**
- Create exactly per research Pattern 3 code
- 'use client' component
- Use `useMapsLibrary('places')` from @vis.gl/react-google-maps
- Props: placeholder, onPlaceSelect (callback with {lat, lng, address, placeId}), defaultValue?, className?
- 300ms debounce on input changes
- `fetchAutocompleteSuggestions` with `includedRegionCodes: ['cz', 'sk']`
- Dropdown list showing suggestion text, click selects and fetches place details (location, formattedAddress)
- Close dropdown on click outside (useEffect with document click listener)
- Style with Tailwind classes matching the existing design system (rounded-xl, border-border-pastel)

**apps/web/app/(app)/layout.tsx:**
- Wrap the existing layout children with `<GoogleMapsProvider>` so Maps/Places are available across all app pages
- Import GoogleMapsProvider
- Keep existing auth check and nav structure unchanged

**Add env var to .env.local.example:**
- Add `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=` placeholder
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck --filter=web
```
Verify TypeScript compiles. The autocomplete won't be testable without a real API key, but it should compile and render without errors.
  </verify>
  <done>Google Maps provider wraps app layout. AddressAutocomplete component uses Places API (New) with fetchAutocompleteSuggestions, debounced input, CZ/SK bias, and dropdown selection.</done>
</task>

<task type="auto">
  <name>Task 2: Create ride posting form, map component, and /rides/new page</name>
  <files>
    apps/web/app/(app)/components/ride-form.tsx
    apps/web/app/(app)/components/ride-map.tsx
    apps/web/app/(app)/rides/new/page.tsx
  </files>
  <action>
**apps/web/app/(app)/components/ride-map.tsx:**
- 'use client' component
- Props: encodedPolyline (string), originLat, originLng, destLat, destLng
- Use `Map` and `useMap` from @vis.gl/react-google-maps
- Decode polyline with `@googlemaps/polyline-codec` to get LatLng array
- Draw a `google.maps.Polyline` on the map (use useEffect with map instance)
- Add origin/destination markers (custom or default pins)
- Auto-fit bounds to show entire route
- Pastel-styled map container (rounded corners, shadow)
- Show nothing if no polyline provided

**apps/web/app/(app)/components/ride-form.tsx:**
- 'use client' component
- Use react-hook-form with zodResolver(CreateRideSchema) from @festapp/shared
- Form sections:
  1. **Route**: Two AddressAutocomplete inputs (origin, destination). After both selected, auto-call compute-route Edge Function via `supabase.functions.invoke('compute-route', { body: { originLat, originLng, destLat, destLng } })`. Show loading spinner while computing.
  2. **Route info**: After compute returns, show distance (km), duration (formatted with date-fns), and RideMap component with polyline. Show suggested price.
  3. **Price**: Slider/input for price_czk with min/max bounds from compute-route response. Show "Suggested: X CZK" label.
  4. **Details**: seats (number input 1-8, default 4), departure date/time (datetime-local input), luggage size (select), booking mode (radio: instant/request), notes (textarea).
  5. **Vehicle**: Optional vehicle selection dropdown (fetch user's vehicles from Supabase).
- On submit:
  - Build ride insert object: origin/destination as `extensions.ST_SetSRID(extensions.ST_MakePoint(lng, lat), 4326)` -- WAIT, geography columns need to be inserted via SQL. Use raw SQL insert via `.rpc()` or pass lat/lng and let an insert function handle it.
  - IMPORTANT: Supabase client .insert() can't directly set geography columns. Create an RPC function `create_ride(...)` that accepts lat/lng params and constructs the geography values server-side. OR use the `postgis` geometry format `POINT(lng lat)` string cast. Research shows you can insert text like `POINT(14.42 50.08)` and it auto-casts to geography. Test this approach first -- it's simpler.
  - Actually, the simplest approach: pass origin_location as `POINT(lng lat)` text in the insert, which PostGIS auto-casts to geography. Same for destination_location and route_geometry (as WKT LINESTRING).
  - After successful insert, redirect to the ride detail page at `/rides/[id]`
- Show form validation errors from Zod
- Show loading state during submission

**apps/web/app/(app)/rides/new/page.tsx:**
- Server component page at route /rides/new
- Check auth (redirect to login if not authenticated)
- Render `<RideForm />` client component
- Page title: "Post a Ride"
  </action>
  <verify>
```bash
cd /Users/miakh/source/festapp-rideshare && pnpm turbo typecheck --filter=web && pnpm turbo build --filter=web
```
Build must pass. The form should render at /rides/new. Full functional test requires Google API key.
  </verify>
  <done>Ride posting form at /rides/new with dual autocomplete inputs, route computation via Edge Function, map display with polyline, price suggestion slider, all ride fields, and database insertion via Supabase client.</done>
</task>

</tasks>

<verification>
- `pnpm turbo build --filter=web` passes
- /rides/new page renders ride posting form
- AddressAutocomplete component compiles with Places API (New)
- RideMap component compiles with polyline decoding
- Form uses react-hook-form + CreateRideSchema validation
- Route computation calls compute-route Edge Function
</verification>

<success_criteria>
- Driver can navigate to /rides/new and see a ride posting form
- Address inputs use Google Places autocomplete (New API) with CZ/SK bias
- After selecting both addresses, route appears on map with distance/duration/price
- Form validates all inputs via Zod before submission
- Successful submission creates a ride in the database and redirects to detail page
</success_criteria>

<output>
After completion, create `.planning/phases/03-ride-posting-search/03-04-SUMMARY.md`
</output>
