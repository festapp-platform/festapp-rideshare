---
phase: 12-critical-bug-fixes-admin-setup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/scripts/set-admin.ts
autonomous: false
requirements: [ADMIN-05, ADMIN-06]

must_haves:
  truths:
    - "bujnmi@gmail.com has is_admin: true in app_metadata"
    - "Admin setup is reproducible via a version-controlled script"
  artifacts:
    - path: "supabase/scripts/set-admin.ts"
      provides: "Executable script to set admin flag on a user via Supabase Admin API"
      contains: "app_metadata"
  key_links:
    - from: "set-admin.ts"
      to: "Supabase Auth Admin API"
      via: "auth.admin.updateUserById with app_metadata.is_admin"
      pattern: "updateUserById.*is_admin"
---

<objective>
Create and execute an admin setup script that sets `app_metadata.is_admin = true` on `bujnmi@gmail.com` via the Supabase Admin API.

Purpose: The admin panel infrastructure already exists (middleware check, `is_admin()` SQL function, admin routes). The only missing piece is actually setting the admin flag on the target user. This script makes the setup reproducible.
Output: A version-controlled TypeScript script and confirmed admin access for `bujnmi@gmail.com`.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-critical-bug-fixes-admin-setup/12-RESEARCH.md

@apps/web/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin setup script and attempt execution</name>
  <files>supabase/scripts/set-admin.ts</files>
  <action>
Create `supabase/scripts/set-admin.ts` -- a TypeScript script that uses the Supabase Admin API to set `app_metadata.is_admin = true` on specific users.

**Script requirements:**
1. Read `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` from environment variables (or from `.env.local` via dotenv if available).
2. Accept an email address as a CLI argument (default to `bujnmi@gmail.com` if none provided).
3. Create a Supabase admin client using the service role key.
4. List users via `auth.admin.listUsers()` and find the target user by email.
5. If user found: call `auth.admin.updateUserById(userId, { app_metadata: { is_admin: true } })`.
6. If user NOT found: print a clear message "User {email} not found. They must sign up first."
7. Print success/failure status.

**Script structure:**
```typescript
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL || '';
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || '';

async function setAdmin(email: string) {
  if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
    console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY');
    process.exit(1);
  }

  const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

  // List users and find by email
  const { data: { users }, error: listError } = await supabase.auth.admin.listUsers();
  if (listError) {
    console.error('Failed to list users:', listError.message);
    process.exit(1);
  }

  const user = users.find(u => u.email === email);
  if (!user) {
    console.error(`User ${email} not found. They must sign up first.`);
    process.exit(1);
  }

  // Set admin flag
  const { error } = await supabase.auth.admin.updateUserById(user.id, {
    app_metadata: { ...user.app_metadata, is_admin: true },
  });

  if (error) {
    console.error('Failed to set admin:', error.message);
    process.exit(1);
  }

  console.log(`Successfully set is_admin=true for ${email} (id: ${user.id})`);
}

const email = process.argv[2] || 'bujnmi@gmail.com';
setAdmin(email);
```

**Important:** Spread existing `app_metadata` to avoid wiping other metadata fields.

After creating the script, attempt to execute it:
```bash
cd /Users/miakh/source/festapp-rideshare
npx tsx supabase/scripts/set-admin.ts
```

If it fails due to missing env vars or user not found, that's expected -- log the result clearly. The script is the deliverable; actual execution depends on environment state.
  </action>
  <verify>
1. Read `supabase/scripts/set-admin.ts` and confirm it uses `auth.admin.updateUserById` with `is_admin: true`
2. Confirm it preserves existing `app_metadata` via spread
3. Confirm it handles missing user case gracefully
  </verify>
  <done>
Script exists at `supabase/scripts/set-admin.ts`, handles both user-found and user-not-found cases, preserves existing app_metadata, and is ready to execute in any environment with proper credentials.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify admin access for bujnmi@gmail.com</name>
  <files>supabase/scripts/set-admin.ts</files>
  <action>
Human verification of admin access. What was built: Admin setup script at supabase/scripts/set-admin.ts that sets is_admin flag via Supabase Admin API.

Steps to verify:
1. If the script execution succeeded in Task 1, verify admin access:
   - Log in as bujnmi@gmail.com
   - Navigate to /admin
   - Confirm the admin dashboard loads (not redirected away)

2. If the script reported "User not found" or failed due to env vars:
   - Ensure bujnmi@gmail.com has signed up on the platform
   - Ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in environment
   - Re-run: `cd /Users/miakh/source/festapp-rideshare && npx tsx supabase/scripts/set-admin.ts`
   - Then verify admin access as above

3. Alternative: Set admin via Supabase Dashboard:
   - Go to Authentication > Users in Supabase Dashboard
   - Find bujnmi@gmail.com
   - Edit user metadata: set app_metadata to include `{"is_admin": true}`
  </action>
  <verify>Log in as bujnmi@gmail.com, navigate to /admin, confirm dashboard loads</verify>
  <done>bujnmi@gmail.com can access /admin and see the admin dashboard. Type "approved" or describe the issue.</done>
</task>

</tasks>

<verification>
1. `supabase/scripts/set-admin.ts` exists with correct Supabase Admin API usage
2. Script handles missing user, missing env vars, and preserves existing metadata
3. bujnmi@gmail.com can access /admin (verified by human)
</verification>

<success_criteria>
- Reproducible admin setup script exists in version control
- bujnmi@gmail.com has admin access and can reach the admin panel
</success_criteria>

<output>
After completion, create `.planning/phases/12-critical-bug-fixes-admin-setup/12-03-SUMMARY.md`
</output>
