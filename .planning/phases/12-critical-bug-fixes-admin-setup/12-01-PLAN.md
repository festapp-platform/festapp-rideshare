---
phase: 12-critical-bug-fixes-admin-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/(app)/components/map-location-picker.tsx
  - apps/web/app/(app)/components/date-time-picker.tsx
  - supabase/migrations/20260216120000_chat_client_uuid.sql
  - apps/web/app/(app)/messages/components/chat-view.tsx
autonomous: true
requirements: [BUG-02, BUG-03, BUG-04]

must_haves:
  truths:
    - "User clicks map location and address appears immediately without button getting stuck"
    - "Time picker disables past hours when today is selected, and disables past minutes when today + current hour is selected"
    - "Chat messages appear exactly once -- no duplicates for sender or recipient"
  artifacts:
    - path: "apps/web/app/(app)/components/map-location-picker.tsx"
      provides: "Fixed reverseGeocode with setIsGeocoding(false) in finally block"
      contains: "finally"
    - path: "apps/web/app/(app)/components/date-time-picker.tsx"
      provides: "Future-only time filtering when today is selected"
      contains: "isToday"
    - path: "supabase/migrations/20260216120000_chat_client_uuid.sql"
      provides: "Altered send_chat_message RPC accepting optional p_message_id UUID"
      contains: "p_message_id"
    - path: "apps/web/app/(app)/messages/components/chat-view.tsx"
      provides: "Client UUID passed to send_chat_message RPC"
      contains: "p_message_id"
  key_links:
    - from: "chat-view.tsx"
      to: "send_chat_message RPC"
      via: "p_message_id parameter matching optimistic UUID"
      pattern: "p_message_id.*optimistic"
    - from: "date-time-picker.tsx"
      to: "selected date/hour state"
      via: "isToday check gating hour/minute options"
      pattern: "isToday.*disabled"
---

<objective>
Fix three surgical bugs: map picker stuck loading state, time picker allowing past times, and chat message duplicates.

Purpose: These three bugs are independent single-file fixes (plus one SQL migration for chat). Grouping them maximizes Wave 1 parallelism while keeping context usage low.
Output: Three working features -- responsive map picker, future-only time picker, duplicate-free chat.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-critical-bug-fixes-admin-setup/12-RESEARCH.md

@apps/web/app/(app)/components/map-location-picker.tsx
@apps/web/app/(app)/components/date-time-picker.tsx
@apps/web/app/(app)/messages/components/chat-view.tsx
@supabase/migrations/00000000000004_chat.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix map picker loading state and time picker past-time filtering</name>
  <files>
    apps/web/app/(app)/components/map-location-picker.tsx
    apps/web/app/(app)/components/date-time-picker.tsx
  </files>
  <action>
**Map picker (BUG-03):**
In `map-location-picker.tsx`, the `reverseGeocode` function calls `setIsGeocoding(true)` at the start but only calls `setIsGeocoding(false)` in the fallback path (after catch). The successful geocode path returns early without resetting the flag, which leaves the confirm button permanently disabled.

Fix: Restructure `reverseGeocode` to use a `try/finally` pattern where `setIsGeocoding(false)` is in the `finally` block, guaranteeing it runs on both success and failure paths. Move the fallback `setAddress` into the catch block. The success path sets the address from `items[0].name` and returns -- the `finally` still fires.

Reference the research pattern (Pattern 3) for the exact code structure.

**Time picker (BUG-04):**
In `date-time-picker.tsx`, the hour and minute `<select>` elements show all options regardless of whether today's date is selected.

Fix:
1. Compute `isToday` by comparing the selected date string with `format(new Date(), "yyyy-MM-dd")` -- use a fresh `new Date()` each render (NOT the memoized `today` constant, since that's start-of-day and doesn't track current hour/minute).
2. For the hour `<select>`, disable options where `parseInt(h, 10) < currentHour` when `isToday` is true.
3. For the minute `<select>`, disable options where `parseInt(m, 10) <= currentMinute` when `isToday && parseInt(selectedHour, 10) === currentHour`.
4. Add a `useEffect` watching `[selectedDate, selectedHour]` that auto-advances to the next valid hour/minute if the current selection becomes past. This handles the edge case where the user selects today and their previously-chosen time is now in the past.
5. Use `date-fns` `format` (already imported) for the date comparison.

Important: Do NOT memoize `new Date()` for hour/minute filtering -- the current time changes while the user interacts.
  </action>
  <verify>
1. Read `map-location-picker.tsx` and confirm `setIsGeocoding(false)` is in a `finally` block
2. Read `date-time-picker.tsx` and confirm `isToday` logic gates hour/minute options with `disabled` prop
3. Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web` to verify no build errors
  </verify>
  <done>
Map picker: `setIsGeocoding(false)` always executes via `finally` block, confirm button is never permanently stuck.
Time picker: Past hours disabled when today is selected; past minutes disabled when today + current hour selected; auto-advance corrects stale selections.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix chat message deduplication with client-supplied UUID</name>
  <files>
    supabase/migrations/20260216120000_chat_client_uuid.sql
    apps/web/app/(app)/messages/components/chat-view.tsx
  </files>
  <action>
**Root cause:** `chat-view.tsx` generates `crypto.randomUUID()` for the optimistic message, but `send_chat_message` RPC generates its own `uuid_generate_v4()` server-side. The IDs never match, so the Realtime dedup check (`prev.some((m) => m.id === newMsg.id)`) fails and the message appears twice.

**SQL migration:**
Create `supabase/migrations/20260216120000_chat_client_uuid.sql`:

Use `CREATE OR REPLACE FUNCTION` (per research Pitfall 3 -- function already exists in migration 00000000000004_chat.sql).

Add a new optional parameter `p_message_id UUID DEFAULT NULL` to the `send_chat_message` function. Keep the existing parameter order (`p_conversation_id`, `p_content`, `p_message_type`) and add `p_message_id` as the 4th parameter.

In the function body, replace the existing `uuid_generate_v4()` with `COALESCE(p_message_id, uuid_generate_v4())`. This means:
- When client supplies an ID, the server uses it (enabling dedup)
- When no ID is supplied (NULL default), a new UUID is generated (backward compat)

Copy the ENTIRE existing function body from `00000000000004_chat.sql` and modify only the ID generation line. Do NOT change any validation, RLS, or return logic.

**Client-side change:**
In `chat-view.tsx`, find where `supabase.rpc("send_chat_message", ...)` is called. Add `p_message_id: optimisticId` (or whatever variable name holds the `crypto.randomUUID()` value) to the RPC parameters object.

The existing Realtime subscription already checks `prev.some((m) => m.id === newMsg.id)` -- when the server-inserted row arrives via Realtime with the same UUID as the optimistic message, it will be recognized as a duplicate and replaced instead of appended.
  </action>
  <verify>
1. Read the migration file and confirm `p_message_id UUID DEFAULT NULL` parameter exists and `COALESCE(p_message_id, uuid_generate_v4())` is used
2. Read `chat-view.tsx` and confirm `p_message_id` is passed to the RPC call
3. Run `cd /Users/miakh/source/festapp-rideshare && pnpm turbo build --filter=web` to verify no build errors
  </verify>
  <done>
Migration adds optional `p_message_id` parameter to `send_chat_message` RPC. Client passes optimistic UUID to RPC. Realtime dedup check matches server row to optimistic message by ID, preventing duplicates.
  </done>
</task>

</tasks>

<verification>
1. Map picker: `setIsGeocoding(false)` exists in a `finally` block in reverseGeocode
2. Time picker: `isToday` variable controls disabled state on hour/minute options
3. Chat: `p_message_id` parameter in SQL function signature AND in client RPC call
4. Build passes: `pnpm turbo build --filter=web` completes without errors
</verification>

<success_criteria>
- Map picker confirm button is never permanently disabled after a successful geocode
- Time picker disables past times when today is selected and auto-corrects stale selections
- Chat messages deduplicate correctly because server uses client-supplied UUID
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-critical-bug-fixes-admin-setup/12-01-SUMMARY.md`
</output>
