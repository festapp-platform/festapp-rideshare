---
phase: 14-price-formatting-chat-optimization-ai-tests
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/app/(app)/messages/components/chat-view.tsx
  - supabase/migrations/20260217100014_chat_archival.sql
autonomous: true
requirements: [CHAT-05, CHAT-06]

must_haves:
  truths:
    - "ChatView loads older messages via shared getMessages() with cursor parameter instead of inline Supabase query"
    - "A database function exists to archive/delete chat messages for completed rides older than 90 days"
    - "Existing chat_messages index covers cursor-based pagination queries efficiently"
  artifacts:
    - path: "apps/web/app/(app)/messages/components/chat-view.tsx"
      provides: "ChatView using shared getMessages() for cursor-based pagination"
      contains: "getMessages"
    - path: "supabase/migrations/20260217100014_chat_archival.sql"
      provides: "archive_completed_ride_messages() SQL function"
      contains: "archive_completed_ride_messages"
  key_links:
    - from: "apps/web/app/(app)/messages/components/chat-view.tsx"
      to: "packages/shared/src/queries/chat.ts"
      via: "import getMessages from @festapp/shared"
      pattern: "import.*getMessages.*@festapp/shared"
    - from: "supabase/migrations/20260217100014_chat_archival.sql"
      to: "public.chat_messages"
      via: "DELETE FROM with ride status check"
      pattern: "DELETE FROM.*chat_messages"
---

<objective>
Refactor ChatView to use shared cursor-based pagination and add a chat message archival strategy for completed rides.

Purpose: ChatView currently bypasses the shared `getMessages()` query builder (which already supports cursor-based pagination) and does its own inline Supabase query. This refactors to use the shared function for consistency and maintainability. Additionally, chat messages for completed rides accumulate indefinitely -- an archival function provides cleanup for messages older than 90 days after ride completion.
Output: ChatView uses `getMessages()` from @festapp/shared. SQL migration adds `archive_completed_ride_messages()` function.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-RESEARCH.md
@packages/shared/src/queries/chat.ts
@apps/web/app/(app)/messages/components/chat-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor ChatView to use shared getMessages() with cursor pagination</name>
  <files>apps/web/app/(app)/messages/components/chat-view.tsx</files>
  <action>
1. Add import: `import { getMessages } from "@festapp/shared";`

2. Replace the inline query in `handleLoadOlder` (lines 198-204):

**Before:**
```typescript
const { data: olderMessages } = await supabase
  .from("chat_messages")
  .select("*")
  .eq("conversation_id", conversationId)
  .lt("created_at", oldestMessage.created_at)
  .order("created_at", { ascending: false })
  .limit(50);
```

**After:**
```typescript
const { data: olderMessages } = await getMessages(
  supabase,
  conversationId,
  50,
  oldestMessage.created_at,
);
```

3. The shared `getMessages()` returns messages in `created_at DESC` order (same as the current inline query), so the existing `.reverse()` on line 207 remains correct for prepending to the messages array.

4. No changes needed to the initial message loading -- that comes from `initialMessages` prop passed from the server component parent.

**IMPORTANT:** Only change the `handleLoadOlder` function. Do NOT modify the Realtime subscription, send message flow, or any other part of ChatView. The change is surgical -- 6 lines replaced by 5 lines.
  </action>
  <verify>
    Run `grep -n 'from.*chat_messages' apps/web/app/(app)/messages/components/chat-view.tsx` -- should return zero matches (no more direct table queries). Run `grep -n 'getMessages' apps/web/app/(app)/messages/components/chat-view.tsx` -- should return the import and the usage.
  </verify>
  <done>ChatView.handleLoadOlder() uses getMessages() from @festapp/shared with cursor-based pagination via the `before` parameter. No inline Supabase queries for message loading remain.</done>
</task>

<task type="auto">
  <name>Task 2: Add chat message archival migration for completed rides</name>
  <files>supabase/migrations/20260217100014_chat_archival.sql</files>
  <action>
Create a SQL migration with:

1. **archive_completed_ride_messages() function:**
   ```sql
   CREATE OR REPLACE FUNCTION public.archive_completed_ride_messages()
   RETURNS INTEGER
   LANGUAGE plpgsql
   SECURITY DEFINER SET search_path = ''
   AS $$
   DECLARE
     v_count INTEGER;
   BEGIN
     DELETE FROM public.chat_messages m
     USING public.chat_conversations c
     JOIN public.rides r ON r.id = c.ride_id
     WHERE m.conversation_id = c.id
       AND r.status = 'completed'
       AND r.departure_time < NOW() - INTERVAL '90 days';

     GET DIAGNOSTICS v_count = ROW_COUNT;
     RETURN v_count;
   END;
   $$;
   ```

2. **Grant execute to service_role** (for Edge Function or cron invocation):
   ```sql
   GRANT EXECUTE ON FUNCTION public.archive_completed_ride_messages() TO service_role;
   ```

3. **Comment documenting scheduling options:**
   ```sql
   COMMENT ON FUNCTION public.archive_completed_ride_messages() IS
     'Deletes chat messages for completed rides older than 90 days. '
     'Can be called via pg_cron: SELECT cron.schedule(''archive-chat'', ''0 3 * * 0'', ''SELECT public.archive_completed_ride_messages()'') '
     'or via a scheduled Edge Function.';
   ```

4. **Verify existing index covers cursor queries** -- add a comment confirming `idx_chat_messages_conversation` on `(conversation_id, created_at)` already exists and covers both the pagination and archival queries. Do NOT create a duplicate index.

**Design notes:**
- 90-day TTL is generous -- users can view conversations for ~3 months after ride completion
- SECURITY DEFINER is required because the function deletes across tables with RLS
- The function returns the count of deleted messages for logging/monitoring
- No pg_cron scheduling in this migration since availability varies by Supabase plan -- the function can be called manually or from a scheduled Edge Function
  </action>
  <verify>
    Read the migration file and verify: (a) function is SECURITY DEFINER, (b) 90-day interval, (c) joins through chat_conversations to rides for status check, (d) returns integer count.
  </verify>
  <done>SQL migration creates archive_completed_ride_messages() function that deletes messages for completed rides older than 90 days. Function is SECURITY DEFINER with service_role grant. Scheduling documented in comment.</done>
</task>

</tasks>

<verification>
1. ChatView no longer has inline `.from("chat_messages")` queries for loading older messages
2. ChatView imports and uses `getMessages` from `@festapp/shared`
3. Migration file exists with `archive_completed_ride_messages()` function
4. Function uses 90-day TTL, SECURITY DEFINER, and proper joins
5. TypeScript compiles: `npx turbo run typecheck --filter=web`
</verification>

<success_criteria>
- ChatView.handleLoadOlder() delegates to shared getMessages() with cursor parameter
- No inline Supabase chat_messages queries remain in ChatView for message loading
- archive_completed_ride_messages() SQL function exists and handles completed rides > 90 days
- Existing chat_messages index confirmed sufficient (no duplicate index created)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-03-SUMMARY.md`
</output>
