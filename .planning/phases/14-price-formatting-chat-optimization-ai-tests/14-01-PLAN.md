---
phase: 14-price-formatting-chat-optimization-ai-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/utils/format-price.ts
  - packages/shared/src/constants/pricing.ts
  - packages/shared/src/index.ts
  - supabase/functions/compute-route/index.ts
autonomous: true
requirements: [PRICE-01, PRICE-02, PRICE-04]

must_haves:
  truths:
    - "formatPrice(150) returns locale-aware CZK string with no decimal places"
    - "formatPrice(0) returns 'Zdarma' (free) by default"
    - "calculateSuggestedPrice uses COST_SHARING_FACTOR ~0.327 yielding ~0.80 CZK/km"
    - "Prices <= 200 CZK round to nearest 10, prices > 200 CZK round to nearest 50"
    - "compute-route Edge Function and shared package use the same COST_SHARING_FACTOR"
  artifacts:
    - path: "packages/shared/src/utils/format-price.ts"
      provides: "formatPrice() utility using Intl.NumberFormat with CZK currency"
      exports: ["formatPrice"]
    - path: "packages/shared/src/constants/pricing.ts"
      provides: "Aligned COST_SHARING_FACTOR (0.327) and roundPrice helper"
      contains: "COST_SHARING_FACTOR: 0.327"
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "packages/shared/src/utils/format-price.ts"
      via: "re-export"
      pattern: "export.*formatPrice.*from.*utils/format-price"
    - from: "supabase/functions/compute-route/index.ts"
      to: "packages/shared/src/constants/pricing.ts"
      via: "aligned constant value"
      pattern: "0\\.327"
---

<objective>
Create the formatPrice() utility, align the pricing coefficient to 0.80 CZK/km, and add smart rounding to suggested prices.

Purpose: Establish the shared formatting function that all price display sites will import, and fix the COST_SHARING_FACTOR divergence between shared package (0.36) and Edge Function (0.6) so both produce ~0.80 CZK/km.
Output: `formatPrice()` exported from @festapp/shared, `roundPrice()` in pricing.ts, aligned COST_SHARING_FACTOR in both locations.
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-RESEARCH.md
@packages/shared/src/constants/pricing.ts
@packages/shared/src/index.ts
@supabase/functions/compute-route/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatPrice utility and add smart rounding to pricing</name>
  <files>
    packages/shared/src/utils/format-price.ts
    packages/shared/src/constants/pricing.ts
    packages/shared/src/index.ts
  </files>
  <action>
1. Create `packages/shared/src/utils/format-price.ts`:
   ```typescript
   export function formatPrice(
     amount: number | null | undefined,
     options?: { locale?: string; free?: string }
   ): string {
     if (amount == null || amount === 0) {
       return options?.free ?? 'Zdarma';
     }
     const locale = options?.locale ?? 'cs';
     const bcp47 = locale === 'en' ? 'en-CZ' : `${locale}-CZ`;
     return new Intl.NumberFormat(bcp47, {
       style: 'currency',
       currency: 'CZK',
       maximumFractionDigits: 0,
       minimumFractionDigits: 0,
     }).format(amount);
   }
   ```
   Key: `maximumFractionDigits: 0` prevents "150,00 Kc" (CZK has no practical subunits).

2. Modify `packages/shared/src/constants/pricing.ts`:
   - Change `COST_SHARING_FACTOR` from `0.36` to `0.327` (yields 0.80 CZK/km with 7L/100km at 35 CZK/L)
   - Add `roundPrice()` function BEFORE `calculateSuggestedPrice`:
     ```typescript
     export function roundPrice(price: number): number {
       if (price > 200) return Math.round(price / 50) * 50;
       return Math.round(price / 10) * 10;
     }
     ```
   - Update `calculateSuggestedPrice` to use `roundPrice()` for suggested, min, and max values:
     ```typescript
     const suggested = Math.max(PRICING.MIN_PRICE_CZK, roundPrice(fuelCost * PRICING.COST_SHARING_FACTOR));
     return {
       suggested,
       min: Math.max(PRICING.MIN_PRICE_CZK, roundPrice(suggested * PRICING.MIN_PRICE_FACTOR)),
       max: roundPrice(suggested * PRICING.MAX_PRICE_FACTOR),
     };
     ```

3. Update `packages/shared/src/index.ts`:
   - Add export: `export { formatPrice } from './utils/format-price';`
   - Add export: `export { roundPrice } from './constants/pricing';` (alongside existing PRICING export)
  </action>
  <verify>
    Run `cd /Users/miakh/source/festapp-rideshare && npx turbo run typecheck --filter=@festapp/shared` to confirm no type errors. Verify format-price.ts exists and exports formatPrice.
  </verify>
  <done>formatPrice() utility exists and is exported from @festapp/shared. COST_SHARING_FACTOR is 0.327. roundPrice() rounds to 10 CZK (<=200) or 50 CZK (>200). calculateSuggestedPrice uses roundPrice.</done>
</task>

<task type="auto">
  <name>Task 2: Align compute-route Edge Function COST_SHARING_FACTOR</name>
  <files>supabase/functions/compute-route/index.ts</files>
  <action>
1. Open `supabase/functions/compute-route/index.ts` and find the `COST_SHARING_FACTOR` constant (currently `0.6`).
2. Change it to `0.327` to match the shared package value.
3. Also find the price calculation in the same file -- if it uses `Math.round()` without smart rounding, update to match the same rounding logic: round to nearest 10 for <=200, nearest 50 for >200. Inline the rounding function (Deno Edge Functions cannot import from shared package):
   ```typescript
   function roundPrice(price: number): number {
     if (price > 200) return Math.round(price / 50) * 50;
     return Math.round(price / 10) * 10;
   }
   ```
4. Apply `roundPrice()` to the suggested, min, and max values in the Edge Function's price calculation.
  </action>
  <verify>
    Grep for `0.327` in `supabase/functions/compute-route/index.ts` to confirm the value is updated. Verify no remaining `0.6` sharing factor.
  </verify>
  <done>compute-route Edge Function uses COST_SHARING_FACTOR 0.327 with smart rounding, aligned with shared package.</done>
</task>

</tasks>

<verification>
1. `grep -r "COST_SHARING_FACTOR" packages/shared/ supabase/functions/compute-route/` shows 0.327 in both locations
2. `grep "roundPrice" packages/shared/src/constants/pricing.ts supabase/functions/compute-route/index.ts` shows the function in both
3. `grep "formatPrice" packages/shared/src/index.ts` shows the export
4. TypeScript compiles without errors
</verification>

<success_criteria>
- formatPrice(150) returns locale-aware CZK string (e.g., "150 Kc" in cs locale) with zero decimal places
- formatPrice(0) returns "Zdarma"
- formatPrice(null) returns "Zdarma"
- COST_SHARING_FACTOR is 0.327 in both shared package and compute-route Edge Function
- calculateSuggestedPrice rounds to nearest 10 CZK for values <= 200, nearest 50 CZK for values > 200
- All existing TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-01-SUMMARY.md`
</output>
