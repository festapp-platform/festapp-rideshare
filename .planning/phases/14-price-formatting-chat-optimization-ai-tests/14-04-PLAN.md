---
phase: 14-price-formatting-chat-optimization-ai-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/__tests__/integration/ai-assistant.test.ts
autonomous: true
requirements: [TEST-11, TEST-12]

must_haves:
  truths:
    - "Integration tests invoke the ai-assistant Edge Function with Czech ride creation input and verify create_ride intent"
    - "Integration tests invoke with Slovak and English inputs and verify structured intent responses"
    - "Integration tests verify graceful handling of incomplete, ambiguous, and gibberish inputs without crashes"
    - "Tests skip gracefully when GOOGLE_AI_API_KEY is not available"
  artifacts:
    - path: "supabase/__tests__/integration/ai-assistant.test.ts"
      provides: "AI Edge Function integration test suite covering TEST-11 and TEST-12"
      contains: "ai-assistant"
  key_links:
    - from: "supabase/__tests__/integration/ai-assistant.test.ts"
      to: "supabase/functions/ai-assistant/index.ts"
      via: "Edge Function invocation via Supabase client"
      pattern: "functions\\.invoke.*ai-assistant"
---

<objective>
Write integration tests for the AI Edge Function covering multilingual ride creation intents and error handling.

Purpose: The AI assistant currently has zero integration test coverage. These tests verify that Czech, Slovak, and English ride creation prompts produce structured `create_ride` intents, and that ambiguous, incomplete, and invalid inputs are handled gracefully without crashes.
Output: `supabase/__tests__/integration/ai-assistant.test.ts` with test cases for TEST-11 (multilingual) and TEST-12 (error handling).
</objective>

<execution_context>
@/Users/miakh/.claude/get-shit-done/workflows/execute-plan.md
@/Users/miakh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-RESEARCH.md
@supabase/__tests__/vitest.config.ts
@supabase/__tests__/helpers/test-user.ts
@supabase/__tests__/helpers/supabase-client.ts
@supabase/functions/ai-assistant/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI Edge Function integration test suite</name>
  <files>supabase/__tests__/integration/ai-assistant.test.ts</files>
  <action>
Create `supabase/__tests__/integration/ai-assistant.test.ts` following the existing test patterns (see chat.test.ts for structure):

```typescript
import { createTestUser, type TestUser } from "../helpers/test-user";
import { cleanupUsers } from "../helpers/cleanup";

// Skip entire suite if AI API key is not configured
const AI_KEY_AVAILABLE = !!process.env.GOOGLE_AI_API_KEY;
const describeIfAI = AI_KEY_AVAILABLE ? describe : describe.skip;
```

**Setup/teardown:**
- `beforeAll`: Create one test user (AI requires authenticated client)
- `afterAll`: Clean up test user
- Use longer `testTimeout` if needed (AI calls take 2-5s, but vitest.config already has 15s)

**Helper function:**
```typescript
async function invokeAI(user: TestUser, message: string) {
  const { data, error } = await user.client.functions.invoke("ai-assistant", {
    body: { message, conversation_history: [] },
  });
  return { data, error };
}
```

**TEST-11: Multilingual ride creation (3 test cases):**

1. **Czech:** `"Chci nabidnout jizdu z Prahy do Brna zitra v 8:00"`
   - Assert: `data.intent` is defined
   - Assert: `data.intent.action === "create_ride"`
   - Assert: `data.intent.params.origin_address` is a non-empty string
   - Assert: `data.intent.params.destination_address` is a non-empty string
   - Assert: `data.intent.need_confirmation === true`
   - Do NOT assert exact city name values (AI may return "Praha", "Prague", etc.)

2. **Slovak:** `"Chcem ponuknut jazdu z Bratislavy do Kosic v piatok o 15:00"`
   - Assert: same structural checks as Czech
   - Assert: `data.intent.action === "create_ride"`

3. **English:** `"I want to offer a ride from Prague to Brno tomorrow at 8am"`
   - Assert: same structural checks
   - Assert: `data.intent.action === "create_ride"`

**TEST-12: Error handling (4 test cases):**

4. **Incomplete input:** `"Jedu z Prahy"` (missing destination/time)
   - Assert: no error (200 response)
   - Assert: `data.reply` is a non-empty string (conversational response asking for more info)
   - Assert: `data.intent` is null or undefined (no action to take)

5. **Ambiguous input:** `"Chci jet"` (no details at all)
   - Assert: no error (200 response)
   - Assert: `data.reply` is a non-empty string
   - Assert: `data.intent` is null or undefined

6. **Gibberish input:** `"asdfghjkl zxcvbnm"`
   - Assert: no error (200 response -- should not crash)
   - Assert: `data.reply` is defined (some conversational response)

7. **Non-ride intent:** `"Jak funguje tato aplikace?"` (how does this app work)
   - Assert: no error (200 response)
   - Assert: `data.reply` is a non-empty string
   - Assert: `data.intent` is null or undefined

**Important implementation notes:**
- Wrap the entire suite in `describeIfAI` so tests skip when AI key is not available
- Use `describe("ai-assistant edge function", ...)` as the outer block
- Group TEST-11 tests in `describe("ride creation intents (TEST-11)", ...)`
- Group TEST-12 tests in `describe("error handling (TEST-12)", ...)`
- Add a 20-second timeout per test: `{ timeout: 20_000 }` on each `it()` call since AI calls can be slow
- Assert structural properties only -- never exact AI response text or exact parameter string values
- The Edge Function returns `{ intent, reply, need_confirmation }` -- check `data.intent?.action` for intent type
  </action>
  <verify>
    If GOOGLE_AI_API_KEY is available: `cd supabase/__tests__ && npx vitest run integration/ai-assistant.test.ts` should pass all 7 tests.
    If not available: the test suite should be skipped (not fail).
    In either case, verify the file exists and has correct structure: `grep -c 'it(' supabase/__tests__/integration/ai-assistant.test.ts` should return 7.
  </verify>
  <done>7 integration tests exist covering Czech, Slovak, English ride creation intents (TEST-11) and incomplete, ambiguous, gibberish, non-ride inputs (TEST-12). Tests assert structural properties only. Suite skips gracefully without AI API key.</done>
</task>

</tasks>

<verification>
1. `supabase/__tests__/integration/ai-assistant.test.ts` exists with 7 test cases
2. Tests are grouped into TEST-11 (3 multilingual) and TEST-12 (4 error handling) describe blocks
3. `describeIfAI` pattern skips tests when GOOGLE_AI_API_KEY is not set
4. No exact string assertions on AI response text or parameter values
5. Each test has appropriate timeout for AI calls
</verification>

<success_criteria>
- 7 integration tests exist for the AI Edge Function
- Czech, Slovak, and English inputs all produce create_ride intents (TEST-11)
- Incomplete, ambiguous, gibberish, and non-ride inputs are handled gracefully (TEST-12)
- Tests use structural assertions (action type, parameter presence) not exact string matching
- Tests skip gracefully when GOOGLE_AI_API_KEY is unavailable
- Tests pass when AI key is available and local Supabase is running
</success_criteria>

<output>
After completion, create `.planning/phases/14-price-formatting-chat-optimization-ai-tests/14-04-SUMMARY.md`
</output>
